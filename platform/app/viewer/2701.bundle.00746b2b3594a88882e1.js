"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2701],{62701:(e,t,n)=>{n.r(t),n.d(t,{default:()=>T});var r=n(97598),a=n.n(r),s=n(86326),i=n(29463),o=n(99993),l=n(76654),c=n(58851),u=n(22989),d=n(45981),p=n(92643);function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},m.apply(null,arguments)}function f(e){const{commandsManager:t,children:n,dataSource:r,displaySets:a,viewportOptions:i,servicesManager:f,extensionManager:S}=e,[y]=(0,d.r)(),{displaySetService:g,cornerstoneViewportService:v,measurementService:E,viewportActionCornersService:b}=f.services,w=i.viewportId;if(a.length>1)throw new Error("SR viewport should only have a single display set");const h=a[0],[D,x]=(0,c.ih)(),[T,C]=(0,s.useState)(0),[M,N]=(0,s.useState)(1),[O,k]=(0,s.useState)(null),[U,R]=(0,s.useState)(null),[j,A]=(0,s.useState)(null),{viewports:q,activeViewportId:P}=D,{t:V}=(0,o.Bd)("Common");let L,F;if(S.registeredExtensionIds.includes("@ohif/extension-measurement-tracking")){const e=S.getModuleEntry("@ohif/extension-measurement-tracking.contextModule.TrackedMeasurementsContext"),t=(0,s.useContext)(e.context);L=t?.[0],F=t?.[1]}F||(L=null,F=(e,{displaySetInstanceUID:t})=>{E.clearMeasurements();const{SeriesInstanceUIDs:n}=(0,u.A)({servicesManager:f,extensionManager:S,appConfig:y},t),r=g.getDisplaySetsForSeries(n[0]);r.length&&x.setDisplaySetsForViewports([{viewportId:P,displaySetInstanceUIDs:[r[0].displaySetInstanceUID]}])});const[$,W]=(0,s.useState)(L?.context?.trackedSeries?.length>0),B=(0,s.useCallback)((e=>{const{measurements:t}=h;(0,l.m1)(j,t.map((e=>e.TrackingUniqueIdentifier)),e)}),[j,T,h]),H=(0,s.useCallback)((e=>{const{StudyInstanceUID:t,displaySetInstanceUID:n,sopClassUids:r}=h;t&&n&&(r&&r.length>1&&console.warn("More than one SOPClassUID in the same series is not yet supported."),async function(e,t,n){const{measurements:r}=e,a=r[t],{displaySetInstanceUID:s}=a;e.keyImageDisplaySet||(e.keyImageDisplaySet=(0,p.A)(n,e));if(!s)return{referencedDisplaySetMetadata:null,referencedDisplaySet:null};const i=n.getDisplaySetByUID(s),o=i.images[0],l={PatientID:o.PatientID,PatientName:o.PatientName,PatientSex:o.PatientSex,PatientAge:o.PatientAge,SliceThickness:o.SliceThickness,StudyDate:o.StudyDate,SeriesDescription:o.SeriesDescription,SeriesInstanceUID:o.SeriesInstanceUID,SeriesNumber:o.SeriesNumber,ManufacturerModelName:o.ManufacturerModelName,SpacingBetweenSlices:o.SpacingBetweenSlices};return{referencedDisplaySetMetadata:l,referencedDisplaySet:i}}(h,e,g).then((({referencedDisplaySet:t,referencedDisplaySetMetadata:n})=>{if(t&&n&&(C(e),k(t),R(n),t.displaySetInstanceUID===O?.displaySetInstanceUID)){const{measurements:t}=h,n=v.getCornerstoneViewport(w);if(!n)return;const r=n.getImageIds().indexOf(t[e].imageId);-1!==r&&n.setImageIdIndex(r)}})))}),[r,h,O,w]),_=(0,s.useCallback)((()=>{if(!O)return null;const{component:t}=S.getModuleEntry("@ohif/extension-cornerstone.viewportModule.cornerstone"),{measurements:n}=h,r=n[T];if(!r)return null;const a=O.images.findIndex((e=>e.imageId===r.imageId));return s.createElement(t,m({},e,{displaySets:[O],viewportOptions:{...i,toolGroupId:"SRToolGroup",viewportType:"stack",positionIds:null},onElementEnabled:t=>{e.onElementEnabled?.(t),(e=>{A(e.detail.element)})(t)},initialImageIndex:a,isJumpToMeasurementDisabled:!0}))}),[O,w,T]),G=(0,s.useCallback)((e=>{let t=T;t+=e,t>=M?t=0:t<0&&(t=M-1),B(t),H(t)}),[T,M,H,B]);(0,s.useEffect)((()=>{const e=g.subscribe(g.EVENTS.DISPLAY_SETS_REMOVED,(({displaySetInstanceUIDs:e})=>{const t=q.get(P);e.includes(t.displaySetInstanceUID)&&x.setDisplaySetsForViewport({viewportId:P,displaySetInstanceUIDs:[]})}));return()=>{e.unsubscribe()}}),[]),(0,s.useEffect)((()=>{(async()=>{h.isLoaded||await h.load();const e=h.measurements.length;N(e),H(T)})()}),[h]),(0,s.useEffect)((()=>{(async()=>{h.isLoaded||await h.load(),j&&h.isLoaded&&B(T)})()}),[T,j,B,h]),(0,s.useEffect)((()=>{W(L?.context?.trackedSeries?.length>0)}),[L]),(0,s.useEffect)((()=>{b.addComponents([{viewportId:w,id:"viewportStatusComponent",component:I({srDisplaySet:h,viewportId:w,isRehydratable:h.isRehydratable,isLocked:$,sendTrackedMeasurementsEvent:F,t:V}),indexPriority:-100,location:b.LOCATIONS.topLeft},{viewportId:w,id:"viewportActionArrowsComponent",index:0,component:s.createElement(c.$I,{key:"actionArrows",onArrowsClick:G}),indexPriority:0,location:b.LOCATIONS.topRight}])}),[$,G,F,h,V,b,w]);let Y=null;return O&&U?(n&&n.length&&(Y=n.map(((e,t)=>e&&s.cloneElement(e,{viewportId:w,key:t})))),s.createElement(s.Fragment,null,s.createElement("div",{className:"relative flex h-full w-full flex-row overflow-hidden"},_(),Y))):null}function I({srDisplaySet:e,viewportId:t,isRehydratable:n,isLocked:r,sendTrackedMeasurementsEvent:a,t:i}){const o=()=>{a("HYDRATE_SR",{displaySetInstanceUID:e.displaySetInstanceUID,viewportId:t})},l=i("LOAD"),u=n&&!r?3:n&&r?2:1;let d=null,p=null;switch(u){case 1:p=()=>s.createElement(c.In,{name:"status-alert"}),d=()=>s.createElement("div",null,"This structured report is not compatible",s.createElement("br",null),"with this application.");break;case 2:p=()=>s.createElement(c.In,{name:"status-locked"}),d=()=>s.createElement("div",null,"This structured report is currently read-only",s.createElement("br",null),"because you are tracking measurements in",s.createElement("br",null),"another viewport.");break;case 3:p=()=>s.createElement(c.In,{className:"text-aqua-pale",name:"status-untracked"}),d=()=>s.createElement("div",null,`Click ${l} to restore measurements.`)}const m=()=>s.createElement("div",{className:"flex h-6 cursor-default text-sm leading-6 text-white"},s.createElement("div",{className:"bg-customgray-100 flex min-w-[45px] items-center rounded-l-xl rounded-r p-1"},s.createElement(p,null),s.createElement("span",{className:"ml-1"},"SR")),3===u&&s.createElement("div",{className:"bg-primary-main hover:bg-primary-light ml-1 cursor-pointer rounded px-1.5 hover:text-black",onMouseUp:o},l));return s.createElement(s.Fragment,null,d&&s.createElement(c.m_,{content:s.createElement(d,null),position:"bottom-left"},s.createElement(m,null)),!d&&s.createElement(m,null))}f.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(i.nH).isRequired};const S=f;var y=n(74137);const g={TEXT:e=>e.TextValue,CODE:e=>e.ConceptCodeSequence?.[0]?.CodeMeaning,UIDREF:e=>e.UID,NUM:e=>{const t=e.MeasuredValueSequence?.[0];if(!t)return;const{NumericValue:n,MeasurementUnitsCodeSequence:r}=t,{CodeValue:a}=r;return`${n} ${a}`},PNAME:e=>{const t=e.PersonName?.[0]?.Alphabetic;return t?i.Wp.formatPN(t):void 0},DATE:e=>{const{Date:t}=e;return t?i.Wp.formatDate(t):void 0},TIME:e=>{const{Time:t}=e;return t?i.Wp.formatTime(t):void 0},DATETIME:e=>{const{DateTime:t}=e;if("string"!=typeof t)return;if(t.length<14)return t;const n=t.substring(0,8),r=t.substring(8,14);return`${i.Wp.formatDate(n)} ${i.Wp.formatTime(r)}`}};const v="[empty]";function E(e){const{contentItem:t,nodeIndexesTree:n,continuityOfContent:r}=e,{ConceptNameCodeSequence:a}=t,{CodeValue:i,CodeMeaning:o}=a,l=0===n[n.length-1],c=function(e){const{ValueType:t}=e,n=g[t];return n?n(e):`[${t} is not supported]`}(t)??v,u="CONTINUOUS"===r,d=i===y.n7.Finding,p=u&&!l&&/^[a-zA-Z0-9]/.test(c?.[0]);let m="whitespace-pre-line";return i===y.n7.Finding&&(m="whitespace-pre-wrap"),u?s.createElement(s.Fragment,null,s.createElement("span",{className:m,title:o},p?" ":"",c)):s.createElement(s.Fragment,null,s.createElement("div",{className:"mb-2"},s.createElement("span",{className:"font-bold"},o,": "),d?s.createElement("pre",null,c):s.createElement("span",{className:m},c)))}function b(){return b=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},b.apply(null,arguments)}function w(e){const{container:t,nodeIndexesTree:n=[0],containerNumberedTree:r=[1]}=e,{ContinuityOfContent:a,ConceptNameCodeSequence:i}=t,{CodeMeaning:o}=i??{};let l=1;const c=t.ContentSequence?.map(((e,t)=>{const{ValueType:i}=e,o=[...n,t],c=o.join(".");let u,d;if("CONTAINER"===i){u=w,d={container:e,nodeIndexesTree:o,containerNumberedTree:[...r,l++]}}else u=E,d={contentItem:e,nodeIndexesTree:o,continuityOfContent:a};return s.createElement(u,b({key:c},d))}));return s.createElement("div",null,s.createElement("div",{className:"font-bold"},r.join("."),".Â ",o),s.createElement("div",{className:"ml-4 mb-2"},c))}function h(e){const{displaySets:t}=e,n=t[0].instances[0];return s.createElement("div",{className:"relative flex h-full w-full flex-col overflow-auto p-4 text-white"},s.createElement("div",null,s.createElement(w,{container:n})))}E.propTypes={contentItem:a().object,nodeIndexesTree:a().arrayOf(a().number),continuityOfContent:a().string},w.propTypes={container:a().object,nodeIndexesTree:a().arrayOf(a().number),containerNumberedTree:a().arrayOf(a().number)},h.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(i.nH).isRequired};const D=h;function x(e){const{displaySets:t}=e,{isImagingMeasurementReport:n}=t[0];return n?s.createElement(S,e):s.createElement(D,e)}x.propTypes={displaySets:a().arrayOf(a().object),viewportId:a().string.isRequired,dataSource:a().object,children:a().node,viewportLabel:a().string,viewportOptions:a().object,servicesManager:a().object.isRequired,extensionManager:a().instanceOf(i.nH).isRequired};const T=x}}]);
//# sourceMappingURL=2701.bundle.00746b2b3594a88882e1.js.map