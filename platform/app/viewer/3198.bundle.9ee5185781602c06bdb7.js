"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3198,2591,4182,1801],{57289:(e,t,a)=>{a.r(t),a.d(t,{default:()=>pe});const n=JSON.parse('{"UU":"@ohif/extension-tmtv"}').UU,o=e=>({type:"cameraPosition",id:e,source:!0,target:!0}),i={type:"hydrateseg",id:"sameFORId",source:!0,target:!0,options:{matchingRules:["sameFOR"]}},r={viewportOptions:{viewportId:"ctAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"ctToolGroup",initialImageOptions:{preset:"first"},syncGroups:[o("axialSync"),{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}},i]},displaySets:[{id:"ctDisplaySet"}]},s={viewportOptions:{viewportId:"ctSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"ctToolGroup",syncGroups:[o("sagittalSync"),{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}},i]},displaySets:[{id:"ctDisplaySet"}]},c={viewportOptions:{viewportId:"ctCORONAL",viewportType:"volume",orientation:"coronal",toolGroupId:"ctToolGroup",syncGroups:[o("coronalSync"),{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}},i]},displaySets:[{id:"ctDisplaySet"}]},l={viewportOptions:{viewportId:"ptAXIAL",viewportType:"volume",background:[1,1,1],orientation:"axial",toolGroupId:"ptToolGroup",initialImageOptions:{preset:"first"},syncGroups:[o("axialSync"),{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},i]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},m={viewportOptions:{viewportId:"ptSAGITTAL",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[o("sagittalSync"),{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},i]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},p={viewportOptions:{viewportId:"ptCORONAL",viewportType:"volume",orientation:"coronal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[o("coronalSync"),{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},i]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},d={viewportOptions:{viewportId:"fusionAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"fusionToolGroup",initialImageOptions:{preset:"first"},syncGroups:[o("axialSync"),{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncColormap:!1,syncInvertState:!1}},i]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.8},{value:1,opacity:.9}]},voi:{custom:"getPTVOIRange"}}}]},u={viewportOptions:{viewportId:"fusionSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"fusionToolGroup",syncGroups:[o("sagittalSync"),{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncColormap:!1,syncInvertState:!1}},i]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.8},{value:1,opacity:.9}]},voi:{custom:"getPTVOIRange"}}}]},g={viewportOptions:{viewportId:"fusionCoronal",viewportType:"volume",orientation:"coronal",toolGroupId:"fusionToolGroup",syncGroups:[o("coronalSync"),{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncColormap:!1,syncInvertState:!1}},i]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.8},{value:1,opacity:.9}]},voi:{custom:"getPTVOIRange"}}}]},y={viewportOptions:{viewportId:"mipSagittal",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"mipToolGroup",syncGroups:[{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},i],customViewportProps:{hideOverlays:!0}},displaySets:[{options:{blendMode:"MIP",slabThickness:"fullVolume",voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},h={id:"@ohif/extension-tmtv.hangingProtocolModule.ptCT",locked:!0,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2022-10-04T19:22:08.894Z",availableTo:{},editableBy:{},imageLoadStrategy:"interleaveTopToBottom",protocolMatchingRules:[{attribute:"ModalitiesInStudy",constraint:{contains:["CT","PT"]}},{attribute:"StudyDescription",constraint:{contains:"PETCT"}},{attribute:"StudyDescription",constraint:{contains:"PET/CT"}}],displaySetSelectors:{ctDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"CT"}},{attribute:"SeriesDescription",constraint:{contains:"CT WB"}}]},ptDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"PT"},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"Corrected"}},{weight:2,attribute:"SeriesDescription",constraint:{doesNotContain:{value:"Uncorrected"}}}]}},stages:[{name:"default",id:"default",viewportStructure:{layoutType:"grid",properties:{rows:3,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:1/3},{x:1/4,y:0,width:1/4,height:1/3},{x:.5,y:0,width:1/4,height:1/3},{x:0,y:1/3,width:1/4,height:1/3},{x:1/4,y:1/3,width:1/4,height:1/3},{x:.5,y:1/3,width:1/4,height:1/3},{x:0,y:2/3,width:1/4,height:1/3},{x:1/4,y:2/3,width:1/4,height:1/3},{x:.5,y:2/3,width:1/4,height:1/3},{x:3/4,y:0,width:1/4,height:1}]}},viewports:[r,s,c,l,m,p,d,u,g,y],createdDate:"2021-02-23T18:32:42.850Z"},{name:"Fusion 2x2",id:"Fusion-2x2",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[r,d,l,y]},{name:"2x3-layout",id:"2x3-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3}},viewports:[r,s,c,l,m,p]},{name:"2x4-layout",id:"2x4-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:.5},{x:1/4,y:0,width:1/4,height:.5},{x:.5,y:0,width:1/4,height:.5},{x:3/4,y:0,width:1/4,height:1},{x:0,y:.5,width:1/4,height:.5},{x:1/4,y:.5,width:1/4,height:.5},{x:.5,y:.5,width:1/4,height:.5}]}},viewports:[p,m,l,y,g,u,d]}],numberOfPriorsReferenced:-1};const S=function(){return[{name:h.id,protocol:h}]};var v=a(86326),f=a(97598),I=a.n(f),T=a(58851),w=a(29463),x=a(99993);const b={PatientWeight:null,PatientSex:null,SeriesTime:null,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:null,RadionuclideHalfLife:null,RadiopharmaceuticalStartTime:null}};function E({servicesManager:e,commandsManager:t}){const{t:a}=(0,x.Bd)("PanelSUV"),{displaySetService:n,toolGroupService:o,toolbarService:i,hangingProtocolService:r}=e.services,[s,c]=(0,v.useState)(b),[l,m]=(0,v.useState)(null),p=e=>{c((t=>{const a={...t};return Object.keys(e).forEach((n=>{"object"==typeof e[n]?a[n]={...t[n],...e[n]}:a[n]=e[n]})),a}))},d=e=>{const a=t.runCommand("getMatchingPTDisplaySet",{viewportMatchDetails:e});if(!a)return;return{ptDisplaySet:a,metadata:t.runCommand("getPTMetadata",{ptDisplaySet:a})}};return(0,v.useEffect)((()=>{const e=n.getActiveDisplaySets(),{viewportMatchDetails:t}=r.getMatchDetails();if(!e.length)return;const a=d(t);if(!a)return;const{ptDisplaySet:o,metadata:i}=a;m(o),c(i)}),[]),(0,v.useEffect)((()=>{const{unsubscribe:e}=r.subscribe(r.EVENTS.PROTOCOL_CHANGED,(({viewportMatchDetails:e})=>{const t=d(e);if(!t)return;const{ptDisplaySet:a,metadata:n}=t;m(a),c(n)}));return()=>{e()}}),[]),v.createElement(v.Fragment,null,v.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},v.createElement("div",{className:"flex min-h-0 flex-1 flex-col bg-black text-[13px] font-[300]"},v.createElement(T.aU,{title:a("Patient Information")},v.createElement("div",{className:"flex flex-col"},v.createElement("div",{className:"bg-primary-dark flex flex-col gap-4 p-2"},v.createElement(T.pd,{containerClassName:"!flex-row !justify-between items-center",label:a("Patient Sex"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.PatientSex||"",onChange:e=>{p({PatientSex:e.target.value})}}),v.createElement(T.pd,{containerClassName:"!flex-row !justify-between items-center",label:a("Weight"),labelChildren:v.createElement("span",{className:"text-aqua-pale"}," kg"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.PatientWeight||"",onChange:e=>{p({PatientWeight:e.target.value})},id:"weight-input"}),v.createElement(T.pd,{containerClassName:"!flex-row !justify-between items-center",label:a("Total Dose"),labelChildren:v.createElement("span",{className:"text-aqua-pale"}," bq"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.RadiopharmaceuticalInformationSequence.RadionuclideTotalDose||"",onChange:e=>{p({RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:e.target.value}})}}),v.createElement(T.pd,{containerClassName:"!flex-row !justify-between items-center",label:a("Half Life"),labelChildren:v.createElement("span",{className:"text-aqua-pale"}," s"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.RadiopharmaceuticalInformationSequence.RadionuclideHalfLife||"",onChange:e=>{p({RadiopharmaceuticalInformationSequence:{RadionuclideHalfLife:e.target.value}})}}),v.createElement(T.pd,{containerClassName:"!flex-row !justify-between items-center",label:a("Injection Time"),labelChildren:v.createElement("span",{className:"text-aqua-pale"}," s"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartTime||"",onChange:e=>{p({RadiopharmaceuticalInformationSequence:{RadiopharmaceuticalStartTime:e.target.value}})}}),v.createElement(T.pd,{containerClassName:"!flex-row !justify-between items-center",label:a("Acquisition Time"),labelChildren:v.createElement("span",{className:"text-aqua-pale"}," s"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.SeriesTime||"",onChange:()=>{}}),v.createElement(T.$n,{className:"!h-[26px] !w-[115px] self-end !p-0",onClick:function(){if(!l)throw new Error("No ptDisplaySet found");w.H8.updateMetadataForSeries(l.StudyInstanceUID,l.SeriesInstanceUID,s),n.setDisplaySetMetadataInvalidated(l.displaySetInstanceUID),setTimeout((()=>{t.runCommand("resetCrosshairs")}),0)}},"Reload Data")))))))}E.propTypes={servicesManager:I().shape({services:I().shape({measurementService:I().shape({getMeasurements:I().func.isRequired,subscribe:I().func.isRequired,EVENTS:I().object.isRequired,VALUE_TYPES:I().object.isRequired}).isRequired}).isRequired}).isRequired};var R=a(11185),M=a(81985);const D=async({segmentationId:e,commandsManager:t,segmentationService:a})=>{const n=a.getSegmentation(e);(0,M.triggerEvent)(M.eventTarget,M.Enums.Events.WEB_WORKER_PROGRESS,{progress:0,type:"Calculate Lesion Stats",id:e});const o={};for(const[a,i]of Object.entries(n.segments)){if(!i)continue;const r=Number(a),s=await t.run("getLesionStats",{segmentationId:e,segmentIndex:r}),c={lesionStats:s,suvPeak:await t.run("calculateSuvPeak",{segmentationId:e,segmentIndex:r}),lesionGlyoclysisStats:s.volume*s.meanValue},l={...i,cachedStats:{...i.cachedStats,...c}};o[r]=c,n.segments[a]=l}const i=a.getSegmentations(),r=await t.run("calculateTMTV",{segmentations:i});(0,M.triggerEvent)(M.eventTarget,M.Enums.Events.WEB_WORKER_PROGRESS,{progress:100,type:"Calculate Lesion Stats",id:e}),i.forEach((e=>{e.cachedStats={...e.cachedStats,tmtv:r},Object.keys(e.segments).forEach((t=>{e.segments[t].cachedStats={...e.segments[t].cachedStats,tmtv:r}}));const t={...e,segments:{...e.segments}};a.addOrUpdateSegmentation(t)}))};var C=a(37415);const O=function({servicesManager:e,commandsManager:t}){const{segmentationService:a}=e.services,{segmentationsWithRepresentations:n}=(0,R.useActiveViewportSegmentationRepresentations)({servicesManager:e});(0,v.useEffect)((()=>{const e=n.map((e=>e.segmentation.segmentationId));(async()=>{for(const n of e)await D({segmentationId:n,commandsManager:t,segmentationService:a})})()}),[]),(0,v.useEffect)((()=>{const e=(0,C.sg)((async e=>{const{segmentationId:n}=e;await D({segmentationId:n,commandsManager:t,segmentationService:a})}),100),n=a.subscribe(a.EVENTS.SEGMENTATION_DATA_MODIFIED,(t=>{e(t)}));return()=>{n.unsubscribe()}}),[t,a]);const o=n.find((e=>void 0!==e.segmentation.cachedStats?.tmtv)),i=o?.segmentation.cachedStats?.tmtv;return v.createElement("div",{className:"mt-2 mb-10 flex flex-col"},v.createElement("div",{className:"invisible-scrollbar overflow-y-auto overflow-x-hidden"},null!=i?v.createElement("div",{className:"bg-secondary-dark flex items-baseline justify-between px-2 py-1"},v.createElement("span",{className:"text-base font-bold uppercase tracking-widest text-white"},"TMTV:"),v.createElement("div",{className:"text-white"},`${i.toFixed(3)} mL`)):null))};var N=a(43494);function L({servicesManager:e,commandsManager:t,extensionManager:a,configuration:n}){return v.createElement(v.Fragment,null,v.createElement(R.PanelSegmentation,{servicesManager:e,commandsManager:t,extensionManager:a,configuration:n},v.createElement(P,{servicesManager:e,commandsManager:t})))}const P=({servicesManager:e,commandsManager:t})=>{const{segmentationsWithRepresentations:a}=(0,R.useActiveViewportSegmentationRepresentations)({servicesManager:e}),n=a[0]?.segmentation.cachedStats?.tmtv,o=a.map((e=>e.segmentation));return o.length?v.createElement("div",{className:"flex h-8 w-full items-center rounded pr-0.5"},v.createElement(N.$n,{size:"sm",variant:"ghost",className:"pl-1.5",onClick:()=>{t.runCommand("exportTMTVReportCSV",{segmentations:o,tmtv:n,config:{}})}},v.createElement(N.FI.Download,null),v.createElement("span",{className:"pl-1"},"CSV"))):null};const U=function({commandsManager:e,extensionManager:t,servicesManager:a}){return[{name:"petSUV",iconName:"tab-patient-info",iconLabel:"Patient Info",label:"Patient Info",component:()=>v.createElement(E,{commandsManager:e,servicesManager:a,extensionManager:t})},{name:"tmtv",iconName:"tab-segmentation",iconLabel:"Segmentation",component:()=>v.createElement(v.Fragment,null,v.createElement(N.OO,{commandsManager:e,servicesManager:a,extensionManager:t,buttonSectionId:"ROIThresholdToolbox",title:"Threshold Tools"}),v.createElement(L,{commandsManager:e,servicesManager:a}),v.createElement(O,{commandsManager:e,servicesManager:a}))},{name:"tmtvBox",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation Toolbox",component:()=>v.createElement(N.OO,{commandsManager:e,servicesManager:a,extensionManager:t,buttonSectionId:"ROIThresholdToolbox",title:"Threshold Tools"})},{name:"tmtvExport",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation Export",component:()=>v.createElement(O,{commandsManager:e,servicesManager:a})}]};var V=a(55139);const A=["RectangleROIStartEndThreshold"],k={toAnnotation:(e,t)=>{},toMeasurement:(e,t,a)=>{const{annotation:n,viewportId:o}=e,{metadata:i,data:r,annotationUID:s}=n;if(!i||!r)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:l,FrameOfReferenceUID:m}=i;if(!A.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:d,StudyInstanceUID:u}=(0,R.getSOPInstanceAttributes)(l,a,o);let g;return g=p?t.getDisplaySetForSOPInstanceUID(p,d):t.getDisplaySetsForSeries(d),{uid:s,SOPInstanceUID:p,FrameOfReferenceUID:m,metadata:i,referenceSeriesUID:d,referenceStudyUID:u,toolName:i.toolName,displaySetInstanceUID:g.displaySetInstanceUID,label:i.label,data:r.cachedStats,type:"RectangleROIStartEndThreshold"}}},F={toAnnotation:(e,t)=>{},toMeasurement:(e,t,a)=>{const{annotation:n,viewportId:o}=e,{metadata:i,data:r,annotationUID:s}=n;if(!i||!r)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:l,FrameOfReferenceUID:m}=i;if(!A.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:d,StudyInstanceUID:u}=(0,R.getSOPInstanceAttributes)(l,a,o);let g;g=p?t.getDisplaySetForSOPInstanceUID(p,d):t.getDisplaySetsForSeries(d);const{cachedStats:y}=r;return{uid:s,SOPInstanceUID:p,FrameOfReferenceUID:m,metadata:i,referenceSeriesUID:d,referenceStudyUID:u,toolName:i.toolName,displaySetInstanceUID:g.displaySetInstanceUID,label:i.label,data:r.cachedStats,type:"CircleROIStartEndThreshold"}}},G=(e,t,a)=>({RectangleROIStartEndThreshold:{toAnnotation:k.toAnnotation,toMeasurement:e=>k.toMeasurement(e,t,a),matchingCriteria:[{valueType:e.VALUE_TYPES.ROI_THRESHOLD_MANUAL}]},CircleROIStartEndThreshold:{toAnnotation:F.toAnnotation,toMeasurement:e=>F.toMeasurement(e,t,a),matchingCriteria:[{valueType:e.VALUE_TYPES.ROI_THRESHOLD_MANUAL}]}}),{CORNERSTONE_3D_TOOLS_SOURCE_NAME:W,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:q}=R.Enums;function j(e,t){const{imageData:a}=e,n=a.getPointData().getScalars().getData(),{fn:o,baseValue:i}=function(e){const t=-1/0,a=(e,t)=>(e>t&&(t=e),t);return{fn:a,baseValue:t}}();let r=i;const s=V.utilities.rectangleROITool.getBoundsIJKFromRectangleAnnotations(t,e),[[c,l],[m,p],[d,u]]=s;for(let e=c;e<=l;e++)for(let t=m;t<=p;t++)for(let i=d;i<=u;i++){r=o(n[a.computeOffsetIndex([e,t,i])],r)}return r}const _=function(e,t,a){if("range"===a.strategy)return{ptLower:Number(a.ptLower),ptUpper:Number(a.ptUpper),ctLower:Number(a.ctLower),ctUpper:Number(a.ctUpper)};const{weight:n}=a,o=e.map((e=>V.annotation.state.getAnnotation(e)));return{ctLower:-1/0,ctUpper:1/0,ptLower:n*j(t[0],o),ptUpper:1/0}};var B=a(5842),H=a(33970);const{datasetToBlob:$}=B.Ay.data,J=w.Ly.MetadataProvider;const K=function(e){const t=H.f_.Cornerstone3D.RTSS.generateRTSSFromAnnotations(e,J,w.H8),a=$(t);var n=URL.createObjectURL(a);window.location.assign(n)},{SegmentationRepresentations:z}=V.Enums,X=w.Ly.MetadataProvider,Y=["RectangleROIStartEndThreshold","RectangleROIThreshold","CircleROIStartEndThreshold"],Z=(0,M.getWebWorkerManager)(),Q={maxWorkerInstances:1,autoTerminateOnIdle:{enabled:!0,idleTimeThreshold:3e3}},ee=()=>new Worker(new URL(a.p+a.u(3584),a.b),{name:"suv-peak-worker"});function te(e){const t=V.segmentation.state.getSegmentation(e).representationData[z.Labelmap],{volumeId:a,referencedVolumeId:n}=t;return{labelmapVolume:M.cache.getVolume(a),referencedVolume:M.cache.getVolume(n)}}function ae(e){const{representationData:t}=e,{volumeId:a}=t[z.Labelmap];return M.cache.getVolume(a)}const ne=({servicesManager:e,commandsManager:t,extensionManager:a})=>{const{viewportGridService:n,uiNotificationService:o,displaySetService:i,hangingProtocolService:r,toolGroupService:s,cornerstoneViewportService:c,segmentationService:l}=e.services,m=a.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{getEnabledElement:p}=m.exports;function d(){const{activeViewportId:e}=n.getState(),{element:t}=p(e)||{};return M.getEnabledElement(t)}function u(e){return e.reduce(((e,t)=>{const a=V.annotation.selection.getAnnotationsSelectedByToolName(t);return e.concat(a)}),[])}const g={getMatchingPTDisplaySet:({viewportMatchDetails:e})=>{let t=null;for(const[a,n]of e){const{displaySetsInfo:e}=n,a=e.map((({displaySetInstanceUID:e})=>i.getDisplaySetByUID(e)));if(a&&0!==a.length&&(t=a.find((e=>"PT"===e.Modality)),t))break}return t},getPTMetadata:({ptDisplaySet:e})=>{const t=a.getDataSources()[0].getImageIdsForDisplaySet(e)[0],n=X.get("instance",t);if("PT"!==n.Modality)return;return{SeriesTime:n.SeriesTime,Modality:n.Modality,PatientSex:n.PatientSex,PatientWeight:n.PatientWeight,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:n.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadionuclideHalfLife:n.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadiopharmaceuticalStartTime:n.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,RadiopharmaceuticalStartDateTime:n.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime}}},createNewLabelmapFromPT:async({label:e})=>{const{viewportMatchDetails:t}=r.getMatchDetails(),a=g.getMatchingPTDisplaySet({viewportMatchDetails:t});let n=null;for(const[e,{displaySetsInfo:o}]of t.entries()){if(o.some((({displaySetInstanceUID:e})=>e===a.displaySetInstanceUID))){n=e;break}}if(!a)return void o.error("No matching PT display set found");const s=l.getSegmentationRepresentations(n),c=i.getDisplaySetByUID(a.displaySetInstanceUID),m=await l.createLabelmapForDisplaySet(c,{label:`Segmentation ${s.length+1}`,segments:{1:{label:"Segment 1",active:!0}}});return l.addSegmentationRepresentation(n,{segmentationId:m}),m},thresholdSegmentationByRectangleROITool:({segmentationId:e,config:t,segmentIndex:a})=>{const i=V.segmentation.state.getSegmentation(e),{representationData:s}=i,{displaySetMatchDetails:c}=r.getMatchDetails(),l=`cornerstoneStreamingImageVolume:${c.get("ctDisplaySet").displaySetInstanceUID}`,{volumeId:m}=s[z.Labelmap],{referencedVolumeId:p}=M.cache.getVolume(m),d=u(Y);if(0===d.length)return void o.show({title:"Commands Module",message:"No ROIThreshold Tool is Selected",type:"error"});const g=M.cache.getVolume(e);let y=M.cache.getVolume(p);const h=M.cache.getVolume(l);if(!y)throw new Error("No Reference volume found");if(!g)throw new Error("No Reference labelmap found");const S=V.annotation.state.getAnnotation(d[0]),{metadata:{enabledElement:{viewport:v}}}=S;if(!v.hasVolumeId(p)){n.getDisplaySetsUIDsForViewport(v.id).forEach((e=>{const t=M.cache.getVolumes().find((t=>t.volumeId.includes(e)));M.utilities.isEqual(t.dimensions,g.dimensions)&&M.utilities.isEqual(t.spacing,g.spacing)&&(y=t)}))}const{ptLower:f,ptUpper:I,ctLower:T,ctUpper:w}=_(d,[y,h],t);return V.utilities.segmentation.rectangleROIThresholdVolumeByRange(d,g,[{volume:y,lower:f,upper:I},{volume:h,lower:T,upper:w}],{overwrite:!0,segmentIndex:a})},calculateSuvPeak:async({segmentationId:e,segmentIndex:t})=>{const a=l.getSegmentation(e),{representationData:n}=a,{volumeId:o,referencedVolumeId:i}=n[z.Labelmap],r=M.cache.getVolume(o),s=M.cache.getVolume(i);Z.registerWorker("suv-peak-worker",ee,Q);const c=u(Y).map((e=>V.annotation.state.getAnnotation(e))),m={dimensions:r.dimensions,origin:r.origin,direction:r.direction,spacing:r.spacing,metadata:r.metadata,scalarData:r.voxelManager.getCompleteScalarDataArray()},p={dimensions:s.dimensions,origin:s.origin,direction:s.direction,spacing:s.spacing,metadata:s.metadata,scalarData:s.voxelManager.getCompleteScalarDataArray()},d=c.map((e=>({...e,metadata:{...e.metadata,enabledElement:{...e.metadata.enabledElement,viewport:null,renderingEngine:null,element:null}}}))),g=await Z.executeTask("suv-peak-worker","calculateSuvPeak",{labelmapProps:m,referenceVolumeProps:p,annotations:d,segmentIndex:t})||{};return{suvPeak:g.mean,suvMax:g.max,suvMaxIJK:g.maxIJK,suvMaxLPS:g.maxLPS}},getLesionStats:({segmentationId:e,segmentIndex:t=1})=>{const{labelmapVolume:a,referencedVolume:n}=te(e),{voxelManager:o,imageData:i,spacing:r}=a,{voxelManager:s}=n;let c=-1/0,l=1/0;const m=[];let p=0;o.forEach((({value:e,index:a})=>{if(e===t){const e=s.getAtIndex(a);m.push(e),e>c&&(c=e),e<l&&(l=e),p++}}),{imageData:i});const d=m.reduce(((e,t)=>e+t),0)/p;return{minValue:l,maxValue:c,meanValue:d,stdValue:Math.sqrt(m.map((e=>(e-d)**2)).reduce(((e,t)=>e+t),0)/p),volume:p*r[0]*r[1]*r[2]*.001}},calculateLesionGlycolysis:({lesionStats:e})=>{const{meanValue:t,volume:a}=e;return{lesionGlyoclysisStats:a*t}},calculateTMTV:async({segmentations:e})=>{const t=e.map((e=>{const t=ae(e);return{dimensions:t.dimensions,spacing:t.spacing,scalarData:t.voxelManager.getCompleteScalarDataArray(),origin:t.origin,direction:t.direction}}));if(t.length)return await Z.executeTask("suv-peak-worker","calculateTMTV",t)},exportTMTVReportCSV:async({segmentations:e,tmtv:a,config:n,options:o})=>{const i=t.runCommand("getSegmentationCSVReport",{segmentations:e}),r=[{key:"Total Lesion Glycolysis",value:{tlg:(await g.getTotalLesionGlycolysis({segmentations:e})).toFixed(4)}},{key:"Threshold Configuration",value:{...n}}];void 0!==a&&r.unshift({key:"Total Metabolic Tumor Volume",value:{tmtv:a}}),function(e,t,a={}){const n=e[Object.keys(e)[0]],o=Object.keys(n),i=[o.join(",")];Object.values(e).forEach((e=>{const t=[];o.forEach((a=>{t.push(Array.isArray(e[a])?e[a].join(" "):e[a])})),i.push(t.join(","))})),i.push(""),i.push(""),i.push(""),i.push(`Patient ID,${n.PatientID}`),i.push(`Study Date,${n.StudyDate}`),i.push(""),t.forEach((({key:e,value:t})=>{const a=[];a.push(`${e}`),Object.keys(t).forEach((e=>{a.push(`${e}`),a.push(`${t[e]}`)})),i.push(a.join(","))}));const r=new Blob([i.join("\n")],{type:"text/csv;charset=utf-8"}),s=URL.createObjectURL(r),c=document.createElement("a");c.href=s,c.download=a.filename??`${n.PatientID}_tmtv.csv`,c.click()}(i,r,o)},getTotalLesionGlycolysis:async({segmentations:e})=>{const t=e.map((e=>{const t=ae(e);return{dimensions:t.dimensions,spacing:t.spacing,scalarData:t.voxelManager.getCompleteScalarDataArray(),origin:t.origin,direction:t.direction}})),{referencedVolume:a}=te(e[0].segmentationId),n={dimensions:a.dimensions,spacing:a.spacing,scalarData:a.voxelManager.getCompleteScalarDataArray(),origin:a.origin,direction:a.direction};return await Z.executeTask("suv-peak-worker","getTotalLesionGlycolysis",{labelmapProps:t,referenceVolumeProps:n})},setStartSliceForROIThresholdTool:()=>{const{viewport:e}=d(),{focalPoint:t}=e.getCamera(),a=u(Y)[0],n=V.annotation.state.getAnnotation(a);n.data.startCoordinate=t,n.invalidated=!0,e.render()},setEndSliceForROIThresholdTool:()=>{const{viewport:e}=d(),t=u(Y)[0],a=V.annotation.state.getAnnotation(t),n=e.getCamera().focalPoint;a.data.endCoordinate=n,a.invalidated=!0,e.render()},createTMTVRTReport:()=>{const e=V.annotation.state.getAnnotationManager(),a=[];Object.keys(e.annotations).forEach((t=>{const n=e.annotations[t],o=Y.reduce(((e,t)=>[...e,...n[t]??[]]),[]);a.push(...o)})),t.runCommand("exportRTReportForAnnotations",{annotations:a})},getSegmentationCSVReport:({segmentations:e})=>{e&&e.length||(e=l.getSegmentations());const t={};for(const a of e){const{label:e,segmentationId:n,representationData:o}=a,i=n,r={id:i,label:e};if(!o){t[i]=r;continue}const{cachedStats:s}=a.segments[1]||{};s&&Object.entries(s).forEach((([e,t])=>{"object"!=typeof t?r[e]=t:Object.entries(t).forEach((([t,a])=>{r[`${e}_${t}`]=a}))}));const c=a.representationData[z.Labelmap];if(!c){t[i]=r;continue}const l=c.referencedVolumeId,m=M.cache.getVolume(l);if(!m){t[i]=r;continue}if(!m.imageIds||!m.imageIds.length){t[i]=r;continue}const p=m.imageIds[0],d=w.Ay.classes.MetadataProvider.get("instance",p);d?t[i]={...r,PatientID:d.PatientID??"000000",PatientName:d.PatientName.Alphabetic,StudyInstanceUID:d.StudyInstanceUID,SeriesInstanceUID:d.SeriesInstanceUID,StudyDate:d.StudyDate}:t[i]=r}return t},exportRTReportForAnnotations:({annotations:e})=>{K(e)},setFusionPTColormap:({toolGroupId:e,colormap:a})=>{const n=s.getToolGroup(e);if(!n)return;const{viewportMatchDetails:o}=r.getMatchDetails(),i=g.getMatchingPTDisplaySet({viewportMatchDetails:o});if(!i)return;const l=n.getViewportIds(),m=[];l.forEach((e=>{t.runCommand("setViewportColormap",{viewportId:e,displaySetInstanceUID:i.displaySetInstanceUID,colormap:{name:a}}),m.push(c.getCornerstoneViewport(e))})),m.forEach((e=>{e.render()}))}},y={setEndSliceForROIThresholdTool:{commandFn:g.setEndSliceForROIThresholdTool},setStartSliceForROIThresholdTool:{commandFn:g.setStartSliceForROIThresholdTool},getMatchingPTDisplaySet:{commandFn:g.getMatchingPTDisplaySet},getPTMetadata:{commandFn:g.getPTMetadata},createNewLabelmapFromPT:{commandFn:g.createNewLabelmapFromPT},thresholdSegmentationByRectangleROITool:{commandFn:g.thresholdSegmentationByRectangleROITool},getTotalLesionGlycolysis:{commandFn:g.getTotalLesionGlycolysis},calculateSuvPeak:{commandFn:g.calculateSuvPeak},getLesionStats:{commandFn:g.getLesionStats},calculateTMTV:{commandFn:g.calculateTMTV},exportTMTVReportCSV:{commandFn:g.exportTMTVReportCSV},createTMTVRTReport:{commandFn:g.createTMTVRTReport},getSegmentationCSVReport:{commandFn:g.getSegmentationCSVReport},exportRTReportForAnnotations:{commandFn:g.exportRTReportForAnnotations},setFusionPTColormap:{commandFn:g.setFusionPTColormap}};return{actions:g,definitions:y,defaultContext:"TMTV:CORNERSTONE"}},oe="roi_stat",ie=[{value:oe,label:"Max",placeHolder:"Max"},{value:"range",label:"Range",placeHolder:"Range"}];const re=function({config:e,dispatch:t,runCommand:a}){const{t:n}=(0,x.Bd)("ROIThresholdConfiguration");return v.createElement("div",{className:"bg-primary-dark flex flex-col space-y-4"},v.createElement("div",{className:"flex items-end space-x-2"},v.createElement("div",{className:"flex w-1/2 flex-col"},v.createElement(T.l6,{label:n("Strategy"),closeMenuOnSelect:!0,className:"border-primary-main mr-2 bg-black text-white ",options:ie,placeholder:ie.find((t=>t.value===e.strategy)).placeHolder,value:e.strategy,onChange:({value:e})=>{t({type:"setStrategy",payload:{strategy:e}})}})),v.createElement("div",{className:"w-1/2"},v.createElement(T.xA,null,v.createElement(T._H,{size:"initial",className:"px-2 py-2 text-base text-white",color:"primaryLight",variant:"outlined",onClick:()=>a("setStartSliceForROIThresholdTool")},n("Start")),v.createElement(T._H,{size:"initial",color:"primaryLight",variant:"outlined",className:"px-2 py-2 text-base text-white",onClick:()=>a("setEndSliceForROIThresholdTool")},n("End"))))),e.strategy===oe&&v.createElement(T.pd,{label:n("Percentage of Max SUV"),labelClassName:"text-[13px] font-inter text-white",className:"border-primary-main bg-black",type:"text",containerClassName:"mr-2",value:e.weight,onChange:e=>{t({type:"setWeight",payload:{weight:e.target.value}})}}),e.strategy!==oe&&v.createElement("div",{className:"mr-2 text-sm"},v.createElement("table",null,v.createElement("tbody",null,v.createElement("tr",{className:"mt-2"},v.createElement("td",{className:"pr-4",colSpan:"3"},v.createElement(T.JU,{className:"font-inter text-[13px] text-white",text:"Lower & Upper Ranges"}))),v.createElement("tr",{className:"mt-2"},v.createElement("td",{className:"pr-4 pt-2 text-center"},v.createElement(T.JU,{className:"text-white",text:"CT"})),v.createElement("td",null,v.createElement("div",{className:"flex justify-between"},v.createElement(T.pd,{label:n(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ctLower,onChange:e=>{t({type:"setThreshold",payload:{ctLower:e.target.value}})}}),v.createElement(T.pd,{label:n(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ctUpper,onChange:e=>{t({type:"setThreshold",payload:{ctUpper:e.target.value}})}})))),v.createElement("tr",null,v.createElement("td",{className:"pr-4 pt-2 text-center"},v.createElement(T.JU,{className:"text-white",text:"PT"})),v.createElement("td",null,v.createElement("div",{className:"flex justify-between"},v.createElement(T.pd,{label:n(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ptLower,onChange:e=>{t({type:"setThreshold",payload:{ptLower:e.target.value}})}}),v.createElement(T.pd,{label:n(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ptUpper,onChange:e=>{t({type:"setThreshold",payload:{ptUpper:e.target.value}})}}))))))))},se=oe;function ce(e,t){const{payload:a}=t,{strategy:n,ctLower:o,ctUpper:i,ptLower:r,ptUpper:s,weight:c}=a;switch(t.type){case"setStrategy":return{...e,strategy:n};case"setThreshold":return{...e,ctLower:o||e.ctLower,ctUpper:i||e.ctUpper,ptLower:r||e.ptLower,ptUpper:s||e.ptUpper};case"setWeight":return{...e,weight:c};default:return e}}const le=function({servicesManager:e,commandsManager:t}){const{segmentationService:a}=e.services,[n,o]=(0,v.useState)(null),i=(0,v.useCallback)(((e,a={})=>t.runCommand(e,a)),[t]),[r,s]=(0,v.useReducer)(ce,{strategy:se,ctLower:-1024,ctUpper:1024,ptLower:2.5,ptUpper:100,weight:.41}),c=(0,v.useCallback)((()=>{const e=n,t=V.segmentation.segmentIndex.getActiveSegmentIndex(e);i("thresholdSegmentationByRectangleROITool",{segmentationId:e,config:r,segmentIndex:t})}),[n,r]);return(0,v.useEffect)((()=>{const e=a.getSegmentationRepresentations();if(!e.length)return;const t=e.find((e=>e.isActive));o(t.id)}),[]),(0,v.useEffect)((()=>{const e=a.EVENTS.SEGMENTATION_MODIFIED,t=[];return[e].forEach((e=>{const{unsubscribe:n}=a.subscribe(e,(()=>{const e=a.getSegmentationRepresentations();if(!e.length)return;const t=e.find((e=>e.isActive));o(t.id)}));t.push(n)})),()=>{t.forEach((e=>{e()}))}}),[]),v.createElement("div",{className:"invisible-scrollbar mb-2 flex flex-col overflow-y-auto overflow-x-hidden"},v.createElement(re,{config:r,dispatch:s,runCommand:i}),null!==n&&v.createElement(T.$n,{className:"mt-2 !h-[26px] !w-[75px]",onClick:c},"Run"))};const me={id:n,preRegistration({servicesManager:e,commandsManager:t,extensionManager:a,configuration:n={}}){!function({servicesManager:e}){const{measurementService:t,displaySetService:a,cornerstoneViewportService:n}=e.services;(0,V.addTool)(V.RectangleROIStartEndThresholdTool),(0,V.addTool)(V.CircleROIStartEndThresholdTool);const{RectangleROIStartEndThreshold:o,CircleROIStartEndThreshold:i}=G(t,a,n),r=t.getSource(W,q);t.addMapping(r,"RectangleROIStartEndThreshold",o.matchingCriteria,o.toAnnotation,o.toMeasurement),t.addMapping(r,"CircleROIStartEndThreshold",i.matchingCriteria,i.toAnnotation,i.toMeasurement)}({servicesManager:e,commandsManager:t,extensionManager:a,configuration:n})},getToolbarModule:function({commandsManager:e,servicesManager:t}){return[{name:"tmtv.RectangleROIThresholdOptions",defaultComponent:()=>le({commandsManager:e,servicesManager:t})}]},getPanelModule:U,getHangingProtocolModule:S,getCommandsModule:({servicesManager:e,commandsManager:t,extensionManager:a})=>ne({servicesManager:e,commandsManager:t,extensionManager:a})},pe=me}}]);
//# sourceMappingURL=3198.bundle.9ee5185781602c06bdb7.js.map