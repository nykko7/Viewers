/*! For license information please see 3970.bundle.ca01d74989f7a90be709.js.LICENSE.txt */
(self.webpackChunk=self.webpackChunk||[]).push([[3970],{33970:(e,t,n)=>{"use strict";n.d(t,{fX:()=>u,X6:()=>br,f_:()=>xr,ql:()=>Cr,QX:()=>Or,_$:()=>s});var r={};n.r(r),n.d(r,{fillSegmentation:()=>Rt,generateSegmentation:()=>Tt,generateToolState:()=>Dt});var a={};n.r(a),n.d(a,{generateLabelMaps2DFrom3D:()=>er,generateSegmentation:()=>Zn,generateToolState:()=>tr});var i={};n.r(i),n.d(i,{generateToolState:()=>rr});var o={};n.r(o),n.d(o,{generateContourSetsFromLabelmap:()=>mr,generateRTSSFromAnnotations:()=>pr,generateRTSSFromSegmentations:()=>fr});var u={};n.r(u),n.d(u,{s:()=>ze});var s={};function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function l(e,t,n,r,a,i,o){try{var u=e[i](o),s=u.value}catch(e){return void n(e)}u.done?t(s):Promise.resolve(s).then(r,a)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var i=e.apply(t,n);function o(e){l(i,r,a,o,u,"next",e)}function u(e){l(i,r,a,o,u,"throw",e)}o(void 0)}))}}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,D(r.key),r)}}function g(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function m(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=R(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(u)throw i}}}}function h(e,t,n){return(t=D(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){h(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function y(){y=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",u=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function l(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,o=Object.create(i.prototype),u=new E(r||[]);return a(o,"_invoke",{value:x(e,n,u)}),o}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var f="suspendedStart",p="suspendedYield",g="executing",m="completed",h={};function v(){}function S(){}function I(){}var T={};c(T,o,(function(){return this}));var D=Object.getPrototypeOf,R=D&&D(D(A([])));R&&R!==n&&r.call(R,o)&&(T=R);var O=I.prototype=v.prototype=Object.create(T);function C(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,i,o,u){var s=d(e[a],e,i);if("throw"!==s.type){var c=s.arg,l=c.value;return l&&"object"==typeof l&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,o,u)}),(function(e){n("throw",e,o,u)})):t.resolve(l).then((function(e){c.value=e,o(c)}),(function(e){return n("throw",e,o,u)}))}u(s.arg)}var i;a(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return i=i?i.then(a,a):a()}})}function x(t,n,r){var a=f;return function(i,o){if(a===g)throw Error("Generator is already running");if(a===m){if("throw"===i)throw o;return{value:e,done:!0}}for(r.method=i,r.arg=o;;){var u=r.delegate;if(u){var s=w(u,r);if(s){if(s===h)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===f)throw a=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=g;var c=d(t,n,r);if("normal"===c.type){if(a=r.done?m:p,c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(a=m,r.method="throw",r.arg=c.arg)}}}function w(t,n){var r=n.method,a=t.iterator[r];if(a===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,w(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h;var i=d(a,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,h;var o=i.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,h):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,h)}function M(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(M,this),this.reset(!0)}function A(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,i=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(typeof t+" is not iterable")}return S.prototype=I,a(O,"constructor",{value:I,configurable:!0}),a(I,"constructor",{value:S,configurable:!0}),S.displayName=c(I,s,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===S||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,I):(e.__proto__=I,c(e,s,"GeneratorFunction")),e.prototype=Object.create(O),e},t.awrap=function(e){return{__await:e}},C(b.prototype),c(b.prototype,u,(function(){return this})),t.AsyncIterator=b,t.async=function(e,n,r,a,i){void 0===i&&(i=Promise);var o=new b(l(e,n,r,a),i);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},C(O),c(O,s,"Generator"),c(O,o,(function(){return this})),c(O,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=A,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return u.type="throw",u.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],u=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,h):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;P(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:A(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),h}},t}function I(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,i,o,u=[],s=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;s=!1}else for(;!(s=(r=i.call(n)).done)&&(u.push(r.value),u.length!==t);s=!0);}catch(e){c=!0,a=e}finally{try{if(!s&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw a}}return u}}(e,t)||R(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||R(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function D(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function R(e,t){if(e){if("string"==typeof e)return c(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}n.r(s),n.d(s,{vk:()=>M});var O=n(5842),C=function(e){return Array.isArray(e)?e:[e]},b=function(e){return function(t){return t.ConceptNameCodeSequence.CodeMeaning===e}},x=n(81429),w=O.p.datasetToDict;function M(e,t){var n;if(e instanceof ArrayBuffer)n=new Blob([e],{type:"application/dicom"});else{if(!e._meta)throw new Error("Dataset must have a _meta property");var r=x.hp.from(w(e).write());n=new Blob([r],{type:"application/dicom"})}var a=document.createElement("a");a.href=window.URL.createObjectURL(n),a.download=t,a.click()}var P=O.BF.TID1500,E=O.BF.addAccessors,A=O.h4.StructuredReport,N=O.z8.Normalizer,q=P.TID1500MeasurementReport,k=P.TID1501MeasurementGroup,U=O.p.DicomMetaDictionary,F={CodingSchemeDesignator:"DCM",CodeValue:"121071"},_={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},V={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},B=function(e,t,n){var r=e.ConceptNameCodeSequence;if(r){var a=r.CodingSchemeDesignator,i=r.CodeValue;return a==t.CodingSchemeDesignator&&i==t.CodeValue||n&&a==n.CodingSchemeDesignator&&i==n.CodeValue}};function G(e,t,n){var r=t[e],a=L.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(r&&r.data&&r.data.length&&a){var i=r.data.map((function(e){return function(e,t,n,r){var a=r.getTID300RepresentationArguments(e);return a.ReferencedSOPSequence=n,new r.TID300Representation(a)}(e,0,n,a)}));return new k(i)}}var L=function(){function e(){f(this,e)}return g(e,null,[{key:"getSetupMeasurementData",value:function(e){var t=e.ContentSequence,n=C(t),r=n.find((function(e){return B(e,F)})),a=n.filter((function(e){return B(e,_,V)}))||[],i=n.find((function(e){return"NUM"===e.ValueType})),o=C(i.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),u=o.ContentSequence.ReferencedSOPSequence,s=u.ReferencedSOPInstanceUID,c=u.ReferencedFrameNumber,l={sopInstanceUid:s,frameIndex:c||1,complete:!0,finding:r?E(r.ConceptCodeSequence):void 0,findingSites:a.map((function(e){return E(e.ConceptCodeSequence)}))};l.finding&&(l.description=l.finding.CodeMeaning);var d=l.findingSites&&l.findingSites[0];return d&&(l.location=d[0]&&d[0].CodeMeaning||d.CodeMeaning),{defaultState:l,findingGroup:r,findingSiteGroups:a,NUMGroup:i,SCOORDGroup:o,ReferencedSOPSequence:u,ReferencedSOPInstanceUID:s,ReferencedFrameNumber:c}}},{key:"generateReport",value:function(e,t,n){var r=[],a=Object.keys(e)[0];if(!a)throw new Error("No measurements provided.");var i=t.get("generalSeriesModule",a),o=i.studyInstanceUID,u=i.seriesInstanceUID;Object.keys(e).forEach((function(n){var a=t.get("sopCommonModule",n),i=t.get("frameNumber",n),o=e[n],u=Object.keys(o),s={ReferencedSOPClassUID:a.sopClassUID,ReferencedSOPInstanceUID:a.sopInstanceUID};N.isMultiframeSOPClassUID(a.sopClassUID)&&(s.ReferencedFrameNumber=i);var c=[];u.forEach((function(e){var t=G(e,o,s);t&&c.push(t)})),r=r.concat(c)}));var s=new q({TID1501MeasurementGroups:r},n),c=new Uint8Array(2);c[1]=1;var l={StudyInstanceUID:o,SeriesInstanceUID:u},d={FileMetaInformationVersion:{Value:[c.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[U.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};l._meta=d,l._vrMap={PixelData:"OW"};var f=new A([l]),p=s.contentItem(l);return f.dataset=Object.assign(f.dataset,p),f.dataset._meta=d,f.dataset.SpecificCharacterSet="ISO_IR 192",f}},{key:"generateToolState",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("1500"!==t.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var r=C(t.ContentSequence).find(b("Imaging Measurements")),a=C(r.ContentSequence).filter(b("Measurement Group")),i={},o=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,u=[];return Object.keys(o).forEach((function(e){u.push(o[e]),i[e]=[]})),a.forEach((function(e){var r=C(e.ContentSequence).find((function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning})).TextValue,a=n.getToolClass?n.getToolClass(e,t,u):u.find((function(e){return e.isValidCornerstoneTrackingIdentifier(r)}));if(a){var o=a.getMeasurementData(e);console.log("=== ".concat(a.toolType," ===")),console.log(o),i[a.toolType].push(o)}})),i}},{key:"registerTool",value:function(t){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[t.utilityToolType]=t,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[t.toolType]=t,e.MEASUREMENT_BY_TOOLTYPE[t.toolType]=t.utilityToolType}}])}();L.MEASUREMENT_BY_TOOLTYPE={},L.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},L.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={};var j="cornerstoneTools@^4.0.0",Y=O.BF.TID300.Length,z="Length",H=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.NUMGroup,i=n.SCOORDGroup,o=S(S({},r),{},{length:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=I(i.GraphicData,4);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.handles,n=e.finding,r=e.findingSites;return{point1:t.start,point2:t.end,distance:e.length,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Length",finding:n,findingSites:r||[]}}}])}();H.toolType=z,H.utilityToolType=z,H.TID300Representation=Y,H.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===z},L.registerTool(H);var X=O.BF.TID300.Polyline,W=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){for(var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.SCOORDGroup,i=n.NUMGroup,o=S(S({},r),{},{toolType:e.toolType,handles:{points:[],textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=a.GraphicData,s=0;s<u.length;s+=2)o.handles.points.push({x:u[s],y:u[s+1]});return o}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.handles,n=e.finding,r=e.findingSites,a=e.cachedStats,i=void 0===a?{}:a,o=t.points,u=i.area,s=void 0===u?0:u,c=i.perimeter;return{points:o,area:s,perimeter:void 0===c?0:c,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:FreehandRoi",finding:n,findingSites:r||[]}}}])}();W.toolType="FreehandRoi",W.utilityToolType="FreehandRoi",W.TID300Representation=X,W.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===W.toolType},L.registerTool(W);var Q=O.BF.TID300.Bidirectional,$="Bidirectional",J=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=t.ContentSequence,r=C(n).find((function(e){return"121071"===e.ConceptNameCodeSequence.CodeValue})),a=C(n).filter((function(e){return"G-C0E3"===e.ConceptNameCodeSequence.CodeValue})),i=C(n).find((function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning})),o=C(i.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),u=C(n).find((function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning})),s=C(u.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),c=o.ContentSequence.ReferencedSOPSequence,l=c.ReferencedSOPInstanceUID,d=c.ReferencedFrameNumber,f=String(i.MeasuredValueSequence.NumericValue),p=String(u.MeasuredValueSequence.NumericValue),g=Math.max(o.GraphicData[0],o.GraphicData[2],s.GraphicData[0],s.GraphicData[2]),m=Math.max(o.GraphicData[1],o.GraphicData[3],s.GraphicData[1],s.GraphicData[3]);return{sopInstanceUid:l,frameIndex:d||1,toolType:e.toolType,active:!1,handles:{start:{x:o.GraphicData[0],y:o.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:0},end:{x:o.GraphicData[2],y:o.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:1},perpendicularStart:{x:s.GraphicData[0],y:s.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:2},perpendicularEnd:{x:s.GraphicData[2],y:s.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:3},textBox:{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0,x:g+10,y:m+10}},invalidated:!1,isCreating:!1,longestDiameter:f,shortestDiameter:p,toolName:"Bidirectional",visible:!0,finding:r?r.ConceptCodeSequence:void 0,findingSites:a.map((function(e){return e.ConceptCodeSequence}))}}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.handles,n=t.start,r=t.end,a=t.perpendicularStart,i=t.perpendicularEnd,o=e.shortestDiameter;return{longAxis:{point1:n,point2:r},shortAxis:{point1:a,point2:i},longAxisLength:e.longestDiameter,shortAxisLength:o,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Bidirectional",finding:e.finding,findingSites:e.findingSites||[]}}}])}();J.toolType=$,J.utilityToolType=$,J.TID300Representation=Q,J.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===$},L.registerTool(J);var K=O.BF.TID300.Ellipse,Z="EllipticalRoi",ee=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.NUMGroup,i=n.SCOORDGroup.GraphicData,o=[{x:i[0],y:i[1]},{x:i[2],y:i[3]}],u=[{x:i[4],y:i[5]},{x:i[6],y:i[7]}],s=Math.sqrt(Math.pow(u[0].x-u[1].x,2)+Math.pow(u[0].y-u[1].y,2)),c=(u[1].x-u[0].x)/s,l=(u[1].y-u[0].y)/s,d=s/2,f={x:o[0].x+c*d,y:o[0].y+l*d},p={x:o[1].x-c*d,y:o[1].y-l*d};return S(S({},r),{},{toolType:e.toolType,active:!1,cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},handles:{end:{x:f.x,y:f.y,highlight:!1,active:!1},initialRotation:0,start:{x:p.x,y:p.y,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.cachedStats,n=void 0===t?{}:t,r=e.handles,a=e.finding,i=e.findingSites,o=r.start,u=r.end,s=n.area,c=Math.abs(o.x-u.x)/2,l=Math.abs(o.y-u.y)/2,d=[],f={x:(o.x+u.x)/2,y:(o.y+u.y)/2};c>l?(d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}),d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l})):(d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l}),d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}));return{area:s,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:EllipticalRoi",finding:a,findingSites:i||[]}}}])}();ee.toolType=Z,ee.utilityToolType=Z,ee.TID300Representation=K,ee.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===Z},L.registerTool(ee);var te=O.BF.TID300.Circle,ne="CircleRoi",re=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.NUMGroup,i=n.SCOORDGroup.GraphicData,o={x:i[0],y:i[1]},u={x:i[2],y:i[3]};return S(S({},r),{},{toolType:e.toolType,active:!1,cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},handles:{end:S(S({},u),{},{highlight:!1,active:!1}),initialRotation:0,start:S(S({},o),{},{highlight:!1,active:!1}),textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.cachedStats,n=void 0===t?{}:t,r=e.handles,a=e.finding,i=e.findingSites,o=r.start,u=r.end,s=n.area,c=n.radius,l=2*Math.PI*c,d=[];d.push(o),d.push(u);return{area:s,perimeter:l,radius:c,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CircleRoi",finding:a,findingSites:i||[]}}}])}();re.toolType=ne,re.utilityToolType=ne,re.TID300Representation=te,re.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===ne},L.registerTool(re);var ae=O.BF.TID300.Point,ie="ArrowAnnotate",oe="CORNERSTONEFREETEXT",ue=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.SCOORDGroup,i=n.findingGroup.ConceptCodeSequence.CodeMeaning,o=a.GraphicData;return S(S({},r),{},{toolType:e.toolType,active:!1,handles:{start:{x:o[0],y:o[1],highlight:!0,active:!1},end:{x:4==o.length?o[2]:o[0]+20,y:4==o.length?o[3]:o[1]+20,highlight:!0,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,text:i,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var t=[e.handles.start,e.handles.end],n=e.finding,r={points:t,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:ArrowAnnotate",findingSites:e.findingSites||[]};return n&&n.CodeValue===oe||(n={CodeValue:oe,CodingSchemeDesignator:"CST4",CodeMeaning:e.text}),r.finding=n,r}}])}();ue.toolType=ie,ue.utilityToolType=ie,ue.TID300Representation=ae,ue.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===ie},L.registerTool(ue);var se=O.BF.TID300.CobbAngle,ce="CobbAngle",le=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.NUMGroup,i=n.SCOORDGroup,o=S(S({},r),{},{rAngle:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},start2:{highlight:!0,drawnIndependently:!0},end2:{highlight:!0,drawnIndependently:!0},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=I(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o.handles.start2.x=u[4],o.handles.start2.y=u[5],o.handles.end2.x=u[6],o.handles.end2.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.handles,n=e.finding,r=e.findingSites;return{point1:t.start,point2:t.end,point3:t.start2,point4:t.end2,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CobbAngle",finding:n,findingSites:r||[]}}}])}();le.toolType=ce,le.utilityToolType=ce,le.TID300Representation=se,le.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===ce},L.registerTool(le);var de=O.BF.TID300.Angle,fe="Angle",pe=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.NUMGroup,i=n.SCOORDGroup,o=S(S({},r),{},{rAngle:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},middle:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=I(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.middle.x=u[2],o.handles.middle.y=u[3],o.handles.middle.x=u[4],o.handles.middle.y=u[5],o.handles.end.x=u[6],o.handles.end.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.handles,n=e.finding,r=e.findingSites;return{point1:t.start,point2:t.middle,point3:t.middle,point4:t.end,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Angle",finding:n,findingSites:r||[]}}}])}();pe.toolType=fe,pe.utilityToolType=fe,pe.TID300Representation=de,pe.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===fe},L.registerTool(pe);var ge=O.BF.TID300.Polyline,me=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t){var n=L.getSetupMeasurementData(t),r=n.defaultState,a=n.SCOORDGroup,i=n.NUMGroup,o=S(S({},r),{},{toolType:e.toolType,handles:{start:{},end:{},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},initialRotation:0},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=I(a.GraphicData,6);return o.handles.start.x=u[0],o.handles.start.y=u[1],u[2],u[3],o.handles.end.x=u[4],o.handles.end.y=u[5],o}},{key:"getTID300RepresentationArguments",value:function(e){var t=e.finding,n=e.findingSites,r=e.cachedStats,a=void 0===r?{}:r,i=e.handles,o=i.start,u=i.end;return{points:[o,{x:o.x,y:u.y},u,{x:u.x,y:o.y}],area:a.area,perimeter:a.perimeter,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:RectangleRoi",finding:t,findingSites:n||[]}}}])}();me.toolType="RectangleRoi",me.utilityToolType="RectangleRoi",me.TID300Representation=ge,me.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===j&&r===me.toolType},L.registerTool(me);var he=n(3293),ve=n.n(he),Se=O.p.DicomMessage,ye=O.p.DicomMetaDictionary,Ie=O.z8.Normalizer;function Te(e,t,n){var r=[];if(t){var a=e[0].data.byteArray.buffer,i=Se.readFile(a),o=ye.naturalizeDataset(i.dict);o._meta=ye.namifyDataset(i.meta),r.push(o)}else for(var u=0;u<e.length;u++){var s=e[u].data.byteArray.buffer,c=Se.readFile(s),l=ye.naturalizeDataset(c.dict);l._meta=ye.namifyDataset(c.meta),r.push(l)}return null!=n&&n.SpecificCharacterSet&&r.forEach((function(e){return e.SpecificCharacterSet=n.SpecificCharacterSet})),Ie.normalizeToDataset(r)}var De=O.BF.orientation,Re=De.rotateDirectionCosinesInPlane,Oe=De.flipImageOrientationPatient,Ce=De.flipMatrix2D,be=De.rotateMatrix902D,xe=O.BF.datasetToBlob,we=O.BF.BitArray,Me=O.BF.DicomMessage,Pe=O.BF.DicomMetaDictionary,Ee=O.z8.Normalizer,Ae=O.h4.Segmentation,Ne={generateSegmentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=t.toolState,a=t.segments,i=e[0],o={x:i.columns,y:i.rows,z:e.length};if(o.xy=o.x*o.y,!ke(s,a))throw new Error("No segments to export!");for(var u=i.imageId.includes("?frame"),s=function(e,t,n){var r=Te(e,t);return new Ae([r],n)}(e,u,n),c=function(e,t,n){for(var r=[],a=[],i=0;i<n.length;i++)n[i]&&(r.push(i),a.push([]));for(var o=0;o<t.length;o++)for(var u=e[t[o].imageId],s=0;s<r.length;s++){var c=r[s];u&&u.brush&&u.brush.data&&u.brush.data[c]&&u.brush.data[c].pixelData&&a[s].push(o)}return{referencedFramesPerSegment:a,segmentIndicies:r}}(r,e,a),l=c.referencedFramesPerSegment,d=c.segmentIndicies,f=0,p=0;p<l.length;p++)f+=l[p].length;s.setNumberOfFrames(f);for(var g=0;g<d.length;g++){var m=d[g],h=l[g],v=h.map((function(e){return e+1})),S=a[m];s.addSegment(S,qe(m,h,r,e,o),v)}return s.bitPackPixelData(),xe(s.dataset)},generateToolState:function(e,t,n){var r=Me.readFile(t),a=Pe.naturalizeDataset(r.dict);a._meta=Pe.namifyDataset(r.meta);var i=Ee.normalizeToDataset([a]),o=n.get("imagePlaneModule",e[0]);o||console.warn("Insufficient metadata, imagePlaneModule missing.");for(var u=function(e){var t=[];t[0]=e,t[1]=Oe.h(e),t[2]=Oe.v(e);var n=Re(e,Math.PI/2);return t[3]=n,t[4]=Oe.h(n),t[5]=Oe.v(n),t[6]=Re(e,Math.PI),t[7]=Re(e,1.5*Math.PI),t}(Array.isArray(o.rowCosines)?[].concat(T(o.rowCosines),T(o.columnCosines)):[o.rowCosines.x,o.rowCosines.y,o.rowCosines.z,o.columnCosines.x,o.columnCosines.y,o.columnCosines.z]),s=i.SharedFunctionalGroupsSequence,c=s.PlaneOrientationSequence?s.PlaneOrientationSequence.ImageOrientationPatient:void 0,l=i.Columns*i.Rows,d=function(e){var t=[],n=e.SegmentSequence;if(Array.isArray(n))for(var r=0;r<n.length;r++)t.push(n[r]);else t.push(n);return{seriesInstanceUid:e.ReferencedSeriesSequence.SeriesInstanceUID,data:t}}(i),f=function(e){var t=e.SegmentationType;if("BINARY"===t)return we.unpack(e.PixelData);var n=new Uint8Array(e.PixelData),r=e.MaximumFractionalValue,a=void 0===n.find((function(e){return 0!==e&&e!==r}));if(!a)return void O.Rm.warn("This is a fractional segmentation, which is not currently supported.");return O.Rm.warn("This segmentation object is actually binary... processing as such."),n}(i),p=i.PerFrameFunctionalGroupsSequence,g={},m=!0,h=0;h<p.length;h++){var v=p[h],S=c||v.PlaneOrientationSequence.ImageOrientationPatient,y=_e(ve()(new Uint8Array(f.buffer,h*l,l),[i.Rows,i.Columns]),S,u);if(!y){console.warn("This segmentation object is not in-plane with the source data. Bailing out of IO. It'd be better to render this with vtkjs. "),m=!1;break}var I=v.SegmentIdentificationSequence.ReferencedSegmentNumber-1;Ue(g,Fe(s.DerivationImageSequence&&s.DerivationImageSequence.SourceImageSequence?s.DerivationImageSequence.SourceImageSequence[h]:v.DerivationImageSequence.SourceImageSequence,e,n),I,y)}if(!m)return;return{toolState:g,segMetadata:d}}};function qe(e,t,n,r,a){for(var i=new Uint8Array(a.xy*t.length),o=0,u=0;u<t.length;u++)for(var s=n[r[t[u]].imageId].brush.data[e].pixelData,c=0;c<s.length;c++)i[o]=s[c],o++;return i}function ke(e,t){for(var n=0,r=0;r<t.length;r++)t[r]&&n++;return n}function Ue(e,t,n,r){e[t]?e[t].brush?e[t].brush.data||(e[t].brush.data=[]):(e[t].brush={},e[t].brush.data=[]):(e[t]={},e[t].brush={},e[t].brush.data=[]),e[t].brush.data[n]={};var a=e[t].brush.data[n];a.pixelData=new Uint8Array(r.data.length);for(var i=a.pixelData,o=0;o<i.length;o++)r.data[o]?i[o]=1:i[o]=0}function Fe(e,t,n){var r=e.ReferencedSOPInstanceUID,a=e.ReferencedFrameNumber;return a?function(e,t,n,r){var a=n.find((function(n){var a=r.get("sopCommonModule",n);if(a){var i=Number(n.split("frame=")[1]);return a.sopInstanceUID===e&&i===t-1}}));return a}(r,a,t,n):function(e,t,n){return t.find((function(t){var r=n.get("sopCommonModule",t);if(r)return r.sopInstanceUID===e}))}(r,t,n)}function _e(e,t,n){return Be(t,n[0])?e:Be(t,n[1])?Ce.v(e):Be(t,n[2])?Ce.h(e):Be(t,n[3])?be(e):Be(t,n[4])?Ce.h(be(e)):Be(t,n[5])?Ce.v(be(e)):Be(t,n[6])?be(be(e)):Be(t,n[7])?be(be(be(e))):void 0}var Ve=1e-5;function Be(e,t){return Math.abs(e[0]-t[0])<Ve&&Math.abs(e[1]-t[1])<Ve&&Math.abs(e[2]-t[2])<Ve&&Math.abs(e[3]-t[3])<Ve&&Math.abs(e[4]-t[4])<Ve&&Math.abs(e[5]-t[5])<Ve}var Ge,Le=O.BF.orientation.nearlyEqual;function je(e,t,n){if(e.length!==t.length)return!1;for(var r=0;r<e.length;++r)if(!Le(e[r],t[r],n))return!1;return!0}function Ye(e,t,n,r){var a=e.SharedFunctionalGroupsSequence,i=e.PerFrameFunctionalGroupsSequence,o=a.PlaneOrientationSequence?a.PlaneOrientationSequence.ImageOrientationPatient:void 0,u=i[0],s=o||u.PlaneOrientationSequence.ImageOrientationPatient;return t.some((function(e){return je(s,e,r)}))?"Planar":function(e,t,n){var r=Math.abs(e[0]*t[0]+e[1]*t[1]+e[2]*t[2]),a=Math.abs(e[3]*t[3]+e[4]*t[4]+e[5]*t[5]);return(r<n||Math.abs(r-1)<n)&&(a<n||Math.abs(a-1)<n)}(s,t[0],r)&&n.includes(e.Rows)&&n.includes(e.Columns)?"Perpendicular":"Oblique"}!function(e){e.SEGMENTATION_LOAD_PROGRESS="CORNERSTONE_ADAPTER_SEGMENTATION_LOAD_PROGRESS"}(Ge||(Ge={}));var ze=Ge,He=O.BF.orientation,Xe=He.rotateDirectionCosinesInPlane,We=He.flipImageOrientationPatient,Qe=He.flipMatrix2D,$e=He.rotateMatrix902D,Je=O.p.BitArray,Ke=O.p.DicomMessage,Ze=O.p.DicomMetaDictionary,et=O.z8.Normalizer,tt=O.h4.Segmentation,nt=O.BF.compression,rt=nt.encode,at=nt.decode,it={includeSliceSpacing:!0,rleEncode:!1};function ot(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=Object.assign({},it,n),a=Array.isArray(t)?t:[t],i=0,o=[],u=function(){for(var e=a[s],t=e.labelmaps2D,n=e.metadata,r=[],u=1;u<n.length;u++)n[u]&&(r[u]=[]);for(var c=function(e){var n=t[e];t[e]&&n.segmentsOnLabelmap.forEach((function(t){0!==t&&(r[t].push(e),i++)}))},l=0;l<t.length;l++)c(l);o[s]=r},s=0;s<a.length;s++)u();e.setNumberOfFrames(i);for(var c=0;c<a.length;c++)for(var l=o[c],d=a[c],f=d.metadata,p=1;p<l.length;p++){var g=l[p];if(g){var m=g.map((function(e){return e+1})),h=f[p],v=ut(d,g);e.addSegmentFromLabelmap(h,v,p,m)}}if(r.rleEncode){var S=rt(e.dataset.PixelData,i,e.dataset.Rows,e.dataset.Columns);e.assignToDataset({BitsAllocated:"8",BitsStored:"8",HighBit:"7",SegmentationType:"FRACTIONAL",SegmentationFractionalType:"PROBABILITY",MaximumFractionalValue:"255"}),e.dataset._meta.TransferSyntaxUID={Value:["1.2.840.10008.1.2.5"],vr:"UI"},e.dataset.SpecificCharacterSet="ISO_IR 192",e.dataset._vrMap.PixelData="OB",e.dataset.PixelData=S}else e.bitPackPixelData();return e}function ut(e,t){for(var n=e.labelmaps2D,r=[],a=0;a<t.length;a++){var i=t[a];r.push(n[i].pixelData)}return r}function st(){return(st=d(y().mark((function e(t,n,r,a){var i,o,u,s,c,l,d,f,p,g,m,h,v,S,I,D,R,O,C,b,x,w,M,P,E,A,N,q,k,U,F,_,V,B,G;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.skipOverlapping,o=void 0!==i&&i,u=a.tolerance,s=void 0===u?.001:u,c=a.TypedArrayConstructor,l=void 0===c?Uint8Array:c,d=a.maxBytesPerChunk,f=void 0===d?199e6:d,p=a.eventTarget,g=a.triggerEvent,m=Ke.readFile(n),(h=Ze.naturalizeDataset(m.dict))._meta=Ze.namifyDataset(m.meta),v=et.normalizeToDataset([h]),S=r.get("imagePlaneModule",t[0]),I=r.get("generalSeriesModule",t[0]),D=I.seriesInstanceUID,S||console.warn("Insufficient metadata, imagePlaneModule missing."),R=Array.isArray(S.rowCosines)?[].concat(T(S.rowCosines),T(S.columnCosines)):[S.rowCosines.x,S.rowCosines.y,S.rowCosines.z,S.columnCosines.x,S.columnCosines.y,S.columnCosines.z],O=mt(R),C=v.Columns*v.Rows,b=vt(v,D),"1.2.840.10008.1.2.5"!==v._meta.TransferSyntaxUID.Value[0]){e.next=23;break}if(M=Array.isArray(v.PixelData)?v.PixelData:[v.PixelData],x=at(M,v.Rows,v.Columns),1!==v.BitsStored){e.next=20;break}return console.warn("No implementation for rle + bitbacking."),e.abrupt("return");case 20:w=[x],e.next=26;break;case 23:if(w=gt(v,{maxBytesPerChunk:f})){e.next=26;break}throw new Error("Fractional segmentations are not yet supported");case 26:P=Ye(v,O,[S.rows,S.columns,t.length],s),E=t.reduce((function(e,t){return e[r.get("generalImageModule",t).sopInstanceUID]=t,e}),{}),A=!1,o||(A=lt(w,v,t,O,r,s,l,E)),e.t0=P,e.next="Planar"===e.t0?33:"Perpendicular"===e.t0?35:"Oblique"===e.t0?36:37;break;case 33:return N=A?dt:pt,e.abrupt("break",37);case 35:throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case 36:throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.");case 37:return(q=[])[0]=[],k=[],U=C*t.length*l.BYTES_PER_ELEMENT,(F=[])[0]=new ArrayBuffer(U),_=t.reduce((function(e,t,n){return e.indices[t]=n,e.metadata[t]=r.get("instance",t),e}),{indices:{},metadata:{}}),V=new Map,e.next=47,N(k,q,F,w,v,t,O,r,s,l,V,E,_,p,g);case 47:return B=e.sent,G=new Map,V.forEach((function(e,n){var a=yt(e,v,r,t);G.set(n,a)})),e.abrupt("return",{labelmapBufferArray:F,segMetadata:b,segmentsOnFrame:k,segmentsOnFrameArray:q,centroids:G,overlappingSegments:B});case 51:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ct(e,t,n,r,a,i){var o=void 0;if(!e)return o;var u=e.FrameOfReferenceUID,s=e.PerFrameFunctionalGroupsSequence,c=e.SourceImageSequence,l=e.ReferencedSeriesSequence;if(!s||0===s.length)return o;var d=s[t];if(!d)return o;var f=void 0;if(d.DerivationImageSequence){var p=d.DerivationImageSequence;Array.isArray(p)&&(p=0!==p.length?p[0]:void 0),p&&(f=p.SourceImageSequence,Array.isArray(f)&&(f=0!==f.length?f[0]:void 0))}else c&&0!==c.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),f=c[t]);(f&&(o=function(e,t){var n=e.ReferencedSOPInstanceUID,r=e.ReferencedFrameNumber;return r?function(e,t,n){var r=n[e];if(!r)return;var a=Number(r.split("frame=")[1]);return a===t-1?r:void 0}(n,r,t):t[n]}(f,i)),void 0===o&&l)&&(o=function(e,t,n,r,a,i){if(void 0===e||void 0===n.PlanePositionSequence||void 0===n.PlanePositionSequence[0]||void 0===n.PlanePositionSequence[0].ImagePositionPatient)return;for(var o=0;o<r.length;++o){var u=a.get("instance",r[o]);if(void 0!==u&&void 0!==u.ImagePositionPatient&&u.FrameOfReferenceUID===t&&u.SeriesInstanceUID===e&&je(n.PlanePositionSequence[0].ImagePositionPatient,u.ImagePositionPatient,i))return r[o]}}((Array.isArray(l)?l[0]:l).SeriesInstanceUID,u,d,n,r,a));return o}function lt(e,t,n,r,a,i,o,u){var s=t.SharedFunctionalGroupsSequence,c=t.PerFrameFunctionalGroupsSequence,l=t.SegmentSequence,d=t.Rows,f=t.Columns;if(l.length<2)return!1;for(var p=s.PlaneOrientationSequence?s.PlaneOrientationSequence.ImageOrientationPatient:void 0,g=f*d,h=c.length,v=new Map,S=function(){if(void 0===ft(t,y))return console.warn("Could not retrieve the segment index for frame segment "+y+", skipping this frame."),0;var e=ct(t,y,n,a,i,u);if(!e)return console.warn("Image not present in stack, can't import frame : "+y+"."),0;var r=n.findIndex((function(t){return t===e}));if(v.has(r)){var o=v.get(r);o.includes(y)||(o.push(y),v.set(r,o))}else v.set(r,[y])},y=0;y<h;++y)S();var T,D=m(v.entries());try{for(D.s();!(T=D.n()).done;)for(var R=I(T.value,2)[1],O=new o(g).fill(0),C=0;C<R.length;++C){var b=R[C],x=c[b],w=p||x.PlaneOrientationSequence.ImageOrientationPatient,M=St(e,b*g,g),P=ht(ve()(M,[d,f]),w,r,i);if(P){for(var E=P.data,A=0,N=E.length;A<N;++A)if(0!==E[A]&&(O[A]++,O[A]>1))return!0}else console.warn("Individual SEG frames are out of plane with respect to the first SEG frame, this is not yet supported, skipping this frame.")}}catch(e){D.e(e)}finally{D.f()}return!1}function dt(e,t,n,r,a,i,o,u,s,c,l,d){for(var f=a.SharedFunctionalGroupsSequence,p=a.PerFrameFunctionalGroupsSequence,g=a.Rows,m=a.Columns,h=f.PlaneOrientationSequence?f.PlaneOrientationSequence.ImageOrientationPatient:void 0,v=m*g,S=v*i.length*c.BYTES_PER_ELEMENT,y=1,I=0,T=n[I].slice(0),D=structuredClone(t[I]),R=a.SegmentSequence.length,O=1;O<=R;++O){for(var C=function(l){var f=p[l],R=ft(a,l);if(void 0===R)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");if(R!==O)return b=l,0;var C=h||f.PlaneOrientationSequence.ImageOrientationPatient,x=St(r,l*v,v),w=ht(ve()(x,[g,m]),C,o,s);if(!w)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var M=ct(a,l,i,u,s,d);if(!M)return console.warn("Image not present in stack, can't import frame : "+l+"."),b=l,0;var P=u.get("instance",M);if(g!==P.Rows||m!==P.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var E=i.findIndex((function(e){return e===M})),A=v*E*c.BYTES_PER_ELEMENT,N=new c(T,A,v),q=w.data,k=!1,U=0,F=w.data.length;U<F;++U)if(q[U]){if(0!==N[U]){++I>=y&&(n[I]=new ArrayBuffer(S),t[I]=[],y++),T=n[I].slice(0),D=structuredClone(t[I]),l=0;break}N[U]=R,k=!0}k&&(D[E]||(D[E]=[]),D[E].push(R),e[E]||(e[E]=[]),e[E].push(R)),b=l},b=0,x=p.length;b<x;++b)C(b);n[I]=T.slice(0),t[I]=structuredClone(D),T=n[I=0].slice(0),D=structuredClone(t[I])}}var ft=function(e,t){var n=e.PerFrameFunctionalGroupsSequence,r=e.SharedFunctionalGroupsSequence,a=n[t];return a&&a.SegmentIdentificationSequence?a.SegmentIdentificationSequence.ReferencedSegmentNumber:r.SegmentIdentificationSequence?r.SegmentIdentificationSequence.ReferencedSegmentNumber:void 0};function pt(e,t,n,r,a,i,o,u,s,c,l,d,f,p,g){var m=a.SharedFunctionalGroupsSequence,h=a.PerFrameFunctionalGroupsSequence,v=a.Rows,S=a.Columns,y=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,I=S*v,T=0,D=h.length,R=Math.ceil(D/10),O=g&&p,C=!1;return new Promise((function(t){!function m(){for(var b=Math.min(T+R,D);T<b;++T){var x=h[T],w=y||x.PlaneOrientationSequence.ImageOrientationPatient,M=St(r,T*I,I),P=ht(ve()(M,[v,S]),w,o,s);if(!P)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var E=ft(a,T);if(void 0===E)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");l.has(E)||l.set(E,{});var A=ct(a,T,i,u,s,d);if(A){var N=f.metadata[A];if(v!==N.Rows||S!==N.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var q=f.indices[A],k=I*q*c.BYTES_PER_ELEMENT,U=new c(n[0],k,I),F=P.data,_=[],V=0,B=P.data.length;V<B;++V)if(F[V]){for(var G=V;G<B;++G)F[G]&&(C||0===U[G]||(C=!0),U[G]=E,_.push(G));e[q]||(e[q]=[]),e[q].push(E);break}var L=l.get(E);L[q]=_,l.set(E,L)}else console.warn("Image not present in stack, can't import frame : "+T+".")}if(O){var j=Math.round(T/D*100);g(p,ze.SEGMENTATION_LOAD_PROGRESS,{percentComplete:j})}T<D?setTimeout(m,0):t(C)}()}))}function gt(e,t){var n,r=e.SegmentationType;if(void 0===(n=Array.isArray(e.PixelData)?e.PixelData[0]:e.PixelData)&&O.Rm.error("This segmentation pixelData is undefined."),"BINARY"===r)return function(e,t){for(var n=new Uint8Array(e),r=[],a=8*t,i=Math.ceil(8*n.length/a),o=0;o<i;o++){var u=o*a,s=Math.min(u+a,8*n.length),c=Math.floor(u/8),l=Math.ceil(s/8),d=n.slice(c,l),f=Je.unpack(d);r.push(f)}return r}(n,t.maxBytesPerChunk);var a=new Uint8Array(n),i=e.MaximumFractionalValue;return void 0===a.find((function(e){return 0!==e&&e!==i}))?(O.Rm.warn("This segmentation object is actually binary... processing as such."),a):void 0}function mt(e){var t=[];t[0]=e,t[1]=We.h(e),t[2]=We.v(e);var n=Xe(e,Math.PI/2);return t[3]=n,t[4]=We.h(n),t[5]=We.v(n),t[6]=Xe(e,Math.PI),t[7]=Xe(e,1.5*Math.PI),t}function ht(e,t,n,r){return je(t,n[0],r)?e:je(t,n[1],r)?Qe.v(e):je(t,n[2],r)?Qe.h(e):je(t,n[3],r)?$e(e):je(t,n[4],r)?$e(Qe.h(e)):je(t,n[5],r)?$e(Qe.v(e)):je(t,n[6],r)?$e($e(e)):je(t,n[7],r)?$e($e($e(e))):void 0}function vt(e,t){var n=e.SegmentSequence;return{seriesInstanceUid:t,data:Array.isArray(n)?[void 0].concat(T(n)):[void 0,n]}}function St(e,t,n){var r=function(e,t,n){var r=e.reduce((function(e,t){return e+t.length}),0);if(t<0||t+n>r)throw new Error("Offset and length out of bounds");var a=0,i=t;for(;i>=e[a].length;)i-=e[a].length,a++;var o=a,u=i+n;for(;u>e[o].length;)u-=e[o].length,o++;return{start:{chunkIndex:a,offset:i},end:{chunkIndex:o,offset:u}}}(e,t,n);if(r.start.chunkIndex===r.end.chunkIndex)return new Uint8Array(e[r.start.chunkIndex].buffer,r.start.offset,n);for(var a=new Uint8Array(n),i=0,o=r.start.chunkIndex;o<=r.end.chunkIndex;o++){var u=o===r.start.chunkIndex?r.start.offset:0,s=o===r.end.chunkIndex?r.end.offset:e[o].length;a.set(new Uint8Array(e[o].buffer,u,s-u),i),i+=s-u}return a}function yt(e,t,n,r){for(var a=0,i=0,o=0,u=0,s=0,c=0,l=0,d=0,f=Object.entries(e);d<f.length;d++){var p=I(f[d],2),g=p[0],h=p[1],v=Number(g);if(h&&0!==h.length){var S=r[v],y=n.get("imagePlaneModule",S);if(y){var T,D=y.imagePositionPatient,R=y.rowCosines,O=y.columnCosines,C=y.rowPixelSpacing,b=y.columnPixelSpacing,x=m(h);try{for(x.s();!(T=x.n()).done;){var w=T.value,M=Math.floor(w/t.Rows),P=w%t.Rows;a+=P,i+=M,o+=v;var E=D[0]+P*R[0]*b+M*O[0]*C,A=D[1]+P*R[1]*b+M*O[1]*C,N=D[2]+P*R[2]*b+M*O[2]*C;u+=E,s+=A,c+=N,l++}}catch(e){x.e(e)}finally{x.f()}}else console.debug("Missing imagePlaneModule metadata for centroid calculation")}}return{image:{x:Math.floor(a/l),y:Math.floor(i/l),z:Math.floor(o/l)},world:{x:u/l,y:s/l,z:c/l},count:l}}var It={generateSegmentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e[0].imageId.includes("?frame");return ot(function(e,t,n){var r=Te(e,t);return new tt([r],n)}(e,r,n),t,n)},generateToolState:function(e,t,n,r){return st.apply(this,arguments)},fillSegmentation:ot};function Tt(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;return 4===r?It.generateSegmentation(e,t,n):3===r?Ne.generateSegmentation(e,t,n):void console.warn("No generateSegmentation adapter for cornerstone version ".concat(r,", exiting."))}function Dt(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;return 4===i?It.generateToolState(e,t,n,r,a):3===i?Ne.generateToolState(e,t,n):void console.warn("No generateToolState adapter for cornerstone version ".concat(i,", exiting."))}function Rt(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===r)return It.fillSegmentation(e,t,n);console.warn("No generateSegmentation adapter for cornerstone version ".concat(r,", exiting."))}var Ot=O.p.DicomMessage,Ct=O.p.DicomMetaDictionary,bt=O.z8.Normalizer;function xt(){return xt=d(y().mark((function e(t,n,r){var a,i,o,u,s,c,l,d,f,p,g,m=arguments;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=m.length>3&&void 0!==m[3]?m[3]:.001,i=Ot.readFile(n),(o=Ct.naturalizeDataset(i.dict))._meta=Ct.namifyDataset(i.meta),u=bt.normalizeToDataset([o]),(s=r.get("imagePlaneModule",t[0]))||console.warn("Insufficient metadata, imagePlaneModule missing."),c=Array.isArray(s.rowCosines)?[].concat(T(s.rowCosines),T(s.columnCosines)):[s.rowCosines.x,s.rowCosines.y,s.rowCosines.z,s.columnCosines.x,s.columnCosines.y,s.columnCosines.z],l=[c],d=Mt(u),f=Ye(u,l,[s.rows,s.columns,t.length],a),p=t.reduce((function(e,t){return e[r.get("generalImageModule",t).sopInstanceUID]=t,e}),{}),"Planar"===f){e.next=15;break}throw new Error("Parametric maps ".concat({Perpendicular:"orthogonal",Oblique:"oblique"}[f]," to the acquisition plane of the source data are not yet supported."));case 15:return g=t.reduce((function(e,t,n){return e.indices[t]=n,e.metadata[t]=r.get("instance",t),e}),{indices:{},metadata:{}}),e.next=18,wt(d,u,t,r,a,p,g);case 18:return e.abrupt("return",{pixelData:d});case 19:case"end":return e.stop()}}),e)}))),xt.apply(this,arguments)}function wt(e,t,n,r,a,i,o){for(var u=new e.constructor(e.length),s=t.PerFrameFunctionalGroupsSequence,c=t.Rows,l=t.Columns,d=l*c,f=s.length,p=0;p<f;p++){var g=new e.constructor(e.buffer,p*d,d),m=Pt(t,p,n,r,a,i);if(m){var h=o.metadata[m];if(c!==h.Rows||l!==h.Columns)throw new Error("Parametric map have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported.");var v=d*o.indices[m]*u.BYTES_PER_ELEMENT;new u.constructor(u.buffer,v,d).set(g)}else console.warn("Image not present in stack, can't import frame : "+p+".")}return u}function Mt(e){var t,n,r;e.PixelData?(t=(16===e.BitsAllocated?[Uint16Array,Int16Array]:[Uint32Array,Int32Array])[null!==(r=e.PixelRepresentation)&&void 0!==r?r:0],n=e.PixelData):e.FloatPixelData?(t=Float32Array,n=e.FloatPixelData):e.DoubleFloatPixelData&&(t=Float64Array,n=e.DoubleFloatPixelData);return void 0===n&&O.Rm.error("This parametric map pixel data is undefined."),Array.isArray(n)&&(n=n[0]),new t(n)}function Pt(e,t,n,r,a,i){var o=void 0;if(!e)return o;var u=e.FrameOfReferenceUID,s=e.PerFrameFunctionalGroupsSequence,c=e.SourceImageSequence,l=e.ReferencedSeriesSequence;if(!s||0===s.length)return o;var d=s[t];if(!d)return o;var f=void 0;if(d.DerivationImageSequence){var p=d.DerivationImageSequence;Array.isArray(p)&&(p=0!==p.length?p[0]:void 0),p&&(f=p.SourceImageSequence,Array.isArray(f)&&(f=0!==f.length?f[0]:void 0))}else c&&0!==c.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),f=c[t]);(f&&(o=function(e,t){var n=e.ReferencedSOPInstanceUID,r=e.ReferencedFrameNumber;return r?function(e,t,n){var r=n[e];if(!r)return;var a=Number(r.split("frame=")[1]);return a===t-1?r:void 0}(n,r,t):t[n]}(f,i)),void 0===o&&l)&&(o=function(e,t,n,r,a,i){if(void 0===e||void 0===n.PlanePositionSequence||void 0===n.PlanePositionSequence[0]||void 0===n.PlanePositionSequence[0].ImagePositionPatient)return;for(var o=0;o<r.length;++o){var u=a.get("instance",r[o]);if(void 0!==u&&void 0!==u.ImagePositionPatient&&u.FrameOfReferenceUID===t&&u.SeriesInstanceUID===e&&je(n.PlanePositionSequence[0].ImagePositionPatient,u.ImagePositionPatient,i))return r[o]}}((Array.isArray(l)?l[0]:l).SeriesInstanceUID,u,d,n,r,a));return o}var Et,At={Length:H,FreehandRoi:W,Bidirectional:J,EllipticalRoi:ee,CircleRoi:re,ArrowAnnotate:ue,MeasurementReport:L,CobbAngle:le,Angle:pe,RectangleRoi:me},Nt={Segmentation:r},qt={ParametricMap:{generateToolState:function(e,t,n){return xt.apply(this,arguments)}}},kt="Cornerstone3DTools@^0.1.0",Ut={CodingSchemeDesignator:"CORNERSTONEJS",codeValues:{CORNERSTONEFREETEXT:"CORNERSTONEFREETEXT"}},Ft=O.BF.TID1500,_t=O.BF.addAccessors,Vt=O.h4.StructuredReport,Bt=O.z8.Normalizer,Gt=Ft.TID1500MeasurementReport,Lt=Ft.TID1501MeasurementGroup,jt=O.p.DicomMetaDictionary,Yt={CodingSchemeDesignator:"DCM",CodeValue:"121071"},zt={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},Ht={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},Xt=function(e,t,n){var r=e.ConceptNameCodeSequence;if(r){var a=r.CodingSchemeDesignator,i=r.CodeValue;return a==t.CodingSchemeDesignator&&i==t.CodeValue||n&&a==n.CodingSchemeDesignator&&i==n.CodeValue}};var Wt=function(){function e(){f(this,e)}return g(e,null,[{key:"getCornerstoneLabelFromDefaultState",value:function(e){var t=e.findingSites,n=void 0===t?[]:t,r=e.finding,a=Ut.codeValues.CORNERSTONEFREETEXT,i=n.find((function(e){return e.CodeValue===a}));return i?i.CodeMeaning:r&&r.CodeValue===a?r.CodeMeaning:void 0}},{key:"generateDatasetMeta",value:function(){var e=new Uint8Array(2);return e[1]=1,{FileMetaInformationVersion:{Value:[e.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[jt.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}}}},{key:"getSetupMeasurementData",value:function(t,n,r,a){var i=t.ContentSequence,o=C(i),u=o.find((function(e){return Xt(e,Yt)})),s=o.filter((function(e){return Xt(e,zt,Ht)}))||[],c=o.find((function(e){return"NUM"===e.ValueType})),l=C(c.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),d=l.ContentSequence.ReferencedSOPSequence,f=d.ReferencedSOPInstanceUID,p=d.ReferencedFrameNumber,g=n[f],m=r.get("imagePlaneModule",g),h=u?_t(u.ConceptCodeSequence):void 0,v=s.map((function(e){return _t(e.ConceptCodeSequence)})),S={description:void 0,sopInstanceUid:f,annotation:{annotationUID:jt.uid(),metadata:{toolName:a,referencedImageId:g,FrameOfReferenceUID:m.frameOfReferenceUID,label:""},data:void 0},finding:h,findingSites:v};return S.finding&&(S.description=S.finding.CodeMeaning),S.annotation.metadata.label=e.getCornerstoneLabelFromDefaultState(S),{defaultState:S,NUMGroup:c,SCOORDGroup:l,ReferencedSOPSequence:d,ReferencedSOPInstanceUID:f,ReferencedFrameNumber:p}}},{key:"generateReport",value:function(t,n,r,a){var i=[],o={},u=[],s=e.generateDatasetMeta();Object.keys(t).forEach((function(a){var s=n.get("sopCommonModule",a),c=n.get("instance",a),l=s.sopInstanceUID,d=s.sopClassUID,f=c.SeriesInstanceUID;if(o[l]=f,!u.find((function(e){return e.SeriesInstanceUID===f}))){var p=e.generateDerivationSourceDataset(c);u.push(p)}var g=n.get("frameNumber",a),m=t[a],h=Object.keys(m),v={ReferencedSOPClassUID:d,ReferencedSOPInstanceUID:l,ReferencedFrameNumber:void 0};(c&&c.NumberOfFrames&&c.NumberOfFrames>1||Bt.isMultiframeSOPClassUID(d))&&(v.ReferencedFrameNumber=g);var S=[];h.forEach((function(e){var t=function(e,t,n,r){var a=t[e],i=Wt.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(a&&a.data&&a.data.length&&i){var o=a.data.map((function(e){return function(e,t,n,r,a){var i=r.getTID300RepresentationArguments(e,a);return i.ReferencedSOPSequence=n,new r.TID300Representation(i)}(e,0,n,i,r)}));return new Lt(o)}}(e,m,v,r);t&&S.push(t)})),i=i.concat(S)}));var c=new Gt({TID1501MeasurementGroups:i},a),l=new Vt(u,a),d=c.contentItem(u,S(S({},a),{},{sopInstanceUIDsToSeriesInstanceUIDMap:o}));return l.dataset=Object.assign(l.dataset,d),l.dataset._meta=s,l.SpecificCharacterSet="ISO_IR 192",l}},{key:"generateToolState",value:function(t,n,r,a,i){if("1500"!==t.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var o=C(t.ContentSequence).find(b("Imaging Measurements")),u=C(o.ContentSequence).filter(b("Measurement Group")),s={},c=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,l=[];return Object.keys(c).forEach((function(e){l.push(c[e]),s[e]=[]})),u.forEach((function(e){try{var o,u=C(e.ContentSequence),c=u.find((function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning})).TextValue,d=u.find((function(e){return"Tracking Unique Identifier"===e.ConceptNameCodeSequence.CodeMeaning})),f=null==d?void 0:d.UID,p=(null==i||null===(o=i.getToolClass)||void 0===o?void 0:o.call(i,e,t,l))||l.find((function(e){return e.isValidCornerstoneTrackingIdentifier(c)}));if(p){var g=p.getMeasurementData(e,n,r,a);g.TrackingUniqueIdentifier=f,console.log("=== ".concat(p.toolType," ===")),console.log(g),s[p.toolType].push(g)}}catch(t){console.warn("Unable to generate tool state for",e,t)}})),s}},{key:"registerTool",value:function(t){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[t.utilityToolType]=t,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[t.toolType]=t,e.MEASUREMENT_BY_TOOLTYPE[t.toolType]=t.utilityToolType}}])}();(Et=Wt).CORNERSTONE_3D_TAG=kt,Et.MEASUREMENT_BY_TOOLTYPE={},Et.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},Et.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={},Et.generateDerivationSourceDataset=function(e){var t=Et.generateDatasetMeta();return S(S({},e),{},{_meta:t,_vrMap:{PixelData:"OW"}})};var Qt,$t=O.BF.TID300.Point,Jt="ArrowAnnotate",Kt="".concat(kt,":").concat(Jt),Zt=Ut.codeValues,en=Ut.CodingSchemeDesignator,tn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=o.annotation.metadata.label,d=u.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(c,[d[p],d[p+1]]);f.push(g)}if(1===f.length){var m=a.get("imagePixelModule",c),h=10,v=10;if(m)h=m.columns/10,v=m.rows/10;var S=r(c,[d[0]+h,d[1]+v]);f.push(S)}var y=o;return y.annotation.data={text:l,handles:{arrowFirst:!0,points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},frameNumber:s},y}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.metadata,a=e.finding,i=e.findingSites,o=r.referencedImageId;if(!o)throw new Error("ArrowAnnotate.getTID300RepresentationArguments: referencedImageId is not defined");var u,s,c=n.handles,l=c.points;c.arrowFirst?(u=l[0],s=l[1]):(u=l[1],s=l[0]);var d=t(o,u),f=t(o,s),p={points:[{x:d[0],y:d[1]},{x:f[0],y:f[1]}],trackingIdentifierTextValue:Kt,findingSites:i||[]};return a&&a.CodeValue===Zt.CORNERSTONEFREETEXT||(a={CodeValue:Zt.CORNERSTONEFREETEXT,CodingSchemeDesignator:en,CodeMeaning:n.text}),p.finding=a,p}}])}();tn.toolType=Jt,tn.utilityToolType=Jt,tn.TID300Representation=$t,tn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===Jt},Wt.registerTool(tn);var nn,rn=O.BF.TID300.Bidirectional,an="Bidirectional",on="".concat(kt,":").concat(an),un=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.ReferencedFrameNumber,s=o.annotation.metadata.referencedImageId,c=t.ContentSequence,l=C(c).find((function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning})),d=C(l.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),f=C(c).find((function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning})),p=C(f.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),g=[];[d,p].forEach((function(e){for(var t=e.GraphicData,n=0;n<t.length;n+=2){var a=r(s,[t[n],t[n+1]]);g.push(a)}}));var m=o;return m.annotation.data={handles:{points:[g[0],g[1],g[2],g[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(s),{length:l.MeasuredValueSequence.NumericValue,width:f.MeasuredValueSequence.NumericValue}),frameNumber:u},m}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.cachedStats,u=void 0===o?{}:o,s=n.handles,c=i.referencedImageId;if(!c)throw new Error("Bidirectional.getTID300RepresentationArguments: referencedImageId is not defined");var l,d,f=u["imageId:".concat(c)]||{},p=f.length,g=f.width,m=s.points,h=[m[0],m[1]],v=[m[2],m[3]];Math.sqrt(Math.pow(h[0][0]-h[1][0],2)+Math.pow(h[0][1]-h[1][1],2)+Math.pow(h[0][2]-h[1][2],2))>Math.sqrt(Math.pow(v[0][0]-v[1][0],2)+Math.pow(v[0][1]-v[1][1],2)+Math.pow(v[0][2]-v[1][2],2))?(l=h,d=v):(l=v,d=h);var S=t(c,l[0]),y=t(c,l[1]),I=t(c,d[0]),T=t(c,d[1]);return{longAxis:{point1:{x:S[0],y:S[1]},point2:{x:y[0],y:y[1]}},shortAxis:{point1:{x:I[0],y:I[1]},point2:{x:T[0],y:T[1]}},longAxisLength:p,shortAxisLength:g,trackingIdentifierTextValue:on,finding:r,findingSites:a||[]}}}])}();(Qt=un).toolType=an,Qt.utilityToolType=an,Qt.TID300Representation=rn,Qt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===an},Wt.registerTool(un);var sn,cn=O.BF.TID300.CobbAngle,ln="Angle",dn="".concat(kt,":").concat(ln),fn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=o;return m.annotation.data={handles:{points:[f[0],f[1],f[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{angle:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},m}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.cachedStats,u=void 0===o?{}:o,s=n.handles,c=i.referencedImageId;if(!c)throw new Error("Angle.getTID300RepresentationArguments: referencedImageId is not defined");var l=t(c,s.points[0]),d=t(c,s.points[1]),f=t(c,s.points[2]),p={x:l[0],y:l[1]},g={x:d[0],y:d[1]};return{point1:p,point2:g,point3:g,point4:{x:f[0],y:f[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:dn,finding:r,findingSites:a||[]}}}])}();(nn=fn).toolType=ln,nn.utilityToolType=ln,nn.TID300Representation=cn,nn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===ln},Wt.registerTool(fn);var pn,gn=O.BF.TID300.CobbAngle,mn="CobbAngle",hn="".concat(kt,":").concat(mn),vn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=o;return m.annotation.data={handles:{points:[f[0],f[1],f[2],f[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{angle:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},m}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.cachedStats,u=void 0===o?{}:o,s=n.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=t(c,s.points[0]),d=t(c,s.points[1]),f=t(c,s.points[2]),p=t(c,s.points[3]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},point3:{x:f[0],y:f[1]},point4:{x:p[0],y:p[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:hn,finding:r,findingSites:a||[]}}}])}();function Sn(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r.toLowerCase()===this.toolType.toLowerCase()}(sn=vn).toolType=mn,sn.utilityToolType=mn,sn.TID300Representation=gn,sn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===mn},Wt.registerTool(vn);var yn=O.BF.TID300.Circle,In="CircleROI",Tn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=o;return m.annotation.data={handles:{points:[].concat(f),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0}),frameNumber:c},m}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.cachedStats,u=void 0===o?{}:o,s=n.handles,c=i.referencedImageId;if(!c)throw new Error("CircleROI.getTID300RepresentationArguments: referencedImageId is not defined");var l=t(c,s.points[0]),d=t(c,s.points[1]),f=[];f.push({x:l[0],y:l[1]}),f.push({x:d[0],y:d[1]});var p=u["imageId:".concat(c)]||{},g=p.area,m=p.radius;return{area:g,perimeter:2*Math.PI*m,radius:m,points:f,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:r,findingSites:a||[]}}}])}();(pn=Tn).trackingIdentifierTextValue="".concat(kt,":").concat(In),pn.toolType=In,pn.utilityToolType=In,pn.TID300Representation=yn,pn.isValidCornerstoneTrackingIdentifier=Sn,Wt.registerTool(Tn);var Dn,Rn,On=n(3823),Cn=O.BF.TID300.Ellipse,bn="EllipticalROI",xn=1e-4,wn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=On.eR.fromValues.apply(On.eR,T(f[0])),v=On.eR.fromValues.apply(On.eR,T(f[1])),S=On.eR.fromValues.apply(On.eR,T(f[2])),y=On.eR.fromValues.apply(On.eR,T(f[3])),I=On.eR.create();On.eR.sub(I,v,m),On.eR.normalize(I,I);var D=On.eR.create();On.eR.sub(D,y,S),On.eR.normalize(D,D);var R=a.get("imagePlaneModule",l);if(!R)throw new Error("imageId does not have imagePlaneModule metadata");var O=R.columnCosines,C=On.eR.fromValues(O[0],O[1],O[2]),b=On.eR.dot(C,I),x=On.eR.dot(C,D),w=Math.abs(b),M=Math.abs(x),P=[];Math.abs(w-1)<xn?P=[f[0],f[1],f[2],f[3]]:Math.abs(M-1)<xn?P=[f[2],f[3],f[0],f[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");var E=o;return E.annotation.data={handles:{points:T(P),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:0}),frameNumber:c},E}},{key:"getTID300RepresentationArguments",value:function(e,t){var n,r,a,i,o=e.data,u=e.finding,s=e.findingSites,c=e.metadata,l=o.cachedStats,d=void 0===l?{}:l,f=o.handles,p=o.initialRotation||0,g=c.referencedImageId;if(!g)throw new Error("EllipticalROI.getTID300RepresentationArguments: referencedImageId is not defined");90==p||270==p?(r=t(g,f.points[2]),n=t(g,f.points[3]),a=t(g,f.points[0]),i=t(g,f.points[1])):(n=t(g,f.points[0]),r=t(g,f.points[1]),a=t(g,f.points[2]),i=t(g,f.points[3]));var m=[];return Math.abs(n[1]-r[1])>Math.abs(a[0]-i[0])?(m.push({x:n[0],y:n[1]}),m.push({x:r[0],y:r[1]}),m.push({x:a[0],y:a[1]}),m.push({x:i[0],y:i[1]})):(m.push({x:a[0],y:a[1]}),m.push({x:i[0],y:i[1]}),m.push({x:n[0],y:n[1]}),m.push({x:r[0],y:r[1]})),{area:(d["imageId:".concat(g)]||{}).area,points:m,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:u,findingSites:s||[]}}}])}();(Dn=wn).trackingIdentifierTextValue="".concat(kt,":").concat(bn),Dn.toolType=bn,Dn.utilityToolType=bn,Dn.TID300Representation=Cn,Dn.isValidCornerstoneTrackingIdentifier=Sn,Wt.registerTool(wn);var Mn=O.BF.TID300.Polyline,Pn="RectangleROI",En="".concat(kt,":").concat(Pn),An=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=o;return m.annotation.data={handles:{points:[f[0],f[1],f[3],f[2]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},m}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.cachedStats,u=void 0===o?{}:o,s=n.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=s.points.map((function(e){return t(c,e)})),d=u.area,f=u.perimeter;return{points:[l[0],l[1],l[3],l[2],l[0]],area:d,perimeter:f,trackingIdentifierTextValue:En,finding:r,findingSites:a||[]}}}])}();(Rn=An).toolType=Pn,Rn.utilityToolType=Pn,Rn.TID300Representation=Mn,Rn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===Pn},Wt.registerTool(An);var Nn,qn=O.BF.TID300.Length,kn="Length",Un="".concat(kt,":").concat(kn),Fn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=o;return m.annotation.data={handles:{points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{length:u?u.MeasuredValueSequence.NumericValue:0}),frameNumber:c},m}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.cachedStats,u=void 0===o?{}:o,s=n.handles,c=i.referencedImageId;if(!c)throw new Error("Length.getTID300RepresentationArguments: referencedImageId is not defined");var l=t(c,s.points[0]),d=t(c,s.points[1]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},distance:(u["imageId:".concat(c)]||{}).length,trackingIdentifierTextValue:Un,finding:r,findingSites:a||[]}}}])}();Fn.toolType=kn,Fn.utilityToolType=kn,Fn.TID300Representation=qn,Fn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===kn},Wt.registerTool(Fn);var _n=O.BF.TID300.Polyline,Vn="PlanarFreehandROI",Bn="".concat(kt,":").concat(Vn),Gn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var m=!0;On.eR.distance(f[f.length-1],f[0])<1e-5&&(f.pop(),m=!1);var v=[];m&&v.push(f[0],f[f.length-1]);var S=o;return S.annotation.data={contour:{polyline:f,closed:!m},handles:{points:v,activeHandleIndex:null,textBox:{hasMoved:!1}},cachedStats:h({},"imageId:".concat(l),{area:u?u.MeasuredValueSequence.NumericValue:null}),frameNumber:c},S}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.contour,u=o.polyline,s=!0!==o.closed,c=i.referencedImageId;if(!c)throw new Error("PlanarFreehandROI.getTID300RepresentationArguments: referencedImageId is not defined");var l=u.map((function(e){return t(c,e)}));if(!s){var d=l[0];l.push([d[0],d[1]])}var f=n.cachedStats["imageId:".concat(c)]||{},p=f.area,g=f.areaUnit,m=f.modalityUnit;return{points:l,area:p,areaUnit:g,perimeter:f.perimeter,modalityUnit:m,mean:f.mean,max:f.max,stdDev:f.stdDev,trackingIdentifierTextValue:Bn,finding:r,findingSites:a||[]}}}])}();(Nn=Gn).toolType=Vn,Nn.utilityToolType=Vn,Nn.TID300Representation=_n,Nn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===Vn},Wt.registerTool(Gn);var Ln,jn=O.BF.TID300.Point,Yn="Probe",zn="".concat(kt,":").concat(Yn),Hn=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=u.GraphicData,d=[],f=0;f<l.length;f+=2){var p=r(c,[l[f],l[f+1]]);d.push(p)}var g=o;return g.annotation.data={handles:{points:d,activeHandleIndex:null,textBox:{hasMoved:!1}},frameNumber:s},g}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.metadata,a=e.finding,i=e.findingSites,o=r.referencedImageId;if(!o)throw new Error("Probe.getTID300RepresentationArguments: referencedImageId is not defined");return{points:n.handles.points.map((function(e){var n=t(o,e);return{x:n[0],y:n[1]}})),trackingIdentifierTextValue:zn,findingSites:i||[],finding:a}}}])}();Hn.toolType=Yn,Hn.utilityToolType=Yn,Hn.TID300Representation=jn,Hn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===Yn},Wt.registerTool(Hn);var Xn=O.BF.TID300.Length,Wn="UltrasoundDirectionalTool",Qn="".concat(kt,":").concat(Wn),$n=function(){function e(){f(this,e)}return g(e,null,[{key:"getMeasurementData",value:function(t,n,r,a){for(var i=Wt.getSetupMeasurementData(t,n,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=u.GraphicData,d=[],f=0;f<l.length;f+=2){var p=r(c,[l[f],l[f+1]]);d.push(p)}var g=o;return g.annotation.data={handles:{points:[d[0],d[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:{},frameNumber:s},g}},{key:"getTID300RepresentationArguments",value:function(e,t){var n=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=n.handles,u=i.referencedImageId;if(!u)throw new Error("UltrasoundDirectionalTool.getTID300RepresentationArguments: referencedImageId is not defined");var s=t(u,o.points[0]),c=t(u,o.points[1]);return{point1:{x:s[0],y:s[1]},point2:{x:c[0],y:c[1]},trackingIdentifierTextValue:Qn,finding:r,findingSites:a||[]}}}])}();(Ln=$n).toolType=Wn,Ln.utilityToolType=Wn,Ln.TID300Representation=Xn,Ln.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var t=I(e.split(":"),2),n=t[0],r=t[1];return n===kt&&r===Wn},Wt.registerTool($n);var Jn=O.z8.Normalizer,Kn=O.h4.Segmentation;function Zn(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=function(e,t,n){var r=e.map((function(e){var n=t.get("instance",e.imageId);return S(S(S({},e),n),{},{SOPClassUID:n.SopClassUID||n.SOPClassUID,SOPInstanceUID:n.SopInstanceUID||n.SOPInstanceUID,PixelData:e.voxelManager.getScalarData(),_vrMap:{PixelData:"OW"},_meta:{}})})),a=Jn.normalizeToDataset(r);if(!a)throw new Error("Failed to normalize the multiframe dataset, the data is not multi-frame.");return new Kn([a],n)}(e,n,r);return ot(a,t,r)}function er(e){for(var t=e.scalarData,n=e.dimensions,r=[],a=new Set,i=0;i<n[2];i++){for(var o=t.slice(i*n[0]*n[1],(i+1)*n[0]*n[1]),u=[],s=0;s<o.length;s++){var c=o[s];u.includes(c)||0===c||u.push(c)}var l={segmentsOnLabelmap:u,pixelData:o,rows:n[1],columns:n[0]};0!==u.length&&(u.forEach((function(e){a.add(e)})),r[n[2]-1-i]=l)}return e.segmentsOnLabelmap=Array.from(a),e.labelmaps2D=r,e}function tr(e,t,n){return Dt(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001)}var nr=qt.ParametricMap.generateToolState;function rr(e,t,n){return nr(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001)}var ar=n(55139);function ir(e,t,n){var r=e.referencedImageId,a=e.FrameOfReferenceUID,i=t.get("instance",r).SeriesInstanceUID,o=n.ReferencedSeriesSequence;return[{FrameOfReferenceUID:a,RTReferencedStudySequence:[{ReferencedSOPClassUID:n.SOPClassUID,ReferencedSOPInstanceUID:n.SOPInstanceUID,RTReferencedSeriesSequence:[{SeriesInstanceUID:i,ContourImageSequence:T(o[0].ReferencedInstanceSequence)}]}]}]}function or(e,t,n,r){var a=e.referencedImageId,i=n.get("instance",a),o=i.SeriesInstanceUID,u=i.StudyInstanceUID,s=[];if(o){var c=r.getSeries(u,o),l={SeriesInstanceUID:o,ReferencedInstanceSequence:[]};c.instances.forEach((function(e){var t=e.SOPInstanceUID,n=e.SOPClassUID;l.ReferencedInstanceSequence.push({ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t})})),s.push(l)}return s}function ur(e,t){var n=e.metadata.FrameOfReferenceUID;return{ROINumber:t+1,ROIName:e.name||"Todo: name ".concat(t+1),ROIDescription:"Todo: description ".concat(t+1),ROIGenerationAlgorithm:"Todo: algorithm",ReferencedFrameOfReferenceUID:n}}var sr=ar.utilities.contours,cr=sr.generateContourSetsFromLabelmap,lr=sr.AnnotationToPointData,dr=O.Ay.data.DicomMetaDictionary;function fr(e,t,n){var r=[];cr({segmentations:e}).forEach((function(e,n){if(e){var a=[];e.sliceContours.forEach((function(e){var n=t.get("sopCommonModule",e.referencedImageId),r=[{ReferencedSOPClassUID:n.sopClassUID,ReferencedSOPInstanceUID:n.sopInstanceUID}],i=e.polyData;e.contours.forEach((function(e,t){var n=e.type,o=e.contourPoints.length,u=[];e.contourPoints.forEach((function(e){var t=i.points[e];t[0]=+t[0].toFixed(2),t[1]=+t[1].toFixed(2),t[2]=+t[2].toFixed(2),u.push(t[0]),u.push(t[1]),u.push(t[2])})),a.push({ContourImageSequence:r,ContourGeometricType:n,NumberOfContourPoints:o,ContourNumber:t+1,ContourData:u})}))}));var i=e.label||"Segment ".concat(n+1),o={name:i,description:i,contourSequence:a,color:e.color,metadata:e.metadata};r.push(o)}}));var a=gr({name:e.label,label:e.label},r[0].metadata,t);r.forEach((function(e,r){var i={ROIDisplayColor:e.color||[255,0,0],ContourSequence:e.contourSequence,ReferencedROINumber:r+1};a.StructureSetROISequence.push(ur(e,r)),a.ROIContourSequence.push(i),a.ReferencedSeriesSequence=or(e.metadata,0,t,n),a.ReferencedFrameOfReferenceSequence=ir(e.metadata,t,a)}));var i=new Uint8Array(2);i[1]=1;var o={FileMetaInformationVersion:{Value:[i.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[dr.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return a._meta=o,a.SpecificCharacterSet="ISO_IR 192",a}function pr(e,t,n){var r=gr({name:"RTSS from Annotations",label:"RTSS from Annotations"},e[0].metadata,t);e.forEach((function(e,a){var i=lr.convert(e,a,t);r.StructureSetROISequence.push(ur(e,a)),r.ROIContourSequence.push(i),r.RTROIObservationsSequence.push(function(e,t){return{ObservationNumber:t+1,ReferencedROINumber:t+1,RTROIInterpretedType:"Todo: type",ROIInterpreter:"Todo: interpreter"}}(0,a)),r.ReferencedSeriesSequence=or(e.metadata,0,t,n),r.ReferencedFrameOfReferenceSequence=ir(e.metadata,t,r)}));var a=new Uint8Array(2);a[1]=1;var i={FileMetaInformationVersion:{Value:[a.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[dr.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return r._meta=i,r.SpecificCharacterSet="ISO_IR 192",r}function gr(e,t,n){var r=dr.uid(),a=t.referencedImageId,i=t.FrameOfReferenceUID,o=n.get("generalSeriesModule",a).studyInstanceUID,u=function(e,t){var n=t.get("generalSeriesModule",e),r=t.get("generalStudyModule",e),a=t.get("patientStudyModule",e),i=t.get("patientModule",e),o=t.get("patientDemographicModule",e);return{Modality:n.modality,PatientID:i.patientId,PatientName:i.patientName,PatientBirthDate:"",PatientAge:a.patientAge,PatientSex:o.patientSex,PatientWeight:a.patientWeight,StudyDate:r.studyDate,StudyTime:r.studyTime,StudyID:"ToDo",AccessionNumber:r.accessionNumber}}(a,n),s=function(e){return{SeriesInstanceUID:e.uid(),SeriesNumber:"99"}}(dr);return S(S(S({StructureSetROISequence:[],ROIContourSequence:[],RTROIObservationsSequence:[],ReferencedSeriesSequence:[],ReferencedFrameOfReferenceSequence:[]},u),s),{},{StudyInstanceUID:o,SOPClassUID:"1.2.840.10008.5.1.4.1.1.481.3",SOPInstanceUID:r,Manufacturer:"dcmjs",Modality:"RTSTRUCT",FrameOfReferenceUID:i,PositionReferenceIndicator:"",StructureSetLabel:e.label||"",StructureSetName:e.name||"",ReferringPhysicianName:"",OperatorsName:"",StructureSetDate:dr.date(),StructureSetTime:dr.time(),_meta:null})}var mr=ar.utilities.contours.generateContourSetsFromLabelmap,hr={Bidirectional:un,CobbAngle:vn,Angle:fn,Length:Fn,CircleROI:Tn,EllipticalROI:wn,RectangleROI:An,ArrowAnnotate:tn,Probe:Hn,PlanarFreehandROI:Gn,UltrasoundDirectional:$n,MeasurementReport:Wt,CodeScheme:Ut,CORNERSTONE_3D_TAG:kt},vr={Segmentation:a},Sr={ParametricMap:i},yr={RTSS:o},Ir=O.p.Colors,Tr=O.p.BitArray;function Dr(e){var t=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;switch(t){case 1:return Math.abs(e);case 2:return Math.sqrt(e[0]*e[0]+e[1]*e[1]);case 3:return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);default:for(var n=0,r=0;r<t;r++)n+=e[r]*e[r];return Math.sqrt(n)}}(e);return 0!==t&&(e[0]/=t,e[1]/=t,e[2]/=t),t}var Rr=function(){return g((function e(){f(this,e)}),null,[{key:"generateSegments",value:function(e){"Array"!==e.SegmentSequence.constructor.name&&(e.SegmentSequence=[e.SegmentSequence]),e.SegmentSequence.forEach((function(e){var t,n,r=(t=e.RecommendedDisplayCIELabValue,(n=Ir.dicomlab2RGB(t).map((function(e){return Math.round(255*e)}))).push(255),n);segments[e.SegmentNumber]={color:r,functionalGroups:[],offset:null,size:null,pixelData:null}})),e.PerFrameFunctionalGroupsSequence.forEach((function(e){var t=e.SegmentIdentificationSequence.ReferencedSegmentNumber;segments[t].functionalGroups.push(e)}));var t=Math.ceil(e.Rows*e.Columns/8),n=0;return Object.keys(segments).forEach((function(r){var a=segments[r];a.numberOfFrames=a.functionalGroups.length,a.size=a.numberOfFrames*t,a.offset=n,n=a.offset+a.size;var i=e.PixelData.slice(a.offset,n);a.pixelData=Tr.unpack(i);var o=function(e,t){var n={},r=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,a=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,i=t[0],o=t[t.length-1],u=i.PlanePositionSequence.ImagePositionPatient.map(Number),s=o.PlanePositionSequence.ImagePositionPatient.map(Number);n.origin=u,n.spacing=[r.PixelSpacing[1],r.PixelSpacing[0],r.SpacingBetweenSlices].map(Number),n.dimensions=[e.Columns,e.Rows,t.length].map(Number);var c,l,d,f,p,g,m=a.ImageOrientationPatient.map(Number),h=m.slice(0,3),v=m.slice(3,6);return n.planeNormal=[],c=h,l=v,d=n.planeNormal,f=c[1]*l[2]-c[2]*l[1],p=c[2]*l[0]-c[0]*l[2],g=c[0]*l[1]-c[1]*l[0],d[0]=f,d[1]=p,d[2]=g,n.sliceStep=[],function(e,t,n){n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2]}(s,u,n.sliceStep),Dr(n.sliceStep),n.direction=h.concat(v).concat(n.sliceStep),n}(e,a.functionalGroups);a.geometry=o})),segments}}])}(),Or={Cornerstone:At,Cornerstone3D:hr},Cr={Cornerstone:Nt,Cornerstone3D:vr,VTKjs:{Segmentation:Rr}},br={Cornerstone:qt,Cornerstone3D:Sr},xr={Cornerstone3D:yr}},26337:e=>{"use strict";e.exports=function(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=n;return t}},11604:e=>{e.exports=function(e){return null!=e&&null!=e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}},3293:(e,t,n)=>{var r=n(26337),a=n(11604),i="undefined"!=typeof Float64Array;function o(e,t){return e[0]-t[0]}function u(){var e,t=this.stride,n=new Array(t.length);for(e=0;e<n.length;++e)n[e]=[Math.abs(t[e]),e];n.sort(o);var r=new Array(n.length);for(e=0;e<r.length;++e)r[e]=n[e][1];return r}function s(e,t){var n=["View",t,"d",e].join("");t<0&&(n="View_Nil"+e);var a="generic"===e;if(-1===t){var i="function "+n+"(a){this.data=a;};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+n+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+n+"(a){return new "+n+"(a);}";return new Function(i)()}if(0===t){i="function "+n+"(a,d) {this.data = a;this.offset = d};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+n+"_copy() {return new "+n+"(this.data,this.offset)};proto.pick=function "+n+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+n+"_get(){return "+(a?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+n+"_set(v){return "+(a?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+n+"(a,b,c,d){return new "+n+"(a,d)}";return new Function("TrivialArray",i)(c[e][0])}i=["'use strict'"];var o=r(t),s=o.map((function(e){return"i"+e})),l="this.offset+"+o.map((function(e){return"this.stride["+e+"]*i"+e})).join("+"),d=o.map((function(e){return"b"+e})).join(","),f=o.map((function(e){return"c"+e})).join(",");i.push("function "+n+"(a,"+d+","+f+",d){this.data=a","this.shape=["+d+"]","this.stride=["+f+"]","this.offset=d|0}","var proto="+n+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),i.push("Object.defineProperty(proto,'size',{get:function "+n+"_size(){return "+o.map((function(e){return"this.shape["+e+"]"})).join("*"),"}})"),1===t?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),t<4?(i.push("function "+n+"_order(){"),2===t?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===t&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+n+"_set("+s.join(",")+",v){"),a?i.push("return this.data.set("+l+",v)}"):i.push("return this.data["+l+"]=v}"),i.push("proto.get=function "+n+"_get("+s.join(",")+"){"),a?i.push("return this.data.get("+l+")}"):i.push("return this.data["+l+"]}"),i.push("proto.index=function "+n+"_index(",s.join(),"){return "+l+"}"),i.push("proto.hi=function "+n+"_hi("+s.join(",")+"){return new "+n+"(this.data,"+o.map((function(e){return["(typeof i",e,"!=='number'||i",e,"<0)?this.shape[",e,"]:i",e,"|0"].join("")})).join(",")+","+o.map((function(e){return"this.stride["+e+"]"})).join(",")+",this.offset)}");var p=o.map((function(e){return"a"+e+"=this.shape["+e+"]"})),g=o.map((function(e){return"c"+e+"=this.stride["+e+"]"}));i.push("proto.lo=function "+n+"_lo("+s.join(",")+"){var b=this.offset,d=0,"+p.join(",")+","+g.join(","));for(var m=0;m<t;++m)i.push("if(typeof i"+m+"==='number'&&i"+m+">=0){d=i"+m+"|0;b+=c"+m+"*d;a"+m+"-=d}");i.push("return new "+n+"(this.data,"+o.map((function(e){return"a"+e})).join(",")+","+o.map((function(e){return"c"+e})).join(",")+",b)}"),i.push("proto.step=function "+n+"_step("+s.join(",")+"){var "+o.map((function(e){return"a"+e+"=this.shape["+e+"]"})).join(",")+","+o.map((function(e){return"b"+e+"=this.stride["+e+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(m=0;m<t;++m)i.push("if(typeof i"+m+"==='number'){d=i"+m+"|0;if(d<0){c+=b"+m+"*(a"+m+"-1);a"+m+"=ceil(-a"+m+"/d)}else{a"+m+"=ceil(a"+m+"/d)}b"+m+"*=d}");i.push("return new "+n+"(this.data,"+o.map((function(e){return"a"+e})).join(",")+","+o.map((function(e){return"b"+e})).join(",")+",c)}");var h=new Array(t),v=new Array(t);for(m=0;m<t;++m)h[m]="a[i"+m+"]",v[m]="b[i"+m+"]";i.push("proto.transpose=function "+n+"_transpose("+s+"){"+s.map((function(e,t){return e+"=("+e+"===undefined?"+t+":"+e+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+n+"(this.data,"+h.join(",")+","+v.join(",")+",this.offset)}"),i.push("proto.pick=function "+n+"_pick("+s+"){var a=[],b=[],c=this.offset");for(m=0;m<t;++m)i.push("if(typeof i"+m+"==='number'&&i"+m+">=0){c=(c+this.stride["+m+"]*i"+m+")|0}else{a.push(this.shape["+m+"]);b.push(this.stride["+m+"])}");return i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+n+"(data,shape,stride,offset){return new "+n+"(data,"+o.map((function(e){return"shape["+e+"]"})).join(",")+","+o.map((function(e){return"stride["+e+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",i.join("\n"))(c[e],u)}var c={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};e.exports=function(e,t,n,r){if(void 0===e)return(0,c.array[0])([]);"number"==typeof e&&(e=[e]),void 0===t&&(t=[e.length]);var o=t.length;if(void 0===n){n=new Array(o);for(var u=o-1,l=1;u>=0;--u)n[u]=l,l*=t[u]}if(void 0===r){r=0;for(u=0;u<o;++u)n[u]<0&&(r-=(t[u]-1)*n[u])}for(var d=function(e){if(a(e))return"buffer";if(i)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}(e),f=c[d];f.length<=o+1;)f.push(s(d,f.length-1));return(0,f[o+1])(e,t,n,r)}}}]);
//# sourceMappingURL=3970.bundle.ca01d74989f7a90be709.js.map