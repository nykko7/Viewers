"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5687],{74137:(e,n,t)=>{t.d(n,{Ay:()=>c,bY:()=>r,n7:()=>s,sh:()=>i});var o=t(33970);const{CodeScheme:a}=o.QX.Cornerstone3D,i={POINT:"POINT",MULTIPOINT:"MULTIPOINT",POLYLINE:"POLYLINE",CIRCLE:"CIRCLE",ELLIPSE:"ELLIPSE"},s={ImagingMeasurementReport:"126000",ImageLibrary:"111028",ImagingMeasurements:"126010",MeasurementGroup:"125007",ImageLibraryGroup:"126200",TrackingUniqueIdentifier:"112040",TrackingIdentifier:"112039",Finding:"121071",FindingSite:"G-C0E3",FindingSiteSCT:"363698007"},r={SRT:"SRT",SCT:"SCT",CornerstoneCodeSchemes:[a.CodingSchemeDesignator,"CST4"]},c={CodeNameCodeSequenceValues:s,CodingSchemeDesignators:r,RelationshipType:{INFERRED_FROM:"INFERRED FROM",CONTAINS:"CONTAINS"},SCOORDTypes:i}},85687:(e,n,t)=>{t.r(n),t.d(n,{Enums:()=>d.Ay,createReferencedImageDisplaySet:()=>oe.A,default:()=>re,hydrateStructuredReport:()=>te.A,srProtocol:()=>B,toolNames:()=>m});var o=t(86326),a=t(29463),i=t(11185),s=t(33970),r=t(55139),c=t(81985),l=t(3823),d=t(74137);const u=1e-4,S=({GraphicData:e,ValueType:n,imageId:t})=>{const o=[];if("SCOORD3D"===n)for(let n=0;n<e.length;n+=3)o.push([e[n],e[n+1],e[n+2]]);else for(let n=0;n<e.length;n+=2){const a=c.utilities.imageToWorldCoords(t,[e[n],e[n+1]]);o.push(a)}return o};const g=function({GraphicType:e,GraphicData:n,ValueType:t,imageId:o}){let a=[];switch(e){case d.sh.POINT:case d.sh.MULTIPOINT:case d.sh.POLYLINE:a=S({GraphicData:n,ValueType:t,imageId:o});break;case d.sh.CIRCLE:{const e=S({GraphicData:n,ValueType:t,imageId:o}),i=e[0],s=e[1],r=l.eR.distance(i,s),d=c.metaData.get("imagePlaneModule",o);if(!d)throw new Error("No imagePlaneModule found");const{columnCosines:u,rowCosines:g}=d,m=l.eR.create();l.eR.scaleAndAdd(m,i,u,r);const p=l.eR.create();l.eR.scaleAndAdd(p,i,u,-r);const f=l.eR.create();l.eR.scaleAndAdd(f,i,g,r);const I=l.eR.create();l.eR.scaleAndAdd(I,i,g,-r),a=[m,p,f,I];break}case d.sh.ELLIPSE:{const e=S({GraphicData:n,ValueType:t,imageId:o}),i=l.eR.fromValues(...e[0]),s=l.eR.fromValues(...e[1]),r=l.eR.fromValues(...e[2]),d=l.eR.fromValues(...e[3]),g=l.eR.create();l.eR.sub(g,s,i),l.eR.normalize(g,g);const m=l.eR.create();l.eR.sub(m,d,r),l.eR.normalize(m,m);const p=c.metaData.get("imagePlaneModule",o);if(!p)throw new Error("imageId does not have imagePlaneModule metadata");const{columnCosines:f}=p,I=l.eR.fromValues(...f),h=Math.abs(l.eR.dot(I,g)),R=Math.abs(l.eR.dot(I,m)),C=Math.abs(h),T=Math.abs(R);a=[],Math.abs(C-1)<u?a=[e[0],e[1],e[2],e[3]]:Math.abs(T-1)<u?a=[e[2],e[3],e[0],e[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");break}default:console.warn("Unsupported GraphicType:",e)}return a},m={DICOMSRDisplay:"DICOMSRDisplay",SRLength:"SRLength",SRBidirectional:"SRBidirectional",SREllipticalROI:"SREllipticalROI",SRCircleROI:"SRCircleROI",SRArrowAnnotate:"SRArrowAnnotate",SRAngle:"SRAngle",SRCobbAngle:"SRCobbAngle",SRRectangleROI:"SRRectangleROI",SRPlanarFreehandROI:"SRPlanarFreehandROI",SRSCOORD3DPoint:"SRSCOORD3DPoint"};function p(e,n,t){let o=m.DICOMSRDisplay;const a=e.coords.reduce(((e,t)=>(e[t.GraphicType]=e[t.GraphicType]||[],e[t.GraphicType].push(g({...t,imageId:n})),e)),{}),{TrackingUniqueIdentifier:i}=e,{ValueType:s,GraphicType:l}=e.coords[0],d=a[l];let u=null;if(n){const e=c.metaData.get("imagePlaneModule",n);u=e?.frameOfReferenceUID}"SCOORD3D"===s&&(o=m.SRSCOORD3DPoint,u=e.coords[0].ReferencedFrameOfReferenceSequence);const S={annotationUID:i,highlighted:!1,isLocked:!1,invalidated:!1,metadata:{toolName:o,valueType:s,graphicType:l,FrameOfReferenceUID:u,referencedImageId:n},data:{label:e.labels?.[0]?.value||void 0,displayText:e.displayText||void 0,handles:{textBox:e.textBox??{},points:d[0]},cachedStats:{},frameNumber:t,renderableData:a,TrackingUniqueIdentifier:i,labels:e.labels}};r.annotation.state.addAnnotation(S),console.debug("Adding SR annotation:",S)}const f=s.QX.Cornerstone3D.MeasurementReport.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,I=["cornerstoneTools@^4.0.0"],h=s.QX.Cornerstone3D.CORNERSTONE_3D_TAG;const R=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-sr"}').UU,C="dicom-sr",T=`${R}.sopClassHandlerModule.${C}`,O="dicom-sr-3d",D=`${R}.sopClassHandlerModule.${O}`,{sopClassDictionary:E}=a.Wp,{CORNERSTONE_3D_TOOLS_SOURCE_NAME:y,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:N}=i.Enums,{ImageSet:U,MetadataProvider:b}=a.Ly,{CodeScheme:w}=s.QX.Cornerstone3D,M=[E.BasicTextSR,E.EnhancedSR,E.ComprehensiveSR],v=(e,n)=>{n.forEach((n=>{if(n.StudyInstanceUID!==e)throw console.warn("Not all instances have the same UID",e,n),new Error(`Instances ${n.SOPInstanceUID} does not belong to ${e}`)}))};function P(e,n){return this.instances.push(...e),a.Wp.sortStudyInstances(this.instances),this.instance=this.instances[this.instances.length-1],this.isLoaded=!1,this}function x(e,n,t){if(!e||!e.length)throw new Error("No instances were provided");a.Wp.sortStudyInstances(e);const o=e[e.length-1],{StudyInstanceUID:i,SeriesInstanceUID:s,SOPInstanceUID:r,SeriesDescription:c,SeriesNumber:l,SeriesDate:u,ConceptNameCodeSequence:S,SOPClassUID:g}=o;v(o.StudyInstanceUID,e);const m=g===E.Comprehensive3DSR,p=S?.CodeValue===d.n7.ImagingMeasurementReport,R={Modality:"SR",displaySetInstanceUID:a.Wp.guid(),SeriesDescription:c,SeriesNumber:l,SeriesDate:u,SOPInstanceUID:r,SeriesInstanceUID:s,StudyInstanceUID:i,SOPClassHandlerId:m?D:T,SOPClassUID:g,instances:e,referencedImages:null,measurements:null,isDerivedDisplaySet:!0,isLoaded:!1,isImagingMeasurementReport:p,sopClassUids:M,instance:o,addInstances:P};return R.load=()=>async function(e,n,t){const{displaySetService:o,measurementService:a}=n.services,i=t.getDataSources(),s=i[0],{ContentSequence:r}=e.instance;async function c(n,t=null,o=null){for(const a in n)if("object"==typeof n[a]&&null!==n[a])await c(n[a],n,a);else if(Array.isArray(n[a]))await Promise.all(n[a].map((e=>c(e,n,a))));else if("BulkDataURI"===a){const i=await s.retrieve.bulkDataURI({BulkDataURI:n[a],StudyInstanceUID:e.instance.StudyInstanceUID,SeriesInstanceUID:e.instance.SeriesInstanceUID,SOPInstanceUID:e.instance.SOPInstanceUID});t&&o&&(t[o]=new Float32Array(i))}}!0!==e.isLoaded&&await c(r);e.isImagingMeasurementReport?(e.referencedImages=function(e){const n=e.find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.ImageLibrary));if(!n)return[];const t=F(n.ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.ImageLibraryGroup));if(!t)return[];const o=[];return F(t.ContentSequence).forEach((e=>{const{ReferencedSOPSequence:n}=e;if(n)for(const e of F(n))if(e.ReferencedSOPClassUID){const{ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t}=e;o.push({ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t})}})),o}(r),e.measurements=function(e){const n=e.find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.ImagingMeasurements));if(!n)return[];const t=function(e){const n={};return e.forEach((e=>{const t=F(e.ContentSequence),o=t.find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.TrackingUniqueIdentifier));o||console.warn("No Tracking Unique Identifier, skipping ambiguous measurement.");const a=o.UID;void 0===n[a]?n[a]=[...t]:t.forEach((e=>{e.ConceptNameCodeSequence.CodeValue!==d.n7.TrackingUniqueIdentifier&&n[a].push(e)}))})),n}(F(n.ContentSequence).filter((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.MeasurementGroup))),o=[];return Object.keys(t).forEach((e=>{const n=function(e){if(e.some((e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)))return function(e){const n=e.find((e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)),t=e.find((e=>"UIDREF"===e.ValueType)),o=e.find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.TrackingIdentifier));if(!n)return void console.warn(`graphic ValueType ${n.ValueType} not currently supported, skipping annotation.`);const a=e.filter((e=>"NUM"===e.ValueType)),i={loaded:!1,labels:[],coords:[V(n)],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:o.TextValue};a.forEach((e=>{const{ConceptNameCodeSequence:n,MeasuredValueSequence:t}=e;t&&i.labels.push(k(n,t))}));const s=e.filter((e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===d.bY.SCT&&e.ConceptNameCodeSequence.CodeValue===d.n7.FindingSiteSCT));s.length&&i.labels.push({label:d.n7.FindingSiteSCT,value:s[0].ConceptCodeSequence.CodeMeaning});return i}(e);return function(e){const n=e.filter((e=>"NUM"===e.ValueType)),t=e.find((e=>"UIDREF"===e.ValueType)),o=e.find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.TrackingIdentifier)),a=e.find((e=>e.ConceptNameCodeSequence.CodeValue===d.n7.Finding)),i=e.filter((e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===d.bY.SRT&&e.ConceptNameCodeSequence.CodeValue===d.n7.FindingSite)),s={loaded:!1,labels:[],coords:[],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:o.TextValue};a&&d.bY.CornerstoneCodeSchemes.includes(a.ConceptCodeSequence.CodingSchemeDesignator)&&a.ConceptCodeSequence.CodeValue===w.codeValues.CORNERSTONEFREETEXT&&s.labels.push({label:w.codeValues.CORNERSTONEFREETEXT,value:a.ConceptCodeSequence.CodeMeaning});if(i.length){const e=i.find((e=>d.bY.CornerstoneCodeSchemes.includes(e.ConceptCodeSequence.CodingSchemeDesignator)&&e.ConceptCodeSequence.CodeValue===w.codeValues.CORNERSTONEFREETEXT));e&&s.labels.push({label:w.codeValues.CORNERSTONEFREETEXT,value:e.ConceptCodeSequence.CodeMeaning})}return n.forEach((e=>{const{ConceptNameCodeSequence:n,ContentSequence:t,MeasuredValueSequence:o}=e,{ValueType:a}=t;if("SCOORD"===!a)return void console.warn(`Graphic ${a} not currently supported, skipping annotation.`);const i=V(t);i&&s.coords.push(i),o&&s.labels.push(k(n,o))})),s}(e)}(t[e]);n&&o.push(n)})),o}(r)):(e.referencedImages=[],e.measurements=[]);const l=a.getSourceMappings(y,N);e.isHydrated=!1,e.isRehydratable=function(e,n){if(!n||!n.length)return!1;const t=n.map((e=>e.annotationType)),{measurements:o}=e,a=Object.keys(f).filter((e=>"function"==typeof f[e].isValidCornerstoneTrackingIdentifier)),i=[];a.forEach((e=>{t.includes(e)&&i.push(f[e])}));for(let e=0;e<o.length;e++){const{TrackingIdentifier:n}=o[e]||{};if(i.some((e=>{let[t,o]=n.split(":");I.includes(t)&&(t=h);const a=`${t}:${o}`;return e.isValidCornerstoneTrackingIdentifier(a)})))return!0;console.log("Measurement is not rehydratable",n,o[e])}return console.log("No measurements found which were rehydratable"),!1}(e,l),e.isLoaded=!0,o.activeDisplaySets.forEach((t=>{A(e,t,s,n)})),o.subscribe(o.EVENTS.DISPLAY_SETS_ADDED,(t=>{const{displaySetsAdded:o}=t;o.forEach((t=>{A(e,t,s,n)}))}))}(R,n,t),[R]}function A(e,n,t,o){const{customizationService:a}=o.services,i=e.measurements.filter((e=>!1===e.loaded));if(0===i.length||!(n instanceof U)||n.unsupported)return;const s=new Map,r=t.getImageIdsForDisplaySet(n);for(const e of r){const{SOPInstanceUID:n,frameNumber:t}=b.getUIDsFromImageID(e),o=`${n}:${t||1}`;s.set(o,e)}if(!i?.length)return;const c=e.SOPClassUID===E.Comprehensive3DSR;for(let t=i.length-1;t>=0;t--){let o=i[t];const r=a.getModeCustomization("onBeforeSRAddMeasurement")?.value;if("function"==typeof r&&(o=r({measurement:o,StudyInstanceUID:e.StudyInstanceUID,SeriesInstanceUID:e.SeriesInstanceUID})),c){p(o,null,null),o.loaded=!0;continue}const l=o.coords[0].ReferencedSOPSequence;if(!l)continue;const{ReferencedSOPInstanceUID:d}=l,u=l.ReferencedFrameNumber||1,S=`${d}:${u}`,g=s.get(S);g&&L(o,d,u)&&(p(o,g,u),o.loaded=!0,o.imageId=g,o.displaySetInstanceUID=n.displaySetInstanceUID,o.ReferencedSOPInstanceUID=d,o.frameNumber=u,i.splice(t,1))}}function L(e,n,t){const{coords:o}=e,a=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence?.ReferencedFrameNumber||1;if(t&&Number(t)!==Number(a))return!1;for(let e=0;e<o.length;e++){const t=o[e],{ReferencedSOPInstanceUID:a}=t.ReferencedSOPSequence;if(a===n)return!0}return!1}const V=e=>{const{ValueType:n,GraphicType:t,GraphicData:o}=e,a={ValueType:n,GraphicType:t,GraphicData:o};return a.ReferencedSOPSequence=e.ContentSequence?.ReferencedSOPSequence,a.ReferencedFrameOfReferenceSequence=e.ReferencedFrameOfReferenceUID||e.ContentSequence?.ReferencedFrameOfReferenceSequence,a};function k(e,n){const{CodeMeaning:t}=e,{NumericValue:o,MeasurementUnitsCodeSequence:a}=n,{CodeValue:i}=a;return{label:t,value:`${o?Number(o).toFixed(2):""} ${i}`}}function F(e){return e?Array.isArray(e)?e:[e]:[]}const q=function({servicesManager:e,extensionManager:n}){const t=t=>x(t,e,n);return[{name:C,sopClassUids:M,getDisplaySetsFromSeries:t},{name:O,sopClassUids:[E.Comprehensive3DSR],getDisplaySetsFromSeries:t}]},B={id:"@ohif/sr",name:"SR Key Images",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{srDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SR"}}]}},stages:[{name:"SR Key Images",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId"}]}]}]};var _=t(5842);const{log:G}=a.Ay;const $=function(e,n){const t={};function o(o,a){if(!o.metadata?.referencedImageId)return void G.warn(`[DICOMSR] No referencedImageId found for ${a} ${o.id}`);const i=o.metadata.referencedImageId;t[i]||(t[i]={});const s=t[i];s[a]||(s[a]={data:[]});const r=e.find((e=>e.uid===o.annotationUID)),c=s[a].data;let{finding:l}=r;const d=[];r.label&&(n.includes(a)?l={CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:r.label}:d.push({CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:r.label})),r.findingSites&&d.push(...r.findingSites);const u=Object.assign({},o,{finding:l,findingSites:d});c.push(u)}const a=e.map((e=>e.uid)).slice(),i=r.annotation.state.getAnnotationManager(),s=i.getFramesOfReference();for(let e=0;e<s.length;e++){const n=s[e],r=i.getAnnotations(n),c=Object.keys(r);for(let e=0;e<c.length;e++){const n=c[e],i=r[n];if(i)for(let e=0;e<i.length;e++){const s=i[e],r=a.findIndex((e=>e===s.annotationUID));if(-1!==r&&(o(s,n),a.splice(r,1),!a.length))return t}}}return t},{MeasurementReport:W}=s.QX.Cornerstone3D,{log:H}=a.Ay,Y=e=>{const{servicesManager:n}=e,{customizationService:t}=n.services,o={downloadReport:({measurementData:e,additionalFindingTypes:n,options:t={}})=>{const a=o.generateReport(e,n,t),i=_.Ay.data.datasetToBlob(a),s=URL.createObjectURL(i);window.location.assign(s)},storeMeasurements:async({measurementData:e,dataSource:n,additionalFindingTypes:o,options:i={}})=>{if(H.info("[DICOMSR] storeMeasurements"),!n||!n.store||!n.store.dicom)return H.error("[DICOMSR] datasource has no dataSource.store.dicom endpoint!"),Promise.reject({});try{const s=((e,n,t={})=>{const o=$(e,n),a=W.generateReport(o,c.metaData,c.utilities.worldToImageCoords,t),{dataset:i}=a;return void 0===i.SpecificCharacterSet&&(i.SpecificCharacterSet="ISO_IR 192"),i})(e,o,i),{StudyInstanceUID:r,ContentSequence:l}=s;if(!l?.[4].ContentSequence?.length)throw console.log("naturalizedReport missing imaging content",s),new Error("Invalid report, no content");const d=t.getModeCustomization("onBeforeDicomStore")?.value;let u;return"function"==typeof d&&(u=d({measurementData:e,naturalizedReport:s})),await n.store.dicom(s,null,u),r&&n.deleteStudyMetadataPromise(r),a.H8.addInstances([s],!0),s}catch(e){throw console.warn(e),H.error(`[DICOMSR] Error while saving the measurements: ${e.message}`),new Error(e.message||"Error while saving the measurements.")}}},i={downloadReport:{commandFn:o.downloadReport},storeMeasurements:{commandFn:o.storeMeasurements}};return{actions:o,definitions:i,defaultContext:"CORNERSTONE_STRUCTURED_REPORT"}};var j=t(76654);class z extends r.AnnotationTool{constructor(e={},n={configuration:{}}){super(e,n),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:o}=t;let a=r.annotation.state.getAnnotations(this.getToolName(),o);if(!a?.length)return;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return;const i=(0,j.eF)(o),{activeIndex:s,trackingUniqueIdentifiers:c}=i,l=c[s],u=a.filter((e=>c.includes(e.data?.TrackingUniqueIdentifier)));if(!t._actors?.size)return;const S={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},{style:g}=r.annotation.config;for(let e=0;e<u.length;e++){const o=u[e],a=o.annotationUID,{renderableData:i,TrackingUniqueIdentifier:s}=o.data,{referencedImageId:c}=o.metadata;S.annotationUID=a;const m=g.getToolGroupToolStyles(this.toolGroupId)[this.getToolName()],p=this.getStyle("lineWidth",S,o),f=this.getStyle("lineDash",S,o),I={color:s===l?"rgb(0, 255, 0)":this.getStyle("color",S,o),lineDash:f,lineWidth:p,...m};Object.keys(i).forEach((e=>{const s=i[e];let l,u;switch(e){case d.sh.POINT:l=this.renderPoint;break;case d.sh.MULTIPOINT:l=this.renderMultipoint;break;case d.sh.POLYLINE:l=this.renderPolyLine;break;case d.sh.CIRCLE:l=this.renderEllipse;break;case d.sh.ELLIPSE:l=this.renderEllipse,u=r.utilities.math.ellipse.getCanvasEllipseCorners;break;default:throw new Error(`Unsupported GraphicType: ${e}`)}const g=l(n,t,s,a,c,I);this.renderTextBox(n,t,g,u,o,S,I)}))}}}_getTextBoxLinesFromLabels(e){const n=Math.min(e.length,5),t=[];for(let o=0;o<n;o++){const n=e[o];t.push(`${Q(n.label)}: ${n.value}`)}return t}renderPolyLine(e,n,t,o,a,i){const s={color:i.color,width:i.lineWidth,lineDash:i.lineDash};let c=[];return t.map(((t,a)=>{const i=t.map((e=>n.worldToCanvas(e))),l=`${a}`;2===i.length?r.drawing.drawLine(e,o,l,i[0],i[1],s):r.drawing.drawPolyline(e,o,l,i,s),c=c.concat(i)})),c}renderMultipoint(e,n,t,o,a,i){let s;t.map(((t,a)=>{s=t.map((e=>n.worldToCanvas(e)));r.drawing.drawHandles(e,o,"0",s,{color:i.color})}))}renderPoint(e,n,t,o,a,i){const s=[];return t.map(((t,l)=>{const d=t[0];if(s.push(n.worldToCanvas(d)),void 0!==t[1])s.push(n.worldToCanvas(t[1]));else{const e=c.metaData.get("imagePixelModule",a);let t=10,o=10;if(e){const{columns:n,rows:a}=e;t=n/10,o=a/10}const i=c.utilities.worldToImageCoords(a,d),r=c.utilities.imageToWorldCoords(a,[i[0]+t,i[1]+o]);s.push(n.worldToCanvas(r))}const u=`${l}`;r.drawing.drawArrow(e,o,u,s[1],s[0],{color:i.color,width:i.lineWidth})})),s}renderEllipse(e,n,t,o,a,i){let s;return t.map(((t,a)=>{if(0===t.length)return;const c=t,l=n.getRotation();let d;s=c.map((e=>n.worldToCanvas(e))),d=90==l||270==l?r.utilities.math.ellipse.getCanvasEllipseCorners([s[2],s[3],s[0],s[1]]):r.utilities.math.ellipse.getCanvasEllipseCorners(s);const u=`${a}`;r.drawing.drawEllipse(e,o,u,d[0],d[1],{color:i.color,width:i.lineWidth,lineDash:i.lineDash})})),s}renderTextBox(e,n,t,o,a,i,s={}){if(!t||!a)return;const{annotationUID:c,data:l={}}=a,{labels:d}=l,{color:u}=s;let S=t;"function"==typeof o&&(S=o(t));const g=this._getTextBoxLinesFromLabels(d),m=r.utilities.drawing.getTextBoxCoordsCanvas(S);a.data?.handles?.textBox?.worldPosition||(a.data.handles.textBox.worldPosition=n.canvasToWorld(m));const p=n.worldToCanvas(a.data.handles.textBox.worldPosition),f=this.getLinkedTextBoxStyle(i,a),I=r.drawing.drawLinkedTextBox(e,c,"1",g,p,t,{},{...f,color:u}),{x:h,y:R,width:C,height:T}=I;a.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([h,R]),topRight:n.canvasToWorld([h+C,R]),bottomLeft:n.canvasToWorld([h,R+T]),bottomRight:n.canvasToWorld([h+C,R+T])}}}z.toolName=m.DICOMSRDisplay;const X={"Short Axis":"W: ","Long Axis":"L: ",AREA:"Area: ",Length:"",CORNERSTONEFREETEXT:""};function Q(e){const n=X[e];return void 0!==n?n:e}class J extends r.AnnotationDisplayTool{constructor(e={},n={configuration:{}}){super(e,n),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:o}=t,a=r.annotation.state.getAnnotations(this.getToolName(),o);if(!a?.length)return;const i=a;if(!t._actors?.size)return;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<i.length;e++){const o=i[e],a=o.annotationUID,{renderableData:c}=o.data,{POINT:l}=c;s.annotationUID=a;const d=this.getStyle("lineWidth",s,o),u=this.getStyle("lineDash",s,o),S={color:this.getStyle("color",s,o),lineDash:u,lineWidth:d},g=l[0][0];if(!t.isReferenceViewable({FrameOfReferenceUID:o.metadata.FrameOfReferenceUID,cameraFocalPoint:g},{asNearbyProjection:!0}))continue;const m=t.worldToCanvas(g),p=[m,[m[0]+20,m[1]+20]];r.drawing.drawArrow(n,a,"1",p[1],p[0],{color:S.color,width:S.lineWidth}),this.renderTextBox(n,t,p,o,s,S)}}}_getTextBoxLinesFromLabels(e){Math.min(e.length,5);return[]}renderTextBox(e,n,t,o,a,i={}){if(!t||!o)return;const{annotationUID:s,data:c={}}=o,{labels:l}=c,d=[];for(const e of l)"363698007"===e.label&&d.push(`Finding Site: ${e.value}`);const{color:u}=i,S=t,g=r.utilities.drawing.getTextBoxCoordsCanvas(S);o.data?.handles?.textBox?.worldPosition||(o.data.handles.textBox.worldPosition=n.canvasToWorld(g));const m=n.worldToCanvas(o.data.handles.textBox.worldPosition),p=this.getLinkedTextBoxStyle(a,o),f=r.drawing.drawLinkedTextBox(e,s,"1",d,m,t,{},{...p,color:u}),{x:I,y:h,width:R,height:C}=f;o.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([I,h]),topRight:n.canvasToWorld([I+R,h]),bottomLeft:n.canvasToWorld([I,h+C]),bottomRight:n.canvasToWorld([I+R,h+C])}}getLinkedTextBoxStyle(e,n){return{visibility:this.getStyle("textBoxVisibility",e,n),fontFamily:this.getStyle("textBoxFontFamily",e,n),fontSize:this.getStyle("textBoxFontSize",e,n),color:this.getStyle("textBoxColor",e,n),shadow:this.getStyle("textBoxShadow",e,n),background:this.getStyle("textBoxBackground",e,n),lineWidth:this.getStyle("textBoxLinkLineWidth",e,n),lineDash:this.getStyle("textBoxLinkLineDash",e,n)}}}J.toolName=m.SRSCOORD3DPoint;const K={toAnnotation:e=>{},toMeasurement:(e,n,t,o,a)=>{const{annotation:i}=e,{metadata:s,data:r,annotationUID:c}=i;if(!s||!r)return console.warn("Probe tool: Missing metadata or data"),null;const{toolName:l}=s,{points:d}=r.handles,u=function(e){const{data:n}=e;if(!n)return[""];const{labels:t}=n,o=[];for(const e of t)"33636980076"===e.label&&o.push(`Finding Site: ${e.value}`);return o}(i);return{uid:c,points:d,metadata:s,toolName:s.toolName,label:r.label,displayText:u,data:r.cachedStats,type:o?.(l)??null}}};function Z(e,n,t={}){class o extends n{constructor(e,n){e.configuration=e.configuration?{...e.configuration,...t}:t,super(e,n)}}o.toolName=e,(0,r.addTool)(o)}const{CORNERSTONE_3D_TOOLS_SOURCE_NAME:ee,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:ne}=i.Enums;var te=t(22989),oe=t(92643);function ae(){return ae=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)({}).hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},ae.apply(null,arguments)}const ie=o.lazy((()=>t.e(2701).then(t.bind(t,62701)))),se=e=>o.createElement(o.Suspense,{fallback:o.createElement("div",null,"Loading...")},o.createElement(ie,e)),re={id:R,onModeEnter:function({servicesManager:e}){const{displaySetService:n}=e.services;[...n.getDisplaySetCache().values()].filter((e=>e.SOPClassHandlerId===T||e.SOPClassHandlerId===D)).forEach((e=>{e.isHydrated=!1}))},preRegistration:function({configuration:e={},servicesManager:n}){const{measurementService:t,cornerstoneViewportService:o}=n.services;Z(m.DICOMSRDisplay,z),Z(m.SRLength,r.LengthTool),Z(m.SRBidirectional,r.BidirectionalTool),Z(m.SREllipticalROI,r.EllipticalROITool),Z(m.SRCircleROI,r.CircleROITool),Z(m.SRArrowAnnotate,r.ArrowAnnotateTool),Z(m.SRAngle,r.AngleTool),Z(m.SRPlanarFreehandROI,r.PlanarFreehandROITool),Z(m.SRRectangleROI,r.RectangleROITool),Z(m.SRSCOORD3DPoint,J),Z(m.SRCobbAngle,r.CobbAngleTool);const i=t.getSource(ee,ne),{POINT:s}=t.VALUE_TYPES;t.addMapping(i,"SRSCOORD3DPoint",s,K.toAnnotation,K.toMeasurement);const l={lineDash:"4,4"};r.annotation.config.style.setToolGroupToolStyles("SRToolGroup",{[m.DICOMSRDisplay]:l,SRLength:l,SRBidirectional:l,SREllipticalROI:l,SRCircleROI:l,SRArrowAnnotate:l,SRCobbAngle:l,SRAngle:l,SRPlanarFreehandROI:l,SRRectangleROI:l,global:{}}),t.subscribe(a.C5.EVENTS.JUMP_TO_MEASUREMENT_LAYOUT,(({viewportId:e,measurement:n,isConsumed:t})=>{if(!t)try{const t=o.getCornerstoneViewport(e),{viewPlaneNormal:a}=t.getCamera(),i=r.utilities.getClosestImageIdForStackViewport(t,n.points[0],a),s=t.getImageIds().indexOf(i);c.utilities.jumpToSlice(t.element,{imageIndex:s})}catch(e){console.warn("Unable to jump to image based on measurement coordinate",e)}}))},getViewportModule:({servicesManager:e,extensionManager:n})=>[{name:"dicom-sr",component:t=>o.createElement(se,ae({servicesManager:e,extensionManager:n},t))}],getCommandsModule:Y,getSopClassHandlerModule:q,getUtilityModule:({servicesManager:e})=>[{name:"tools",exports:{toolNames:m}}]}},76654:(e,n,t)=>{t.d(n,{eF:()=>s,m1:()=>i});var o=t(81985);const a={TrackingUniqueIdentifier:null,trackingIdentifiersByViewportId:{}};function i(e,n,t=0){const i=(0,o.getEnabledElement)(e),{viewport:s}=i;a.trackingIdentifiersByViewportId[s.id]={trackingUniqueIdentifiers:n,activeIndex:t}}function s(e){const n=(0,o.getEnabledElement)(e),{viewport:t}=n;return a.trackingIdentifiersByViewportId[t.id]?a.trackingIdentifiersByViewportId[t.id]:{trackingUniqueIdentifiers:[]}}},92643:(e,n,t)=>{t.d(n,{A:()=>s});const o=t(29463).Ly.ImageSet,a=(e,n)=>{const{displaySetInstanceUID:t,ReferencedSOPInstanceUID:o}=e,a=n.getDisplaySetByUID(t);if(a.images)return a.images.find((e=>e.SOPInstanceUID===o))},i=(e,n)=>{const t=[],o={};for(const i of n.measurements){const{imageId:n}=i;if(!n)continue;if(o[n])continue;const s=a(i,e);s?(o[n]=s,t.push(s)):console.log("Measurement",i,"had no instances found")}return t},s=(e,n)=>{const t=i(e,n),a=new o(t),s=t[0];if(s)return a.setAttributes({displaySetInstanceUID:a.uid,SeriesDate:s.SeriesDate,SeriesTime:s.SeriesTime,SeriesInstanceUID:a.uid,StudyInstanceUID:s.StudyInstanceUID,SeriesNumber:s.SeriesNumber||0,SOPClassUID:s.SOPClassUID,SeriesDescription:`${n.SeriesDescription} KO ${n.instance.SeriesNumber}`,Modality:"KO",isMultiFrame:!1,numImageFrames:t.length,SOPClassHandlerId:"@ohif/extension-default.sopClassHandlerModule.stack",isReconstructable:!1,isCompositeStack:!0,madeInClient:!0,excludeFromThumbnailBrowser:!0,updateInstances:function(){this.images.splice(0,this.images.length,...i(e,n)),this.numImageFrames=this.images.length}}),e.addDisplaySets(a),a}},22989:(e,n,t)=>{t.d(n,{A:()=>h});var o=t(81985),a=t(29463),i=t(33970);const{CodeScheme:s}=i.QX.Cornerstone3D;var r=t(55139),c=t(11185);const{locking:l}=r.annotation,{guid:d}=a.Ay.utils,{MeasurementReport:u,CORNERSTONE_3D_TAG:S}=i.QX.Cornerstone3D,{CORNERSTONE_3D_TOOLS_SOURCE_NAME:g,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:m}=c.Enums,p=["cornerstoneTools@^4.0.0"],f=(e,n)=>{if(!n||"CORNERSTONEJS"===n.CodingSchemeDesignator)return;const t=`${n.CodingSchemeDesignator}:${n.CodeValue}`;return{...e[t],ref:t,...n,text:n.CodeMeaning}},I=(e,n)=>{if(!n||!n.length)return;const t=[];for(let o=0;o<n.length;o++){const a=f(e,n[o][0]||n[o]);a&&t.push(a)}return t.length&&t||void 0};function h({servicesManager:e,extensionManager:n,appConfig:t},i){const c=r.annotation.state.getAnnotationManager(),h=n.getActiveDataSource()[0],{measurementService:T,displaySetService:O,customizationService:D}=e.services,E=D.getCustomization("codingValues",{}),{disableEditing:y}=D.getCustomization("PanelMeasurement.disableEditing",{id:"default.disableEditing",disableEditing:!1}),N=O.getDisplaySetByUID(i),U=T.getSourceMappings(g,m);if(!U||!U.length)throw new Error("Attempting to hydrate measurements service when no mappings present. This shouldn't be reached.");const b=a.H8.getInstance(N.StudyInstanceUID,N.SeriesInstanceUID,N.SOPInstanceUID),w={},M={};N.measurements.forEach((e=>{const{ReferencedSOPInstanceUID:n,imageId:t,frameNumber:o}=e;w[n]||(w[n]=t,M[n]=[]),M[n][o]||(M[n][o]=t)}));const v=function(e){const n="Imaging Measurements",t="Measurement Group",o="Tracking Identifier",a=R(e.ContentSequence).find(C(n)),i=R(a.ContentSequence).filter(C(t)),s={},r=u.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,c=[];return Object.keys(r).forEach((e=>{c.push(r[e]),s[e]=[]})),i.forEach(((e,n)=>{const t=R(e.ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeMeaning===o)),a=t.TextValue;let[i,s]=a.split(":");p.includes(i)&&(i=S);const r=`${i}:${s}`;t.TextValue=r})),e}(b);let P=u.generateToolState(v,w,o.utilities.imageToWorldCoords,o.metaData);const x=D.getModeCustomization("onBeforeSRHydration")?.value;"function"==typeof x&&(P=x({storedMeasurementByAnnotationType:P,displaySet:N}));const A=U.map((e=>e.annotationType)),L={};Object.keys(P).forEach((e=>{A.includes(e)&&(L[e]=P[e])}));const V=[];let k;Object.keys(L).forEach((e=>{L[e].forEach((e=>{const n=e.annotation.data&&e.annotation.data.frameNumber||1,t=M[e.sopInstanceUid][n]||w[e.sopInstanceUid];V.includes(t)||V.push(t)}))}));const F=[];for(let e=0;e<V.length;e++){const n=V[e],{SeriesInstanceUID:t,StudyInstanceUID:a}=o.metaData.get("instance",n);F.includes(t)||F.push(t),k?k!==a&&console.warn("NO SUPPORT FOR SRs THAT HAVE MEASUREMENTS FROM MULTIPLE STUDIES."):k=a}return Object.keys(L).forEach((e=>{L[e].forEach((n=>{const t=n.annotation.data&&n.annotation.data.frameNumber||1,a=M[n.sopInstanceUid][t]||w[n.sopInstanceUid];n.uid=d();const i=o.metaData.get("instance",a),{FrameOfReferenceUID:r}=i,u={annotationUID:n.annotation.annotationUID,data:n.annotation.data,metadata:{toolName:e,referencedImageId:a,FrameOfReferenceUID:r}},S=T.getSource(g,m);u.data.label=function(e){const{findingSites:n=[],finding:t}=e;let o=n.find((e=>e.CodeValue===s.codeValues.CORNERSTONEFREETEXT));return o?o.CodeMeaning:t&&t.CodeValue===s.codeValues.CORNERSTONEFREETEXT?t.CodeMeaning:void 0}(n),u.data.finding=f(E,n.finding?.[0]),u.data.findingSites=I(E,n.findingSites),u.data.site=u.data.findingSites?.[0];const p=U.find((n=>n.annotationType===e)),R=T.addRawMeasurement(S,e,{annotation:u},p.toMeasurementSchema,h);if(y){const e=c.getAnnotation(R);l.setAnnotationLocked(e,!0)}V.includes(a)||V.push(a)}))})),N.isHydrated=!0,{StudyInstanceUID:k,SeriesInstanceUIDs:F}}const R=function(e){return Array.isArray(e)?e:[e]},C=e=>n=>n.ConceptNameCodeSequence.CodeMeaning===e}}]);
//# sourceMappingURL=5687.bundle.c5a7d2facc03d353e983.js.map