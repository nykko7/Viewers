/*! For license information please see 5717.bundle.b8aa8ab6825291a6bba0.js.LICENSE.txt */
(self.webpackChunk=self.webpackChunk||[]).push([[5717],{5057:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(53586),o=n(48080),a=n(92885),s=n(71209);function r(e,t){const n=e.image;if(!e.canvas||!e.image)return;const r=(0,i.A)();if(n.stats={lastGetPixelDataTime:-1,lastStoredPixelDataToCanvasImageDataTime:-1,lastPutImageDataTime:-1,lastRenderTime:-1,lastLutGenerateTime:-1},n){let i=n.render;i||(i=e.viewport.colormap?s.l:n.color?o.f:a.j),i(e,t)}const l=(0,i.A)()-r;n.stats.lastRenderTime=l,e.invalid=!1,e.needsRedraw=!1}},7808:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(45354);function o(e,t){const n=new i.d;if(!e.viewport.displayedArea)return n;n.translate(e.canvas.width/2,e.canvas.height/2);const o=e.viewport.rotation;0!==o&&n.rotate(o*Math.PI/180);let a=e.viewport.scale,s=e.viewport.scale;const r=e.viewport.displayedArea.brhc.x-(e.viewport.displayedArea.tlhc.x-1),l=e.viewport.displayedArea.brhc.y-(e.viewport.displayedArea.tlhc.y-1);if("NONE"===e.viewport.displayedArea.presentationSizeMode)e.image.rowPixelSpacing<e.image.columnPixelSpacing?a*=e.image.columnPixelSpacing/e.image.rowPixelSpacing:e.image.columnPixelSpacing<e.image.rowPixelSpacing&&(s*=e.image.rowPixelSpacing/e.image.columnPixelSpacing);else if(a=e.viewport.displayedArea.columnPixelSpacing,s=e.viewport.displayedArea.rowPixelSpacing,"SCALE TO FIT"===e.viewport.displayedArea.presentationSizeMode){const t=e.canvas.height/(l*s),n=e.canvas.width/(r*a);a=s=Math.min(n,t),e.viewport.displayedArea.rowPixelSpacing<e.viewport.displayedArea.columnPixelSpacing?a*=e.viewport.displayedArea.columnPixelSpacing/e.viewport.displayedArea.rowPixelSpacing:e.viewport.displayedArea.columnPixelSpacing<e.viewport.displayedArea.rowPixelSpacing&&(s*=e.viewport.displayedArea.rowPixelSpacing/e.viewport.displayedArea.columnPixelSpacing)}return n.scale(a,s),0!==o&&n.rotate(-o*Math.PI/180),n.translate(e.viewport.translation.x,e.viewport.translation.y),0!==o&&n.rotate(o*Math.PI/180),void 0!==t&&n.scale(t,t),e.viewport.hflip&&n.scale(-1,1),e.viewport.vflip&&n.scale(1,-1),n.translate(-r/2,-l/2),n}},36931:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(12132),o=n(57162);function a(e,t,n,a){if(void 0===e)throw new Error("getDefaultViewport: parameter canvas must not be undefined");if(void 0===t)return(0,i.A)();const s=(0,o.A)(e,t,0).scaleFactor;let r;return"PT"===n&&t.isPreScaled?r={windowWidth:5,windowCenter:2.5}:void 0!==t.windowWidth&&void 0!==t.windowCenter&&(r={windowWidth:Array.isArray(t.windowWidth)?t.windowWidth[0]:t.windowWidth,windowCenter:Array.isArray(t.windowCenter)?t.windowCenter[0]:t.windowCenter}),{scale:s,translation:{x:0,y:0},voi:r,invert:t.invert,pixelReplication:!1,rotation:0,hflip:!1,vflip:!1,modalityLUT:t.modalityLUT,modality:n,voiLUT:t.voiLUT,colormap:void 0!==a?a:t.colormap,displayedArea:{tlhc:{x:1,y:1},brhc:{x:t.columns,y:t.rows},rowPixelSpacing:void 0===t.rowPixelSpacing?1:t.rowPixelSpacing,columnPixelSpacing:void 0===t.columnPixelSpacing?1:t.columnPixelSpacing,presentationSizeMode:"NONE"}}}},98834:(e,t,n)=>{"use strict";n.d(t,{ge:()=>r,x:()=>s,oI:()=>i.Ay,A7:()=>o.A});n(61640),n(92099);var i=n(30135),o=n(10809),a=n(46347);const s=async function(e,t,n,i=!1,o=!1){for(const t of n){const n=e.getViewport(t);if(!n)throw new Error(`Viewport with Id ${t} does not exist`);if(!(n instanceof a.A))return void console.warn(`Viewport with Id ${t} is not a BaseVolumeViewport. Cannot add volume to this viewport.`)}const s=n.map((async n=>{const a=e.getViewport(n);await a.addVolumes(t,i,o)}));await Promise.all(s)};n(90740);const r=async function(e,t,n){for(const t of n){const n=e.getStackViewport(t);if(!n)throw new Error(`Viewport with Id ${t} does not exist`);if(!n.addImages)return void console.warn(`Viewport with Id ${t} does not have addImages. Cannot add image segmentation to this viewport.`)}const i=n.map((async n=>{e.getStackViewport(n).addImages(t)}));await Promise.all(i)}},57308:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});const i=Symbol("DefaultSettings"),o=Symbol("RuntimeSettings"),a=Symbol("ObjectSettingsMap"),s=Symbol("Dictionary");class r{constructor(e){const t=Object.create(e instanceof r&&s in e?e[s]:null);Object.seal(Object.defineProperty(this,s,{value:t}))}set(e,t){return d(this[s],e,t,null)}get(e){return function(e,t){return e[t]}(this[s],e)}unset(e){return function(e,t){if(t.endsWith(".")){let n=0;const i=t,o=i.slice(0,-1),a=0===o.length;for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a||t.startsWith(i)||t===o)&&(delete e[t],++n);return n>0}return delete e[t]}(this[s],e+"")}forEach(e){l(this[s],e)}extend(){return new r(this)}import(e){c(e)&&Object.keys(e).forEach((t=>{d(this[s],t,e[t],null)}))}dump(){const e={};return l(this[s],((t,n)=>{void 0!==n&&h(e,t,n)})),e}static assert(e){return e instanceof r?e:r.getRuntimeSettings()}static getDefaultSettings(e=null){let t=r[i];if(t instanceof r||(t=new r,r[i]=t),e){const n={};return t.forEach((i=>{if(i.startsWith(e)){const o=i.split(`${e}.`)[1];n[o]=t.get(i)}})),n}return t}static getRuntimeSettings(){let e=r[o];return e instanceof r||(e=new r(r.getDefaultSettings()),r[o]=e),e}static getObjectSettings(e,t){let n=null;if(e instanceof r)n=e;else if("object"==typeof e&&null!==e){let i=r[a];i instanceof WeakMap||(i=new WeakMap,r[a]=i),n=i.get(e),n instanceof r||(n=new r(r.assert(r.getObjectSettings(t))),i.set(e,n))}return n}static extendRuntimeSettings(){return r.getRuntimeSettings().extend()}}function l(e,t){for(const n in e)t(n,e[n])}function d(e,t,n,i){return!!function(e){let t,n,i;if("string"!=typeof e||(t=e.length-1)<0)return!1;i=-1;for(;(n=e.indexOf(".",i+1))>=0;){if(n-i<2||n===t)return!1;i=n}return!0}(t)&&(c(n)?function(e,t,n,i){let o;if(i.has(n))return d(e,t,null,i);i.add(n),o=0;for(const a in n)Object.prototype.hasOwnProperty.call(n,a)&&(d(e,0===a.length?t:`${t}.${a}`,n[a],i)||++o);return i.delete(n),0===o}(e,t,n,i instanceof WeakSet?i:new WeakSet):(e[t]=n,!0))}function c(e){if("object"==typeof e&&null!==e){const t=Object.getPrototypeOf(e);if(t===Object.prototype||null===t)return!0}return!1}function h(e,t,n){const i=t.indexOf(".");if(i>=0){const o=t.slice(0,i);let a=e[o];if("object"!=typeof a||null===a){const t=a;a={},void 0!==t&&(a[""]=t),e[o]=a}h(a,t.slice(i+1,t.length),n)}else e[t]=n}r.getDefaultSettings().set("useCursors",!0)},14305:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=class{constructor(e){const{points:t,type:n}=e.data;this.id=e.id,this._points=t,this._type=n,this._color=e.color,this._segmentIndex=e.segmentIndex,this.sizeInBytes=this._getSizeInBytes()}_getSizeInBytes(){return 3*this._points.length}get points(){return this._points}set points(e){this._points=e}get color(){return this._color}set color(e){this._color=e}get type(){return this._type}set type(e){this._type=e}get segmentIndex(){return this._segmentIndex}set segmentIndex(e){this._segmentIndex=e}get flatPointsArray(){return this._points.map((e=>[...e])).flat()}}},77585:(e,t,n)=>{"use strict";n.d(t,{P:()=>o});var i=n(14305);class o{constructor(e){this._color=[200,0,0],this.id=e.id,this._contours=[],this._color=e.color??this._color,this.frameOfReferenceUID=e.frameOfReferenceUID,this._segmentIndex=e.segmentIndex,this._createEachContour(e.data),this.sizeInBytes=this._getSizeInBytes()}_createEachContour(e){e.forEach((e=>{const{points:t,type:n,color:o}=e,a=new i.A({id:`${this.id}-segment-${this._segmentIndex}`,data:{points:t,type:n,segmentIndex:this._segmentIndex,color:o??this._color},segmentIndex:this._segmentIndex,color:o??this._color});this._contours.push(a)})),this._updateContourSetCentroid()}_updateContourSetCentroid(){const e=this.totalNumberOfPoints,t=this.flatPointsArray,n=t.reduce(((e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]]),[0,0,0]),i=[n[0]/e,n[1]/e,n[2]/e],o=t.reduce(((e,t)=>this._getDistance(i,t)<this._getDistance(i,e)?t:e),t[0]);this._centroid=o}_getSizeInBytes(){return this._contours.reduce(((e,t)=>e+t.sizeInBytes),0)}_getDistance(e,t){return Math.sqrt((e[0]-t[0])**2+(e[1]-t[1])**2+(e[2]-t[2])**2)}get centroid(){return this._centroid}get segmentIndex(){return this._segmentIndex}get color(){return this._color}set color(e){this._color=e,this._contours.forEach((t=>{t instanceof i.A&&(t.color=e)}))}get contours(){return this._contours}get flatPointsArray(){return this._contours.flatMap((e=>e.points))}get numberOfContours(){return this._contours.length}get totalNumberOfPoints(){return this._contours.reduce(((e,t)=>e+t.points.length),0)}get numberOfPointsArray(){return this._contours.map((e=>e.points.length))}getPointsInContour(e){return this._contours[e].points}getNumberOfPointsInAContour(e){return this.getPointsInContour(e).length}}},90808:(e,t,n)=>{"use strict";n.d(t,{u:()=>i});class i{constructor(e){this._color=[200,0,0],this.id=e.id,this._points=e.points,this._polys=e.polys,this._color=e.color??this._color,this.frameOfReferenceUID=e.frameOfReferenceUID,this._segmentIndex=e.segmentIndex,this.sizeInBytes=this._getSizeInBytes(),this._updateCentroid()}_getSizeInBytes(){return 4*this._points.length+4*this._polys.length}_updateCentroid(){const e=this._points.length/3;let t=0,n=0,i=0;for(let e=0;e<this._points.length;e+=3)t+=this._points[e],n+=this._points[e+1],i+=this._points[e+2];this._centroid=[t/e,n/e,i/e]}get color(){return this._color}set color(e){this._color=e}get points(){return this._points}set points(e){this._points=e,this._updateCentroid()}get polys(){return this._polys}set polys(e){this._polys=e}get segmentIndex(){return this._segmentIndex}get centroid(){return this._centroid}get flatPointsArray(){return this._points}get totalNumberOfPoints(){return this._points.length/3}}},31749:(e,t,n)=>{"use strict";n.d(t,{BlendModes:()=>c,CalibrationTypes:()=>p,Events:()=>i.A,GenerateImageType:()=>f,GeometryType:()=>u,ImageQualityStatus:()=>E.A,InterpolationType:()=>s.A,MetadataModules:()=>C.A,OrientationAxis:()=>g.A,RequestType:()=>o.A,VOILUTFunctionType:()=>v.A,VideoEnums:()=>I,ViewportStatus:()=>w.A,ViewportType:()=>a.A});var i=n(32643),o=n(43213),a=n(41864),s=n(29310),r=n(67737);const{BlendMode:l}=r.Ay;var d;!function(e){e[e.COMPOSITE=l.COMPOSITE_BLEND]="COMPOSITE",e[e.MAXIMUM_INTENSITY_BLEND=l.MAXIMUM_INTENSITY_BLEND]="MAXIMUM_INTENSITY_BLEND",e[e.MINIMUM_INTENSITY_BLEND=l.MINIMUM_INTENSITY_BLEND]="MINIMUM_INTENSITY_BLEND",e[e.AVERAGE_INTENSITY_BLEND=l.AVERAGE_INTENSITY_BLEND]="AVERAGE_INTENSITY_BLEND"}(d||(d={}));const c=d;var h,g=n(18735);!function(e){e.CONTOUR="CONTOUR",e.SURFACE="SURFACE"}(h||(h={}));const u=h;n(86066);var m,v=n(82501);n(91369);!function(e){e.NOT_APPLICABLE="",e.ERMF="ERMF",e.USER="User",e.PROJECTION="Proj",e.REGION="Region",e.ERROR="Error",e.UNCALIBRATED="Uncalibrated"}(m||(m={}));const p=m;var f,w=n(1814),E=n(77474),I=n(13545),C=n(69850);!function(e){e.SUM="SUM",e.SUBTRACT="SUBTRACT",e.AVERAGE="AVERAGE"}(f||(f={}))},86846:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>o,b1:()=>a,yj:()=>s,zb:()=>r});var i=n(39536);function o(e){if(!e)return;const{viewportUid:t,renderingEngineUid:n}=e.dataset;return a(t,n)}function a(e,t){if(!t||!e)return;const n=(0,i.Ay)(t);if(!n||n.hasBeenDestroyed)return;const o=n.getViewport(e);if(!o)return;const a=o.getFrameOfReferenceUID();return{viewport:o,renderingEngine:n,viewportId:e,renderingEngineId:t,FrameOfReferenceUID:a}}function s(e){const t=(0,i.qO)();for(let n=0;n<t.length;n++){const i=t[n];if(i.getViewport(e))return a(e,i.id)}}function r(){const e=[];return(0,i.qO)().forEach((t=>{t.getViewports().forEach((({element:t})=>{e.push(o(t))}))})),e}},81985:(e,t,n)=>{"use strict";n.d(t,{BaseVolumeViewport:()=>s.A,CONSTANTS:()=>o,Enums:()=>i,Settings:()=>p.A,StackViewport:()=>r.A,VideoViewport:()=>l.A,VolumeViewport:()=>a.A,addImageSlicesToViewports:()=>_.ge,addVolumesToViewports:()=>_.x,cache:()=>h.Ay,eventTarget:()=>d.A,geometryLoader:()=>E,getEnabledElement:()=>u.Ay,getEnabledElementByIds:()=>u.b1,getEnabledElementByViewportId:()=>u.yj,getEnabledElements:()=>u.zb,getRenderingEngine:()=>c.lD,getRenderingEngines:()=>c.qO,getWebWorkerManager:()=>v.G_,imageLoadPoolManager:()=>g.A,imageLoader:()=>w,metaData:()=>m,triggerEvent:()=>C.A,utilities:()=>I,volumeLoader:()=>f});var i=n(31749),o=n(19325),a=(n(56706),n(61640),n(92099),n(30135),n(94155)),s=(n(40893),n(46347)),r=n(58165),l=n(32501),d=(n(81466),n(10056),n(10364)),c=n(39536),h=(n(58927),n(49038)),g=(n(91073),n(51159)),u=n(86846),m=n(74876),v=n(59693),p=n(57308),f=n(39561),w=n(80068),E=n(39459),I=(n(36822),n(49035)),C=n(69372),_=(n(55500),n(55509),n(98834))},59693:(e,t,n)=>{"use strict";n.d(t,{lk:()=>g,D0:()=>v,LH:()=>u,G_:()=>p,Dh:()=>m,a:()=>f});n(39536),n(74268);var i=n(99178),o=n(31749),a=n(24743);const s=class{constructor(){this.workerRegistry={},this.workerPoolManager=new a.R("webworker")}registerWorker(e,t,n={}){const{maxWorkerInstances:o=1,overwrite:a=!1,autoTerminateOnIdle:s={enabled:!1,idleTimeThreshold:3e3}}=n;if(this.workerRegistry[e]&&!a)return void console.warn(`Worker type '${e}' is already registered...`);a&&this.workerRegistry[e]?.idleCheckIntervalId&&clearInterval(this.workerRegistry[e].idleCheckIntervalId);const r={workerFn:null,instances:[],loadCounters:[],lastActiveTime:[],nativeWorkers:[],autoTerminateOnIdle:s.enabled,idleCheckIntervalId:null,idleTimeThreshold:s.idleTimeThreshold};r.loadCounters=Array(o).fill(0),r.lastActiveTime=Array(o).fill(null);for(let e=0;e<o;e++){const e=t();r.instances.push(i.LV(e)),r.nativeWorkers.push(e),r.workerFn=t}this.workerRegistry[e]=r}getNextWorkerAPI(e){const t=this.workerRegistry[e];if(!t)return console.error(`Worker type '${e}' is not registered.`),null;const n=t.instances.filter((e=>null!==e));let o=0,a=t.loadCounters[0]||0;for(let e=1;e<n.length;e++){const n=t.loadCounters[e]||0;n<a&&(o=e,a=n)}if(null===t.instances[o]){const e=t.workerFn();t.instances[o]=i.LV(e),t.nativeWorkers[o]=e}return t.loadCounters[o]+=1,{api:t.instances[o],index:o}}executeTask(e,t,n={},{requestType:a=o.RequestType.Compute,priority:s=0,options:r={},callbacks:l=[]}={}){return new Promise(((o,d)=>{this.workerPoolManager.addRequest((async()=>{const{api:a,index:s}=this.getNextWorkerAPI(e);if(!a){const t=new Error(`No available worker instance for '${e}'`);return console.error(t),void d(t)}try{let r=[];l.length&&(r=l.map((e=>i.BX(e))));const d=this.workerRegistry[e];d.processing=!0;const c=await a[t](n,...r);d.processing=!1,d.lastActiveTime[s]=Date.now(),d.autoTerminateOnIdle&&!d.idleCheckIntervalId&&d.idleTimeThreshold&&(d.idleCheckIntervalId=setInterval((()=>{this.terminateIdleWorkers(e,d.idleTimeThreshold)}),d.idleTimeThreshold)),o(c)}catch(n){console.error(`Error executing method '${t}' on worker '${e}':`,n),d(n)}finally{this.workerRegistry[e].loadCounters[s]--}}),a,r,s)}))}terminateIdleWorkers(e,t){const n=this.workerRegistry[e];if(n.processing)return;const i=Date.now();n.instances.forEach(((o,a)=>{const s=n.lastActiveTime[a];!(null!==s&&n.loadCounters[a]>0)&&i-s>t&&this.terminateWorkerInstance(e,a)}))}terminate(e){const t=this.workerRegistry[e];t?t.instances.forEach(((t,n)=>{this.terminateWorkerInstance(e,n)})):console.error(`Worker type '${e}' is not registered.`)}terminateWorkerInstance(e,t){const n=this.workerRegistry[e],o=n.instances[t];null!==o&&(o[i.A2](),n.nativeWorkers[t].terminate(),n.instances[t]=null,n.lastActiveTime[t]=null)}};let r=!1;const l={gpuTier:{tier:2},isMobile:!1,rendering:{useCPURendering:!1,preferSizeOverAccuracy:!1,strictZSpacingForVolumeViewport:!0},peerImport:e=>null};let d={...l,rendering:{...l.rendering}},c=null;function h(){return!!/iPad|iPhone|iPod/.test(navigator.platform)||navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&navigator.platform.includes("MacIntel")}function g(){return!h()}function u(){return d.rendering.useCPURendering}function m(){return r}function v(){return d}function p(){return c||(c=new s),c}function f(e){return d.peerImport(e)}},39459:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createAndCacheGeometry:()=>v,loadAndCacheGeometry:()=>m,loadGeometry:()=>u,registerGeometryLoader:()=>p,registerUnknownGeometryLoader:()=>f});n(98455);var i=n(49038),o=n(31749),a=n(56349),s=n(69871),r=n(32643),l=n(10364),d=n(69372);const c={};let h;function g(e,t){const n=e.indexOf(":"),i=e.substring(0,n);let o=c[i];if(null==o){if(null==h||"function"!=typeof h)throw new Error(`No geometry loader for scheme ${i} has been registered`);o=h}const a=o(e,t);return a.promise.then((function(e){(0,d.A)(l.A,r.A.GEOMETRY_LOADED,{geometry:e})}),(function(t){const n={geometryId:e,error:t};(0,d.A)(l.A,r.A.GEOMETRY_LOADED_FAILED,n)})),a}function u(e,t){if(void 0===e)throw new Error("loadGeometry: parameter geometryId must not be undefined");let n=i.Ay.getGeometryLoadObject(e);return void 0!==n||(n=g(e,t)),n.promise}async function m(e,t){if(void 0===e)throw new Error("createAndCacheGeometry: parameter geometryId must not be undefined");let n=i.Ay.getGeometryLoadObject(e);return void 0!==n||(n=g(e,t),await i.Ay.putGeometryLoadObject(e,n)),n.promise}function v(e,t){if(void 0===e)throw new Error("createAndCacheGeometry: parameter geometryId must not be undefined");let n=i.Ay.getGeometry(e);if(n)return n;if(t.type===o.GeometryType.CONTOUR)n=(0,a.z)(e,t.geometryData);else{if(t.type!==o.GeometryType.SURFACE)throw new Error("Unknown geometry type");n=(0,s.g)(e,t.geometryData)}return i.Ay.putGeometrySync(e,n),n}function p(e,t){c[e]=t}function f(e){const t=h;return h=e,t}},80068:(e,t,n)=>{"use strict";n.r(t),n.d(t,{cancelLoadAll:()=>S,cancelLoadImage:()=>T,cancelLoadImages:()=>b,createAndCacheDerivedImage:()=>I,createAndCacheDerivedImages:()=>C,createAndCacheDerivedLabelmapImage:()=>M,createAndCacheDerivedLabelmapImages:()=>x,createAndCacheLocalImage:()=>_,loadAndCacheImage:()=>w,loadAndCacheImages:()=>E,loadImage:()=>f,registerImageLoader:()=>y,registerUnknownImageLoader:()=>A,unregisterAllImageLoaders:()=>D});var i=n(49038),o=n(32643),a=n(10364),s=n(27119),r=n(99576),l=n(69372),d=n(80221),c=n(24623),h=n(51159),g=n(74876);const u={};let m;function v(e,t){const n=i.Ay.getImageLoadObject(e);if(n)return p(n.promise,e),n;const o=e.split(":")[0],a=u[o]||m;if(!a)throw new Error(`loadImageFromImageLoader: No image loader found for scheme '${o}'`);const s=a(e,t);return p(s.promise,e),s}function p(e,t){Promise.resolve(e).then((e=>{!function(e){if(!e.voxelManager){const{width:t,height:n,numberOfComponents:i}=e,o=c.A.createImageVoxelManager({scalarData:e.getPixelData(),width:t,height:n,numberOfComponents:i});e.voxelManager=o,e.getPixelData=()=>o.getScalarData(),delete e.imageFrame.pixelData}}(e),(0,l.A)(a.A,o.A.IMAGE_LOADED,{image:e})})).catch((e=>{const n={imageId:t,error:e};(0,l.A)(a.A,o.A.IMAGE_LOAD_FAILED,n)}))}function f(e,t={priority:0,requestType:"prefetch"}){if(void 0===e)throw new Error("loadImage: parameter imageId must not be undefined");return v(e,t).promise}function w(e,t={priority:0,requestType:"prefetch"}){if(void 0===e)throw new Error("loadAndCacheImage: parameter imageId must not be undefined");const n=v(e,t);return i.Ay.getImageLoadObject(e)||i.Ay.putImageLoadObject(e,n),n.promise}function E(e,t={priority:0,requestType:"prefetch"}){if(!e||0===e.length)throw new Error("loadAndCacheImages: parameter imageIds must be list of image Ids");return e.map((e=>w(e,t)))}function I(e,t={}){if(void 0===e)throw new Error("createAndCacheDerivedImage: parameter imageId must not be undefined");void 0===t.imageId&&(t.imageId=`derived:${(0,d.A)()}`);const{imageId:n,skipCreateBuffer:o,onCacheAdd:a}=t,l=g.get("imagePlaneModule",e),c=l.rows*l.columns,{TypedArrayConstructor:h}=(0,r.h)(t.targetBuffer?.type,c),u=new h(o?1:c),m=n,v=g.get("imagePlaneModule",e);s.A.add(m,{type:"imagePlaneModule",metadata:v});const p=g.get("generalSeriesModule",e);s.A.add(m,{type:"generalSeriesModule",metadata:p}),s.A.add(m,{type:"generalImageModule",metadata:{instanceNumber:t.instanceNumber}});const f=g.get("imagePixelModule",e);s.A.add(m,{type:"imagePixelModule",metadata:{...f,bitsAllocated:8,bitsStored:8,highBit:7,samplesPerPixel:1,pixelRepresentation:0}});const w=_(n,{scalarData:u,onCacheAdd:a,skipCreateBuffer:o,targetBuffer:{type:u.constructor.name},dimensions:[l.columns,l.rows],spacing:[l.columnPixelSpacing,l.rowPixelSpacing],origin:l.imagePositionPatient,direction:l.imageOrientationPatient,frameOfReferenceUID:l.frameOfReferenceUID});return w.referencedImageId=e,i.Ay.getImageLoadObject(n)||i.Ay.putImageSync(n,w),w}function C(e,t={}){if(0===e.length)throw new Error("createAndCacheDerivedImages: parameter imageIds must be list of image Ids");const n=[];return e.map(((e,i)=>{const o={imageId:t?.getDerivedImageId?.(e)||`derived:${(0,d.A)()}`,...t};return n.push(o.imageId),I(e,{...o,instanceNumber:i+1})}))}function _(e,t){const{scalarData:n,origin:o,direction:a,targetBuffer:l,skipCreateBuffer:d,onCacheAdd:h,frameOfReferenceUID:g}=t,u=t.dimensions,m=t.spacing;if(!u||!m)throw new Error("createAndCacheLocalImage: dimensions and spacing are required");const v=u[0],p=u[1],f=m[0],w=m[1],E={frameOfReferenceUID:g,rows:p,columns:v,imageOrientationPatient:a??[1,0,0,0,1,0],rowCosines:a?a.slice(0,3):[1,0,0],columnCosines:a?a.slice(3,6):[0,1,0],imagePositionPatient:o??[0,0,0],pixelSpacing:[w,f],rowPixelSpacing:w,columnPixelSpacing:f},I=v*p,C=n.length/I;let _,T,b,S;if(n){if(!(n instanceof Uint8Array||n instanceof Float32Array||n instanceof Uint16Array||n instanceof Int16Array))throw new Error("createAndCacheLocalImage: scalarData must be of type Uint8Array, Uint16Array, Int16Array or Float32Array");_=n}else if(!d){const{numBytes:e,TypedArrayConstructor:t}=(0,r.h)(l?.type,I);_=new t(I)}if(_ instanceof Uint8Array)T=8,b=8,S=7;else if(_ instanceof Uint16Array)T=16,b=16,S=15;else if(_ instanceof Int16Array)T=16,b=16,S=15;else{if(!(_ instanceof Float32Array))throw new Error("Unsupported scalarData type");T=32,b=32,S=31}const y={samplesPerPixel:1,photometricInterpretation:_.length>u[0]*u[1]?"RGB":"MONOCHROME2",rows:p,columns:v,bitsAllocated:T,bitsStored:b,highBit:S},A={imagePlaneModule:E,imagePixelModule:y};["imagePlaneModule","imagePixelModule"].forEach((t=>{s.A.add(e,{type:t,metadata:A[t]||{}})}));const D=c.A.createImageVoxelManager({height:p,width:v,numberOfComponents:C,scalarData:_});let x=_[0],M=_[0];for(let e=1;e<_.length;e++)_[e]<x&&(x=_[e]),_[e]>M&&(M=_[e]);const O={imageId:e,intercept:0,windowCenter:0,windowWidth:0,color:"RGB"===y.photometricInterpretation,numberOfComponents:y.samplesPerPixel,dataType:l?.type,slope:1,minPixelValue:x,maxPixelValue:M,rows:y.rows,columns:y.columns,getCanvas:void 0,height:y.rows,width:y.columns,rgba:void 0,columnPixelSpacing:E.columnPixelSpacing,rowPixelSpacing:E.rowPixelSpacing,FrameOfReferenceUID:E.frameOfReferenceUID,invert:!1,getPixelData:()=>D.getScalarData(),voxelManager:D,sizeInBytes:n.byteLength};return h?.(O),i.Ay.putImageSync(O.imageId,O),O}function T(e){h.A.filterRequests((({additionalDetails:t})=>!t.imageId||t.imageId!==e));const t=i.Ay.getImageLoadObject(e);t&&t.cancelFn()}function b(e){e.forEach((e=>{T(e)}))}function S(){const e=h.A.getRequestPool();Object.keys(e).forEach((t=>{const n=e[t];Object.keys(n).forEach((e=>{const t=n[e].pop().additionalDetails,{imageId:o,volumeId:a}=t;let s;o?s=i.Ay.getImageLoadObject(o):a&&(s=i.Ay.getVolumeLoadObject(a)),s&&s.cancel()})),h.A.clearRequestStack(t)}))}function y(e,t){u[e]=t}function A(e){const t=m;return m=e,t}function D(){Object.keys(u).forEach((e=>delete u[e])),m=void 0}function x(e,t={}){return C(e,{...t,targetBuffer:{type:"Uint8Array"}})}function M(e,t={}){return I(e,{...t,targetBuffer:{type:"Uint8Array"}})}},56349:(e,t,n)=>{"use strict";n.d(t,{z:()=>s});var i=n(31749),o=n(72171),a=n(77585);function s(e,t){(0,o.x)(t);const n=new a.P({id:t.id,data:t.data,color:t.color,frameOfReferenceUID:t.frameOfReferenceUID,segmentIndex:t.segmentIndex??1});return{id:e,type:i.GeometryType.CONTOUR,data:n,sizeInBytes:n.sizeInBytes}}},72171:(e,t,n)=>{"use strict";function i(e){if(!e||0===e.data.length)throw new Error("Invalid contour set data, see publicContourSetData type for more info");if(!e.id)throw new Error("Invalid contour set data, each contour set must have an id");if(!e.data||!Array.isArray(e.data))throw new Error("Invalid contour set data, each contour set must have an array of contours");e.data.forEach((e=>{if(!e.points||!Array.isArray(e.points))throw new Error("Invalid contour set data, each contour must have an array of points");e.points.forEach((e=>{if(!e||!Array.isArray(e)||3!==e.length)throw new Error("Invalid contour set data, each point must be an array of length 3")}))}))}n.d(t,{x:()=>i})},69871:(e,t,n)=>{"use strict";n.d(t,{g:()=>s});var i=n(31749),o=n(80405),a=n(90808);function s(e,t){(0,o.e)(t);const n=new a.u({id:t.id,points:t.points,polys:t.polys,color:t.color,frameOfReferenceUID:t.frameOfReferenceUID,segmentIndex:t.segmentIndex??1});return{id:e,type:i.GeometryType.SURFACE,data:n,sizeInBytes:n.sizeInBytes}}},80405:(e,t,n)=>{"use strict";function i(e){if(!e.id)throw new Error("Surface must have an id");if(0===e.points?.length)throw new Error("Surface must have non-empty points array");if(0===e.polys?.length)throw new Error("Surface must have non-empty polys array");if(!e.frameOfReferenceUID)throw new Error("Surface must have a frameOfReferenceUID")}n.d(t,{e:()=>i})},39561:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createAndCacheDerivedLabelmapVolume:()=>y,createAndCacheDerivedVolume:()=>w,createAndCacheVolume:()=>f,createAndCacheVolumeFromImages:()=>E,createAndCacheVolumeFromImagesSync:()=>I,createLocalLabelmapVolume:()=>A,createLocalVolume:()=>C,getUnknownVolumeLoaderSchema:()=>S,getVolumeLoaderSchemes:()=>T,loadVolume:()=>p,registerUnknownVolumeLoader:()=>b,registerVolumeLoader:()=>_});n(7742);var i=n(86252),o=n(49038),a=n(32643),s=n(10364),r=n(69372),l=n(80221),d=n(24623),c=n(80068),h=n(9734),g=n(55500);const u={};let m=g.F;function v(e,t){const n=e.indexOf(":"),i=e.substring(0,n);let o=u[i];if(null==o){if(null==m||"function"!=typeof m)throw new Error(`No volume loader for scheme ${i} has been registered`);o=m}const l=o(e,t);return l.promise.then((function(e){(0,r.A)(s.A,a.A.VOLUME_LOADED,{volume:e})}),(function(t){const n={volumeId:e,error:t};(0,r.A)(s.A,a.A.VOLUME_LOADED_FAILED,n)})),l}function p(e,t={imageIds:[]}){if(void 0===e)throw new Error("loadVolume: parameter volumeId must not be undefined");let n=o.Ay.getVolumeLoadObject(e);return void 0!==n?n.promise:(n=v(e,t),n.promise.then((e=>e)))}async function f(e,t){if(void 0===e)throw new Error("createAndCacheVolume: parameter volumeId must not be undefined");let n=o.Ay.getVolumeLoadObject(e);return void 0!==n||(n=v(e,t),o.Ay.putVolumeLoadObject(e,n)),n.promise}function w(e,t){const n=o.Ay.getVolume(e);if(!n)throw new Error(`Cannot created derived volume: Referenced volume with id ${e} does not exist.`);let{volumeId:a}=t;void 0===a&&(a=(0,l.A)());const{metadata:s,dimensions:r,spacing:d,origin:h,direction:g}=n,u=n.isDynamicVolume()?n.getCurrentTimePointImageIds():n.imageIds??[],m=(0,c.createAndCacheDerivedImages)(u,{targetBuffer:t.targetBuffer}),v=m[0].dataType,p=m.map((e=>e.imageId)),f=new i.Q({volumeId:a,dataType:v,metadata:structuredClone(s),dimensions:[r[0],r[1],r[2]],spacing:d,origin:h,direction:g,referencedVolumeId:e,imageIds:p,referencedImageIds:n.imageIds??[]});return o.Ay.putVolumeSync(a,f),f}async function E(e,t){if(void 0===t)throw new Error("createAndCacheVolumeFromImages: parameter imageIds must not be undefined");if(void 0===e)throw new Error("createAndCacheVolumeFromImages: parameter volumeId must not be undefined");const n=o.Ay.getVolume(e);if(n)return n;if(0===t.filter((e=>!o.Ay.getImage(e))).length)return I(e,t);return await f(e,{imageIds:t})}function I(e,t){if(void 0===t)throw new Error("createAndCacheVolumeFromImagesSync: parameter imageIds must not be undefined");if(void 0===e)throw new Error("createAndCacheVolumeFromImagesSync: parameter volumeId must not be undefined");const n=o.Ay.getVolume(e);if(n)return n;const a=(0,h.D)(t,e),s=new i.Q({volumeId:e,dataType:a.dataType,metadata:structuredClone(a.metadata),dimensions:a.dimensions,spacing:a.spacing,origin:a.origin,direction:a.direction,referencedVolumeId:a.referencedVolumeId,imageIds:a.imageIds,referencedImageIds:a.referencedImageIds});return o.Ay.putVolumeSync(e,s),s}function C(e,t={}){const{metadata:n,dimensions:a,spacing:s,origin:r,direction:l,scalarData:h,targetBuffer:g,preventCache:u=!1}=t,m=o.Ay.getVolume(e);if(m)return m;const v=a[0]*a[1],p=h?h.constructor.name:g?.type??"Float32Array",f=v*a[2];let w;switch(p){case"Uint8Array":case"Int8Array":w=f;break;case"Uint16Array":case"Int16Array":w=2*f;break;case"Float32Array":w=4*f}if(!o.Ay.isCacheable(w))throw new Error(`Cannot created derived volume: Volume with id ${e} is not cacheable.`);const E=[],I=[];for(let t=0;t<a[2];t++){const n=`${e}_slice_${t}`;E.push(n);const i=h.subarray(t*v,(t+1)*v),o=(0,c.createAndCacheLocalImage)(n,{scalarData:i,dimensions:[a[0],a[1]],spacing:[s[0],s[1]],origin:r,direction:l,targetBuffer:{type:p}});I.push(o)}const C=new i.Q({volumeId:e,metadata:structuredClone(n),dimensions:[a[0],a[1],a[2]],spacing:s,origin:r,direction:l,imageIds:E,dataType:p}),_=d.A.createImageVolumeVoxelManager({imageIds:E,dimensions:a,numberOfComponents:1});return C.voxelManager=_,u||o.Ay.putVolumeSync(e,C),C}function _(e,t){u[e]=t}function T(){return Object.keys(u)}function b(e){const t=m;return m=e,t}function S(){return m.name}function y(e,t={}){return w(e,{...t,targetBuffer:{type:"Uint8Array"}})}function A(e,t,n=!1){return e.scalarData||(e.scalarData=new Uint8Array(e.dimensions[0]*e.dimensions[1]*e.dimensions[2])),C(t,{...e,preventCache:n})}},22191:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});class i{constructor(e){this.name=e||"unknown"}static as(e){if(e.iterator)return e.iterator;const t=new i("as iterator");return e.then((e=>{try{t.add(e,!0)}catch(e){t.reject(e)}}),(e=>{t.reject(e)})),t}add(e,t=!1){this.nextValue=e,this.done||=t,this.waiting&&(this.waiting.resolve(e),this.waiting=void 0)}resolve(){this.done=!0,this.waiting&&(this.waiting.resolve(this.nextValue),this.waiting=void 0)}reject(e){this.rejectReason=e,this.waiting?.reject(e)}getRecent(){if(this.rejectReason)throw this.rejectReason;return this.nextValue}async*[Symbol.asyncIterator](){for(;!this.done;){if(this.rejectReason)throw this.rejectReason;if(void 0!==this.nextValue&&(yield this.nextValue,this.done))break;this.waiting||(this.waiting={},this.waiting.promise=new Promise(((e,t)=>{this.waiting.resolve=e,this.waiting.reject=t}))),await this.waiting.promise}yield this.nextValue}async forEach(e,t){let n=0;try{for await(const i of this){const{done:o}=this;try{await e(i,o,n),n++}catch(e){if(!o){console.warn("Caught exception in intermediate value",e);continue}if(!t)throw e;t(e,o)}}}catch(e){if(!t)throw e;t(e,!0)}}generate(e,t){return e(this,this.reject.bind(this)).then((()=>{this.done||this.resolve()}),(e=>{this.reject(e),t?t(e):console.warn("Couldn't process because",e)}))}async nextPromise(){for await(const e of this)if(e)return e;return this.nextValue}async donePromise(){for await(const e of this);return this.nextValue}getNextPromise(){const e=this.nextPromise();return e.iterator=this,e}getDonePromise(){const e=this.donePromise();return e.iterator=this,e}}},67645:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});class i{constructor(e,t,n=1){this.rows=new Map,this.height=1,this.width=1,this.depth=1,this.jMultiple=1,this.kMultiple=1,this.numberOfComponents=1,this.defaultValue=0,this.pixelDataConstructor=Uint8Array,this.get=e=>{const t=e%this.jMultiple,n=(e-t)/this.jMultiple,i=this.getRLE(t,n);return i?.value||this.defaultValue},this.getRun=(e,t)=>{const n=e+t*this.height;return this.rows.get(n)},this.set=(e,t)=>{if(void 0===t)throw new Error("Can't set undefined at "+e%this.width);const n=e%this.width,i=(e-n)/this.width,o=this.rows.get(i);if(!o)return void this.rows.set(i,[{start:n,end:n+1,value:t}]);const a=this.findIndex(o,n),s=o[a],r=o[a-1];if(!s)return r&&r.value===t&&r.end===n?void r.end++:void(o[a]={start:n,end:n+1,value:t});const{start:l,end:d,value:c}=s;if(t===c&&n>=l)return;const h={start:n,end:n+1,value:t},g=n>l,u=g?a+1:a,m=g?s:r;let v=g?o[a+1]:s;if(m?.value===t&&m.end===n)return m.end++,void(v?.value===t&&v.start===n+1?(m.end=v.end,o.splice(a,1)):v?.start===n&&(v.start++,v.start===v.end&&(o.splice(a,1),v=o[a],v?.start===n+1&&v.value===t&&(m.end=v.end,o.splice(a,1)))));if(v?.value===t&&v.start===n+1)return v.start--,void(m?.end>n&&(m.end=n,m.end===m.start&&o.splice(a,1)));if(v?.start!==n||v.end!==n+1)n===v?.start&&v.start++,g&&d>n+1?o.splice(u,0,h,{start:n+1,end:m.end,value:m.value}):o.splice(u,0,h),m?.end>n&&(m.end=n);else{v.value=t;const e=o[a+1];e?.start==n+1&&e?.value===t&&(o.splice(a+1,1),v.end=e.end)}},this.width=e,this.height=t,this.depth=n,this.jMultiple=e,this.kMultiple=this.jMultiple*t}getRLE(e,t,n=0){const i=this.rows.get(t+n*this.height);if(!i)return;const o=i[this.findIndex(i,e)];return e>=o?.start?o:void 0}findIndex(e,t){for(let n=0;n<e.length;n++){const{end:i}=e[n];if(t<i)return n}return e.length}clear(){this.rows.clear()}keys(){return[...this.rows.keys()]}getPixelData(e=0,t){t?t.fill(0):t=new this.pixelDataConstructor(this.width*this.height*this.numberOfComponents);const{width:n,height:i,numberOfComponents:o}=this;for(let a=0;a<i;a++){const i=this.getRun(a,e);if(i)if(1===o)for(const e of i){const i=a*n,{start:o,end:s,value:r}=e;for(let e=o;e<s;e++)t[i+e]=r}else for(const e of i){const i=a*n*o,{start:s,end:r,value:l}=e;for(let e=s;e<r;e+=o)for(let n=0;n<o;n++)t[i+e+n]=l[n]}}return t}}},98039:(e,t,n)=>{"use strict";function i(e){return o(e,"vtkVolume")||o(e,"vtkImageSlice")}function o(e,t){return!!("isA"in e?e:e.actor).isA(t)}n.d(t,{N:()=>o,e:()=>i})},96833:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(33739),o=n(99341);function a(e,t){const n=t.colorTransfer.split(" ").splice(1).map(parseFloat),{shiftRange:a}=function(e){let t=1/0,n=-1/0;for(let i=0;i<e.length;i+=4)t=Math.min(t,e[i]),n=Math.max(n,e[i]);const i=(n-t)/2;return{shiftRange:[-i,i],min:t,max:n}}(n),s=a[0],r=a[1]-a[0],l=i.Ay.newInstance(),d=[];for(let e=0;e<n.length;e+=4){let t=n[e];const i=n[e+1],o=n[e+2],a=n[e+3];t=(t-s)/r,d.push([t,i,o,a])}!function(e,t,n){const i=t[1]-t[0],o=e.map((([e,n,o,a])=>[e*i+t[0],n,o,a]));n.removeAllPoints(),o.forEach((([e,t,i,o])=>n.addRGBPoint(e,t,i,o)))}(d,a,l),e.getProperty().setRGBTransferFunction(0,l);const c=t.scalarOpacity.split(" ").splice(1).map(parseFloat),h=o.Ay.newInstance(),g=[];for(let e=0;e<c.length;e+=2){let t=c[e];const n=c[e+1];t=(t-s)/r,g.push([t,n])}!function(e,t,n){const i=t[1]-t[0],o=e.map((([e,n])=>[e*i+t[0],n]));n.removeAllPoints(),o.forEach((([e,t])=>n.addPoint(e,t)))}(g,a,h);const u=e.getProperty();u.setScalarOpacity(0,h);const[m,v,p,f]=t.gradientOpacity.split(" ").splice(1).map(parseFloat);u.setUseGradientOpacity(0,!0),u.setGradientOpacityMinimumValue(0,m),u.setGradientOpacityMinimumOpacity(0,v),u.setGradientOpacityMaximumValue(0,p),u.setGradientOpacityMaximumOpacity(0,f),"1"===t.interpolation&&u.setInterpolationTypeToFastLinear(),u.setShade("1"===t.shade);const w=parseFloat(t.ambient),E=parseFloat(t.diffuse),I=parseFloat(t.specular),C=parseFloat(t.specularPower);u.setAmbient(w),u.setDiffuse(E),u.setSpecular(I),u.setSpecularPower(C)}},91979:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(39536),o=n(24724);const a=e=>{const t=function(e){const t=(0,i.qO)(),n=[];return t.forEach((t=>{const i=(0,o.A)(e);i.length&&n.push({renderingEngine:t,viewportIds:i.map((e=>e.id))})})),n}(e);t?.length&&t.forEach((({renderingEngine:e,viewportIds:t})=>{e.hasBeenDestroyed||e.renderViewports(t)}))}},84061:(e,t,n)=>{"use strict";function i(e,t,n){return Math.max(t,Math.min(n,e))}n.d(t,{A:()=>i,q:()=>i})},13859:(e,t,n)=>{"use strict";n.r(t),n.d(t,{findMatchingColormap:()=>c,getColormap:()=>l,getColormapNames:()=>d,registerColormap:()=>r});var i=n(660),o=n(74638),a=n(98039);const s=new Map;function r(e){s.set(e.Name,e)}function l(e){return s.get(e)}function d(){return Array.from(s.keys())}function c(e,t){const n=i.A.rgbPresetNames.map((e=>i.A.getPresetByName(e))),s=d().map((e=>l(e))),r=n.concat(s).find((t=>{const{RGBPoints:n}=t;if(n.length!==e.length)return!1;for(let t=0;t<n.length;t+=4)if(!(0,o.Ay)(n.slice(t+1,t+4),e.slice(t+1,t+4)))return!1;return!0}));if(!r)return null;const c=[];if((0,a.N)(t,"vtkVolume")){const e=t.getProperty().getScalarOpacity(0).getDataPointer();if(!e)return{name:r.Name};for(let t=0;t<e.length;t+=2)c.push({value:e[t],opacity:e[t+1]})}return{name:r.Name,opacity:c}}},74657:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(33739);function o(e){const t=i.Ay.newInstance();let n=0,o=1024;return void 0!==e.lower&&void 0!==e.upper&&(n=e.lower,o=e.upper),t.addRGBPoint(n,0,0,0),t.addRGBPoint(o,1,1,1),t}},40256:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(33739),o=n(42008),a=n(68136);function s(e,t=1024){const{windowWidth:n,windowCenter:s}=a.toWindowLevel(e.lower,e.upper),r=Array.from({length:t},((e,n)=>(n+1)/(t+2))).flatMap((e=>{const t=((e,t,n)=>t-n/4*Math.log((1-e)/e))(e,s,n);return[t,e,e,e,.5,0]})),l=i.Ay.newInstance();return l.buildFunctionFromArray(o.Ay.newInstance({values:r,numberOfComponents:6})),l}},63470:(e,t,n)=>{"use strict";function i(e,t,n=0){const i=[];for(let o=n;o<e.length;o+=t)i.push(o);return i}n.d(t,{A:()=>i})},99949:(e,t,n)=>{"use strict";function i(e){if(null===e||"object"!=typeof e)return e;if("function"==typeof e)return e;if("function"==typeof structuredClone)return e;if(Array.isArray(e))return e.map(i);{const t={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=i(e[n]));return t}}n.d(t,{G:()=>i})},88619:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(3823),o=n(74876),a=n(85008),s=n(19325);function r(e,t,n){const{direction:r,spacing:l,imageIds:d}=e;if(!d.length)return;const c=r.slice(6,9),h=i.eR.dot(c,n);if(Math.abs(h)<1-s.EPSILON)return;const g=(0,a.A)({direction:r,spacing:l},n)/2;let u;for(let e=0;e<d.length;e++){const a=d[e],{imagePositionPatient:s}=o.get("imagePlaneModule",a),r=i.eR.create();i.eR.sub(r,t,s);const l=i.eR.dot(r,n);Math.abs(l)<g&&(u=a)}return u}},47476:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(20537),o=n(65292);const a=function(e){const t=e.getCamera(),{spacingInNormalDirection:n,imageVolume:a}=(0,o.A)(e,t);if(!a)return;const{viewPlaneNormal:s,focalPoint:r}=t,l=e.getActors().find((e=>e.referencedId===a.volumeId||e.uid===a.volumeId));l||console.warn("No actor found for with actorUID of",a.volumeId);const d=l.actor,c=(0,i.A)(d,s,r),{min:h,max:g,current:u}=c,m=Math.round((g-h)/n)+1;let v=(u-h)/(g-h)*m;return v=Math.floor(v),v>m-1?v=m-1:v<0&&(v=0),{numberOfSlices:m,imageIndex:v}}},25308:(e,t,n)=>{"use strict";function i(e){let t,n=e[0],i=e[0];const o=e.length;for(let a=1;a<o;a++)t=e[a],n=Math.min(n,t),i=Math.max(i,t);return{min:n,max:i}}n.d(t,{A:()=>i})},32173:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(74876);function o(e){const t=i.get("modalityLutModule",e)||{},n=i.get("generalSeriesModule",e)||{},{modality:o}=n,a={rescaleSlope:t.rescaleSlope||1,rescaleIntercept:t.rescaleIntercept??0,modality:o},s=i.get("scalingModule",e)||{};return{...a,..."PT"===o&&{suvbw:s.suvbw,suvbsa:s.suvbsa,suvlbm:s.suvlbm}}}},20537:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n(89265),o=n(15105),a=n(19325);const s=a.EPSILON*a.EPSILON,r=e=>Math.abs(Math.abs(e)-1)<s,l=(e,t)=>r(e[t])||r(e[t+1])||r(e[t+2]),d=e=>l(e,0)&&l(e,3)&&l(e,6);function c(e,t,n){const a=e.getMapper().getInputData();let s;const r=a.getDirection();if(d(r))s=(0,o.A)(e);else{const[e,t,n]=a.getDimensions();s=[[0,0,0],[e-1,0,0],[0,t-1,0],[e-1,t-1,0],[0,0,n-1],[e-1,0,n-1],[0,t-1,n-1],[e-1,t-1,n-1]].map((e=>a.indexToWorld(e)))}const l=i.A.buildFromDegree().identity().rotateFromDirections(t,[1,0,0]);s.forEach((e=>l.apply(e)));const c=[...n];l.apply(c);const h=c[0];let g=1/0,u=-1/0;for(let e=0;e<8;e++){const t=s[e][0];t>u&&(u=t),t<g&&(g=t)}return{min:g,max:u,current:h,actor:e,viewPlaneNormal:t,focalPoint:n}}},85008:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(3823);function o(e,t){const{direction:n,spacing:o}=e,a=n.slice(0,3),s=n.slice(3,6),r=n.slice(6,9),l=[i.eR.dot(a,t),i.eR.dot(s,t),i.eR.dot(r,t)],d=i.eR.create();i.eR.set(d,l[0]*o[0],l[1]*o[1],l[2]*o[2]);return i.eR.length(d)}},65292:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n(49038),o=n(19325),a=n(85008),s=n(39561),r=n(12437);const l=1+o.EPSILON,d=e=>!!(0,s.getVolumeLoaderSchemes)().find((t=>{return n=e.volumeId,(i=t)===n.substring(0,Math.min(n.length,i.length));var n,i}));function c(e,t,n,o=!1){const{viewPlaneNormal:a}=t,s=e.getActors();if(!s.length)return{spacingInNormalDirection:null,imageVolume:null,actorUID:null};const c=s.map((e=>{const t=e.referencedId??e.uid;return i.Ay.getVolume(t)})).filter((e=>!!e));if(n){const t=(0,r.A)(n),i=c.findIndex((e=>t.includes(e.volumeId))),l=c[i],{uid:d}=s[i];return{imageVolume:l,spacingInNormalDirection:h(l,a,e,o),actorUID:d}}if(!c.length)return{spacingInNormalDirection:null,imageVolume:null,actorUID:null};const g={spacingInNormalDirection:1/0,imageVolume:null,actorUID:null},u=c.find(d);for(let t=0;t<c.length;t++){const n=c[t];if(u&&!d(n))continue;const i=h(n,a,e);i*l<g.spacingInNormalDirection&&(g.spacingInNormalDirection=i,g.imageVolume=n,g.actorUID=s[t].uid)}return g}function h(e,t,n,i=!1){const{slabThickness:o}=n.getProperties();let s=o;return o&&i||(s=(0,a.A)(e,t)),s}},24724:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(39536);const o=function(e){const t=(0,i.qO)(),n=[];return t.forEach((t=>{const i=t.getVolumeViewports().filter((t=>t.hasVolumeId(e)));n.push(...i)})),n}},70210:(e,t,n)=>{"use strict";function i(e){let t=[];const[n,i]=e.getRange();e.getTable(n,i,1024,t),t=t.filter(((e,t)=>t%3==0));const o=[...Array(1024).keys()].map(((e,t)=>n+(i-n)/1023*t)),a=t[256],s=Math.log((1-a)/a),r=o[256],l=t[768],d=Math.log((1-l)/l),c=o[768],h=Math.round(4*(c-r)/(s-d)),g=Math.round(r+h*s/4);return[Math.round(g-h/2),Math.round(g+h/2)]}n.d(t,{A:()=>i})},15105:(e,t,n)=>{"use strict";function i(e){const t=e.getMapper().getInputData(),n=t.extentToBounds(t.getExtent());return[[n[0],n[2],n[4]],[n[0],n[2],n[5]],[n[0],n[3],n[4]],[n[0],n[3],n[5]],[n[1],n[2],n[4]],[n[1],n[2],n[5]],[n[1],n[3],n[4]],[n[1],n[3],n[5]]]}n.d(t,{A:()=>i})},12437:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=e=>{const t="volumeId:",n=e.includes(t)?e.substring(9):e,i=n.indexOf("sliceIndex=");return-1===i?n:n.substring(0,i-1)}},4031:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(20537),o=n(65292);const a=function(e,t,n=!1){const a=e.getCamera(),{focalPoint:s,viewPlaneNormal:r}=a,{spacingInNormalDirection:l,actorUID:d}=(0,o.A)(e,a,t,n);if(!d)throw new Error(`Could not find image volume with id ${t} in the viewport`);const c=e.getActor(d);if(!c)return console.warn("No actor found for with actorUID of",d),null;const h=c.actor;return{sliceRange:(0,i.A)(h,r,s),spacingInNormalDirection:l,camera:a}}},61375:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(4031);const o=function(e,t,n=!1){const{sliceRange:o,spacingInNormalDirection:a,camera:s}=(0,i.A)(e,t,n),{min:r,max:l,current:d}=o,c=Math.round((l-r)/a),h=(d-r)/(l-r)*c;return{numScrollSteps:c,currentStepIndex:Math.round(h),sliceRangeInfo:{sliceRange:o,spacingInNormalDirection:a,camera:s}}}},30169:(e,t,n)=>{"use strict";n.d(t,{a:()=>i});const i=e=>Object.values(e).some((e=>"number"==typeof e&&!Number.isInteger(e)))},38883:(e,t,n)=>{"use strict";function i(e){return Array.isArray(e)?e.some((e=>Number.isNaN(e))):Number.isNaN(e)}n.d(t,{A:()=>i})},39537:(e,t,n)=>{"use strict";function i(e){const t=e.indexOf(":");return e.substring(t+1)}n.d(t,{A:()=>i})},17791:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(74876);const o=new Map,a="imageRetrieveConfiguration",s={IMAGE_RETRIEVE_CONFIGURATION:a,clear:()=>{o.clear()},add:(e,t)=>{o.set(e,t)},get:(e,...t)=>{if(e===a)return t.map((e=>o.get(e))).find((e=>void 0!==e))}};(0,i.addProvider)(s.get.bind(s));const r=s},49035:(e,t,n)=>{"use strict";n.r(t),n.d(t,{PointsManager:()=>Ee,ProgressiveIterator:()=>Me.A,RLEVoxelMap:()=>Ge.A,VoxelManager:()=>Fe.A,actorIsA:()=>ae.N,applyPreset:()=>we.A,autoLoad:()=>ft.A,calculateViewportsSpatialRegistration:()=>me,calibratedPixelSpacingMetadataProvider:()=>T,clamp:()=>b.A,clip:()=>Ct,color:()=>a,colormap:()=>tt,convertStackToVolumeViewport:()=>We,convertToGrayscale:()=>je,convertVolumeToStackViewport:()=>He,createLinearRGBTransferFunction:()=>h.A,createSigmoidRGBTransferFunction:()=>d.A,decimate:()=>Oe.A,deepClone:()=>Et.G,deepEqual:()=>st,deepMerge:()=>Ie.A,eventListener:()=>i,generateVolumePropsFromImageIds:()=>ke.D,genericMetadataProvider:()=>Ae.A,getBufferConfiguration:()=>Ne.h,getClosestImageId:()=>A.A,getClosestStackImageIndexForPoint:()=>le,getCurrentVolumeViewportSlice:()=>ce,getDynamicVolumeInfo:()=>pt,getImageLegacy:()=>be,getImageSliceDataForVolumeViewport:()=>oe.A,getMinMax:()=>v.A,getRandomSampleFromArray:()=>Ke,getRuntimeId:()=>I,getScalingParameters:()=>Ce.A,getSliceRange:()=>ne.A,getSpacingInNormalDirection:()=>D.A,getTargetVolumeAndSpacingInNormalDir:()=>x.A,getViewportImageCornersInWorld:()=>ve,getViewportImageIds:()=>Ze,getViewportModality:()=>St,getViewportsWithImageURI:()=>se,getViewportsWithVolumeId:()=>P.A,getVoiFromSigmoidRGBTransferFunction:()=>c.A,getVolumeActorCorners:()=>M.A,getVolumeId:()=>Xe.A,getVolumeSliceRangeInfo:()=>ee.A,getVolumeViewportScrollInfo:()=>te.A,getVolumeViewportsContainingSameVolumes:()=>L,hasFloatScalingParameters:()=>Je.a,hasNaNValues:()=>fe.A,imageIdToURI:()=>C.A,imageRetrieveMetadataProvider:()=>Re.A,imageToWorldCoords:()=>Q,indexWithinDimensions:()=>O,invertRgbTransferFunction:()=>l.A,isEqual:()=>S.n4,isEqualAbs:()=>S.Ph,isEqualNegative:()=>S.WC,isImageActor:()=>ae.e,isOpposite:()=>y,isPTPrescaledWithSUV:()=>G,isValidVolume:()=>De,isVideoTransferSyntax:()=>Pe,jumpToSlice:()=>bt,loadImageToCanvas:()=>Y,makeVolumeMetadata:()=>ye.A,planar:()=>re,pointInShapeCallback:()=>Qe.i,renderToCanvasCPU:()=>Z,renderToCanvasGPU:()=>$,roundNumber:()=>qe,roundToPrecision:()=>ze,scaleArray:()=>wt,scaleRgbTransferFunction:()=>g,scroll:()=>Tt,snapFocalPointToSlice:()=>ie.A,sortImageIdsAndGetSpacing:()=>Se.A,spatialRegistrationMetadataProvider:()=>ue,splitImageIdsBy4DTags:()=>vt,transferFunctionUtils:()=>nt,transformIndexToWorld:()=>k.A,transformWorldToIndex:()=>N.A,triggerEvent:()=>u.A,updateVTKImageDataWithCornerstoneImage:()=>xe.J,uuidv4:()=>m.A,windowLevel:()=>et,worldToImageCoords:()=>J});var i={};n.r(i),n.d(i,{MultiTargetEventListenerManager:()=>r,TargetEventListeners:()=>s});var o,a={};n.r(a),n.d(a,{hexToRgb:()=>at,rgbToHex:()=>ot}),function(e){e[e.None=0]="None",e[e.Capture=1]="Capture",e[e.Bubble=2]="Bubble"}(o||(o={}));class s{constructor(e){this._eventListeners=new Map,this._children=new Map,this._target=e}get isEmpty(){return 0===this._eventListeners.size&&0===this._children.size}addEventListener(e,t,n){const i=e.indexOf(".");if(-1!==i){const o=e.substring(0,i);let a=this._children.get(o);a||(a=new s(this._target),this._children.set(o,a)),e=e.substring(i+1),a.addEventListener(e,t,n)}else this._addEventListener(e,t,n)}removeEventListener(e,t,n){const i=e.indexOf(".");if(-1!==i){const o=e.substring(0,i),a=this._children.get(o);if(!a)return;e=e.substring(i+1),a.removeEventListener(e,t,n),a.isEmpty&&this._children.delete(o)}else this._removeEventListener(e,t,n)}reset(){Array.from(this._children.entries()).forEach((([e,t])=>{if(t.reset(),!t.isEmpty)throw new Error("Child is not empty and cannot be removed");this._children.delete(e)})),this._unregisterAllEvents()}_addEventListener(e,t,n){let i=this._eventListeners.get(e);i||(i=new Map,this._eventListeners.set(e,i));const a=n?.capture??!1?o.Capture:o.Bubble,s=i.get(t)??o.None;s&a?console.warn("A listener is already registered for this phase"):(i.set(t,s|a),this._target.addEventListener(e,t,n))}_removeEventListener(e,t,n){const i=n?.capture??!1?o.Capture:o.Bubble,a=this._eventListeners.get(e);if(!a)return;(t?[t]:Array.from(a.keys())).forEach((t=>{const s=a.get(t)??o.None;if(!!!(s&i))return;this._target.removeEventListener(e,t,n);const r=s^i;r===o.None?a.delete(t):a.set(t,r)})),a.size||this._eventListeners.delete(e)}_unregisterAllListeners(e,t){Array.from(t.entries()).forEach((([t,n])=>{for(let i=o.Capture;n;i<<=1){if(!(n&i))continue;const a=i===o.Capture;this.removeEventListener(e,t,{capture:a}),n^=i}}))}_unregisterAllEvents(){Array.from(this._eventListeners.entries()).forEach((([e,t])=>{this._unregisterAllListeners(e,t)}))}}class r{constructor(){this._targetsEventListeners=new Map}addEventListener(e,t,n,i){let o=this._targetsEventListeners.get(e);o||(o=new s(e),this._targetsEventListeners.set(e,o)),o.addEventListener(t,n,i)}removeEventListener(e,t,n,i){const o=this._targetsEventListeners.get(e);o&&(o.removeEventListener(t,n,i),o.isEmpty&&this._targetsEventListeners.delete(e))}reset(){Array.from(this._targetsEventListeners.entries()).forEach((([e,t])=>{t.reset(),this._targetsEventListeners.delete(e)}))}}var l=n(50134),d=n(40256),c=n(70210),h=n(74657);function g(e,t){const n=e.getSize();for(let i=0;i<n;i++){const n=[];e.getNodeValue(i,n),n[1]=n[1]*t,n[2]=n[2]*t,n[3]=n[3]*t,e.setNodeValue(i,n)}}var u=n(69372),m=n(80221),v=n(25308);const p=Symbol("LastRuntimeId"),f={},w=4294967295,E="-";function I(e,t,n){return function(e,t,n){let i=e[t];i instanceof Array||(i=[0],Object.defineProperty(e,t,{value:i}));for(let e=!0,t=0;e&&t<i.length;++t){let o=0|i[t];o<n?(e=!1,o+=1):(o=0,t+1===i.length&&i.push(0)),i[t]=o}return i}(null!==e&&"object"==typeof e?e:f,p,("number"==typeof n&&n>0?n:w)>>>0).join("string"==typeof t?t:E)}var C=n(39537);const _={},T={add:(e,t)=>{const n=(0,C.A)(e);_[n]=t},get:(e,t)=>{if("calibratedPixelSpacing"===e){const e=(0,C.A)(t);return _[e]}}};var b=n(84061),S=n(74638);function y(e,t,n=1e-5){return Math.abs(e[0]+t[0])<n&&Math.abs(e[1]+t[1])<n&&Math.abs(e[2]+t[2])<n}var A=n(88619),D=n(85008),x=n(65292),M=n(15105);function O(e,t){return!(e[0]<0||e[0]>=t[0]||e[1]<0||e[1]>=t[1]||e[2]<0||e[2]>=t[2])}var R=n(39536);const L=function(e,t){let n;n=t?[(0,R.lD)(t)]:(0,R.qO)();const i=[];return n.forEach((t=>{const n=e.getActors(),o=t.getVolumeViewports();for(const e of o){const t=e.getActors();if(t.length!==n.length)continue;n.every((({uid:e})=>t.find((t=>e===t.uid))))&&i.push(e)}})),i};var P=n(24724),N=n(38669),k=n(94741),U=n(80068),V=n(74876),W=n(31749),B=n(51159),H=n(30135),F=n(56706);const G=e=>e.preScale.scaled&&e.preScale.scalingParameters.suvbw;function $(e,t,n=void 0,i="_thumbnails",o={displayArea:{imageArea:[1,1]}}){if(!(e&&e instanceof HTMLCanvasElement))throw new Error("canvas element is required");const a=!t.imageId,s=!a&&t,r=a&&t,l=`renderGPUViewport-${s.imageId||r.volumeId}`,d=document.createElement("div"),c=window.devicePixelRatio||1;o.displayArea||(o.displayArea={imageArea:[1,1]});const h=e.width,g=e.height;d.style.width=`${h/c+H.p8}px`,d.style.height=`${g/c+H.p8}px`,d.style.visibility="hidden",d.style.position="absolute",document.body.appendChild(d);const u=l.split(":").join("-");d.setAttribute("viewport-id-for-remove",u);const m=(0,H.Ay)(d),v=(0,R.lD)(i)||new F.Ay(i);let p=v.getViewport(l);if(!p){const e={viewportId:l,type:a?W.ViewportType.ORTHOGRAPHIC:W.ViewportType.STACK,element:d,defaultOptions:{...o,suppressEvents:!0}};v.enableElement(e),p=v.getViewport(l)}return new Promise((i=>{let h=!1,{viewReference:g}=o;const f=t=>{if(h)return;if(g){const e=g;return g=null,p.setViewReference(e),void p.render()}e.getContext("2d").drawImage(m,0,0,m.width,m.height,0,0,e.width,e.height);const n=p.canvasToWorld([0,0]),o=p.canvasToWorld([m.width/c,0]),a=p.canvasToWorld([0,m.height/c]);h=!0,d.removeEventListener(W.Events.IMAGE_RENDERED,f),setTimeout((()=>{v.disableElement(l);document.querySelectorAll(`[viewport-id-for-remove="${u}"]`).forEach((e=>{e.remove()}))}),0),i({origin:n,bottomLeft:a,topRight:o,thicknessMm:1})};d.addEventListener(W.Events.IMAGE_RENDERED,f),a?p.setVolumes([r],!1,!0):p.renderImageObject(t),p.resetCamera(),"PT"!==n||G(s)||p.setProperties({voiRange:{lower:s.minPixelValue,upper:s.maxPixelValue}}),p.render()}))}var z=n(36931),q=n(7808),j=n(5057);function Z(e,t,n,i,o){if(t.volumeId)throw new Error("Unsupported volume rendering for CPU");const a=t,s={canvas:e,viewport:(0,z.A)(e,a,n),image:a,renderingTools:{}};s.transform=(0,q.A)(s);return new Promise(((e,t)=>{(0,j.A)(s,true),e(null)}))}n(59693);var K=n(49038);function Y(e){const{canvas:t,imageId:n,viewReference:i,requestType:o=W.RequestType.Thumbnail,priority:a=-5,renderingEngineId:s="_thumbnails",useCPURendering:r=!1,thumbnail:l=!1,imageAspect:d=!1,viewportOptions:c}=e,h=i?.volumeId,g=h&&!n,u=i&&c?{...c,viewReference:i}:c,m=r?Z:$;return new Promise(((e,i)=>{function c(n,o){const{modality:a}=V.get("generalSeriesModule",o)||{},c=!g&&n,h=g&&n;c&&(c.isPreScaled=c.isPreScaled||c.preScale?.scaled),l&&(t.height=256,t.width=256),d&&c&&(t.width=c&&t.height*c.width/c.height),t.style.width=t.width/devicePixelRatio+"px",t.style.height=t.height/devicePixelRatio+"px",h&&r&&i(new Error("CPU rendering of volume not supported")),m(t,n,a,s,u).then(e)}function v(e,t){console.error(e,t),i(e)}const p={useRGBA:!!r,requestType:o};if(h){const e=K.Ay.getVolume(h);e||i(new Error(`Volume id ${h} not found in cache`));c(e,e.imageIds[0])}else B.A.addRequest(function(e,t,n){return(0,U.loadAndCacheImage)(e,n).then((t=>{c.call(this,t,e)}),(t=>{v.call(this,t,e)}))}.bind(null,n,null,p),o,{imageId:n},a)}))}var X=n(3823);const J=function(e,t){const n=(0,V.get)("imagePlaneModule",e);if(!n)throw new Error(`No imagePlaneModule found for imageId: ${e}`);const{columnCosines:i,rowCosines:o,imagePositionPatient:a}=n;let{columnPixelSpacing:s,rowPixelSpacing:r}=n;s||=1,r||=1;const l=X.eR.create();X.eR.scaleAndAdd(l,a,i,-s/2),X.eR.scaleAndAdd(l,l,o,-r/2);const d=X.eR.create();return X.eR.sub(d,t,l),[X.eR.dot(d,o)/r,X.eR.dot(d,i)/s]};function Q(e,t){const n=(0,V.get)("imagePlaneModule",e);if(!n)throw new Error(`No imagePlaneModule found for imageId: ${e}`);const{columnCosines:i,rowCosines:o,imagePositionPatient:a}=n;let{columnPixelSpacing:s,rowPixelSpacing:r}=n;s||=1,r||=1;const l=X.eR.create();return X.eR.scaleAndAdd(l,a,o,r*(t[0]-.5)),X.eR.scaleAndAdd(l,l,i,s*(t[1]-.5)),Array.from(l)}var ee=n(4031),te=n(61375),ne=n(20537),ie=n(80500),oe=n(47476),ae=n(98039);function se(e){const t=(0,R.qO)(),n=[];return t.forEach((t=>{t.getViewports().forEach((t=>{t.hasImageURI(e)&&n.push(t)}))})),n}var re=n(52268);function le(e,t){const n=function(e,t){const n=t.getImageIds(),i=t.getCurrentImageIdIndex();if(0===n.length)return null;const o=t=>{const n=function(e){const t=V.get("imagePlaneModule",e);if(!(t&&t.rowCosines instanceof Array&&3===t.rowCosines.length&&t.columnCosines instanceof Array&&3===t.columnCosines.length&&t.imagePositionPatient instanceof Array&&3===t.imagePositionPatient.length))return null;const{rowCosines:n,columnCosines:i,imagePositionPatient:o}=t,a=X.eR.set(X.eR.create(),...n),s=X.eR.set(X.eR.create(),...i),r=X.eR.cross(X.eR.create(),a,s);return{rowCosines:n,columnCosines:i,imagePositionPatient:o,planeNormal:r}}(t);if(!n)return null;const i=re.planeEquation(n.planeNormal,n.imagePositionPatient);return re.planeDistanceToPoint(i,e)},a={distance:o(n[i])??1/0,index:i},s=n.slice(i+1);for(let e=0;e<s.length;e++){const t=o(s[e]);if(null!==t){if(!(t<=a.distance))break;a.distance=t,a.index=e+i+1}}const r=n.slice(0,i);for(let e=r.length-1;e>=0;e--){const t=o(r[e]);if(null!==t&&t!==a.distance){if(!(t<a.distance))break;a.distance=t,a.index=e}}return a.distance===1/0?null:a}(e,t);return n?n.index:null}var de=n(51919);function ce(e){const{width:t,height:n}=e.getCanvas(),{sliceToIndexMatrix:i,indexToSliceMatrix:o}=e.getSliceViewInfo(),a=(0,de.e)(e,[0,0]),s=(0,de.e)(e,[t-1,0]),r=(0,de.e)(e,[0,n-1]),l=X.eR.sub(X.eR.create(),s,a),d=X.eR.sub(X.eR.create(),r,a),c=X.eR.cross(X.eR.create(),l,d);X.eR.normalize(l,l),X.eR.normalize(d,d),X.eR.normalize(c,c);const h=Math.max(Math.abs(l[0]),Math.abs(l[1]),Math.abs(l[2])),g=Math.max(Math.abs(d[0]),Math.abs(d[1]),Math.abs(d[2]));if(!X.Fd.equals(1,h)||!X.Fd.equals(1,g))throw new Error("Livewire is not available for rotate/oblique viewports");const{voxelManager:u}=e.getImageData(),m=e.getSliceViewInfo(),v=u.getSliceData(m);return{width:m.width,height:m.height,scalarData:v,sliceToIndexMatrix:i,indexToSliceMatrix:o}}const he={},ge={add:(e,t)=>{const[n,i]=e,o=`${n}_${i}`;he[o]||(he[o]={}),he[o]=t},get:(e,t,n)=>{if("spatialRegistrationModule"!==e)return;const i=`${t}_${n}`;if(he[i])return he[i];const o=`${n}_${t}`;return he[o]?X.pB.invert(X.pB.create(),he[o]):void 0}};(0,V.addProvider)(ge.get.bind(ge));const ue=ge;const me=function(e,t){const n=e.getSliceIndex(),i=t.getSliceIndex(),o=(0,V.get)("imagePlaneModule",n.toString()),a=(0,V.get)("imagePlaneModule",i.toString());if(!o||!a)return void console.log("Viewport spatial registration requires image plane module");const{imageOrientationPatient:s}=a;if(!o.imageOrientationPatient.every(((e,t)=>Math.abs(e-s[t])<.05)))return void console.log("Viewport spatial registration only supported for same orientation (hence translation only) for now",o?.imageOrientationPatient,a?.imageOrientationPatient);const r=o.imagePositionPatient,l=a.imagePositionPatient,d=X.eR.subtract(X.eR.create(),r,l),c=X.pB.fromTranslation(X.pB.create(),d);ue.add([e.id,t.id],c)};function ve(e){const{imageData:t,dimensions:n}=e.getImageData(),{canvas:i}=e,o=window.devicePixelRatio,a=[i.width/o,0],s=[i.width/o,i.height/o],r=[0,i.height/o],l=e.canvasToWorld([0,0]),d=e.canvasToWorld(a),c=e.canvasToWorld(s),h=e.canvasToWorld(r),g=t.worldToIndex(l),u=t.worldToIndex(d),m=t.worldToIndex(c),v=t.worldToIndex(h);return function({dimensions:e,imageData:t,topLeftImage:n,topRightImage:i,bottomRightImage:o,bottomLeftImage:a,topLeftWorld:s,topRightWorld:r,bottomRightWorld:l,bottomLeftWorld:d}){const c=pe(n,e)?s:t.indexToWorld([0,0,0]),h=pe(i,e)?r:t.indexToWorld([e[0]-1,0,0]),g=pe(o,e)?l:t.indexToWorld([e[0]-1,e[1]-1,0]),u=pe(a,e)?d:t.indexToWorld([0,e[1]-1,0]);return[c,h,u,g]}({dimensions:n,imageData:t,topLeftImage:g,topRightImage:u,bottomRightImage:m,bottomLeftImage:v,topLeftWorld:l,topRightWorld:d,bottomRightWorld:c,bottomLeftWorld:h})}function pe(e,t){return e[0]>0||e[0]<t[0]-1||e[1]>0||e[1]<t[1]-1||e[2]>0||e[2]<t[2]-1}var fe=n(38883),we=n(96833);class Ee{constructor(e={}){this._dimensions=3,this._length=0,this._byteSize=4,this.growSize=128;const{initialSize:t=1024,dimensions:n=3,growSize:i=128}=e,o=t*n;this.growSize=i,this.array=new ArrayBuffer(o*this._byteSize),this.data=new Float32Array(this.array),this._dimensions=n}forEach(e){for(let t=0;t<this._length;t++)e(this.getPoint(t),t)}get length(){return this._length}get dimensions(){return this._dimensions}get dimensionLength(){return this._length*this._dimensions}getPoint(e){if(e<0&&(e+=this._length),e<0||e>=this._length)return;const t=this._dimensions*e;return this.data.subarray(t,t+this._dimensions)}getPointArray(e){const t=[];if(e<0&&(e+=this._length),e<0||e>=this._length)return;const n=this._dimensions*e;for(let e=0;e<this._dimensions;e++)t.push(this.data[e+n]);return t}grow(e=1,t=this.growSize){if(this.dimensionLength+e*this._dimensions<=this.data.length)return;const n=this.data.length+t,i=new ArrayBuffer(n*this._dimensions*this._byteSize),o=new Float32Array(i);o.set(this.data),this.data=o,this.array=i}reverse(){const e=Math.floor(this._length/2);for(let t=0;t<e;t++){const e=t*this._dimensions,n=(this._length-1-t)*this._dimensions;for(let t=0;t<this._dimensions;t++){const i=this.data[e+t];this.data[e+t]=this.data[n+t],this.data[n+t]=i}}}push(e){this.grow(1);const t=this.length*this._dimensions;for(let n=0;n<this._dimensions;n++)this.data[n+t]=e[n];this._length++}map(e){const t=[];for(let n=0;n<this._length;n++)t.push(e(this.getPoint(n),n));return t}get points(){return this.map((e=>e))}toXYZ(){const e={x:[],y:[]};this._dimensions>=3&&(e.z=[]);const{x:t,y:n,z:i}=e;return this.forEach((e=>{t.push(e[0]),n.push(e[1]),i&&i.push(e[2])})),e}static fromXYZ({x:e,y:t,z:n}){const i=Ee.create3(e.length);let o=0;for(let a=0;a<e.length;a++)i.data[o++]=e[a],i.data[o++]=t[a],i.data[o++]=n?n[a]:0;return i._length=e.length,i}subselect(e=10,t=0){const n=new Ee({initialSize:e,dimensions:this._dimensions});for(let i=0;i<e;i++){const o=(t+Math.floor(this.length*i/e))%this.length;n.push(this.getPoint(o))}return n}static create3(e=128){return new Ee({initialSize:e,dimensions:3})}static create2(e=128){return new Ee({initialSize:e,dimensions:2})}}var Ie=n(74268),Ce=n(32173),_e=n(58165),Te=n(86846);const be=function(e){const t=(0,Te.Ay)(e);if(!t)return;const{viewport:n}=t;if(!(n instanceof _e.A))throw new Error(`An image can only be fetched for a stack viewport and not for a viewport of type: ${n.type}`);return n.getCornerstoneImage()};var Se=n(90537),ye=n(1865),Ae=n(27119);function De(e){const t=e[0],{modality:n,seriesInstanceUID:i}=V.get("generalSeriesModule",t),{imageOrientationPatient:o,pixelSpacing:a,frameOfReferenceUID:s,columns:r,rows:l}=V.get("imagePlaneModule",t),d={modality:n,imageOrientationPatient:o,pixelSpacing:a,frameOfReferenceUID:s,columns:r,rows:l,seriesInstanceUID:i},c=e.every((e=>{const{modality:t,seriesInstanceUID:n}=V.get("generalSeriesModule",e),{imageOrientationPatient:i,pixelSpacing:o,columns:a,rows:s}=V.get("imagePlaneModule",e);return n===d.seriesInstanceUID&&t===d.modality&&a===d.columns&&s===d.rows&&(0,S.Ay)(i,d.imageOrientationPatient)&&(0,S.Ay)(o,d.pixelSpacing)}));return c}var xe=n(45278),Me=n(22191),Oe=n(63470),Re=n(17791);const Le=new Set(["1.2.840.10008.1.2.4.100","1.2.840.10008.1.2.4.100.1","1.2.840.10008.1.2.4.101","1.2.840.10008.1.2.4.101.1","1.2.840.10008.1.2.4.102","1.2.840.10008.1.2.4.102.1","1.2.840.10008.1.2.4.103","1.2.840.10008.1.2.4.103.1","1.2.840.10008.1.2.4.104","1.2.840.10008.1.2.4.104.1","1.2.840.10008.1.2.4.105","1.2.840.10008.1.2.4.105.1","1.2.840.10008.1.2.4.106","1.2.840.10008.1.2.4.106.1","1.2.840.10008.1.2.4.107","1.2.840.10008.1.2.4.108"]);function Pe(e){if(!e)return!1;return(Array.isArray(e)?e:[e]).find((e=>Le.has(e)))}var Ne=n(99576),ke=n(9734),Ue=n(98834),Ve=n(39561);async function We({viewport:e,options:t={}}){const n=e.getRenderingEngine();let i=t.volumeId||`${(0,m.A)()}`;if(0===i.split(":").length){i=`${(0,Ve.getUnknownVolumeLoaderSchema)()}:${i}`}const{id:o,element:a}=e,s=t.viewportId||o,r=e.getImageIds(),l=e.getViewPresentation(),d=e.getViewReference();n.enableElement({viewportId:s,type:W.ViewportType.ORTHOGRAPHIC,element:a,defaultOptions:{background:t.background,orientation:t.orientation}});(await(0,Ve.createAndCacheVolume)(i,{imageIds:r})).load();const c=n.getViewport(s);await(0,Ue.A7)(n,[{volumeId:i}],[s]);const h=()=>{c.render(),a.removeEventListener(W.Events.VOLUME_VIEWPORT_NEW_VOLUME,h)};return a.addEventListener(W.Events.VOLUME_VIEWPORT_NEW_VOLUME,h),c.setViewPresentation(l),c.setViewReference(d),c.render(),c}var Be=n(86252);async function He({viewport:e,options:t}){const n=e,{id:i,element:o}=n,a=e.getRenderingEngine(),{background:s}=t,r=t.viewportId||i,l=K.Ay.getVolume(n.getVolumeId());if(!(l instanceof Be.Q))throw new Error("Currently, you cannot decache a volume that is not an ImageVolume. So, unfortunately, volumes such as nifti  (which are basic Volume, without imageIds) cannot be decached.");const d={viewportId:r,type:W.ViewportType.STACK,element:o,defaultOptions:{background:s}},c=n.getViewReference();a.enableElement(d);const h=a.getViewport(r);return await h.setStack(l.imageIds),h.setViewReference(c),h.render(),h}var Fe=n(24623),Ge=n(67645),$e=n(19325);function ze(e){return Math.round(e/$e.EPSILON)*$e.EPSILON}const qe=function e(t,n=2){if(Array.isArray(t))return t.map((t=>e(t,n))).join(", ");if(null==t||""===t)return"NaN";t=Number(t);const i=Math.abs(t);if(i<1e-4)return`${t}`;const o=i>=100?n-2:i>=10?n-1:i>=1?n:i>=.1?n+1:i>=.01?n+2:i>=.001?n+3:n+4;return t.toFixed(o)};function je(e,t,n){const i=e.length===t*n*4,o=e.length===t*n*3;if(i||o){const o=new Float32Array(t*n);let a=0,s=0;const r=i?4:3;for(let i=0;i<t;i++)for(let t=0;t<n;t++){const t=e[a],n=e[a+1],i=e[a+2];o[s]=(t+n+i)/3,a+=r,s++}return o}return e}const Ze=function(e){if(e instanceof F.PX){return K.Ay.getVolume(e.getVolumeId()).imageIds}if(e.getImageIds)return e.getImageIds()};function Ke(e,t){const n=[...e];return t>=n.length?(Ye(n),n):(Ye(n),n.slice(0,t))}function Ye(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}var Xe=n(12437),Je=n(30169),Qe=n(56577),et=n(68136),tt=n(13859),nt=n(85745);function it(e){const t=e.toString(16);return 1==t.length?"0"+t:t}function ot(e,t,n){return"#"+it(e)+it(t)+it(n)}function at(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function st(e,t){if(e===t)return!0;if(null==e||null==t)return!1;try{return JSON.stringify(e)===JSON.stringify(t)}catch(n){return console.debug("Error in JSON.stringify during deep comparison:",n),e===t}}const rt=(e,t)=>e.reduce(((e,n)=>((e[n[t]]=e[n[t]]||[]).push(n),e)),{});function lt(e,t){const n={};let i=[];const o=Object.keys(e);for(let a=0;a<o.length;a++){const s=new Set,r=e[o[a]];for(let e=0;e<r.length;e++){const i=t(r[e].imageId)||0;if(n[i]=n[i]||[],n[i].push({imageId:r[e].imageId}),s.add(i),s.size-1<e)return}if(0==a)i=Array.from(s);else if(!ut(i,s))return}return n}function dt(e,t){const n=V.get(t,e);try{return parseFloat(n)}catch{return}}function ct(e){const t=V.get("20011003",e);try{const{InlineBinary:e}=t;if(e){const t=atob(e),n=new ArrayBuffer(t.length),i=new DataView(n);for(let e=0;e<t.length;e++)i.setUint8(e,t.charCodeAt(e));return new Float32Array(n)[0]}return parseFloat(t)}catch{return}}function ht(e){let t=V.get("0019100c",e)||V.get("0019100C",e);try{const{InlineBinary:e}=t;return e&&(t=atob(e)),parseFloat(t)}catch{return}}function gt(e){let t=V.get("00431039",e);try{const{InlineBinary:e}=t;return e&&(t=atob(e).split("//")),parseFloat(t[0])%1e5}catch{return}}function ut(e,t){if(e.length!=t.size)return!1;for(let n=0;n<e.length;n++)if(!t.has(e[n]))return!1;return!0}function mt(e){const t=V.get("petImageModule",e);return t?t.frameReferenceTime:0}const vt=function(e){const t=function(e){const t=e.map((e=>{const{imagePositionPatient:t}=V.get("imagePlaneModule",e)||{};return{imageId:e,imagePositionPatient:t}}));if(!t.every((e=>e.imagePositionPatient)))return null;const n=rt(t,"imagePositionPatient"),i=Object.keys(n),o=n[i[0]].length;return 1===o?null:i.every((e=>n[e].length===o))?n:null}(e);if(!t)return{imageIdGroups:[e],splittingTag:null};const n=["TemporalPositionIdentifier","DiffusionBValue","TriggerTime","EchoTime","EchoNumber","PhilipsPrivateBValue","SiemensPrivateBValue","GEPrivateBValue","PetFrameReferenceTime"],i=[e=>dt(e,n[0]),e=>dt(e,n[1]),e=>dt(e,n[2]),e=>dt(e,n[3]),e=>dt(e,n[4]),ct,ht,gt,mt];for(let e=0;e<i.length;e++){const o=lt(t,i[e]);if(o){return{imageIdGroups:Object.keys(o).map(Number.parseFloat).sort(((e,t)=>e-t)).map((e=>o[e].map((e=>e.imageId)))),splittingTag:n[e]}}}return{imageIdGroups:[e],splittingTag:null}};const pt=function(e){const{imageIdGroups:t,splittingTag:n}=vt(e);return{isDynamicVolume:t.length>1,timePoints:t,splittingTag:n}};var ft=n(91979);function wt(e,t){const n=e.length,{rescaleSlope:i,rescaleIntercept:o,suvbw:a}=t;if("PT"===t.modality&&"number"==typeof a)for(let t=0;t<n;t++)e[t]=a*(e[t]*i+o);else for(let t=0;t<n;t++)e[t]=e[t]*i+o;return e}var Et=n(99949);function It(e,t,n){return Math.min(Math.max(t,e),n)}const Ct=It;var _t=n(10364);function Tt(e,t){if(!(0,Te.Ay)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof F.hS&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{volumeId:n,delta:i,scrollSlabs:o}=t;if(e instanceof F.PX)!function(e,t,n,i=!1){const o=i,{numScrollSteps:a,currentStepIndex:s,sliceRangeInfo:r}=(0,te.A)(e,t,o);if(!r)return;const{sliceRange:l,spacingInNormalDirection:d,camera:c}=r,{focalPoint:h,viewPlaneNormal:g,position:m}=c,{newFocalPoint:v,newPosition:p}=(0,ie.A)(h,m,l,g,d,n);e.setCamera({focalPoint:v,position:p}),e.render();const f=s+n,w={volumeId:t,viewport:e,delta:n,desiredStepIndex:f,currentStepIndex:s,numScrollSteps:a,currentImageId:e.getCurrentImageId()};(f>a||f<0)&&e.getCurrentImageId()?(0,u.A)(_t.A,W.Events.VOLUME_VIEWPORT_SCROLL_OUT_OF_BOUNDS,w):(0,u.A)(_t.A,W.Events.VOLUME_VIEWPORT_SCROLL,w)}(e,n,i,o);else{const n=e.getCurrentImageIdIndex();if(n+i>e.getImageIds().length-1||n+i<0){const e={imageIdIndex:n,direction:i};(0,u.A)(_t.A,W.Events.STACK_SCROLL_OUT_OF_BOUNDS,e)}e.scroll(i,t.debounceLoading,t.loop)}}async function bt(e,t={}){const{imageIndex:n,debounceLoading:i,volumeId:o}=t,a=(0,Te.Ay)(e);if(!a)throw new Error("Element has been disabled");const{viewport:s}=a,{imageIndex:r,numberOfSlices:l}=function(e,t){if(e instanceof _e.A)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};return{numberOfSlices:e.getNumberOfSlices(),imageIndex:e.getSliceIndex()}}(s,i),d=function(e,t){const n=e-1;return Ct(t,0,n)}(l,n);Tt(s,{delta:d-r,debounceLoading:i,volumeId:o})}const St=(e,t)=>function(e,t,n){if(!n)throw new Error("getVolume is required, use the utilities export instead ");if(e.modality)return e.modality;if(e.setVolumes){if(!(t=t??e.getVolumeId())||!n)return;return n(t).metadata.Modality}throw new Error("Invalid viewport type")}(e,t,K.Ay.getVolume)},50134:(e,t,n)=>{"use strict";function i(e){if(!e)return;const t=e.getSize();for(let n=0;n<t;n++){const t=[];e.getNodeValue(n,t),t[1]=1-t[1],t[2]=1-t[2],t[3]=1-t[3],e.setNodeValue(n,t)}}n.d(t,{A:()=>i})},74638:(e,t,n)=>{"use strict";function i(e,t,n){return Math.abs(e-t)<=n}function o(e){return"number"==typeof e}function a(e){return e&&"object"==typeof e&&"length"in e&&"number"==typeof e.length&&e.length>0&&"number"==typeof e[0]}function s(e,t,n=1e-5){return typeof e==typeof t&&null!==e&&null!==t&&(o(e)&&o(t)?i(e,t,n):!(!a(e)||!a(t))&&function(e,t,n=1e-5){if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(!i(e[o],t[o],n))return!1;return!0}(e,t,n))}n.d(t,{Ay:()=>s,Ph:()=>c,WC:()=>d,n4:()=>s});const r=e=>"number"==typeof e?-e:e?.map?e.map(r):!e,l=e=>"number"==typeof e?Math.abs(e):e?.map?e.map(l):e,d=(e,t,n=void 0)=>s(e,r(t),n),c=(e,t,n=void 0)=>s(l(e),l(t),n)},1865:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(74876);function o(e){const t=e[0],{pixelRepresentation:n,bitsAllocated:o,bitsStored:a,highBit:s,photometricInterpretation:r,samplesPerPixel:l}=(0,i.get)("imagePixelModule",t),d=[],c=(0,i.get)("voiLutModule",t);let h;if(c){const{windowWidth:e,windowCenter:t}=c;if(h=c?.voiLUTFunction,Array.isArray(e))for(let n=0;n<e.length;n++)d.push({windowWidth:e[n],windowCenter:t[n]});else d.push({windowWidth:e,windowCenter:t})}else d.push({windowWidth:void 0,windowCenter:void 0});const{modality:g,seriesInstanceUID:u}=(0,i.get)("generalSeriesModule",t),{imageOrientationPatient:m,pixelSpacing:v,frameOfReferenceUID:p,columns:f,rows:w}=(0,i.get)("imagePlaneModule",t);return{BitsAllocated:o,BitsStored:a,SamplesPerPixel:l,HighBit:s,PhotometricInterpretation:r,PixelRepresentation:n,Modality:g,ImageOrientationPatient:m,PixelSpacing:v,FrameOfReferenceUID:p,Columns:f,Rows:w,voiLut:d,VOILUTFunction:h,SeriesInstanceUID:u}}},52268:(e,t,n)=>{"use strict";n.r(t),n.d(t,{linePlaneIntersection:()=>o,planeDistanceToPoint:()=>r,planeEquation:()=>a,threePlaneIntersection:()=>s});var i=n(3823);function o(e,t,n){const[i,o,a]=e,[s,r,l]=t,[d,c,h,g]=n,u=s-i,m=r-o,v=l-a,p=-1*(d*i+c*o+h*a-g)/(d*u+c*m+h*v);return[u*p+i,m*p+o,v*p+a]}function a(e,t,n=!1){const[i,o,a]=e,s=i*t[0]+o*t[1]+a*t[2];if(n){const e=Math.sqrt(i*i+o*o+a*a);return[i/e,o/e,a/e,s/e]}return[i,o,a,s]}function s(e,t,n){const[o,a,s,r]=e,[l,d,c,h]=t,[g,u,m,v]=n,p=i.w0.fromValues(o,l,g,a,d,u,s,c,m),f=i.w0.fromValues(r,h,v,a,d,u,s,c,m),w=i.w0.fromValues(o,l,g,r,h,v,s,c,m),E=i.w0.fromValues(o,l,g,a,d,u,r,h,v);return[i.w0.determinant(f)/i.w0.determinant(p),i.w0.determinant(w)/i.w0.determinant(p),i.w0.determinant(E)/i.w0.determinant(p)]}function r(e,t,n=!1){const[i,o,a,s]=e,[r,l,d]=t,c=i*r+o*l+a*d-s,h=Math.abs(c)/Math.sqrt(i*i+o*o+a*a);return(n?Math.sign(c):1)*h}},56577:(e,t,n)=>{"use strict";n.d(t,{i:()=>o});var i=n(3823);function o(e,t){const{pointInShapeFn:n,callback:o,boundsIJK:a,returnPoints:s=!1}=t;let r,l,d,c,h,g,u;const{numComps:m}=e;if(u=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData(),!u)return void console.warn("No scalar data found for imageData",e);const v=e.getDimensions();a?[[r,l],[d,c],[h,g]]=a:(r=0,l=v[0],d=0,c=v[1],h=0,g=v[2]);const p=i.eR.fromValues(r,d,h),f=e.getDirection(),w=f.slice(0,3),E=f.slice(3,6),I=f.slice(6,9),C=e.getSpacing(),[_,T,b]=C,S=e.indexToWorld(p),y=i.eR.fromValues(w[0]*_,w[1]*_,w[2]*_),A=i.eR.fromValues(E[0]*T,E[1]*T,E[2]*T),D=i.eR.fromValues(I[0]*b,I[1]*b,I[2]*b),x=m||u.length/v[2]/v[1]/v[0],M=v[0]*x,O=v[1]*M,R=[],L=i.eR.clone(S);for(let e=h;e<=g;e++){const t=i.eR.clone(L);for(let t=d;t<=c;t++){const a=i.eR.clone(L);for(let a=r;a<=l;a++){const s=[a,t,e];if(n(L,s)){const n=e*O+t*M+a*x;let i;i=x>2?[u[n],u[n+1],u[n+2]]:u[n],R.push({value:i,index:n,pointIJK:s,pointLPS:L.slice()}),o&&o({value:i,index:n,pointIJK:s,pointLPS:L})}i.eR.add(L,L,y)}i.eR.copy(L,a),i.eR.add(L,L,A)}i.eR.copy(L,t),i.eR.add(L,L,D)}return s?R:void 0}},80500:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(3823);function o(e,t,n,o,a,s){const{min:r,max:l,current:d}=n,c=i.eR.create();i.eR.sub(c,t,e);const h=Math.round((l-r)/a),g=(d-r)/(l-r)*h;let u=Math.round(g),m=[e[0]-o[0]*g*a,e[1]-o[1]*g*a,e[2]-o[2]*g*a];u+=s,u>h?u=h:u<0&&(u=0);const v=u*a;m=[m[0]+o[0]*v,m[1]+o[1]*v,m[2]+o[2]*v];return{newFocalPoint:m,newPosition:[m[0]+c[0],m[1]+c[1],m[2]+c[2]]}}},90537:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(3823),o=n(74876),a=n(59693);function s(e,t){const{imagePositionPatient:n,imageOrientationPatient:s}=o.get("imagePlaneModule",e[0]);if(!t){const e=i.eR.fromValues(s[0],s[1],s[2]),n=i.eR.fromValues(s[3],s[4],s[5]);t=i.eR.create(),i.eR.cross(t,e,n)}const r=i.eR.create(),l="wadouri"===e[0].split(":")[0];let d,c;function h(e){const{imagePositionPatient:a}=o.get("imagePlaneModule",e),s=i.eR.create();return i.eR.sub(s,n,a),i.eR.dot(s,t)}if(i.eR.set(r,n[0],n[1],n[2]),l){const a=[e[0],e[Math.floor(e.length/2)]];d=e;h(a[0])-h(a[1])<0&&d.reverse();const s=o.get("imagePlaneModule",a[1]);if(!s)throw new Error("Incomplete metadata required for volume construction.");const r=i.eR.create();i.eR.sub(r,n,s.imagePositionPatient);const l=i.eR.dot(r,t);c=Math.abs(l)/Math.floor(e.length/2)}else{const t=e.map((e=>({distance:h(e),imageId:e})));t.sort(((e,t)=>t.distance-e.distance)),d=t.map((e=>e.imageId));const n=t.length;c=Math.abs(t[n-1].distance-t[0].distance)/(n-1)}const{imagePositionPatient:g,sliceThickness:u,spacingBetweenSlices:m}=o.get("imagePlaneModule",d[0]),{strictZSpacingForVolumeViewport:v}=(0,a.D0)().rendering;0!==c||v||(u&&m?(console.log("Could not calculate zSpacing. Using spacingBetweenSlices"),c=m):u?(console.log("Could not calculate zSpacing and no spacingBetweenSlices. Using sliceThickness"),c=u):(console.log("Could not calculate zSpacing. The VolumeViewport visualization is compromised. Setting zSpacing to 1 to render"),c=1));return{zSpacing:c,origin:g,sortedImageIds:d}}},85745:(e,t,n)=>{"use strict";function i(e){const t=e.getSize(),n=[];for(let i=0;i<t;i++){const t=[];e.getNodeValue(i,t),n.push(t)}return n}function o(e,t){t?.length&&(e.removeAllPoints(),t.forEach((t=>{e.addRGBPoint(...t)})))}n.r(t),n.d(t,{getTransferFunctionNodes:()=>i,setTransferFunctionNodes:()=>o})},51919:(e,t,n)=>{"use strict";n.d(t,{e:()=>o});var i=n(38669);function o(e,t){const{imageData:n}=e.getImageData(),o=e.canvasToWorld(t);return(0,i.A)(n,o)}},94741:(e,t,n)=>{"use strict";function i(e,t){return e.indexToWorld(t)}n.d(t,{A:()=>i})},38669:(e,t,n)=>{"use strict";function i(e,t){return e.worldToIndex(t).map(Math.round)}n.d(t,{A:()=>i})},45278:(e,t,n)=>{"use strict";function i(e,t){const n=t.voxelManager.getScalarData();if(!e.getPointData)return;const i=e.getPointData().getScalars().getData();if(t.color&&t.rgba){const e=new Uint8Array(t.columns*t.rows*3);for(let i=0;i<t.columns*t.rows;i++)e[3*i]=n[4*i],e[3*i+1]=n[4*i+1],e[3*i+2]=n[4*i+2];t.rgba=!1,t.getPixelData=()=>e,i.set(e)}else i.set(n);e.modified()}n.d(t,{J:()=>i})},68136:(e,t,n)=>{"use strict";function i(e,t){return{windowWidth:Math.abs(t-e)+1,windowCenter:(e+t+1)/2}}function o(e,t){return{lower:t-.5-(e-1)/2,upper:t-.5+(e-1)/2}}n.r(t),n.d(t,{toLowHighRange:()=>o,toWindowLevel:()=>i})},93952:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]]},94430:(e,t,n)=>{"use strict";n.d(t,{A:()=>a,i:()=>r});const i=Symbol("DefinedCursors"),o=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class a{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof a?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=s(a,i);let n=t.get(e);return n instanceof a?n:o.has(e)?(n=new a(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof a){return s(a,i).set(e,t),!0}return!1}}function s(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const r=o.values()},7001:(e,t,n)=>{"use strict";n.d(t,{hideElementCursor:()=>r,resetElementCursor:()=>s});var i=n(94430);const o=Symbol("ElementCursorsMap");function a(e,t){const n=l(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof i.A?t:i.A.getDefinedCursor("auto")).getStyleProperty()}function s(e){a(e,l(e)[1])}function r(e){a(e,i.A.getDefinedCursor("none"))}function l(e){let t=l[o];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(l,o,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}},79475:(e,t,n)=>{"use strict";var i=n(94430);n(81985);i.A;var o=n(99737);const a={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},s={x:127,y:60},r='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',l='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',d='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',c='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',h='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',g={Angle:u(a,{name:"Angle",iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:u(a,{name:"ArrowAnnotate",iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:u(a,{name:"Bidirectional",iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:u(a,{name:"CobbAngle",iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:u(a,{name:"CircleROI",iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:u(a,{name:"EllipticalROI",iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:u(a,{name:"FreehandROI",iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:u(a,{name:"FreehandROISculptor",iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:u(a,{name:"Length",iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Height:u(a,{name:"Height",iconContent:'<path d="m 6 22 l 8.5 0 v -16 h 8" stroke-width="3" fill="none" stroke="{{color}}" />',viewBox:{x:24,y:24}}),Probe:u(a,{name:"Probe",iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:u(a,{name:"RectangleROI",iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:u(a,{name:"TextMarker",iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:u(a,{name:"Crosshairs",iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:u(a,{name:"Eraser",iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:u(a,{name:"Magnify",iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:u(a,{name:"Pan",iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:u(a,{name:"Rotate",iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:u(a,{name:"StackScroll",iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:u(a,{name:"WindowLevelRegion",iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:u(a,{name:"WindowLevel",iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:u(a,{name:"Zoom",iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:u(a,{name:"SegmentationFreeHandEraseInside",iconContent:`${d} ${r}`,viewBox:s}),SegmentationFreeHandFillInside:u(a,{name:"SegmentationFreeHandFillInside",iconContent:`${d} ${l}`,viewBox:s}),SegmentationFreeHandEraseOutside:u(a,{name:"SegmentationFreeHandEraseOutside",iconContent:`${d} ${r}`,viewBox:s}),SegmentationFreeHandFillOutside:u(a,{name:"SegmentationFreeHandFillOutside",iconContent:`${d} ${l}`,viewBox:s}),SegmentationRectangleEraseInside:u(a,{name:"SegmentationRectangleEraseInside",iconContent:`${c} ${r}`,viewBox:s}),RectangleScissor:u(a,{name:"RectangleScissor",iconContent:`${c} ${l}`,viewBox:s}),"RectangleScissor.FILL_INSIDE":u(a,{name:"RectangleScissor.FILL_INSIDE",iconContent:`${c} ${l}`,viewBox:s}),"RectangleScissor.FILL_OUTSIDE":u(a,{name:"RectangleScissor.FILL_OUTSIDE",iconContent:`${c} ${l}`,viewBox:s}),"RectangleScissor.ERASE_OUTSIDE":u(a,{name:"RectangleScissor.ERASE_OUTSIDE",iconContent:`${c} ${r}`,viewBox:s}),"RectangleScissor.ERASE_INSIDE":u(a,{name:"RectangleScissor.ERASE_INSIDE",iconContent:`${c} ${r}`,viewBox:s}),CircleScissor:u(a,{name:"CircleScissor",iconContent:`${h} ${l}`,viewBox:s}),"CircleScissor.FILL_INSIDE":u(a,{name:"CircleScissor.FILL_INSIDE",iconContent:`${h} ${l}`,viewBox:s}),"CircleScissor.ERASE_OUTSIDE":u(a,{name:"CircleScissor.ERASE_OUTSIDE",iconContent:`${h} ${r}`,viewBox:s}),"CircleScissor.FILL_OUTSIDE":u(a,{name:"CircleScissor.FILL_OUTSIDE",iconContent:`${h} ${l}`,viewBox:s})};function u(e,t){return Object.assign(Object.create(e),{...t,name:t.name||e.name})}const m=Object.keys(g);n(76712);o.AnnotationStyleStates.Highlighted,o.ToolModes.Active;n(7001);i.i},89578:(e,t,n)=>{"use strict";n.d(t,{draw:()=>h,drawArrow:()=>O,drawCircle:()=>v,drawEllipseByCoordinates:()=>p,drawHandle:()=>f,drawHandles:()=>w,drawHeight:()=>I,drawLine:()=>E,drawLinkedTextBox:()=>D,drawPath:()=>_,drawPolyline:()=>C,drawRect:()=>M,drawRectByCoordinates:()=>x,drawRedactionRect:()=>R,drawTextBox:()=>S});var i=n(85204),o=n(81985);const a="viewport-element";function s(e,t){if(i.wk.svgNodeCache[e])return i.wk.svgNodeCache[e][t]?i.wk.svgNodeCache[e][t].domRef:void 0}function r(e,t,n,o){if(!i.wk.svgNodeCache[t])return null;i.wk.svgNodeCache[t][o]={touched:!0,domRef:n},e.appendChild(n)}function l(e,t){i.wk.svgNodeCache[e]&&i.wk.svgNodeCache[e][t]&&(i.wk.svgNodeCache[e][t].touched=!0)}function d(e,t){i.wk.svgNodeCache[t]&&Object.keys(i.wk.svgNodeCache[t]).forEach((n=>{const o=i.wk.svgNodeCache[t][n];!o.touched&&o.domRef&&(e.removeChild(o.domRef),delete i.wk.svgNodeCache[t][n])}))}const c=function(e){const t=(0,o.getEnabledElement)(e),{viewportId:n,renderingEngineId:c}=t,h=`${n}:${c}`,g=function(e){const t=`.${a}`,n=e.querySelector(t),i=n?.querySelector(":scope > .svg-layer");return i}(e);return Object.keys(i.wk.svgNodeCache[h]).forEach((e=>{i.wk.svgNodeCache[h][e].touched=!1})),{svgLayerElement:g,svgNodeCacheForCanvas:i.wk.svgNodeCache,getSvgNode:s.bind(this,h),appendNode:r.bind(this,g,h),setNodeTouched:l.bind(this,h),clearUntouched:d.bind(this,g,h)}};const h=function(e,t){const n=c(e);t(n),n.clearUntouched()};var g=n(97181);const u=function(e,t){Object.keys(e).forEach((n=>{const i=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):i!==o&&t.setAttribute(n,o)}))};const m=function(e,t){Object.keys(e).forEach((n=>{const i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)}))};const v=function(e,t,n,i,o,a={},s=""){const{color:r,fill:l,width:d,lineWidth:c,lineDash:h,fillOpacity:v,strokeOpacity:p}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),f=c||d,w=(0,g.A)(t,"circle",n),E=e.getSvgNode(w),I={cx:`${i[0]}`,cy:`${i[1]}`,r:`${o}`,stroke:r,fill:l,"stroke-width":f,"stroke-dasharray":h,"fill-opacity":v,"stroke-opacity":p};if(E)u(I,E),e.setNodeTouched(w);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==s&&t.setAttribute("data-id",s),m(I,t),e.appendNode(t,w)}};const p=function(e,t,n,i,o={},a=""){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),c=l||r,h=(0,g.A)(t,"ellipse",n),v=e.getSvgNode(h),[p,f,w,E]=i,I=Math.hypot(w[0]-E[0],w[1]-E[1]),C=Math.hypot(f[0]-p[0],f[1]-p[1]),_=180*Math.atan2(w[1]-E[1],w[0]-E[0])/Math.PI,T=[(w[0]+E[0])/2,(f[1]+p[1])/2],b={cx:`${T[0]}`,cy:`${T[1]}`,rx:`${I/2}`,ry:`${C/2}`,stroke:s,fill:"transparent",transform:`rotate(${_} ${T[0]} ${T[1]})`,"stroke-width":c,"stroke-dasharray":d};if(v)u(b,v),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==a&&t.setAttribute("data-id",a),m(b,t),e.appendNode(t,h)}};const f=function(e,t,n,i,o={},a){const{color:s,handleRadius:r,width:l,lineWidth:d,fill:c,type:h,opacity:v}=Object.assign({color:"rgb(0, 255, 0)",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},o),p=d||l,f=(0,g.A)(t,"handle",`hg-${n}-index-${a}`);let w;if("circle"===h)w={cx:`${i[0]}`,cy:`${i[1]}`,r,stroke:s,fill:c,"stroke-width":p,opacity:v};else{if("rect"!==h)throw new Error(`Unsupported handle type: ${h}`);{const e=1.5*parseFloat(r);w={x:`${i[0]-.5*e}`,y:`${i[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:s,fill:c,"stroke-width":p,rx:""+.1*e,opacity:v}}}const E=e.getSvgNode(f);if(E)u(w,E),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg",h);m(w,t),e.appendNode(t,f)}};const w=function(e,t,n,i,o={}){i.forEach(((i,a)=>{f(e,t,n,i,o,a)}))};function E(e,t,n,i,o,a={},s=""){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:r,width:l,lineWidth:d,lineDash:c,shadow:h}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),v=d||l,p=(0,g.A)(t,"line",n),f=e.getSvgNode(p),w=h?`filter:url(#shadow-${e.svgLayerElement.id});`:"",E={x1:`${i[0]}`,y1:`${i[1]}`,x2:`${o[0]}`,y2:`${o[1]}`,stroke:r,style:w,"stroke-width":v,"stroke-dasharray":c};if(f)u(E,f),e.setNodeTouched(p);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==s&&t.setAttribute("data-id",s),m(E,t),e.appendNode(t,p)}}function I(e,t,n,i,o,a={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a),c=o[0]+(i[0]-o[0])/2,h=[c,i[1]],g=[c,o[1]],u={start:i,end:h},m={start:h,end:g},v={start:g,end:o};E(e,t,"1",u.start,u.end,{color:s,width:r,lineWidth:l}),E(e,t,"2",m.start,m.end,{color:s,width:r,lineWidth:l}),E(e,t,"3",v.start,v.end,{color:s,width:r,lineWidth:l})}function C(e,t,n,i,o){if(i.length<2)return;const{color:a="rgb(0, 255, 0)",width:s=10,fillColor:r="none",fillOpacity:l=0,lineWidth:d,lineDash:c,closePath:h=!1}=o,v=d||s,p=(0,g.A)(t,"polyline",n),f=e.getSvgNode(p);let w="";for(const e of i)w+=`${e[0].toFixed(1)}, ${e[1].toFixed(1)} `;if(h){const e=i[0];w+=`${e[0]}, ${e[1]}`}const E={points:w,stroke:a,fill:r,"fill-opacity":l,"stroke-width":v,"stroke-dasharray":c};if(f)u(E,f),e.setNodeTouched(p);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");m(E,t),e.appendNode(t,p)}}function _(e,t,n,i,o){const a=i.length&&i[0].length&&Array.isArray(i[0][0])?i:[i],{color:s="rgb(0, 255, 0)",width:r=10,fillColor:l="none",fillOpacity:d=0,lineWidth:c,lineDash:h,closePath:v=!1}=o,p=c||r,f=(0,g.A)(t,"path",n),w=e.getSvgNode(f);let E="";for(let e=0,t=a.length;e<t;e++){const t=a[e],n=t.length;if(!(n<2)){for(let e=0;e<n;e++){const n=t[e];E+=`${e?"L":"M"} ${n[0].toFixed(1)}, ${n[1].toFixed(1)} `}v&&(E+="Z ")}}if(!E)return;const I={d:E,stroke:s,fill:l,"fill-opacity":d,"stroke-width":p,"stroke-dasharray":h};if(w)u(I,w),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");m(I,t),e.appendNode(t,f)}}function T(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function b(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const i=e.getBBox(),o={x:`${i.x}`,y:`${i.y}`,width:`${i.width}`,height:`${i.height}`,fill:t};return u(o,n),i}const S=function(e,t,n,i,o,a={}){return function(e,t,n,i=[""],o,a){const{padding:s,color:r,fontFamily:l,fontSize:d,background:c}=a;let h;const[m,v]=[o[0]+s,o[1]+s],p="http://www.w3.org/2000/svg",f=(0,g.A)(t,"text",n),w=e.getSvgNode(f);if(w){const t=w.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],o=i[e]||"";t.textContent=o}if(i.length>n.length){for(let e=0;e<i.length-n.length;e++){const o=T(i[e+n.length]);t.appendChild(o)}w.appendChild(t),e.appendNode(w,f)}const o={transform:`translate(${m} ${v})`};u({fill:r,"font-size":d,"font-family":l},t),u(o,w),h=b(w,c),e.setNodeTouched(f)}else{const t=document.createElementNS(p,"g");t.setAttribute("transform",`translate(${m} ${v})`);const n=function(e,t){const{color:n,fontFamily:i,fontSize:o}=t,a="http://www.w3.org/2000/svg",s=document.createElementNS(a,"text"),r="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${r}${l}`;return s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("fill",n),s.setAttribute("font-family",i),s.setAttribute("font-size",o),s.setAttribute("style",d),s}(e,a);for(let e=0;e<i.length;e++){const t=T(i[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,f),h=b(t,c)}return Object.assign({},h,{x:m,y:v,height:h.height+s,width:h.width+s})}(e,t,n,i,o,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a))};var y=n(90554);const A=function(e,t,n,i,o,a,s={}){const r=i.length>0?(0,y.A)(i,o):o,l=function(e){const{x:t,y:n,height:i,width:o}=e,a=o/2,s=i/2;return[[t+a,n],[t,n+s],[t+a,n+i],[t+o,n+s]]}(a);E(e,t,`link-${n}`,r,(0,y.A)(l,r),Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},s))};const D=function(e,t,n,i,o,a,s,r={}){const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},r),d=S(e,t,n,i,o,l);return A(e,t,n,a,o,d,l),d};function x(e,t,n,i,o={},a=""){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),c=l||r,h=(0,g.A)(t,"rect",n),v=e.getSvgNode(h),[p,f,w,E]=i,I=Math.hypot(p[0]-f[0],p[1]-f[1]),C=Math.hypot(p[0]-w[0],p[1]-w[1]),_=[(E[0]+p[0])/2,(E[1]+p[1])/2],T=[(w[0]+p[0])/2,(w[1]+p[1])/2],b=180*Math.atan2(_[1]-T[1],_[0]-T[0])/Math.PI,S={x:""+(_[0]-I/2),y:""+(_[1]-C/2),width:`${I}`,height:`${C}`,stroke:s,fill:"transparent",transform:`rotate(${b} ${_[0]} ${_[1]})`,"stroke-width":c,"stroke-dasharray":d};if(v)u(S,v),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==a&&t.setAttribute("data-id",a),m(S,t),e.appendNode(t,h)}}function M(e,t,n,i,o,a={},s=""){x(e,t,n,[[i[0],i[1]],[o[0],i[1]],[i[0],o[1]],[o[0],o[1]]],a,s)}function O(e,t,n,i,o,a={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a);E(e,t,n,i,o,{color:s,width:r,lineWidth:l,lineDash:d});const c=Math.atan2(o[1]-i[1],o[0]-i[0]),h={start:[o[0]-10*Math.cos(c-Math.PI/7),o[1]-10*Math.sin(c-Math.PI/7)],end:o},g={start:[o[0]-10*Math.cos(c+Math.PI/7),o[1]-10*Math.sin(c+Math.PI/7)],end:o};E(e,t,"2",h.start,h.end,{color:s,width:r,lineWidth:l}),E(e,t,"3",g.start,g.end,{color:s,width:r,lineWidth:l})}function R(e,t,n,i,o,a={}){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l||r,h=(0,g.A)(t,"rect",n),v=e.getSvgNode(h),p=[Math.min(i[0],o[0]),Math.min(i[1],o[1])],f=Math.abs(i[0]-o[0]),w=Math.abs(i[1]-o[1]),E={x:`${p[0]}`,y:`${p[1]}`,width:`${f}`,height:`${w}`,stroke:s,fill:"black","stroke-width":c,"stroke-dasharray":d};if(v)u(E,v),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");m(E,t),e.appendNode(t,h)}}},75183:(e,t,n)=>{"use strict";var i;n.d(t,{A:()=>o}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated"}(i||(i={}));const o=i},94021:(e,t,n)=>{"use strict";var i;n.d(t,{A:()=>o}),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",e.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_ADDED",e.SEGMENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_ADDED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(i||(i={}));const o=i},84093:(e,t,n)=>{"use strict";var i;n.d(t,{A:()=>o}),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.ComputeInnerCircleRadius="computeInnerCircleRadius"}(i||(i={}));const o=i},49892:(e,t,n)=>{"use strict";var i;n.d(t,{A:()=>o}),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(i||(i={}));const o=i},10401:(e,t,n)=>{"use strict";var i;n.d(t,{H:()=>i}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(i||(i={}))},99737:(e,t,n)=>{"use strict";n.d(t,{AnnotationStyleStates:()=>s,ChangeTypes:()=>h.A,Events:()=>l.A,KeyboardBindings:()=>o.q,MouseBindings:()=>o.i,SegmentationRepresentations:()=>d.A,StrategyCallbacks:()=>c.A,ToolModes:()=>a.A,WorkerTypes:()=>g});var i,o=n(66452),a=n(49892);!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(i||(i={}));const s=i;var r,l=n(94021),d=n(18682),c=(n(10401),n(84093)),h=n(75183);!function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="Converting Contour to Labelmap",e.POLYSEG_SURFACE_TO_LABELMAP="Converting Surfaces to Labelmap",e.POLYSEG_CONTOUR_TO_SURFACE="Converting Contour to Surface",e.POLYSEG_LABELMAP_TO_SURFACE="Converting Labelmap to Surface",e.SURFACE_CLIPPING="Clipping Surfaces"}(r||(r={}));const g=r},50986:(e,t,n)=>{"use strict";n.d(t,{r:()=>c});n(81985),n(15295),n(95527);var i=n(58640),o=n(8056),a=n(82056),s=(n(93126),n(44049),n(72967)),r=n(64843);n(7754),n(68040);const l="PlanarFreehandContourSegmentationTool";function d(e,t){const n=e.length,i=new Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);return i}function c(e,t,n){const{windingDirection:c}=t.data.contour,{windingDirection:h}=n.data.contour;(0,a.addChildAnnotation)(t,n),(0,r.removeContourSegmentationAnnotation)(n);const{contour:g}=n.data,u=d(g.polyline,e);(0,s.A)(n,{points:u,closed:g.closed},e);const{element:m}=e,v=new Set([l,t.metadata.toolName,n.metadata.toolName]);for(const e of v.values()){const t=(0,o.getViewportIdsWithToolToRender)(m,e);(0,i.A)(t)}}},59718:(e,t,n)=>{"use strict";n.d(t,{kt:()=>i.A});n(91099),n(68014),n(41343);n(41666),n(82603);n(17806);var i=n(39595);n(24917),n(81985),n(98870),n(99737),n(59452);n(33283);n(42008),n(58498),n(78231),n(97577),n(93210);new Map;n(64843),n(50986);n(58640)},55139:(e,t,n)=>{"use strict";n.d(t,{utilities:()=>y});var i=n(81985),o=n(82056),a=n(99737);n(68040),n(59718),n(56069);n(94021),n(40100);n(74690);n(70333);const{Active:s,Passive:r,Enabled:l}=a.ToolModes,{Active:d,Passive:c,Enabled:h}=a.ToolModes;n(84971);n(15773);const{Active:g,Passive:u,Enabled:m}=a.ToolModes;var v=n(85204);n(39011);n(57725),n(39848);var p=n(6802);n(65136);n(48145);var f=n(7754);n(59475),n(24917);n(93952);const{CAMERA_MODIFIED:w}=i.Enums.Events;const{CAMERA_MODIFIED:E}=i.Enums.Events;const{CAMERA_MODIFIED:I}=i.Enums.Events;var C=n(3823);const{STACK_NEW_IMAGE:_,VOLUME_NEW_IMAGE:T}=i.Enums.Events;const{CAMERA_MODIFIED:b}=i.Enums.Events;var S=n(89578),y=n(23566),A=(n(79475),n(13369),n(47807),n(1300)),D=n(85817);class x extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),a=n.world;if(0===a[0]&&0===a[1]&&0===a[2])return;const s=o.viewport.getCamera(),{focalPoint:r,position:l}=s,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];o.viewport.setCamera({focalPoint:c,position:d}),o.viewport.render()}}x.toolName="Pan";var M=n(84607);class O extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}){super(e,t),this._resizeObservers=new Map,this._hasResolutionChanged=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{viewport:a}=o,s=a.getDefaultActor().actor.getMapper();if(!("getSampleDistance"in s||"getCurrentSampleDistance"in s))return!0;const r=s.getSampleDistance();return this._hasResolutionChanged||(s.setSampleDistance(2*r),this._hasResolutionChanged=!0,null!==this.cleanUp&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{s.setSampleDistance(r),a.render(),this._hasResolutionChanged=!1},document.addEventListener("mouseup",this.cleanUp,{once:!0})),!0},this._getViewportsInfo=()=>(0,f.getToolGroup)(this.toolGroupId).viewportsInfo,this.onSetToolActive=()=>{const e=()=>{this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{if(!this._resizeObservers.has(e)){const{viewport:n}=(0,i.getEnabledElementByIds)(e,t)||{viewport:null};if(!n)return;const{element:o}=n,a=new ResizeObserver((()=>{const n=(0,i.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:o}=n;o.resetCamera(),o.render()}));a.observe(o),this._resizeObservers.set(e,a)}}))};e(),this._viewportAddedListener=t=>{t.detail.toolGroupId===this.toolGroupId&&e()},i.eventTarget.addEventListener(a.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener)},this.onSetToolDisabled=()=>{this._resizeObservers.forEach(((e,t)=>{e.disconnect(),this._resizeObservers.delete(t)})),this._viewportAddedListener&&(i.eventTarget.removeEventListener(a.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null)},this.rotateCamera=(e,t,n,i)=>{const o=e.getVtkActiveCamera(),a=o.getViewUp(),s=o.getFocalPoint(),r=o.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],h=C.pB.identity(new Float32Array(16));C.pB.translate(h,h,t),C.pB.rotate(h,h,i,n),C.pB.translate(h,h,[-t[0],-t[1],-t[2]]),C.eR.transformMat4(l,r,h),C.eR.transformMat4(d,s,h),C.pB.identity(h),C.pB.rotate(h,h,i,n),C.eR.transformMat4(c,a,h),e.setCamera({position:l,viewUp:c,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:o}=e.detail,a=n.canvas,s=o.canvas,{rotateIncrementDegrees:r}=this.configuration,l=(0,i.getEnabledElement)(t),{viewport:d}=l,c=d.getCamera(),h=t.clientWidth,g=t.clientHeight,u=[a[0]/h,a[1]/g],m=[s[0]/h,s[1]/g],v=[.5*h,.5*g],p=d.canvasToWorld(v),f=(1+Math.abs(.5))**2,w=[m[0],0,0],E=[u[0],0,0],I=w[0]**2,C=E[0]**2,_=I>f?0:Math.sqrt(f-I),T=C>f?0:Math.sqrt(f-C),b=[w[0],0,_];M.Ay.normalize(b);const S=[E[0],0,T];M.Ay.normalize(S);const y=M.Ay.dot(b,S);if(Math.abs(y)>1e-4){const e=-2*Math.acos(M.Ay.clampValue(y,-1,1))*Math.sign(u[0]-m[0])*r,t=c.viewUp,n=c.viewPlaneNormal,i=[0,0,0],o=[0,0,0];M.Ay.cross(t,n,i),M.Ay.normalize(i),M.Ay.cross(n,i,o),M.Ay.normalize(o),M.Ay.normalize(t),this.rotateCamera(d,p,o,e);const a=(m[1]-u[1])*r;this.rotateCamera(d,p,i,a),d.render()}}}O.toolName="TrackballRotate";class R extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),i=t[0]*t[1];let o,a;e instanceof Float32Array?(o=4,a=Float32Array):e instanceof Uint8Array?(o=1,a=Uint8Array):e instanceof Uint16Array?(o=2,a=Uint16Array):e instanceof Int16Array&&(o=2,a=Int16Array);const s=new a(e.buffer,n*i*o,i),{max:r,min:l}=this._getMinMax(s,i);return r-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:a}=o;let s,r,l,d,c,h,g=!1;const u=a.getProperties();if(a instanceof i.VolumeViewport){s=a.getVolumeId(),h=i.utilities.getViewportsWithVolumeId(s),({lower:r,upper:l}=u.voiRange);const e=i.cache.getVolume(s);if(!e)throw new Error("Volume not found "+s);d=e.metadata.Modality,g=e.scaling&&Object.keys(e.scaling).length>0}else{if(!u.voiRange)throw new Error("Viewport is not a valid type");{d=a.modality,({lower:r,upper:l}=u.voiRange);const{preScale:e={scaled:!1}}=a.getImageData?.()||{};g=e.scaled&&void 0!==e.scalingParameters?.suvbw}}c="PT"===d&&g?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:r,upper:l,clientHeight:t.clientHeight,isPreScaled:g,viewport:a,volumeId:s}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:s,lower:r,upper:l}),c.lower>=c.upper||(a.setProperties({voiRange:c}),a.render(),a instanceof i.VolumeViewport&&h.forEach((e=>{a!==e&&e.render()})))}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:i,viewport:o,volumeId:a,isPreScaled:s}){let r=4;r=s?5/i:this._getMultiplierFromDynamicRange(o,a)||4;return n-=e[1]*r,{lower:t,upper:n=s?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:o,upper:a}){const s=this._getMultiplierFromDynamicRange(e,n)||4,r=t[0]*s,l=t[1]*s;let{windowWidth:d,windowCenter:c}=i.utilities.windowLevel.toWindowLevel(o,a);return d+=r,c+=l,d=Math.max(d,1),i.utilities.windowLevel.toLowHighRange(d,c)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const o=i.cache.getVolume(t),{voxelManager:a}=e.getImageData(),s=a.getMiddleSliceData().reduce(((e,t)=>[Math.min(e[0],t),Math.max(e[1],t)]),[1/0,-1/0]),r=o?.metadata?.BitsStored,l=r?2**r:1/0;n=Math.min(s,l)}else n=this._getImageDynamicRangeFromViewport(e);const o=n/1024;return o>1?Math.round(o):o}_getImageDynamicRangeFromViewport(e){const{imageData:t,voxelManager:n}=e.getImageData();if(n?.getRange){const e=n.getRange();return e[1]-e[0]}const i=t.getDimensions();if(t.getRange){const e=t.getRange();return e[1]-e[0]}let o,a;if(o=t.getScalarData?t.getScalarData():t.getPointData().getScalars().getData(),1!==i[2])return this._getImageDynamicRangeFromMiddleSlice(o,i);if(o.getRange)a=o.getRange();else{const{min:e,max:t}=this._getMinMax(o,o.length);a=[e,t]}return a[1]-a[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let o=0;o<t;o++){const t=e[o];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}R.toolName="WindowLevel";var L=n(44049),P=n(8056),N=n(7001),k=n(58640),U=n(93575);class V extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{minWindowWidth:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:r}=s;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,a,d,c),g=r.getFrameOfReferenceUID(),u={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...a],[...a],[...a],[...a]]},cachedStats:{}}};(0,p.lC)(u,o);const m=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m},this._activateDraw(o),(0,N.hideElementCursor)(o),e.preventDefault(),(0,k.A)(m),u},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o}=this.editData;this._deactivateDraw(n),(0,N.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,(0,p.O8)(i.annotationUID),(0,k.A)(o),(0,L.dZ)(i),this.applyWindowLevelRegion(i,n)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a}=this.editData,{data:s}=o,{currentPoints:r}=t,l=(0,i.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,h=r.world,{points:g}=s.handles;g[3]=[...h];const u=d(g[0]),m=d(g[3]),v=[m[0],u[1]],p=[u[0],m[1]],f=c(v),w=c(p);g[1]=f,g[2]=w,o.invalidated=!0,(0,k.A)(a)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,p.Rh)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:r,data:l}=o,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e)));s.annotationUID=r;const{color:h,lineWidth:g,lineDash:u}=this.getAnnotationStyle({annotation:o,styleSpecifier:s});if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const m=`${r}-rect`,v="0";(0,S.drawRect)(t,r,v,c[0],c[3],{color:h,lineDash:u,lineWidth:g},m),n=!0}return n},this.applyWindowLevelRegion=(e,t)=>{const n=(0,i.getEnabledElement)(t),{viewport:o}=n,a=U.windowLevel.extractWindowLevelRegionToolData(o),{data:s}=e,{points:r}=s.handles,l=r.map((e=>o.worldToCanvas(e))),d=l[0],c=l[3];let h=Math.min(d[0],c[0]),g=Math.min(d[1],c[1]),u=Math.abs(d[0]-c[0]),m=Math.abs(d[1]-c[1]);h=i.utilities.clip(h,0,a.width),g=i.utilities.clip(g,0,a.height),u=Math.floor(Math.min(u,Math.abs(a.width-h))),m=Math.floor(Math.min(m,Math.abs(a.height-g)));const v=U.windowLevel.getLuminanceFromRegion(a,Math.round(h),Math.round(g),u,m),p=U.windowLevel.calculateMinMaxMean(v,a.minPixelValue,a.maxPixelValue);void 0===this.configuration.minWindowWidth&&(this.configuration.minWindowWidth=10);const f=Math.max(Math.abs(p.max-p.min),this.configuration.minWindowWidth),w=p.mean,E=i.utilities.windowLevel.toLowHighRange(f,w);o.setProperties({voiRange:E}),o.render()},this.cancel=()=>null,this.isPointNearTool=()=>null,this.toolSelectedCallback=()=>null,this.handleSelectedCallback=()=>null,this._activateModify=()=>null,this._deactivateModify=()=>null}}V.toolName="WindowLevelRegion";class W extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseWheelCallback(e){this._scroll(e)}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){this._scrollDrag(e)}_scrollDrag(e){const{deltaPoints:t,viewportId:n,renderingEngineId:o}=e.detail,{viewport:a}=(0,i.getEnabledElementByIds)(n,o),{debounceIfNotLoaded:s,invert:r,loop:l}=this.configuration,d=t.canvas[1];let c;a instanceof i.VolumeViewport&&(c=a.getVolumeId());const h=this._getPixelPerImage(a),g=d+this.deltaY;if(h)if(Math.abs(g)>=h){const e=Math.round(g/h);i.utilities.scroll(a,{delta:r?-e:e,volumeId:c,debounceLoading:s,loop:l}),this.deltaY=g%h}else this.deltaY=g}_scroll(e){const{wheel:t,element:n}=e.detail,{direction:o}=t,{invert:a}=this.configuration,{viewport:s}=(0,i.getEnabledElement)(n),r=o*(a?-1:1);i.utilities.scroll(s,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s instanceof i.BaseVolumeViewport?s.getVolumeId():void 0,scrollSlabs:this.configuration.scrollSlabs})}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}W.toolName="StackScroll";var B=n(25963);class H extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.mouseWheelCallback=e=>{const{element:t,wheel:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:a}=o,{invert:s}=this.configuration,r=10*n.direction*(s?-1:1);this.setAngle(a,r)},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:o}=e.detail,a=n.world,s=o.world,r=(0,i.getEnabledElement)(t),{viewport:l}=r,d=l.getCamera(),c=[.5*t.clientWidth,.5*t.clientHeight],h=l.canvasToWorld(c);let g=(0,B.A)([s,h],[h,a]);const{viewPlaneNormal:u}=d,m=C.eR.sub(C.eR.create(),h,s),v=C.eR.sub(C.eR.create(),h,a),p=C.eR.cross(C.eR.create(),m,v);C.eR.dot(u,p)>0&&(g=-g),Number.isNaN(g)||this.setAngle(l,g)}setAngle(e,t){const{viewPlaneNormal:n,viewUp:o}=e.getCamera();if(e instanceof i.BaseVolumeViewport){const i=(t+360)%360*Math.PI/180,a=C.pB.identity(new Float32Array(16));C.pB.rotate(a,a,i,n);const s=C.eR.transformMat4(C.eR.create(),o,a);e.setCamera({viewUp:s})}else{const{rotation:n}=e.getViewPresentation();e.setViewPresentation({rotation:(n+t+360)%360})}e.render()}}H.toolName="PlanarRotate";class F extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.001,maxZoomScale:3e3,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,a=o.world,s=(0,i.getEnabledElement)(n).viewport.getCamera(),{focalPoint:r}=s;this.initialMousePosWorld=a;let l=C.eR.fromValues(r[0]-a[0],r[1]-a[1],r[2]-a[2]);return l=C.eR.normalize(C.eR.create(),l),this.dirVec=l,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,i=!1)=>{const{element:o,deltaPoints:a}=e.detail,s=i?e.detail.deltaDistance.canvas:a.canvas[1],r=[o.clientWidth,o.clientHeight],{parallelScale:l,focalPoint:d,position:c}=n,h=s*(5/r[1])*(this.configuration.invert?-1:1),g=(1-h)*l;let u=d,m=c;if(!this.configuration.zoomToCenter){const e=C.eR.distance(d,this.initialMousePosWorld);m=C.eR.scaleAndAdd(C.eR.create(),c,this.dirVec,-e*h),u=C.eR.scaleAndAdd(C.eR.create(),d,this.dirVec,-e*h)}const v=t.getImageData();let p=[1,1,1];v&&(p=v.spacing);const{minZoomScale:f,maxZoomScale:w}=this.configuration,E=o.clientHeight*p[1]*.5,I=E/g;let _=g,T=!1;v&&(I<f?(_=E/f,T=!0):I>=w&&(_=E/w,T=!0)),t.setCamera({parallelScale:_,focalPoint:T?d:u,position:T?c:m})},this._dragPerspectiveProjection=(e,t,n,i=!1)=>{const{element:o,deltaPoints:a}=e.detail,s=i?e.detail.deltaDistance.canvas:a.canvas[1],r=[o.clientWidth,o.clientHeight],{position:l,focalPoint:d,viewPlaneNormal:c}=n,h=M.Ay.distance2BetweenPoints(l,d),g=Math.sqrt(h)/r[1],u=[-c[0],-c[1],-c[2]],m=this.configuration.invert?s/g:s*g;let v=m*u[0];l[0]+=v,d[0]+=v,v=m*u[1],l[1]+=v,d[1]+=v,v=m*u[2],l[2]+=v,d[2]+=v,t.setCamera({position:l,focalPoint:d})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:a}=o,s=a.getCamera(),r=n.world,{focalPoint:l}=s;this.initialMousePosWorld=r;let d=C.eR.fromValues(l[0]-r[0],l[1]-r[1],l[2]-r[2]);d=C.eR.normalize(C.eR.create(),d),this.dirVec=d,s.parallelProjection?this._dragParallelProjection(e,a,s,!0):this._dragPerspectiveProjection(e,a,s,!0),a.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,i.getEnabledElement)(t),{viewport:o}=n,a=o.getCamera();a.parallelProjection?this._dragParallelProjection(e,o,a):this._dragPerspectiveProjection(e,o,a),o.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),a=n.world,s=o.viewport.getCamera(),{focalPoint:r,position:l}=s,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];o.viewport.setCamera({focalPoint:c,position:d}),o.viewport.render()}}F.toolName="Zoom";var G=n(13165);class $ extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:a,renderingEngine:s}=o,r=a.getVolumeId();if(!r)throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");let l=-1/0;const d=(0,G.getPointInLineOfSightWithCriteria)(a,n.world,r,((e,t)=>{if(e>l)return l=e,t}));if(!d||!d.length)return;const{targetViewportIds:c,toolGroupId:h}=this.configuration;s.getViewports().filter((e=>{if(c?.indexOf(e.id)>=0)return!0;const t=(0,f.getToolGroupForViewport)(e.id,s.id);return!(!h||h!==t?.id)})).forEach((e=>{e instanceof i.VolumeViewport?e.jumpToWorld(d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}$.toolName="MIPJumpToClickTool";var z=n(89265),q=n(35381),j=n(93258),Z=n(2076);const{RENDERING_DEFAULTS:K}=i.CONSTANTS;function Y(){return"rgb(0, 200, 0)"}function X(){return!0}function J(){return!0}function Q(){return!0}const ee=1,te=2,ne=3;class ie extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!1,viewportIndicatorsConfig:{radius:5,x:null,y:null},autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:i.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,i.getEnabledElementByIds)(t,e),{FrameOfReferenceUID:a,viewport:s}=n,{element:r}=s,{position:l,focalPoint:d,viewPlaneNormal:c}=s.getCamera();let h=this._getAnnotations(n);h=this.filterInteractableAnnotationsForElement(r,h),h.length&&(0,o.removeAnnotation)(h[0].annotationUID);const g={highlighted:!1,metadata:{cameraPosition:[...l],cameraFocalPoint:[...d],FrameOfReferenceUID:a,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}};return(0,o.addAnnotation)(g,r),{normal:c,point:s.canvasToWorld([s.canvas.clientWidth/2,s.canvas.clientHeight/2])}},this._getViewportsInfo=()=>(0,f.getToolGroup)(this.toolGroupId).viewportsInfo,this.resetCrosshairs=()=>{const e=this._getViewportsInfo();for(const t of e){const{viewportId:e,renderingEngineId:n}=t,a=(0,i.getEnabledElementByIds)(e,n),s=a.viewport,r=!0,l=!0,d=!0,c=!0,h=!0;s.resetCamera({resetPan:r,resetZoom:l,resetToCenter:d,resetRotation:c,suppressEvents:h}),s.resetSlabThickness();const{element:g}=s;let u=this._getAnnotations(a);u=this.filterInteractableAnnotationsForElement(g,u),u.length&&(0,o.removeAnnotation)(u[0].annotationUID),s.render()}this._computeToolCenter(e)},this.computeToolCenter=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._computeToolCenter=e=>{if(!e.length||1===e.length)return void console.warn("For crosshairs to operate, at least two viewports must be given.");const[t,n,o]=e,{normal:a,point:s}=this.initializeViewport(t),{normal:r,point:l}=this.initializeViewport(n);let d=[0,0,0],c=C.eR.create();o?({normal:d,point:c}=this.initializeViewport(o)):(C.eR.add(c,s,l),C.eR.scale(c,c,.5),C.eR.cross(d,a,r));const h=i.utilities.planar.planeEquation(a,s),g=i.utilities.planar.planeEquation(r,l),u=i.utilities.planar.planeEquation(d,c);this.toolCenter=i.utilities.planar.threePlaneIntersection(h,g,u),(0,k.A)(e.map((({viewportId:e})=>e)))},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.world,s=(0,i.getEnabledElement)(n),{viewport:r}=s;this._jump(s,a);const l=this._getAnnotations(s),d=this.filterInteractableAnnotationsForElement(r.element,l),{data:c}=d[0],{rotationPoints:h}=c.handles,g=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(g.push(t.id),e++)}return c.activeViewportIds=[...g],c.handles.activeOperation=ee,e.preventDefault(),(0,N.hideElementCursor)(n),this._activateModify(n),d[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),(0,N.hideElementCursor)(i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i;t.highlighted=!0,this._activateModify(o),(0,N.hideElementCursor)(o),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{renderingEngine:a}=o,s=o.viewport,r=this._getAnnotations(o),l=this.filterInteractableAnnotationsForElement(n,r)[0];if(!l)return;const d=s.getCamera(),c=l.metadata.cameraPosition,h=[0,0,0];M.Ay.subtract(d.position,c,h);const g=l.metadata.cameraFocalPoint,u=[0,0,0];M.Ay.subtract(d.focalPoint,g,u),l.metadata.cameraPosition=[...d.position],l.metadata.cameraFocalPoint=[...d.focalPoint];const m=this._getReferenceLineControllable(s.id),v=this._getReferenceLineDraggableRotatable(s.id);if(!i.utilities.isEqual(d.position,c,.001)&&m&&v){let e=!1;i.utilities.isEqual(h,u,.001)||(e=!0);const t=Math.abs(M.Ay.dot(h,d.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=h[0],this.toolCenter[1]+=h[1],this.toolCenter[2]+=h[2])}if(this.configuration.autoPan?.enabled){(0,f.getToolGroupForViewport)(s.id,a.id).getViewportIds().filter((e=>e!==s.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,a)}))}const p=(0,P.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,k.A)(p)},this.onResetCamera=e=>{this.resetCrosshairs()},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(let e=0;e<t.length;e++){const i=t[e];if((0,Z.isAnnotationLocked)(i.annotationUID))continue;const{data:s,highlighted:r}=i;if(!s.handles)continue;const l=s.handles.activeOperation,d=s.activeViewportIds&&s.activeViewportIds.length>0?[...s.activeViewportIds]:[];s.activeViewportIds=[],s.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,i,o,6)||this._pointNearTool(n,i,o,6);c&&!r||!c&&r?(i.highlighted=!r,a=!0):s.handles.activeOperation===l&&this._areViewportIdArraysEqual(s.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,i.getEnabledElement)(e),{viewportId:o}=n,a=t.filter((e=>e.data.viewportId===o));return a},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,renderingEngine:o}=e,{element:a}=i,s=this._getAnnotations(e),r=i.getCamera(),l=this.filterInteractableAnnotationsForElement(a,s)[0];if(!s?.length||!l?.data)return n;const d=l.annotationUID,{clientWidth:c,clientHeight:h}=i.canvas,g=Math.sqrt(c*c+h*h),u=Math.min(c,h),m=l.data,v=i.worldToCanvas(this.toolCenter),p=this._filterAnnotationsByUniqueViewportOrientations(e,s),f=[],w=[0,0,c,h];p.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=o.getViewport(t.viewportId),a=n.getCamera(),s=this._getReferenceLineControllable(n.id),l=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:c,clientHeight:h}=n.canvas,m=Math.sqrt(c*c+h*h),E=[.5*c,.5*h],I=n.canvasToWorld(E),_=[0,0,0];M.Ay.cross(r.viewPlaneNormal,a.viewPlaneNormal,_),M.Ay.normalize(_),M.Ay.multiplyScalar(_,m);const T=[0,0,0];M.Ay.add(I,_,T);const b=[0,0,0];M.Ay.subtract(I,_,b);const S=i.worldToCanvas(T),y=i.worldToCanvas(I),A=C.Zc.create();C.Zc.subtract(A,S,y),C.Zc.normalize(A,A);const D=C.Zc.create();C.Zc.scale(D,A,100*g);const x=C.Zc.create();C.Zc.scale(x,A,.4*u);const O=C.Zc.create();C.Zc.scale(O,A,.2*u);const R=C.Zc.create(),L=this.configuration.referenceLinesCenterGapRadius;C.Zc.scale(R,A,2===p.length?L:0);const P=C.Zc.create(),N=C.Zc.create(),k=C.Zc.create(),U=C.Zc.create();let V=C.Zc.clone(v);l&&s||(V=C.Zc.clone(y)),C.Zc.add(P,V,R),C.Zc.add(N,V,D),C.Zc.subtract(k,V,R),C.Zc.subtract(U,V,D),(0,q.A)(P,N,w),(0,q.A)(k,U,w);const W=C.Zc.create();C.Zc.subtract(W,v,x);const B=C.Zc.create();C.Zc.add(B,v,x);let H=C.Zc.clone(v);!l&&d&&(H=C.Zc.clone(y));let F=[...this.toolCenter];!l&&d&&(F=[...I]);const G=[0,0,0];M.Ay.subtract(T,b,G),M.Ay.normalize(G);const{viewPlaneNormal:$}=r,{matrix:j}=z.A.buildFromDegree().rotate(90,$),Z=[0,0,0];C.eR.transformMat4(Z,G,j);const K=n.getSlabThickness(),Y=[...Z];M.Ay.multiplyScalar(Y,K);const X=[0,0,0];M.Ay.add(F,Y,X);const J=i.worldToCanvas(X),Q=C.Zc.create();C.Zc.subtract(Q,H,J);const ee=C.Zc.create();C.Zc.subtract(ee,H,D),C.Zc.add(ee,ee,Q);const te=C.Zc.create();C.Zc.add(te,H,D),C.Zc.add(te,te,Q),(0,q.A)(ee,te,w);const ne=C.Zc.create();C.Zc.add(ne,H,D),C.Zc.subtract(ne,ne,Q);const ie=C.Zc.create();C.Zc.subtract(ie,H,D),C.Zc.subtract(ie,ie,Q),(0,q.A)(ne,ie,w);const oe=C.Zc.create(),ae=C.Zc.create(),se=C.Zc.create(),re=C.Zc.create();C.Zc.subtract(oe,H,O),C.Zc.add(oe,oe,Q),C.Zc.add(ae,H,O),C.Zc.add(ae,ae,Q),C.Zc.subtract(se,H,O),C.Zc.subtract(se,se,Q),C.Zc.add(re,H,O),C.Zc.subtract(re,re,Q),f.push([n,P,N,k,U,ee,te,ne,ie,W,B,oe,ae,se,re])}));const E=[],I=[],_=this._getReferenceLineColor(i.id),T=void 0!==_?_:"rgb(200, 200, 200)";if(f.forEach(((e,n)=>{const o=e[0],a=this._getReferenceLineColor(o.id),s=this._getReferenceLineControllable(o.id),r=this._getReferenceLineDraggableRotatable(o.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(o.id)||this.configuration.mobile?.enabled,c=m.activeViewportIds.find((e=>e===o.id));let h=void 0!==a?a:"rgb(200, 200, 200)",g=1;const u=null!==m.handles.activeOperation&&m.handles.activeOperation===ee&&c;u&&(g=2.5);let v=`${n}`;if(s&&r?(v=`${n}One`,(0,S.drawLine)(t,d,v,e[1],e[2],{color:h,lineWidth:g}),v=`${n}Two`,(0,S.drawLine)(t,d,v,e[3],e[4],{color:h,lineWidth:g})):(0,S.drawLine)(t,d,v,e[2],e[4],{color:h,lineWidth:g}),s){h=void 0!==a?a:"rgb(200, 200, 200)";const s=m.handles.activeOperation===te,g=[e[9],e[10]],p=[i.canvasToWorld(e[9]),o,e[1],e[2]],f=[i.canvasToWorld(e[10]),o,e[3],e[4]];E.push(p,f);const w=m.handles.activeOperation===ne,C=[e[11],e[12],e[13],e[14]],_=[i.canvasToWorld(e[11]),o,e[5],e[6]],T=[i.canvasToWorld(e[12]),o,e[5],e[6]],b=[i.canvasToWorld(e[13]),o,e[7],e[8]],y=[i.canvasToWorld(e[14]),o,e[7],e[8]];if(I.push(_,T,b,y),(u||this.configuration.mobile?.enabled)&&!s&&!w&&r&&l){let e=`${n}One`;(0,S.drawHandles)(t,d,e,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),e=`${n}Two`,(0,S.drawHandles)(t,d,e,C,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(u&&!s&&!w&&r){const e=`${n}`;(0,S.drawHandles)(t,d,e,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(c&&!s&&!w&&l){const e=`${n}`;(0,S.drawHandles)(t,d,e,C,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(s&&r){const e=`${n}`;(0,S.drawHandles)(t,d,e,g,{color:h,handleRadius:2,fill:h,type:"circle"})}else w&&c&&l&&(0,S.drawHandles)(t,d,v,C,{color:h,handleRadius:2,fill:h,type:"rect"});o.getSlabThickness()>.5&&l&&(v=`${n}STOne`,(0,S.drawLine)(t,d,v,e[5],e[6],{color:h,width:1,lineDash:[2,3]}),v=`${n}STTwo`,(0,S.drawLine)(t,d,v,e[7],e[8],{color:h,width:e,lineDash:[2,3]}))}})),n=!0,m.handles.rotationPoints=E,m.handles.slabThicknessPoints=I,this.configuration.viewportIndicators){const{viewportIndicatorsConfig:e}=this.configuration,n=[c*(e?.xOffset||.95),h*(e?.yOffset||.05)],i=e?.circleRadius||.01*g,o="0";(0,S.drawCircle)(t,d,o,n,i,{color:T,fill:T})}return n},this._getAnnotations=e=>{const{viewport:t}=e,n=(0,o.getAnnotations)(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map((({viewportId:e})=>e)),a=n.filter((e=>{const{data:t}=e;return i.includes(t.viewportId)}));return a},this._onNewVolume=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1})),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:o,viewport:a}=e,s=t.filter((e=>e.data.viewportId!==n));if(!s||!s.length)return[];const r=a.getCamera(),{viewPlaneNormal:l,position:d}=r,c=s.filter((e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera();return!(i.utilities.isEqual(n.viewPlaneNormal,l,.01)&&i.utilities.isEqual(n.position,d,1))}));return c},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:o}=e,{data:a}=t,s=o.getViewport(a.viewportId),r=n.filter((e=>{const{data:t}=e,n=o.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!r||!r.length)return[];const l=s.getCamera(),d=l.viewPlaneNormal;M.Ay.normalize(d);const c=r.filter((e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera(),a=n.viewPlaneNormal;return M.Ay.normalize(a),i.utilities.isEqual(d,a,.01)&&i.utilities.isEqual(l.viewUp,n.viewUp,.01)}));return c},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:o}=e,a=o.getCamera().viewPlaneNormal;M.Ay.normalize(a);const s=t.filter((e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0===a})),r=[];for(let e=0;e<s.length;++e){const t=s[e],{viewportId:o}=t.data,l=n.getViewport(o).getCamera(),d=l.viewPlaneNormal;if(M.Ay.normalize(d),i.utilities.isEqual(a,d,.01)||i.utilities.isOpposite(a,d,.01))continue;let c=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,a=n.getViewport(o).getCamera();i.utilities.isEqual(a.viewPlaneNormal,l.viewPlaneNormal,.01)&&i.utilities.isEqual(a.position,l.position,1)&&(c=!0)}c||r.push(t)}const l=t.filter((e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0!==a}));for(let e=0;e<l.length;++e){const t=l[e],{viewportId:o}=t.data,s=n.getViewport(o).getCamera(),d=s.viewPlaneNormal;if(M.Ay.normalize(d),i.utilities.isEqual(a,d,.01)||i.utilities.isOpposite(a,d,.01))continue;let c=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,a=n.getViewport(o).getCamera();i.utilities.isEqual(a.viewPlaneNormal,s.viewPlaneNormal,.01)&&i.utilities.isEqual(a.position,s.position,1)&&(c=!0)}c||r.push(t)}const d=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<d.length;++e){const t=d[e];if(r.some((e=>e===t)))continue;const{viewportId:o}=t.data,s=n.getViewport(o).getCamera(),l=s.viewPlaneNormal;if(M.Ay.normalize(l),i.utilities.isEqual(a,l,.01)||i.utilities.isOpposite(a,l,.01))continue;let c=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,a=n.getViewport(o).getCamera();i.utilities.isEqual(a.viewPlaneNormal,s.viewPlaneNormal,.01)&&i.utilities.isEqual(a.position,s.position,1)&&(c=!0)}c||r.push(t)}return r},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getActors(),i=t.getActors();let o=!0;return n.forEach((e=>{n.length===i.length&&void 0!==i.find((({uid:t})=>t===e.uid))||(o=!1)})),o},this._jump=(e,t)=>{v.wk.isInteractingWithTool=!0;const{viewport:n,renderingEngine:i}=e,o=this._getAnnotations(e),a=[0,0,0];M.Ay.subtract(t,this.toolCenter,a);const s=this._getAnnotationsForViewportsWithDifferentCameras(e,o).filter((e=>{const{data:t}=e,o=i.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,o);return this._getReferenceLineControllable(o.id)&&this._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===s.length?(v.wk.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,s,a),v.wk.isInteractingWithTool=!1,!0)},this._activateModify=e=>{v.wk.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),(0,N.resetElementCursor)(n),this.editData=null;const i=(0,P.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,k.A)(i)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:o}=t,a=(0,i.getEnabledElement)(o),{renderingEngine:s,viewport:r}=a,l=this._getAnnotations(a),d=this.filterInteractableAnnotationsForElement(o,l)[0];if(!d)return;const{handles:c}=d.data,{currentPoints:h}=e.detail,g=h.canvas;if(c.activeOperation===ee){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,l).filter((e=>{const{data:t}=e,n=s.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o&&d.data.activeViewportIds.find((e=>e===n.id))}));this._applyDeltaShiftToSelectedViewportCameras(s,e,n)}else if(c.activeOperation===te){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,l).filter((e=>{const{data:t}=e,n=s.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o})),n=C.Zc.create(),i=C.Zc.create(),o=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],d=r.worldToCanvas(o),c=t.currentPoints.canvas,h=C.Zc.create();C.Zc.sub(h,c,t.deltaPoints.canvas),C.Zc.sub(n,h,d),C.Zc.sub(i,c,d);let g=C.Zc.angle(n,i);this._isClockWise(d,h,c)&&(g*=-1),g=Math.round(100*g)/100;const u=r.getCamera().viewPlaneNormal,{matrix:m}=z.A.buildFromRadian().translate(o[0],o[1],o[2]).rotate(g,u).translate(-o[0],-o[1],-o[2]),v=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=o;const n=s.getViewport(t.viewportId),i=n.getCamera(),{viewUp:a,position:r,focalPoint:l}=i;a[0]+=r[0],a[1]+=r[1],a[2]+=r[2],C.eR.transformMat4(l,l,m),C.eR.transformMat4(r,r,m),C.eR.transformMat4(a,a,m),a[0]-=r[0],a[1]-=r[1],a[2]-=r[2],n.setCamera({position:r,viewUp:a,focalPoint:l}),v.push(n.id)})),s.renderViewports(v)}else if(c.activeOperation===ne){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,l).filter((e=>{const{data:t}=e,n=s.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===o&&d.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const o=this._filterViewportWithSameOrientation(a,e[0],l),c=[];c.push(r.id),o.forEach((e=>{const{data:o}=e,a=s.getViewport(o.viewportId),l=a.getCamera().viewPlaneNormal,h=M.Ay.dot(n,l),u=[...l];if(M.Ay.multiplyScalar(u,h),Math.abs(u[0])>.001||Math.abs(u[1])>.001||Math.abs(u[2])>.001){const e=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),n=t.lastPoints.world,o=[0,0,0],h=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(a.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===a.id));if(2===t.length){const e=r.canvasToWorld(t[0][3]),n=r.canvasToWorld(t[1][3]);M.Ay.add(e,n,h),M.Ay.multiplyScalar(h,.5)}}M.Ay.subtract(n,h,o);const m=M.Ay.dot(o,l),v=[...l];M.Ay.multiplyScalar(v,m);const p=[v[0],v[1],v[2]];C.eR.normalize(p,p);const w=[u[0],u[1],u[2]];C.eR.normalize(w,w);let E=a.getSlabThickness();i.utilities.isOpposite(p,w,.001)?E-=e:E+=e,E=Math.abs(E),E=Math.max(K.MINIMUM_SLAB_THICKNESS,E);this._pointNearReferenceLine(d,g,6,a)&&(E=K.MINIMUM_SLAB_THICKNESS);(0,f.getToolGroupForViewport)(a.id,s.id).getToolInstance(this.getToolName()).setSlabThickness(a,E),c.push(a.id)}})),s.renderViewports(c)}},this._pointNearReferenceLine=(e,t,n,i)=>{const{data:o}=e,{rotationPoints:a}=o.handles;for(let e=0;e<a.length-1;++e){const o=a[e][1];if(o.id!==i.id)continue;if(!this._getReferenceLineControllable(o.id))continue;const s={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},r=j.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=j.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(r<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||Y,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||X,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||J,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||Q}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this._computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this._computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this._computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((({renderingEngineId:e,viewportId:t})=>{const n=(0,i.getEnabledElementByIds)(t,e);if(!n)return;const a=this._getAnnotations(n);a?.length&&a.forEach((e=>{(0,o.removeAnnotation)(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,o){const a=(0,i.getEnabledElement)(e),{viewport:s}=a;let r=this._getRotationHandleNearImagePoint(s,t,n,o);return null!==r?r:(r=this._getSlabThicknessHandleNearImagePoint(s,t,n,o),null!==r?r:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,i.getEnabledElementByIds)(e,t),{element:o}=n;o.removeEventListener(i.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,i.getEnabledElementByIds)(e,t),{element:o}=n;o.addEventListener(i.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:i,clientHeight:o}=n.canvas,a=n.worldToCanvas(this.toolCenter),s=this.configuration.autoPan.panSize,r=[a[0],a[1]];if(a[0]<0?r[0]=s:a[0]>i&&(r[0]=i-s),a[1]<0?r[1]=s:a[1]>o&&(r[1]=o-s),r[0]===a[0]&&r[1]===a[1])return;const l=n.canvasToWorld(r),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:g}=c,u=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:o}=this.configuration;o&&o.length>0&&(n=o);let a=this.configuration.slabThicknessBlendMode;t===K.MINIMUM_SLAB_THICKNESS&&(a=i.Enums.BlendModes.COMPOSITE);e.setBlendMode(a,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,o=e.getViewport(i.viewportId),a=o.getCamera(),s=a.viewPlaneNormal,r=M.Ay.dot(n,s),l=[...s];if(M.Ay.multiplyScalar(l,r),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];M.Ay.add(a.focalPoint,l,e),M.Ay.add(a.position,l,t),o.setCamera({focalPoint:e,position:t}),o.render()}}_getRotationHandleNearImagePoint(e,t,n,i){const{data:o}=t,{rotationPoints:a}=o.handles;for(let s=0;s<a.length;s++){const r=a[s][0],l=a[s][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineDraggableRotatable(l.id))continue;const d=e.worldToCanvas(r);if(C.Zc.distance(n,d)<i)return o.handles.activeOperation=te,this.editData={annotation:t},r}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){const{data:o}=t,{slabThicknessPoints:a}=o.handles;for(let s=0;s<a.length;s++){const r=a[s][0],l=a[s][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const d=e.worldToCanvas(r);if(C.Zc.distance(n,d)<i)return o.handles.activeOperation=ne,o.activeViewportIds=[l.id],this.editData={annotation:t},r}return null}_pointNearTool(e,t,n,o){const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{clientWidth:r,clientHeight:l}=s.canvas,d=Math.sqrt(r*r+l*l),{data:c}=t,{rotationPoints:h}=c.handles,{slabThicknessPoints:g}=c.handles,u=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!i||!a)continue;const s={start:{x:h[e][2][0],y:h[e][2][1]},end:{x:h[e][3][0],y:h[e][3][1]}},r=j.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]),l={start:{x:h[e+1][2][0],y:h[e+1][2][1]},end:{x:h[e+1][3][0],y:h[e+1][3][1]}},d=j.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(r<=o||d<=o)&&(u.push(t.id),c.handles.activeOperation=ee),e++}for(let e=0;e<g.length-1;++e){const t=g[e][1];if(u.find((e=>e===t.id)))continue;const i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!i||!a)continue;const s=g[e][2],r=g[e][3],l=C.Zc.create();C.Zc.add(l,s,r),C.Zc.scale(l,l,.5);const h=C.Zc.create();C.Zc.subtract(h,s,l),C.Zc.normalize(h,h);const m=C.Zc.create();C.Zc.scale(m,h,.05*d);const v=C.Zc.create(),p=C.Zc.create();C.Zc.add(v,l,m),C.Zc.subtract(p,l,m);const f={start:{x:v[0],y:v[1]},end:{x:s[0],y:s[1]}},w=j.distanceToPoint([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]]),E={start:{x:p[0],y:p[1]},end:{x:r[0],y:r[1]}},I=j.distanceToPoint([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(w<=o||I<=o)&&(u.push(t.id),c.handles.activeOperation=null),e++}return c.activeViewportIds=[...u],this.editData={annotation:t},c.handles.activeOperation===ee}}ie.toolName="Crosshairs";const oe="magnify-viewport";class ae extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this._hasBeenRemoved=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,a=(0,i.getEnabledElement)(n),{viewport:s,renderingEngine:r}=a;if(!(s instanceof i.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const l=this._getReferencedImageId(s);if(!l)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const d=(0,P.getViewportIdsWithToolToRender)(n,this.getToolName());return this.editData={referencedImageId:l,viewportIdsToRender:d,enabledElement:a,renderingEngine:r,currentPoints:o},this._createMagnificationViewport(),this._activateDraw(n),(0,N.hideElementCursor)(n),e.preventDefault(),(0,k.A)(d),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:o,currentPoints:a}=this.editData,{viewport:s}=e,{element:r}=s,l=s.getProperties(),{canvas:d,world:c}=a;let h;if(h=r.querySelector(".magnifyTool"),null===h){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",h=e;r.querySelector(".viewport-element").appendChild(e);const t={viewportId:oe,type:i.Enums.ViewportType.STACK,element:h};o.enableElement(t)}h.style.top=d[1]-this.configuration.magnifyHeight/2+"px",h.style.left=d[0]-this.configuration.magnifyWidth/2+"px";const g=o.getViewport(oe);g.setStack([t]).then((()=>{if(this._hasBeenRemoved)return;g.setProperties(l);const{parallelScale:e}=s.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=g.getCamera(),o=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),a=[c[0],c[1],c[2]],r=[a[0]+o*i[0],a[1]+o*i[1],a[2]+o*i[2]];g.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:a,position:r}),g.render()})),h.style.display="block",(0,k.A)(n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:o,currentPoints:a}=t,s=n.world,r=a.canvas,l=(0,i.getEnabledElement)(o),{renderingEngine:d}=l,c=d.getViewport(oe),h=o.querySelector(".magnifyTool");if(!h)return;h.style.top=r[1]-this.configuration.magnifyHeight/2+"px",h.style.left=r[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:g,position:u}=c.getCamera(),m=[u[0]+s[0],u[1]+s[1],u[2]+s[2]],v=[g[0]+s[0],g[1]+s[1],g[2]+s[2]];c.setCamera({focalPoint:v,position:m}),c.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,i.getEnabledElement)(t),{renderingEngine:o}=n;o.disableElement(oe);const a=t.querySelector(".viewport-element"),s=a.querySelector(".magnifyTool");a.removeChild(s),this._deactivateDraw(t),(0,N.resetElementCursor)(t),this._hasBeenRemoved=!0},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,this._hasBeenRemoved=!1,e.addEventListener(a.Events.MOUSE_UP,this._dragEndCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(a.Events.TOUCH_END,this._dragEndCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._dragEndCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(a.Events.TOUCH_END,this._dragEndCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof i.StackViewport&&(n=t.split("imageId:")[1]),n}}ae.toolName="Magnify";var se=n(29601),re=n(77081),le=n(52905),de=n(29614);const{Events:ce}=i.Enums,he=e=>e.uid!==e.referencedId;var ge;!function(e){e.ShowZoomFactorsList="showZoomFactorsList"}(ge||(ge={}));const ue=1-i.CONSTANTS.EPSILON;class me extends D.EC{static{this.Actions=ge}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:3,zoomFactorList:[1.5,2,2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:a.MouseBindings.Secondary,modifierKey:a.KeyboardBindings.Shift}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=(0,i.getEnabledElement)(a),{viewport:r,renderingEngine:l}=s,d=n.world,c=n.canvas,{magnifyingGlass:h}=this.configuration,{radius:g,zoomFactor:u,autoPan:m}=h,v=this._getCanvasHandlePoints(c,g),p=r.getCamera(),{viewPlaneNormal:f,viewUp:w}=p,E=this.getReferencedImageId(r,d,f,w),I=i.utilities.uuidv4(),C=i.utilities.uuidv4(),_=r.getFrameOfReferenceUID(),T={annotationUID:I,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...f],viewUp:[...w],FrameOfReferenceUID:_,referencedImageId:E},data:{sourceViewportId:r.id,magnifyViewportId:C,zoomFactor:u,isCanvasAnnotation:!0,handles:{points:v,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(T,{magnifyViewportId:C,sourceEnabledElement:s,position:c,radius:g,zoomFactor:u,autoPan:{enabled:m.enabled,padding:m.padding,callback:e=>{const t=T.data.handles.points,{canvas:n}=e.delta;for(let e=0,i=t.length;e<i;e++){const i=t[e];i[0]+=n[0],i[1]+=n[1],T.invalidated=!0}}}}),(0,o.addAnnotation)(T,a);const b=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return e.preventDefault(),(0,k.A)(b),T},this.onSetToolDisabled=()=>{this.magnifyViewportManager.dispose();(0,o.getAllAnnotations)().forEach((e=>{e.metadata.toolName===this.getToolName()&&(0,o.removeAnnotation)(e.annotationUID)}))},this.isPointNearTool=(e,t,n,i)=>{const{data:o}=t,{points:a}=o.handles,s=a,r=s[0],l=s[2],d=s[3],c=.5*Math.abs(l[1]-r[1]),h=[d[0]+c,r[1]+c],g=(0,re.r)([h,n]);return Math.abs(g-c)<2*i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=(0,P.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o},(0,N.hideElementCursor)(i),this._activateModify(i),(0,k.A)(o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;const{points:s}=a.handles,r=s.findIndex((e=>e===n)),l=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r},this._activateModify(o),(0,N.hideElementCursor)(o),(0,k.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,{data:s}=i;s.handles.activeHandleIndex=null,this._deactivateModify(n),(0,N.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,(0,k.A)(o),a&&(0,L.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{deltaPoints:n}=t,i=n?.canvas??[0,0,0],{annotation:o,viewportIdsToRender:a}=this.editData,{points:s}=o.data.handles;s.forEach((e=>{e[0]+=i[0],e[1]+=i[1]})),o.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(a)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a}=this.editData,{data:s}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.canvas;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;(0,k.A)(o)},this._dragHandle=e=>{const t=e.detail,{annotation:n}=this.editData,{data:i}=n,{points:o}=i.handles,a=o,s=a[0],r=a[2],l=a[3],d=.5*Math.abs(r[1]-s[1]),c=[l[0]+d,s[1]+d],{currentPoints:h}=t,g=h.canvas,u=(0,re.r)([c,g]),m=this._getCanvasHandlePoints(c,u);o[0]=m[0],o[1]=m[1],o[2]=m[2],o[3]=m[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,t.annotationUID},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;s=s?.filter((e=>e.data.sourceViewportId===i.id));const r=this.filterInteractableAnnotationsForElement(a,s);if(!r?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const o=r[e],{annotationUID:a,data:s}=o,{magnifyViewportId:d,zoomFactor:c,handles:h}=s,{points:g,activeHandleIndex:u}=h;l.annotationUID=a;this.getStyle("lineWidth",l,o),this.getStyle("lineDash",l,o);const m=this.getStyle("color",l,o),v=g,p=v[0],f=v[2],w=v[3],E=.5*Math.abs(f[1]-p[1]),I=[w[0]+E,p[1]+E];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let C;if(!(0,se.isAnnotationVisible)(a))continue;if((0,Z.isAnnotationLocked)(a)||this.editData||null===u||(C=[v[u]]),C){const e="0";(0,S.drawHandles)(t,a,e,C,{color:m})}const _=`${a}-advancedMagnify`,T="0";(0,S.drawCircle)(t,a,T,I,E,{color:m,lineWidth:5},_);const b=this.magnifyViewportManager.getViewport(d);b.position=I,b.radius=E,b.zoomFactor=c,b.update(),n=!0}return n},this._getCanvasHandlePoints=(e,t)=>[[e[0],e[1]-t,0],[e[0]+t,e[1],0],[e[0],e[1]+t,0],[e[0]-t,e[1],0]],this.magnifyViewportManager=ve.getInstance()}showZoomFactorsList(e,t){const{element:n,currentPoints:o}=e.detail,a=(0,i.getEnabledElement)(n),{viewport:s}=a,{canvas:r}=o,l=n.querySelector(":scope .viewport-element"),d=t.data.zoomFactor,c=this._getZoomFactorsListDropdown(d,(e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),c.parentElement.removeChild(c),s.render()}));Object.assign(c.style,{left:`${r[0]}px`,top:`${r[1]}px`}),l.appendChild(c),c.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,i=document.createElement("select");return i.size=5,Object.assign(i.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((e=>{i.addEventListener(e,(e=>e.stopPropagation()))})),i.addEventListener("change",(e=>{e.stopPropagation(),t(i.value)})),i.addEventListener("keydown",(e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())})),n.forEach((t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,i.add(n)})),i}}class ve{constructor(){this.createViewport=(e,t)=>{const{magnifyViewportId:n,sourceEnabledElement:i,position:o,radius:a,zoomFactor:s,autoPan:r}=t,{viewport:l}=i,{element:d}=l,c=new pe({magnifyViewportId:n,sourceEnabledElement:i,radius:a,position:o,zoomFactor:s,autoPan:r});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(c.viewportId,{annotation:e,magnifyViewport:c,magnifyViewportInfo:t}),c},this._annotationRemovedCallback=e=>{const{annotation:t}=e.detail;"AdvancedMagnify"===t.metadata.toolName&&this.destroyViewport(t.data.magnifyViewportId)},this._newStackImageCallback=e=>{const{viewportId:t,imageId:n}=e.detail,o=this._getMagnifyViewportsMapEntriesBySourceViewportId(t),{viewport:a}=(0,i.getEnabledElementByViewportId)(t);a.stackActorReInitialized&&this._reset(t),o.forEach((({annotation:e})=>{e.metadata.referencedImageId=n,e.invalidated=!0}))},this._newVolumeImageCallback=e=>{const{renderingEngineId:t,viewportId:n}=e.detail,o=(0,i.getRenderingEngine)(t).getViewport(n),{viewPlaneNormal:a}=o.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(n).forEach((({annotation:e})=>{const{viewPlaneNormal:t}=e.metadata;if(!(Math.abs(C.eR.dot(t,a))>ue))return;const{handles:n}=e.data,i=o.canvasToWorld([0,0]),s=C.eR.sub(C.eR.create(),i,n.points[0]),r=C.eR.dot(s,a),l=C.eR.scale(C.eR.create(),a,r);for(let e=0,t=n.points.length;e<t;e++){const t=n.points[e];t[0]+=l[0],t[1]+=l[1],t[2]+=l[2]}e.invalidated=!0}))},this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){return ve._singleton=ve._singleton??new ve,ve._singleton}getViewport(e){return this._magnifyViewportsMap.get(e)?.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}destroyViewport(e){const t=this._magnifyViewportsMap.get(e);if(t){const{magnifyViewport:n}=t,{viewport:i}=n.sourceEnabledElement,{element:o}=i;this._removeSourceElementEventListener(o),n.dispose(),this._magnifyViewportsMap.delete(e)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach((e=>this.destroyViewport(e)))}_getMagnifyViewportsMapEntriesBySourceViewportId(e){return Array.from(this._magnifyViewportsMap.values()).filter((({magnifyViewport:t})=>{const{viewport:n}=t.sourceEnabledElement;return n.id===e}))}_reset(e){this._getMagnifyViewportsMapEntriesBySourceViewportId(e).forEach((({magnifyViewport:t,annotation:n,magnifyViewportInfo:o})=>{this.destroyViewport(t.viewportId);const a=(0,i.getEnabledElementByViewportId)(e);this.createViewport(n,{...o,sourceEnabledElement:{...a}})}))}_addEventListeners(){i.eventTarget.addEventListener(a.Events.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){i.eventTarget.removeEventListener(a.Events.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(e){e.addEventListener(ce.STACK_NEW_IMAGE,this._newStackImageCallback);const t=e=>{const{viewportId:t}=e.detail;this._reset(t)};e.addEventListener(ce.VIEWPORT_NEW_IMAGE_SET,t);const n=e=>{const{viewportId:t}=e.detail;this._reset(t)};e.addEventListener(ce.VOLUME_VIEWPORT_NEW_VOLUME,n),e.addEventListener(ce.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),e.newStackHandler=t,e.newVolumeHandler=n}_removeSourceElementEventListener(e){e.removeEventListener(ce.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(ce.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),e.removeEventListener(ce.VIEWPORT_NEW_IMAGE_SET,e.newStackHandler),e.removeEventListener(ce.VOLUME_VIEWPORT_NEW_VOLUME,e.newVolumeHandler),delete e.newStackHandler,delete e.newVolumeHandler}_initialize(){this._addEventListeners()}}class pe{constructor({magnifyViewportId:e,sourceEnabledElement:t,radius:n=125,position:o=[0,0],zoomFactor:a,autoPan:s}){this._enabledElement=null,this._sourceToolGroup=null,this._magnifyToolGroup=null,this._isViewportReady=!1,this._radius=0,this._resized=!1,this._canAutoPan=!1,this._viewportId=e??i.utilities.uuidv4(),this._sourceEnabledElement=t,this._autoPan=s,this.radius=n,this.position=o,this.zoomFactor=a,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=(0,le.A)(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}update(){const{radius:e,position:t,visible:n}=this,{viewport:i}=this._enabledElement,{element:o}=i,a=2*e,[s,r]=t;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(o.style,{display:n?"block":"hidden",width:`${a}px`,height:`${a}px`,left:-e+"px",top:-e+"px",transform:`translate(${s}px, ${r}px)`}),this._isViewportReady&&(this._syncViewports(),i.render())}dispose(){const{viewport:e}=this._enabledElement,{element:t}=e,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}_handleToolModeChanged(e){const{_magnifyToolGroup:t}=this,{toolGroupId:n,toolName:i,mode:o,toolBindingsOptions:s}=e.detail;if(this._sourceToolGroup?.id===n)switch(o){case a.ToolModes.Active:t.setToolActive(i,s);break;case a.ToolModes.Passive:t.setToolPassive(i);break;case a.ToolModes.Enabled:t.setToolEnabled(i);break;case a.ToolModes.Disabled:t.setToolDisabled(i);break;default:throw new Error(`Unknow tool mode (${o})`)}}_inheritBorderRadius(e){const t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}_createViewportNode(){const e=document.createElement("div"),{radius:t}=this,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:`${n}px`,height:`${n}px`,position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:-t+"px",top:-t+"px",transform:"translate(-1000px, -1000px)"}),e}_convertZoomFactorToParallelScale(e,t,n){const{parallelScale:i}=e.getCamera();return i*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}_isStackViewport(e){return"setStack"in e}_isVolumeViewport(e){return"addVolumes"in e}_cloneToolGroups(e,t){const n=e.getActors(),i=`${t.id}-toolGroup`,o=(0,f.getToolGroupForViewport)(e.id,e.renderingEngineId),s=o.clone(i,(e=>{const t=o.getToolInstance(e);return t instanceof D.EC&&!(t instanceof me)}));return s.addViewport(t.id,t.renderingEngineId),n.filter(he).forEach((e=>{(0,A.addSegmentationRepresentations)(this.viewportId,[{segmentationId:e.referencedId,type:a.SegmentationRepresentations.Labelmap}])})),{sourceToolGroup:o,magnifyToolGroup:s}}_cloneStack(e,t){const n=e.getImageIds();t.setStack(n).then((()=>{this._isViewportReady=!0,this.update()}))}_cloneVolumes(e,t){const n=e.getActors().filter((e=>!he(e))).map((e=>({volumeId:e.uid})));return t.setVolumes(n).then((()=>{this._isViewportReady=!0,this.update()})),t}_cloneViewport(e,t){const{viewportId:n}=this,i=e.getRenderingEngine(),{options:o}=e,a={element:t,viewportId:n,type:e.type,defaultOptions:{...o}};i.enableElement(a);const s=i.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,s):this._isVolumeViewport(e)&&this._cloneVolumes(e,s),this._inheritBorderRadius(t);const r=this._cloneToolGroups(e,s);this._sourceToolGroup=r.sourceToolGroup,this._magnifyToolGroup=r.magnifyToolGroup}_cancelMouseEventCallback(e){e.stopPropagation(),e.preventDefault()}_browserMouseUpCallback(e){const{element:t}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(e){const{element:t}=this._enabledElement.viewport;this._canAutoPan=!!e.target?.closest(".advancedMagnifyTool"),document.addEventListener("mouseup",this._browserMouseUpCallback),t.removeEventListener("mouseup",this._cancelMouseEventCallback),t.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(e){if(!v.wk.isInteractingWithTool)return;const{_autoPan:t}=this;if(!t.enabled||!this._canAutoPan)return;const{currentPoints:n}=e.detail,{viewport:i}=this._enabledElement,{canvasToWorld:o}=i,{canvas:a}=n,{radius:s}=this,r=[s,s],l=(0,de.distanceToPoint)(r,a),d=s-t.padding;if(l<=d)return;const c=l-d,h=C.Zc.sub(C.Zc.create(),a,r);C.Zc.normalize(h,h),C.Zc.scale(h,h,c);const g=C.Zc.add(C.Zc.create(),this.position,h),u=o(this.position),m=o(g),p=C.eR.sub(C.eR.create(),m,u),f={points:{currentPosition:{canvas:this.position,world:u},newPosition:{canvas:g,world:m}},delta:{canvas:h,world:p}};t.callback(f)}_addBrowserEventListeners(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(e){i.eventTarget.addEventListener(a.Events.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(a.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}_removeEventListeners(e){i.eventTarget.removeEventListener(a.Events.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(a.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}_initialize(){const{_sourceEnabledElement:e}=this,{viewport:t}=e,{canvas:n}=t,o=this._createViewportNode();n.parentNode.appendChild(o),this._addEventListeners(o),this._cloneViewport(t,o),this._enabledElement=(0,i.getEnabledElement)(o)}_syncViewportsCameras(e,t){const n=e.canvasToWorld(this.position),i=this._convertZoomFactorToParallelScale(e,t,this.zoomFactor),{focalPoint:o,position:a,viewPlaneNormal:s}=t.getCamera(),r=Math.sqrt(Math.pow(o[0]-a[0],2)+Math.pow(o[1]-a[1],2)+Math.pow(o[2]-a[2],2)),l=[n[0],n[1],n[2]],d=[l[0]+r*s[0],l[1]+r*s[1],l[2]+r*s[2]];t.setCamera({parallelScale:i,focalPoint:l,position:d})}_syncStackViewports(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}_syncViewports(){const{viewport:e}=this._sourceEnabledElement,{viewport:t}=this._enabledElement,n=e.getProperties();t.getImageData()&&(t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t),this._syncViewportsCameras(e,t),t.render())}_resizeViewport(){const{viewport:e}=this._enabledElement;e.getRenderingEngine().resize()}}me.toolName="AdvancedMagnify";var fe=n(6030);const{EPSILON:we}=i.CONSTANTS;class Ee extends fe.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",enforceSameFrameOfReference:!0,showFullDimension:!1}}){super(e,t),this.editData=null,this._init=()=>{const e=(0,i.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,P.filterViewportsWithToolEnabled)(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n?.getImageData())return;const{element:a}=n,{viewUp:s,viewPlaneNormal:r}=n.getCamera(),l=i.utilities.getViewportImageCornersInWorld(n);let d=this.editData?.annotation;const c=n.getFrameOfReferenceUID();if(d)this.editData.annotation.data.handles.points=l;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...s],FrameOfReferenceUID:c,referencedImageId:null},data:{handles:{points:l}}};(0,o.addAnnotation)(e,a),d=e}this.editData={sourceViewportId:n.id,renderingEngine:e,annotation:d},(0,k.A)(t.filter((e=>e.id!==n.id)).map((e=>e.id)))},this.onSetToolEnabled=()=>{this._init()},this.onSetToolConfiguration=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e;if(!this.editData)return!1;const{annotation:o,sourceViewportId:a}=this.editData;let s=!1;const{viewport:r}=(0,i.getEnabledElementByViewportId)(a)||{};if(!r)return s;if(r.id===n.id)return s;if(!o||!o?.data?.handles?.points)return s;if(this.configuration.enforceSameFrameOfReference&&r.getFrameOfReferenceUID()!==n.getFrameOfReferenceUID())return s;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d=o.data.handles.points[0],c=o.data.handles.points[1],h=o.data.handles.points[2],g=o.data.handles.points[3],{focalPoint:u,viewPlaneNormal:m,viewUp:v}=n.getCamera(),{viewPlaneNormal:p}=r.getCamera();if(this.isParallel(m,p))return s;const f=i.utilities.planar.planeEquation(m,u),w=[d,h,c,g],E=[d,c,h,g];let I=w,_=C.eR.subtract(C.eR.create(),w[0],w[1]);_=C.eR.normalize(C.eR.create(),_);let T=C.eR.subtract(C.eR.create(),w[2],w[0]);T=C.eR.normalize(C.eR.create(),T);const b=C.eR.cross(C.eR.create(),_,T);if(this.isParallel(b,m))return s;this.isPerpendicular(_,m)&&(I=E);const y=i.utilities.planar.linePlaneIntersection(I[0],I[1],f),A=i.utilities.planar.linePlaneIntersection(I[2],I[3],f),{annotationUID:D}=o;l.annotationUID=D;const x=this.getStyle("lineWidth",l,o),M=this.getStyle("lineDash",l,o),O=this.getStyle("color",l,o),R=this.getStyle("shadow",l,o);let L=[y,A].map((e=>n.worldToCanvas(e)));if(this.configuration.showFullDimension&&(L=this.handleFullDimension(n,y,m,v,A,L)),L.length<2)return s;const P=`${D}-line`;return(0,S.drawLine)(t,D,"1",L[0],L[1],{color:O,width:x,lineDash:M,shadow:R},P),s=!0,s},this.isPerpendicular=(e,t)=>{const n=C.eR.dot(e,t);return Math.abs(n)<we}}handleFullDimension(e,t,n,o,a,s){e.getRenderingEngine();const r=this.getTargetId(e),l=this.getTargetImageData(r),d=this.getReferencedImageId(e,t,n,o);if(d&&l)try{const{imageData:n,dimensions:o}=l,[r,c,h,g]=[n.indexToWorld([0,0,0]),n.indexToWorld([o[0]-1,0,0]),n.indexToWorld([o[0]-1,o[1]-1,0]),n.indexToWorld([0,o[1]-1,0])].map((e=>i.utilities.worldToImageCoords(d,e))),[u,m]=[t,a].map((e=>i.utilities.worldToImageCoords(d,e)));s=[[r,c],[c,h],[g,h],[r,g]].map((([e,t])=>this.intersectInfiniteLines(e,t,u,m))).filter((e=>e&&this.isInBound(e,o))).map((t=>{const n=i.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return s}intersectInfiniteLines(e,t,n,i){const[o,a]=e,[s,r]=t,[l,d]=n,[c,h]=i,g=r-a,u=o-s,m=s*a-o*r,v=h-d,p=l-c,f=c*d-l*h;if(Math.abs(g*p-v*u)<we)return;return[(u*f-p*m)/(g*p-v*u),(v*m-g*f)/(g*p-v*u)]}isParallel(e,t){return Math.abs(C.eR.dot(e,t))>1-we}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}Ee.toolName="ReferenceLines";const{EPSILON:Ie}=i.CONSTANTS;class Ce extends fe.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(e,t),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=i.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,a=(0,f.getToolGroup)(this.toolGroupId).viewportsInfo;if(!a?.length)return void console.warn("OverlayGridTool: No viewports found");const s=(0,o.getAnnotations)(this.getToolName(),n);if(!s?.length){const t=e.map((e=>this.calculateImageIdPointSets(e))),i={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}};(0,o.addAnnotation)(i,n)}(0,k.A)(a.map((({viewportId:e})=>e)))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:o,rowCosines:a,columnCosines:s,rowPixelSpacing:r,columnPixelSpacing:l}=i.metaData.get("imagePlaneModule",e),d=[...t],c=[...t],h=[...t],g=[...t];C.eR.scaleAndAdd(c,t,s,o*l),C.eR.scaleAndAdd(h,t,a,n*r),C.eR.scaleAndAdd(g,h,s,o*l);return{pointSet1:[d,h,c,g],pointSet2:[d,c,h,g]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let a=!1;if(!n?.length)return a;const{viewport:s,FrameOfReferenceUID:r}=e;if(s.getImageIds().length<2)return a;const l=(0,o.getAnnotations)(this.getToolName(),r);if(!l?.length)return a;const d=l[0],{annotationUID:c}=d,{focalPoint:h,viewPlaneNormal:g}=s.getCamera(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},m=this.getImageIdNormal(n[0]);if(this.isParallel(g,m))return a;const v=i.utilities.planar.planeEquation(g,h),p=d.data.pointSets,f=d.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:o}=p[e],a=f.get(s.id)||this.initializeViewportData(f,s.id);if(!a.pointSetsToUse[e]){let t=n,s=C.eR.subtract(C.eR.create(),n[0],n[1]);s=C.eR.normalize(C.eR.create(),s),this.isPerpendicular(s,g)&&(t=o),a.pointSetsToUse[e]=t,a.lineStartsWorld[e]=i.utilities.planar.linePlaneIntersection(t[0],t[1],v),a.lineEndsWorld[e]=i.utilities.planar.linePlaneIntersection(t[2],t[3],v)}const r=a.lineStartsWorld[e],l=a.lineEndsWorld[e];u.annotationUID=c;const h=this.getStyle("lineWidth",u,d),m=this.getStyle("lineDash",u,d),w=this.getStyle("color",u,d),E=this.getStyle("shadow",u,d),I=[r,l].map((e=>s.worldToCanvas(e))),_=`${c}-line`,T=`${e}`;(0,S.drawLine)(t,c,T,I[0],I[1],{color:w,width:h,lineDash:m,shadow:E},_)}return a=!0,a},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=C.eR.dot(e,t);return Math.abs(n)<Ie}}isParallel(e,t){return Math.abs(C.eR.dot(e,t))>1-Ie}getImageIdNormal(e){const{imageOrientationPatient:t}=i.metaData.get("imagePlaneModule",e),n=C.eR.fromValues(t[0],t[1],t[2]),o=C.eR.fromValues(t[3],t[4],t[5]);return C.eR.cross(C.eR.create(),n,o)}}Ce.toolName="OverlayGrid";var _e=n(38726);class Te extends fe.A{constructor(e={},t={configuration:{opacity:.5}}){super(e,t),this._init=()=>{const e=(0,f.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,i.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),a=(0,o.getAnnotations)(this.getToolName(),n);if(!a?.length){const t=new Map;!function(e,t){t.forEach((({viewportId:t,renderingEngineId:n})=>{const o=(0,i.getRenderingEngine)(n)?.getViewport(t);be(e,o)}))}(t,e);const a={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}};(0,o.addAnnotation)(a,n)}(0,k.A)(e.map((({viewportId:e})=>e)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:i}=e;let a=!1;const s=(0,o.getAnnotations)(this.getToolName(),i);if(!s?.length)return a;const r=s[0],{annotationUID:l}=r,d=r.data.actorsWorldPointsMap;be(d,n);const c=n.getActors(),h=Se(n);return c.forEach((e=>{if(!e?.clippingFilter)return;const i=d.get(e.uid);if(!i)return;if(!i.get(h))return;let o=1;const{worldPointsSet:a,color:s}=i.get(h);for(let i=0;i<a.length;i++){const r=a[i].map((e=>n.worldToCanvas(e))),d={color:s,fillColor:s,fillOpacity:this.configuration.opacity,closePath:!0,lineWidth:2},c=e.uid+"#"+o;(0,S.drawPath)(t,l,c,r,d),o++}})),a=!0,a}}}function be(e,t){const n=t.getActors(),i=Se(t);n.forEach((t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(i)){const e=t.clippingFilter.getOutputData(),o=y.polyDataUtils.getPolyDataPoints(e);if(!o)return;const a=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(i,{worldPointsSet:o,color:a})}}))}function Se(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${(0,_e.l)(t)}-${n}`}Te.toolName="SegmentationIntersection";class ye extends fe.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;const o=this.getActiveAnnotation(n);return null===o?(this.createInitialAnnotation(i.world,n),!1):(this.updateAnnotationPosition(n,o),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,i.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:a,renderingEngine:s}=n;this.isDrawing=!0;const r=a.getCamera(),{viewPlaneNormal:l,viewUp:d}=r;if(!l||!d)throw new Error("Camera not found");const c=this.getReferencedImageId(a,e,l,d),h=a.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...d],FrameOfReferenceUID:h,referencedImageId:c},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if((0,o.getAnnotations)(this.getToolName(),t).length>0)return null;if(null===(0,o.addAnnotation)(g,t))return;const u=(0,P.getViewportIdsWithToolToRender)(t,this.getToolName(),!1);(0,k.A)(u)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:o,camera:a}=t,s=(0,i.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=o.focalPoint,l=a.viewPlaneNormal,d=a.focalPoint,c=[0,0,0];if(M.Ay.subtract(d,r,c),0===c.reduce(((e,t)=>e+t),0))return;const h=M.Ay.dot(c,l);if(Math.abs(h)<.01)return;if(!this._currentCanvasPosition)return;const g=s.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=g,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,FrameOfReferenceUID:a}=e,s=this._elementWithCursor===i.element;this.configuration.positionSync&&!s&&this.updateViewportImage(i);const{element:r}=i;let l=(0,o.getAnnotations)(this.getToolName(),r);if(!l?.length)return n;if(l=this.filterInteractableAnnotationsForElement(r,l),!l?.length)return n;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){const o=l[e],{annotationUID:a,data:r}=o,{handles:c}=r,{points:h}=c;if(!a)return n;d.annotationUID=a;const g=parseFloat(this.getStyle("lineWidth",d,o)),u=g,m=this.getStyle("lineDash",d,o),v=this.getStyle("color",d,o);if(h[0].some((e=>isNaN(e))))return n;const p=h.map((e=>i.worldToCanvas(e)));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,se.isAnnotationVisible)(a))continue;const f={upper:"upper",right:"right",lower:"lower",left:"left"},[w,E]=p[0],I=s?20:7,C=s?5:7;(0,S.drawLine)(t,a,f.upper,[w,E-(I/2+C)],[w,E-I/2],{color:v,lineDash:m,lineWidth:u}),(0,S.drawLine)(t,a,f.lower,[w,E+(I/2+C)],[w,E+I/2],{color:v,lineDash:m,lineWidth:u}),(0,S.drawLine)(t,a,f.right,[w+(I/2+C),E],[w+I/2,E],{color:v,lineDash:m,lineWidth:u}),(0,S.drawLine)(t,a,f.left,[w-(I/2+C),E],[w-I/2,E],{color:v,lineDash:m,lineWidth:u}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=(0,f.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,i.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&(0,N.hideElementCursor)(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=(0,f.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,i.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&(0,N.resetElementCursor)(e.viewport.element)}))}getActiveAnnotation(e){const t=(0,o.getAnnotations)(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const o=(0,P.getViewportIdsWithToolToRender)(e,this.getToolName(),!1);(0,i.getEnabledElement)(e)&&(0,k.A)(o)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],o=(0,i.getEnabledElement)(e)?.viewport;if(!o)return[];const a=o.getCamera(),{viewPlaneNormal:s,focalPoint:r}=a;if(!s||!r)return[];const l=n.data?.handles?.points;if(!(l instanceof Array)||1!==l.length)return[];const d=l[0],c=i.utilities.planar.planeEquation(s,r);return i.utilities.planar.planeDistanceToPoint(c,d)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof i.StackViewport){const n=i.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof i.VolumeViewport){const{focalPoint:n,viewPlaneNormal:o}=e.getCamera();if(!n||!o)return;const a=i.utilities.planar.planeEquation(o,n),s=i.utilities.planar.planeDistanceToPoint(a,t,!0);if(Math.abs(s)<.5)return;const r=C.eR.normalize(C.eR.create(),C.eR.fromValues(...o)),l=C.eR.scale(C.eR.create(),r,s),d=C.eR.add(C.eR.create(),C.eR.fromValues(...n),l);if(!0){e.setCamera({focalPoint:d});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}ye.toolName="ReferenceCursors";const Ae=[];class De extends fe.A{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData=null,this._init=()=>{const e=(0,i.getRenderingEngines)()[0];if(!e)return;const t=(0,f.getToolGroup)(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,i.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:a}=n[0];const{FrameOfReferenceUID:s}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(a=e.viewport)})),!a)return;const{viewUp:r,viewPlaneNormal:l}=a.getCamera(),d=i.utilities.getViewportImageCornersInWorld(a);let c=this.editData.annotation;const h=(0,o.getAnnotations)(this.getToolName(),a.element);h.length&&(c=h.filter((e=>e.data.viewportId==a.id))[0]),n.forEach((e=>{const{viewport:t}=e;if(!Ae.includes(t.id)){const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...r],FrameOfReferenceUID:s,referencedImageId:null},data:{handles:{points:i.utilities.getViewportImageCornersInWorld(t)},viewportId:t.id}};Ae.push(t.id),(0,o.addAnnotation)(e,t.element),c=e}})),this.editData.annotation&&this.editData.annotation.data.viewportId==a.id&&(this.editData.annotation.data.handles.points=d,this.editData.annotation.data.viewportId=a.id),this.editData={viewport:a,renderingEngine:e,annotation:c}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let o;return o="top"==n||"bottom"==n?i.filter((t=>t<.6*e&&t>.2*e)):i.filter((e=>e<.6*t&&e>.2*t)),o[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,i,o)=>{let a;"bottom"==t||"top"==t?a=o[0][0]-i[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-i[0][1]);const s=[],r=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const o={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};s.push(`${n}-tick${e}`),r.push(`tick${e}`),(e+1)%5==0?l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][0][0],i[1][1]+o[t][0][1]]]):l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][1][0],i[1][1]+o[t][1][1]]])}return{tickIds:s,tickUIDs:r,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let i,o=C.eR.subtract(C.eR.create(),n[0],n[1]);o=C.eR.normalize(C.eR.create(),o);let a=C.eR.subtract(C.eR.create(),n[2],n[0]);a=C.eR.normalize(C.eR.create(),a);const s={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},r=C.eR.add(C.eR.create(),s[t][0],s[t][0]).map((e=>e/2)),l=e/2/Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2)+Math.pow(o[2],2));return"top"==t||"bottom"==t?i=[C.eR.subtract(C.eR.create(),r,a.map((e=>e*l))),C.eR.add(C.eR.create(),r,a.map((e=>e*l)))]:"left"!=t&&"right"!=t||(i=[C.eR.add(C.eR.create(),r,o.map((e=>e*l))),C.eR.subtract(C.eR.create(),r,o.map((e=>e*l)))]),i},this.computeCanvasScaleCoordinates=(e,t,n,i,o)=>{let a;if("top"==o||"bottom"==o){const i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){const n=t[0][1]-t[1][1];a=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,i)=>{const o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),s={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},r={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:r[i][0]+s[i][0],width:r[i][1]+s[i][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:i}=e,a=(0,o.getAnnotations)(this.getToolName(),i.element).filter((e=>e.data.viewportId==i.id))[0],s=e.viewport.canvas,r=!1;if(!i)return r;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d={width:s.width/window.devicePixelRatio||1,height:s.height/window.devicePixelRatio||1},c=a.data.handles.points[0],h=a.data.handles.points[1],g=a.data.handles.points[2],u=a.data.handles.points[3],m=[c,g,h,u],v=C.eR.distance(g,u),p=C.eR.distance(c,g),f=this.computeScaleBounds(d,.05,.05,n),w=this.computeScaleBounds(d,.05,.05,n),E=this.computeScaleSize(v,p,n),I=this.computeWorldScaleCoordinates(E,n,m).map((e=>i.worldToCanvas(e))),_=this.computeCanvasScaleCoordinates(d,I,w,f,n),T=this.computeEndScaleTicks(_,n),{annotationUID:b}=a;l.annotationUID=b;const y=this.getStyle("lineWidth",l,a),A=this.getStyle("lineDash",l,a),D=this.getStyle("color",l,a),x=this.getStyle("shadow",l,a),M=`${b}-scaleline`;(0,S.drawLine)(t,b,"1",_[0],_[1],{color:D,width:y,lineDash:A,shadow:x},M);const O=`${b}-left`;(0,S.drawLine)(t,b,"2",T.endTick1[0],T.endTick1[1],{color:D,width:y,lineDash:A,shadow:x},O);const R=`${b}-right`;(0,S.drawLine)(t,b,"3",T.endTick2[0],T.endTick2[1],{color:D,width:y,lineDash:A,shadow:x},R);const L={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},P=[_[0][0]+L[n][0],_[0][1]+L[n][1]],N=this._getTextLines(E),{tickIds:k,tickUIDs:U,tickCoordinates:V}=this.computeInnerScaleTicks(E,n,b,T.endTick1,T.endTick2);for(let e=0;e<U.length;e++)(0,S.drawLine)(t,b,U[e],V[e][0],V[e][1],{color:D,width:y,lineDash:A,shadow:x},k[e]);return(0,S.drawTextBox)(t,b,"text0",N,[P[0],P[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:D}),r}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}De.toolName="ScaleOverlay";var xe=n(95527),Me=n(76712),Oe=n(16175),Re=n(13271);class Le extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{minSpacing:1,referencedToolNames:["PlanarFreehandROI","PlanarFreehandContourSegmentationTool"],toolShape:"circle",referencedToolName:"PlanarFreehandROI"}}){super(e,t),this.registeredShapes=new Map,this.isActive=!1,this.commonData={activeAnnotationUID:null,viewportIdsToRender:[],isEditingOpenContour:!1,canvasLocation:void 0},this.preMouseDownCallback=e=>{const t=e.detail,n=t.element;if(this.configureToolSize(e),this.selectFreehandTool(t),null!==this.commonData.activeAnnotationUID)return this.isActive=!0,(0,N.hideElementCursor)(n),this.activateModify(n),!0},this.mouseMoveCallback=e=>{this.mode===a.ToolModes.Active?(this.configureToolSize(e),this.updateCursor(e)):this.commonData.canvasLocation=void 0},this.endCallback=e=>{const t=e.detail,{element:n}=t,o=this.configuration,a=(0,i.getEnabledElement)(n);this.isActive=!1,this.deactivateModify(n),(0,N.resetElementCursor)(n);const{renderingEngineId:s,viewportId:r}=a,l=(0,f.getToolGroupForViewport)(r,s).getToolInstance(o.referencedToolName),d=this.filterSculptableAnnotationsForElement(n).find((e=>e.annotationUID===this.commonData.activeAnnotationUID));l.configuration.calculateStats&&(d.invalidated=!0),(0,L.XF)(d,n)},this.dragCallback=e=>{const t=e.detail,n=t.element;this.updateCursor(e);const i=this.filterSculptableAnnotationsForElement(n),o=i.find((e=>e.annotationUID===this.commonData.activeAnnotationUID));if(!i?.length||!this.isActive)return;const a=o.data.contour.polyline;this.sculpt(t,a)},this.registerShapes(Oe.A.shapeName,Oe.A),this.setToolShape(this.configuration.toolShape)}registerShapes(e,t){const n=new t;this.registeredShapes.set(e,n)}sculpt(e,t){const n=this.configuration,o=e.element,a=(0,i.getEnabledElement)(o),{viewport:s}=a,r=this.registeredShapes.get(this.selectedShape);this.sculptData={mousePoint:e.currentPoints.world,mouseCanvasPoint:e.currentPoints.canvas,points:t,maxSpacing:r.getMaxSpacing(n.minSpacing),element:o};const l=r.pushHandles(s,this.sculptData);void 0!==l.first&&this.insertNewHandles(l)}interpolatePointsWithinMaxSpacing(e,t,n,o){const{element:a}=this.sculptData,s=(0,i.getEnabledElement)(a),{viewport:r}=s,l=Pe(e+1,t.length),d=r.worldToCanvas(t[e]),c=r.worldToCanvas(t[l]);xe.point.distanceToPoint(d,c)>o&&n.push(e)}updateCursor(e){const t=e.detail,n=t.element,o=(0,i.getEnabledElement)(n),{renderingEngine:a,viewport:s}=o;this.commonData.viewportIdsToRender=[s.id];const r=this.filterSculptableAnnotationsForElement(n);if(!r?.length)return;const l=r.find((e=>e.annotationUID===this.commonData.activeAnnotationUID));if(this.commonData.canvasLocation=t.currentPoints.canvas,this.isActive)l.highlighted=!0;else{const e=this.registeredShapes.get(this.selectedShape),n=t.currentPoints.canvas;e.updateToolSize(n,s,l)}(0,k.t)(this.commonData.viewportIdsToRender)}filterSculptableAnnotationsForElement(e){const t=this.configuration,n=(0,i.getEnabledElement)(e),{renderingEngineId:o,viewportId:a}=n,s=[],r=(0,f.getToolGroupForViewport)(a,o).getToolInstance(t.referencedToolName);return t.referencedToolNames.forEach((t=>{const n=(0,p.Rh)(t,e);n&&s.push(...n)})),r.filterInteractableAnnotationsForElement(e,s)}configureToolSize(e){this.registeredShapes.get(this.selectedShape).configureToolSize(e)}insertNewHandles(e){const t=this.findNewHandleIndices(e);let n=0;for(let e=0;e<t?.length;e++){const i=t[e]+1+n;this.insertHandleRadially(i),n++}}findNewHandleIndices(e){const{points:t,maxSpacing:n}=this.sculptData,i=[];for(let o=e.first;o<=e.last;o++)this.interpolatePointsWithinMaxSpacing(o,t,i,n);return i}insertHandleRadially(e){const{points:t}=this.sculptData;if(e>t.length-1&&this.commonData.isEditingOpenContour)return;const n=this.registeredShapes.get(this.selectedShape),i=e-1,o=Pe(e,t.length),a=n.getInsertPosition(i,o,this.sculptData);t.splice(e,0,a)}selectFreehandTool(e){const t=this.getClosestFreehandToolOnElement(e);void 0!==t&&(this.commonData.activeAnnotationUID=t)}getClosestFreehandToolOnElement(e){const{element:t}=e,n=(0,i.getEnabledElement)(t),{viewport:o}=n,a=this.configuration,s=this.filterSculptableAnnotationsForElement(t);if(!s?.length)return;const r=e.currentPoints.canvas,l={distance:1/0,toolIndex:void 0,annotationUID:void 0};for(let e=0;e<s?.length;e++){if(s[e].isLocked||!s[e].isVisible)continue;const t=(0,Re.X)(o,s[e],r);-1!==t&&(t<l.distance&&(l.distance=t,l.toolIndex=e,l.annotationUID=s[e].annotationUID))}return this.commonData.isEditingOpenContour=!s[l.toolIndex].data.contour.closed,a.referencedToolName=s[l.toolIndex].metadata.toolName,l.annotationUID}activateModify(e){e.addEventListener(a.Events.MOUSE_UP,this.endCallback),e.addEventListener(a.Events.MOUSE_CLICK,this.endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this.dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this.endCallback),e.addEventListener(a.Events.TOUCH_END,this.endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this.dragCallback)}deactivateModify(e){e.removeEventListener(a.Events.MOUSE_UP,this.endCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this.endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this.dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this.endCallback),e.removeEventListener(a.Events.TOUCH_END,this.endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this.dragCallback)}setToolShape(e){this.selectedShape=this.registeredShapes.get(e)??Oe.A.shapeName}renderAnnotation(e,t){const{viewport:n}=e,{element:i}=n,o=this.commonData.viewportIdsToRender;if(!this.commonData.canvasLocation||this.mode!==a.ToolModes.Active||!o.includes(n.id))return;const s=this.filterSculptableAnnotationsForElement(i);if(!s?.length)return;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};let l=(0,Me.h)("color",r,a.AnnotationStyleStates.Default,this.mode);this.isActive&&(l=(0,Me.h)("color",r,a.AnnotationStyleStates.Highlighted,this.mode));this.registeredShapes.get(this.selectedShape).renderShape(t,this.commonData.canvasLocation,{color:l})}}const Pe=(e,t)=>(e+t)%t;Le.toolName="SculptorTool";const Ne=[0,0,1];class ke extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:Ne,rotateIncrementDegrees:30}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:a}=o,{direction:s,rotateIncrementDegrees:r}=this.configuration,l=a.getCamera(),{viewUp:d,position:c,focalPoint:h}=l,{direction:g}=n,[u,m,v]=h,[p,f,w]=s,E=g*(r*Math.PI)/180,I=[0,0,0],_=[0,0,0],T=[0,0,0],b=C.pB.identity(new Float32Array(16));C.pB.translate(b,b,[u,m,v]),C.pB.rotate(b,b,E,[p,f,w]),C.pB.translate(b,b,[-u,-m,-v]),C.eR.transformMat4(I,c,b),C.eR.transformMat4(_,h,b),C.pB.identity(b),C.pB.rotate(b,b,E,[p,f,w]),C.eR.transformMat4(T,d,b),a.setCamera({position:I,viewUp:T,focalPoint:_}),a.render()}}ke.toolName="VolumeRotateMouseWheel";n(25072);var Ue=n(4096),Ve=n(27730),We=n(66990);const{transformWorldToIndex:Be}=i.utilities;class He extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Fe}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;(0,N.hideElementCursor)(a),this.isDrawing=!0;const{viewPlaneNormal:c,viewUp:h,position:g}=l.getCamera(),u=this.getReferencedImageId(l,s,c,h),m={highlighted:!0,invalidated:!0,metadata:{...l.getViewReference({points:[s]}),toolName:this.getToolName(),referencedImageId:u,viewUp:h,cameraPosition:g},data:{handles:{points:[[...s],[...s]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,o.addAnnotation)(m,a);const v=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),e.preventDefault(),(0,k.A)(v),m},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return j.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,N.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;r.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0,(0,k.A)(o)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const a=s[o],{annotationUID:c,data:h}=a,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:v,lineDash:p,shadow:f}=this.getAnnotationStyle({annotation:a,styleSpecifier:d}),w=g.map((e=>i.worldToCanvas(e)));if(h.cachedStats[r]&&null!=h.cachedStats[r].unit?a.invalidated&&this._throttledCalculateCachedStats(a,l,e):(h.cachedStats[r]={length:null,unit:null},this._calculateCachedStats(a,l,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let E;if(!(0,se.isAnnotationVisible)(c))continue;if((0,Z.isAnnotationLocked)(c)||this.editData||null===u||(E=[w[u]]),E){const e="0";(0,S.drawHandles)(t,c,e,w,{color:m,lineDash:p,lineWidth:v})}const I=`${c}-line`,C="1";if((0,S.drawLine)(t,c,C,w[0],w[1],{color:m,width:v,lineDash:p,shadow:f},I),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const _=this.getLinkedTextBoxStyle(d,a);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=(0,We.getTextBoxCoordsCanvas)(w);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const b=i.worldToCanvas(h.handles.textBox.worldPosition),y="1",A=(0,S.drawLinkedTextBox)(t,c,y,T,b,w,{},_),{x:D,y:x,width:M,height:O}=A;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,x]),topRight:i.canvasToWorld([D+M,x]),bottomLeft:i.canvasToWorld([D,x+O]),bottomRight:i.canvasToWorld([D+M,x+O])}}return n},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,N.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(d),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport,a=i.handles.points[0],s=i.handles.points[1],{cachedStats:r}=i,l=Object.keys(r);for(let e=0;e<l.length;e++){const t=l[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:i,dimensions:o}=n,d=Be(i,a),c=Be(i,s),h=[d,c],{scale:g,unit:u}=(0,Ue.Op)(n,h),m=this._calculateLength(a,s)/g;this._isInsideVolume(d,c,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,r[t]={length:m,unit:u}}return e.invalidated=!1,(0,L.XF)(e,o),r}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function Fe(e,t){const n=e.cachedStats[t],{length:o,unit:a}=n;if(null==o||isNaN(o))return;return[`${i.utilities.roundNumber(o)} ${a}`]}He.toolName="Length";const{transformWorldToIndex:Ge}=i.utilities;class $e extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:ze}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;(0,N.hideElementCursor)(a),this.isDrawing=!0;const{viewPlaneNormal:c,viewUp:h,position:g}=l.getCamera(),u=this.getReferencedImageId(l,s,c,h),m={highlighted:!0,invalidated:!0,metadata:{...l.getViewReference({points:[s]}),toolName:this.getToolName(),referencedImageId:u,viewUp:h,cameraPosition:g},data:{handles:{points:[[...s],[...s]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,o.addAnnotation)(m,a);const v=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),e.preventDefault(),(0,k.A)(v),m},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return j.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,N.hideElementCursor)(o);(0,i.getEnabledElement)(o);(0,k.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;(0,i.getEnabledElement)(e);return(0,k.A)(n),o&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const a=s[o],{annotationUID:c,data:h}=a,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:v,lineDash:p,shadow:f}=this.getAnnotationStyle({annotation:a,styleSpecifier:d}),w=g.map((e=>i.worldToCanvas(e)));let E;if(h.cachedStats[r]&&null!=h.cachedStats[r].unit?a.invalidated&&this._throttledCalculateCachedStats(a,l,e):(h.cachedStats[r]={length:null,unit:null},this._calculateCachedStats(a,l,e)),!(0,se.isAnnotationVisible)(c))continue;if((0,Z.isAnnotationLocked)(c)||this.editData||null===u||(E=[w[u]]),E){const e="0";(0,S.drawHandles)(t,c,e,w,{color:m,lineDash:p,lineWidth:v})}const I="0";if((0,S.drawHeight)(t,c,I,w[0],w[1],{color:m,width:v,lineDash:p}),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const C=this.getLinkedTextBoxStyle(d,a);if(!C.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=(0,We.getTextBoxCoordsCanvas)(w);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const T=i.worldToCanvas(h.handles.textBox.worldPosition),b="1",y=(0,S.drawLinkedTextBox)(t,c,b,_,T,w,{},C),{x:A,y:D,width:x,height:M}=y;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([A,D]),topRight:i.canvasToWorld([A+x,D]),bottomLeft:i.canvasToWorld([A,D+M]),bottomRight:i.canvasToWorld([A+x,D+M])}}return n},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,N.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(d),e.preventDefault()}_calculateHeight(e,t){const n=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return 0==n?0!=i?Math.abs(o):0:0==i?Math.abs(o):0==o?Math.abs(i):void 0}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport,a=i.handles.points[0],s=i.handles.points[1],{cachedStats:r}=i,l=Object.keys(r);for(let e=0;e<l.length;e++){const t=l[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:i,dimensions:o}=n,d=Ge(i,a),c=Ge(i,s),h=[d,c],{scale:g,unit:u}=(0,Ue.Op)(n,h),m=this._calculateHeight(a,s)/g,v=this._isInsideVolume(d,c,o);this.isHandleOutsideImage=v,r[t]={height:m,unit:u}}return e.invalidated=!1,(0,L.XF)(e,o),r}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function ze(e,t){const n=e.cachedStats[t],{height:o,unit:a}=n;if(null==o||isNaN(o))return;return[`${i.utilities.roundNumber(o)} ${a}`]}$e.toolName="Height";var qe=n(40634),je=n(18990);const{transformWorldToIndex:Ze}=i.utilities;class Ke extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ye}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l}=r;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(l,s,c),u=l.getFrameOfReferenceUID(),m={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:u,referencedImageId:g},data:{label:"",handles:{points:[[...s]]},cachedStats:{}}};(0,o.addAnnotation)(m,a);const v=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:m,newAnnotation:!0,viewportIdsToRender:v},this._activateModify(a),(0,N.hideElementCursor)(a),e.preventDefault(),(0,k.A)(v),m},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r}=this.editData,{viewportId:l,renderingEngine:d}=(0,i.getEnabledElement)(n);this.eventDispatchDetail={viewportId:l,renderingEngineId:d.id},this._deactivateModify(n),(0,N.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,{annotation:s,viewportIdsToRender:r}=this.editData,{data:l}=s;l.handles.points[0]=[...a],s.invalidated=!0;const d=(0,i.getEnabledElement)(o),{renderingEngine:c}=d;(0,k.A)(r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:a}=e,{element:s}=a;let r=(0,o.getAnnotations)(this.getToolName(),s);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(s,r),!r?.length)return n;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<r.length;o++){const s=r[o],h=s.annotationUID,g=s.data,u=g.handles.points[0],m=a.worldToCanvas(u);c.annotationUID=h;const{color:v}=this.getAnnotationStyle({annotation:s,styleSpecifier:c});if(g.cachedStats||(g.cachedStats={}),g.cachedStats[l]&&null!=g.cachedStats[l].value){if(s.invalidated&&(this._calculateCachedStats(s,d,e),a instanceof i.VolumeViewport)){const{referencedImageId:e}=s.metadata;for(const t in g.cachedStats)if(t.startsWith("imageId")){d.getStackViewports().find((t=>{const n=i.utilities.imageIdToURI(e),o=t.hasImageURI(n),a=i.utilities.imageIdToURI(t.getCurrentImageId());return o&&a!==n}))&&delete g.cachedStats[t]}}}else g.cachedStats[l]={Modality:null,index:null,value:null},this._calculateCachedStats(s,d,e);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const p="0";(0,S.drawHandles)(t,h,p,[m],{color:v}),n=!0;const f=this.getLinkedTextBoxStyle(c,s);if(!f.visibility)continue;const w=this.configuration.getTextLines(g,l);if(w){const e=[m[0]+6,m[1]-6],n="0";(0,S.drawTextBox)(t,h,n,w,[e[0],e[1]],f)}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,o){const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,l=r.handles.points[0],d=s.worldToCanvas(l);if(!0===C.Zc.distance(n,d)<o)return l}handleSelectedCallback(e,t){const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(o),(0,N.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()}_calculateCachedStats(e,t,n){const o=e.data,{renderingEngineId:a,viewport:s}=n,{element:r}=s,l=o.handles.points[0],{cachedStats:d}=o,c=Object.keys(d);for(let t=0;t<c.length;t++){const n=c[t],o={isPreScaled:(0,je.u)(s,n),isSuvScaled:this.isSuvScaled(s,n,e.metadata.referencedImageId)},a=this.getTargetImageData(n);if(!a)continue;const{dimensions:h,imageData:g,metadata:u,voxelManager:m}=a,v=u.Modality;let p=Ze(g,l);if(p=C.eR.round(p,p),i.utilities.indexWithinDimensions(p,h)){this.isHandleOutsideImage=!1;let t,s=m.getAtIJKPoint(p);if(n.startsWith("imageId:")){const e=n.split("imageId:")[1],t=i.utilities.imageIdToURI(e),o=i.utilities.getViewportsWithImageURI(t)[0];p[2]=o.getCurrentImageIdIndex()}if("US"===v){const e=(0,Ue.Xw)(a,[p]),n=e.values.every((e=>null!==e));s=n?e.values:s,t=n?e.units:"raw"}else t=(0,qe.j)(v,e.metadata.referencedImageId,o);d[n]={index:p,value:s,Modality:v,modalityUnit:t}}else this.isHandleOutsideImage=!0,d[n]={index:p,Modality:v};e.invalidated=!1,(0,L.XF)(e,r)}return d}}function Ye(e,t){const n=e.cachedStats[t],{index:o,value:a,modalityUnit:s}=n;if(void 0===a)return;const r=[];if(r.push(`(${o[0]}, ${o[1]}, ${o[2]})`),a instanceof Array&&s instanceof Array)for(let e=0;e<a.length;e++)r.push(`${i.utilities.roundNumber(a[e])} ${s[e]}`);else r.push(`${i.utilities.roundNumber(a)} ${s}`);return r}Ke.toolName="Probe";const Xe=Ke;class Je extends Xe{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Qe}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(r,a,c,h),u={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:g},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}},m=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:u,newAnnotation:!0,viewportIdsToRender:m},this._activateModify(o),(0,N.hideElementCursor)(o),e.preventDefault(),(0,k.A)(m),u},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;if(!this.editData)return n;const o=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(!o?.length)return n;const a=this.getTargetId(i),s=i.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,h=c.handles.points[0],g=i.worldToCanvas(h);r.annotationUID=d;const{color:u}=this.getAnnotationStyle({annotation:l,styleSpecifier:r});if(c.cachedStats[a]&&null!=c.cachedStats[a].value?l.invalidated&&this._calculateCachedStats(l,s,e):(c.cachedStats[a]={Modality:null,index:null,value:null},this._calculateCachedStats(l,s,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;(0,S.drawHandles)(t,d,"0",[g],{color:u}),n=!0;const m=this.configuration.getTextLines(c,a);if(m){const e=[g[0]+6,g[1]-6],n="0";(0,S.drawTextBox)(t,d,n,m,[e[0],e[1]],this.getLinkedTextBoxStyle(r,l))}return n}}}function Qe(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const s=[];return s.push(`(${i[0]}, ${i[1]}, ${i[2]})`),s.push(`${o.toFixed(2)} ${a}`),s}Je.toolName="DragProbe";n(4010);var et=n(40133),tt=n(87009),nt=n(79362);const{transformWorldToIndex:it}=i.utilities;class ot extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,getTextLines:at,statsCalculator:nt.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(n.canvas,(0,i.getEnabledElement)(a)),{viewport:l,renderingEngine:d}=r;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...l.getViewReference({points:[s]})},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...s],[...s],[...s],[...s]],activeHandleIndex:null},cachedStats:{},initialRotation:l.getRotation()}};(0,o.addAnnotation)(v,a);const p=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,centerWorld:s,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,N.hideElementCursor)(a),e.preventDefault(),(0,k.A)(p),v},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=l.map((e=>s.worldToCanvas(e))),c=(0,tt.getCanvasEllipseCorners)(d),[h,g]=c,u={left:Math.min(h[0],g[0])+o/2,top:Math.min(h[1],g[1])+o/2,width:Math.abs(h[0]-g[0])-o,height:Math.abs(h[1]-g[1])-o},m={left:Math.min(h[0],g[0])-o/2,top:Math.min(h[1],g[1])-o/2,width:Math.abs(h[0]-g[0])+o,height:Math.abs(h[1]-g[1])+o},v=this._pointInEllipseCanvas(u,n);return!(!this._pointInEllipseCanvas(m,n)||v)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,N.hideElementCursor)(o),this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l,d,c,h,g,u=!1;if(n.worldPosition)u=!0;else{const{points:e}=s.handles,{viewport:t}=(0,i.getEnabledElement)(a),{worldToCanvas:o,canvasToWorld:u}=t;r=e.findIndex((e=>e===n));const m=e.map(o);g=m[r],c=Math.abs(m[2][0]-m[3][0]),h=Math.abs(m[0][1]-m[1][1]),l=[(m[2][0]+m[3][0])/2,(m[0][1]+m[1][1])/2],d=u(l)}const m=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:m,handleIndex:r,canvasWidth:c,canvasHeight:h,centerWorld:d,originalHandleCanvas:g,movingTextBox:u},this._activateModify(a),(0,N.hideElementCursor)(a);const v=(0,i.getEnabledElement)(a),{renderingEngine:p}=v;(0,k.A)(m),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;a.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const{renderingEngine:c}=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h,centerWorld:g}=this.editData,u=l.worldToCanvas(g),{data:m}=c,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),f=[u[0],u[1]-p],w=[u[0],u[1]+p],E=[u[0]-v,u[1]],I=[u[0]+v,u[1]];m.handles.points=[d(f),d(w),d(E),d(I)],c.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:o}=(0,i.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=o,{annotation:r,canvasWidth:l,canvasHeight:d,handleIndex:c,centerWorld:h,originalHandleCanvas:g}=this.editData,u=o.worldToCanvas(h),{data:m}=r,{points:v}=m.handles,{currentPoints:p}=t,f=p.canvas;if(0===c||1===c){const e=Math.abs(f[1]-u[1]),t=[u[0],u[1]-e],n=[u[0],u[1]+e];v[0]=a(t),v[1]=a(n);const i=l/2+(f[0]-g[0]),o=[u[0]-i,u[1]],s=[u[0]+i,u[1]];v[2]=a(o),v[3]=a(s)}else{const e=Math.abs(f[0]-u[0]),t=[u[0]-e,u[1]],n=[u[0]+e,u[1]];v[2]=a(t),v[3]=a(n);const i=d/2+(f[1]-g[1]),o=[u[0],u[1]-i],s=[u[0],u[1]+i];v[0]=a(o),v[1]=a(s)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:a}=e,{element:s}=a;let r=(0,o.getAnnotations)(this.getToolName(),s);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(s,r),!r?.length)return n;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<r.length;o++){const s=r[o],{annotationUID:h,data:g}=s,{handles:u}=g,{points:m,activeHandleIndex:v}=u;c.annotationUID=h;const{color:p,lineWidth:f,lineDash:w}=this.getAnnotationStyle({annotation:s,styleSpecifier:c}),E=m.map((e=>a.worldToCanvas(e))),I=(0,tt.getCanvasEllipseCorners)(E),{centerPointRadius:C}=this.configuration;if(g.cachedStats[l]&&null!=g.cachedStats[l].areaUnit){if(s.invalidated&&(this._throttledCalculateCachedStats(s,a,d,e),a instanceof i.VolumeViewport)){const{referencedImageId:e}=s.metadata;for(const t in g.cachedStats)if(t.startsWith("imageId")){d.getStackViewports().find((t=>{const n=i.utilities.imageIdToURI(e),o=t.hasImageURI(n),a=i.utilities.imageIdToURI(t.getCurrentImageId());return o&&a!==n}))&&delete g.cachedStats[t]}}}else g.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(s,a,d);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let _;if(!(0,se.isAnnotationVisible)(h))continue;if((0,Z.isAnnotationLocked)(h)||this.editData||null===v||(_=[E[v]]),_){const e="0";(0,S.drawHandles)(t,h,e,_,{color:p})}const T=`${h}-ellipse`,b="0";if((0,S.drawEllipseByCoordinates)(t,h,b,E,{color:p,lineDash:w,lineWidth:f},T),C>0){if(Math.min(Math.abs(I[0][0]-I[1][0])/2,Math.abs(I[0][1]-I[1][1])/2)>3*C){const e=this._getCanvasEllipseCenter(E);(0,S.drawCircle)(t,h,`${b}-center`,e,C,{color:p,lineDash:w,lineWidth:f})}}n=!0;const y=this.getLinkedTextBoxStyle(c,s);if(!y.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const A=this.configuration.getTextLines(g,l);if(!A||0===A.length)continue;let D;g.handles.textBox.hasMoved||(D=(0,We.getTextBoxCoordsCanvas)(I),g.handles.textBox.worldPosition=a.canvasToWorld(D));const x=a.worldToCanvas(g.handles.textBox.worldPosition),M="1",O=(0,S.drawLinkedTextBox)(t,h,M,A,x,E,{},y),{x:R,y:L,width:P,height:N}=O;g.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([R,L]),topRight:a.canvasToWorld([R+P,L]),bottomLeft:a.canvasToWorld([R,L+N]),bottomRight:a.canvasToWorld([R+P,L+N])}}return n},this._calculateCachedStats=(e,t,n)=>{const i=e.data,{element:o}=t,{points:a}=i.handles,s=a.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:r,viewUp:l}=t.getCamera(),[d,c]=(0,tt.getCanvasEllipseCorners)(s),h=t.canvasToWorld(d),g=t.canvasToWorld(c),{cachedStats:u}=i,m=Object.keys(u),v=h,p=g;for(let n=0;n<m.length;n++){const i=m[n],o=this.getTargetImageData(i);if(!o)continue;const{dimensions:a,imageData:s,metadata:d,voxelManager:c}=o,f=it(s,v);f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]);const w=it(s,p);w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this.isHandleOutsideImage=!this._isInsideVolume(f,w,a);const E=[[Math.min(f[0],w[0]),Math.max(f[0],w[0])],[Math.min(f[1],w[1]),Math.max(f[1],w[1])],[Math.min(f[2],w[2]),Math.max(f[2],w[2])]],I={center:[(h[0]+g[0])/2,(h[1]+g[1])/2,(h[2]+g[2])/2],xRadius:Math.abs(h[0]-g[0])/2,yRadius:Math.abs(h[1]-g[1])/2,zRadius:Math.abs(h[2]-g[2])/2},{worldWidth:C,worldHeight:_}=(0,et.A)(r,l,v,p),T=0===C&&0===_,b=[f,w],{scale:S,areaUnit:y}=(0,Ue.Op)(o,b),A=Math.abs(Math.PI*(C/2)*(_/2))/S/S,D={isPreScaled:(0,je.u)(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},x=(0,qe.j)(d.Modality,e.metadata.referencedImageId,D),M=c.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:E,imageData:s,isInObject:e=>(0,tt.pointInEllipse)(I,e,{fast:!0}),returnPoints:this.configuration.storePointData}),O=this.configuration.statsCalculator.getStatistics();u[i]={Modality:d.Modality,area:A,mean:O.mean?.value,max:O.max?.value,stdDev:O.stdDev?.value,statsArray:O.array,pointsInShape:M,isEmptyArea:T,areaUnit:y,modalityUnit:x}}return e.invalidated=!1,(0,L.XF)(e,o),u},this._isInsideVolume=(e,t,n)=>i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,i=e.height/2;if(n<=0||i<=0)return!1;const o=[e.left+n,e.top+i],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(i*i)<=1}_getCanvasEllipseCenter(e){const[t,n,i,o]=e,a=[i[0],n[1]],s=[o[0],t[1]];return[(a[0]+s[0])/2,(a[1]+s[1])/2]}}function at(e,t){const n=e.cachedStats[t],{area:o,mean:a,stdDev:s,max:r,isEmptyArea:l,areaUnit:d,modalityUnit:c}=n,h=[];if(o){const e=l?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(o)} ${d}`;h.push(e)}return a&&h.push(`Mean: ${i.utilities.roundNumber(a)} ${c}`),r&&h.push(`Max: ${i.utilities.roundNumber(r)} ${c}`),s&&h.push(`Std Dev: ${i.utilities.roundNumber(s)} ${c}`),h}ot.toolName="EllipticalROI";const{transformWorldToIndex:st}=i.utilities;class rt extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,getTextLines:lt,statsCalculator:nt.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...l.getViewReference({points:[s]})},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...s],[...s]],activeHandleIndex:null},cachedStats:{}}};(0,o.addAnnotation)(v,a);const p=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,N.hideElementCursor)(a),e.preventDefault(),(0,k.A)(p),v},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=l.map((e=>s.worldToCanvas(e))),c=(0,re.r)(d),h=(0,re.r)([d[0],n]);return Math.abs(h-c)<o/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,N.hideElementCursor)(o),this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex((e=>e===n))}const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,N.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;a.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const{renderingEngine:c}=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h}=this.editData,{data:g}=c;g.handles.points=[g.handles.points[0],d(a)],c.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=o.viewport,{annotation:r,handleIndex:l}=this.editData,{data:d}=r,{points:c}=d.handles,h=c.map((e=>s(e))),{currentPoints:g}=t,u=g.canvas;if(0===l){const e=u[0]-h[0][0],t=u[1]-h[0][1],n=u,i=[h[1][0]+e,h[1][1]+t];c[0]=a(n),c[1]=a(i)}else c[1]=a(u)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:a}=e,{element:s}=a;let r=(0,o.getAnnotations)(this.getToolName(),s);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(s,r),!r?.length)return n;const l=this.getTargetId(a),d=a.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<r.length;o++){const s=r[o],{annotationUID:h,data:g}=s,{handles:u}=g,{points:m,activeHandleIndex:v}=u;c.annotationUID=h;const{color:p,lineWidth:f,lineDash:w}=this.getAnnotationStyle({annotation:s,styleSpecifier:c}),E=m.map((e=>a.worldToCanvas(e))),I=E[0],C=(0,re.r)(E),_=(0,re.H)(E),{centerPointRadius:T}=this.configuration;if(g.cachedStats[l]&&null!=g.cachedStats[l].areaUnit){if(s.invalidated&&(this._throttledCalculateCachedStats(s,a,d,e),a instanceof i.VolumeViewport)){const{referencedImageId:e}=s.metadata;for(const t in g.cachedStats)if(t.startsWith("imageId")){d.getStackViewports().find((t=>{const n=i.utilities.imageIdToURI(e),o=t.hasImageURI(n),a=i.utilities.imageIdToURI(t.getCurrentImageId());return o&&a!==n}))&&delete g.cachedStats[t]}}}else g.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(s,a,d,e);if(!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!(0,se.isAnnotationVisible)(h))continue;if((0,Z.isAnnotationLocked)(h)||this.editData||null===v||(b=[E[v]]),b){const e="0";(0,S.drawHandles)(t,h,e,b,{color:p})}const y=`${h}-circle`,A="0";(0,S.drawCircle)(t,h,A,I,C,{color:p,lineDash:w,lineWidth:f},y),T>0&&C>3*T&&(0,S.drawCircle)(t,h,`${A}-center`,I,T,{color:p,lineDash:w,lineWidth:f}),n=!0;const D=this.getLinkedTextBoxStyle(c,s);if(!D.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(g,l);if(!x||0===x.length)continue;let M;g.handles.textBox.hasMoved||(M=(0,We.getTextBoxCoordsCanvas)(_),g.handles.textBox.worldPosition=a.canvasToWorld(M));const O=a.worldToCanvas(g.handles.textBox.worldPosition),R="1",L=(0,S.drawLinkedTextBox)(t,h,R,x,O,E,{},D),{x:P,y:N,width:k,height:U}=L;g.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([P,N]),topRight:a.canvasToWorld([P+k,N]),bottomLeft:a.canvasToWorld([P,N+U]),bottomRight:a.canvasToWorld([P+k,N+U])}}return n},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{element:a}=t,{points:s}=o.handles,r=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:l,viewUp:d}=t.getCamera(),[c,h]=(0,re.H)(r),g=t.canvasToWorld(c),u=t.canvasToWorld(h),{cachedStats:m}=o,v=Object.keys(m),p=g,f=u;for(let n=0;n<v.length;n++){const i=v[n],o=this.getTargetImageData(i);if(!o)continue;const{dimensions:a,imageData:s,metadata:r,voxelManager:c}=o,h=st(s,p);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);const w=st(s,f);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(h,w,a)){const n=[[Math.min(h[0],w[0]),Math.max(h[0],w[0])],[Math.min(h[1],w[1]),Math.max(h[1],w[1])],[Math.min(h[2],w[2]),Math.max(h[2],w[2])]],a={center:[(g[0]+u[0])/2,(g[1]+u[1])/2,(g[2]+u[2])/2],xRadius:Math.abs(g[0]-u[0])/2,yRadius:Math.abs(g[1]-u[1])/2,zRadius:Math.abs(g[2]-u[2])/2},{worldWidth:v,worldHeight:E}=(0,et.A)(l,d,p,f),I=0===v&&0===E,C=[h,w],{scale:_,unit:T,areaUnit:b}=(0,Ue.Op)(o,C),S=(0,Ue.CQ)(o),y=Math.abs(Math.PI*(v/_/2)*(E/S/_/2)),A={isPreScaled:(0,je.u)(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},D=(0,qe.j)(r.Modality,e.metadata.referencedImageId,A),x=c.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,tt.pointInEllipse)(a,e,{fast:!0}),boundsIJK:n,imageData:s,returnPoints:this.configuration.storePointData}),M=this.configuration.statsCalculator.getStatistics();m[i]={Modality:r.Modality,area:y,mean:M.mean?.value,max:M.max?.value,stdDev:M.stdDev?.value,statsArray:M.array,pointsInShape:x,isEmptyArea:I,areaUnit:b,radius:v/2/_,radiusUnit:T,perimeter:2*Math.PI*(v/2)/_,modalityUnit:D}}else this.isHandleOutsideImage=!0,m[i]={Modality:r.Modality}}return e.invalidated=!1,(0,L.XF)(e,a),m},this._isInsideVolume=(e,t,n)=>i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}}function lt(e,t){const n=e.cachedStats[t],{radius:o,radiusUnit:a,area:s,mean:r,stdDev:l,max:d,isEmptyArea:c,areaUnit:h,modalityUnit:g}=n,u=[];if(o){const e=c?"Radius: Oblique not supported":`Radius: ${i.utilities.roundNumber(o)} ${a}`;u.push(e)}if(s){const e=c?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(s)} ${h}`;u.push(e)}return r&&u.push(`Mean: ${i.utilities.roundNumber(r)} ${g}`),d&&u.push(`Max: ${i.utilities.roundNumber(d)} ${g}`),l&&u.push(`Std Dev: ${i.utilities.roundNumber(l)} ${g}`),u}rt.toolName="CircleROI";const dt=rt;class ct extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,degrees:[45,135,225,315],diameters:[10,30,60]}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...l.getViewReference({points:[s]})},data:{label:"",handles:{points:[[...s]]}}};(0,o.addAnnotation)(v,a);const p=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,newAnnotation:!0},this._activateDraw(a),(0,N.hideElementCursor)(a),e.preventDefault(),(0,k.A)(p),v},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=(0,re.r)([d,n]);return Math.abs(c)<o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},(0,N.hideElementCursor)(o),this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(o),(0,N.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;a.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const{renderingEngine:c}=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h}=this.editData,{data:g}=c;g.handles.points=[d(a),d(a)],c.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a}=this.editData,{data:s}=o,{deltaPoints:r}=t,l=r.world;s.handles.points.forEach((e=>{e[0]+=l[0],e[1]+=l[1],e[2]+=l[2]})),o.invalidated=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=o.viewport,{annotation:r}=this.editData,{data:l}=r,{points:d}=l.handles,c=d.map((e=>s(e))),{currentPoints:h}=t,g=h.canvas,u=g[0]-c[0][0],m=g[1]-c[0][1],v=g,p=[c[1][0]+u,c[1][1]+m];d[0]=a(v),d[1]=a(p)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,i.getEnabledElement)(e);return(0,k.A)(n),o&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const o=s[e],{annotationUID:a,data:l}=o,{handles:d}=l,{points:c}=d;r.annotationUID=a;const{color:h,lineWidth:g,lineDash:u}=this.getAnnotationStyle({annotation:o,styleSpecifier:r}),m=c.map((e=>i.worldToCanvas(e)))[0];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,se.isAnnotationVisible)(a))continue;let v=`${a}-crosshair-vertical`,p=[m[0],m[1]+5],f=[m[0],m[1]-5];(0,S.drawLine)(t,a,v,p,f,{color:h,lineDash:u,lineWidth:g}),v=`${a}-crosshair-horizontal`,p=[m[0]+5,m[1]],f=[m[0]-5,m[1]],(0,S.drawLine)(t,a,v,p,f,{color:h,lineDash:u,lineWidth:g});const w=this.configuration.diameters.map((e=>this.worldMeasureToCanvas(e,i)));for(let e=0;e<w.length;e++){const n=`${a}-circle-${e}`,i=`${a}-circle-${e}`;(0,S.drawCircle)(t,a,i,m,w[e]/2,{color:h,lineDash:u,lineWidth:g},n)}const E=e=>e*Math.PI/180,I=this.configuration.degrees.map((e=>E(e)));for(let e=0;e<I.length;e++){const n=`${a}-line-${e}`,i=[Math.cos(I[e])*w[0]/2+m[0],Math.sin(I[e])*w[0]/2+m[1]],o=[Math.cos(I[e])*w[2]/2+m[0],Math.sin(I[e])*w[2]/2+m[1]];(0,S.drawLine)(t,a,n,i,o,{color:h,lineDash:u,lineWidth:g})}n=!0}return n}}worldMeasureToCanvas(e,t){const n=t.canvasToWorld([t.canvas.width/2,t.canvas.height/2]),{viewUp:i}=t.getCamera(),o=C.eR.scaleAndAdd(C.eR.create(),n,i,e),a=t.worldToCanvas(n),s=t.worldToCanvas(o);return Math.sqrt(Math.pow(s[0]-a[0],2)+Math.pow(s[1]-a[1],2))}}ct.toolName="ETDRSGrid";var ht=n(76910),gt=n(93126),ut=n(71543),mt=n(63802),vt=n(31147),pt=n(34115),ft=n(36320);const wt={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var Et,It;!function(e){e.Cardinal="CARDINAL",e.Linear="LINEAR",e.CatmullRom="CATMULLROM",e.BSpline="BSPLINE"}(Et||(Et={})),function(e){e.AddControlPoint="addControlPoint",e.DeleteControlPoint="deleteControlPoint"}(It||(It={}));class Ct extends ft.A{static{this.SplineTypes=Et}static{this.Actions=It}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:_t,contourHoleAdditionModifierKey:a.KeyboardBindings.Shift,decimate:{enabled:!1,epsilon:.1},spline:{configuration:{[Et.Cardinal]:{Class:ut.A,scale:.5},[Et.CatmullRom]:{Class:vt.e},[Et.Linear]:{Class:mt.F},[Et.BSpline]:{Class:pt.k,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:Et.CatmullRom,drawPreviewEnabled:!0,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[It.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:a.MouseBindings.Primary,modifierKey:a.KeyboardBindings.Shift}]},[It.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:a.MouseBindings.Primary,modifierKey:a.KeyboardBindings.Ctrl}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.fireChangeOnUpdate=null,this.isPointNearTool=(e,t,n,i)=>{const{instance:o}=t.data.spline;return o.isPointNearCurve(n,i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1};const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;this._activateModify(o),(0,y.triggerAnnotationRenderForViewportIds)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex((e=>e===n))}const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,y.triggerAnnotationRenderForViewportIds)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:s,viewportIdsToRender:r,newAnnotation:l,contourHoleProcessingEnabled:d}=this.editData,{data:c}=s;s.autoGenerated=!1,c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const h=(0,i.getEnabledElement)(n),g=this.getTargetImageData(this.getTargetId(h.viewport)),{imageData:u,dimensions:m}=g;this.isHandleOutsideImage=c.handles.points.map((e=>i.utilities.transformWorldToIndex(u,e))).some((e=>!i.utilities.indexWithinDimensions(e,m))),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(s.annotationUID);const v=l?a.ChangeTypes.Completed:a.ChangeTypes.HandlesUpdated;this.fireChangeOnUpdate?(this.fireChangeOnUpdate.annotationUID=s.annotationUID,this.fireChangeOnUpdate.changeType=v):this.fireChangeOnUpdate={annotationUID:s.annotationUID,changeType:v,contourHoleProcessingEnabled:d},(0,y.triggerAnnotationRenderForViewportIds)(r),this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const t=e.detail,{element:n}=t,i=t.key??"",{lastControlPointDeletionKeys:o}=this.configuration.spline;if(!o.includes(i))return;const{annotation:a}=this.editData,{data:s}=a;if(3!==s.handles.points.length){{const e=s.handles.points.length-1;this._deleteControlPointByIndex(n,a,e)}e.preventDefault()}else this.cancel(n)},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:t}=this.configuration.spline;if(!t)return;const{element:n}=e.detail,{renderingEngine:o}=(0,i.getEnabledElement)(n),a=(0,P.getViewportIdsWithToolToRender)(n,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,(0,y.triggerAnnotationRenderForViewportIds)(a),e.preventDefault()},this._mouseDownCallback=e=>{const t=e.type===a.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:o}=this.editData,{data:s}=n;if(s.contour.closed)return;const r=e.detail,{element:l}=r,{currentPoints:d}=r,{canvas:c,world:h}=d,g=(0,i.getEnabledElement)(l),{renderingEngine:u}=g;let m=s.handles.points.length>=2&&t,v=!0;if(s.handles.points.length>=3){const{instance:e}=s.spline,t=e.getClosestControlPointWithinDistance(c,10);0===t?.index&&(v=!1,m=!0)}v&&s.handles.points.push(h),s.contour.closed=s.contour.closed||m,n.invalidated=!0,(0,y.triggerAnnotationRenderForViewportIds)(o),s.contour.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;this.moveAnnotation(o,n)}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,y.triggerAnnotationRenderForViewportIds)(a)},this.triggerAnnotationCompleted=(e,t)=>{const n=a.Events.ANNOTATION_COMPLETED,o={annotation:e,changeType:a.ChangeTypes.Completed,contourHoleProcessingEnabled:t};(0,i.triggerEvent)(i.eventTarget,n,o)},this.triggerAnnotationModified=(e,t,n=a.ChangeTypes.StatsUpdated)=>{const{viewportId:o,renderingEngineId:s}=t,r=a.Events.ANNOTATION_MODIFIED,l={annotation:e,viewportId:o,renderingEngineId:s,changeType:n};(0,i.triggerEvent)(i.eventTarget,r,l)},this.triggerChangeEvent=(e,t,n=a.ChangeTypes.StatsUpdated,i)=>{n===a.ChangeTypes.Completed?this.triggerAnnotationCompleted(e,i):this.triggerAnnotationModified(e,t,n)},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.KEY_DOWN,this._keyDownCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(a.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(a.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(a.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.KEY_DOWN,this._keyDownCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(a.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(a.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._mouseDownCallback)},this._renderStats=(e,t,n,i)=>{const o=e.data,a=this.getTargetId(t);if(!o.spline.instance.closed||!i.visibility)return;const s=this.configuration.getTextLines(o,a);if(!s||0===s.length)return;const r=o.handles.points.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=(0,We.getTextBoxCoordsCanvas)(r);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const l=t.worldToCanvas(o.handles.textBox.worldPosition),d=(0,S.drawLinkedTextBox)(n,e.annotationUID??"","textBox",s,l,r,{},i),{x:c,y:h,width:g,height:u}=d;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([c,h]),topRight:t.canvasToWorld([c+g,h]),bottomLeft:t.canvasToWorld([c,h+u]),bottomRight:t.canvasToWorld([c+g,h+u])}},this.addControlPointCallback=(e,t)=>{const{data:n}=t,o=n.spline.type,a=this._getSplineConfig(o),s=a.controlPointAdditionDistance;if(!1===a.controlPointAdditionEnabled)return;const r=e.detail,{element:l}=r,d=(0,i.getEnabledElement)(l),{renderingEngine:c,viewport:h}=d,{canvasToWorld:g}=h,{instance:u}=n.spline,m=e.detail.currentPoints.canvas,v=u.getClosestPoint(m);if(v.distance>s)return;const{index:p,point:f}=u.addControlPointAtU(v.uValue);n.handles.points.splice(p,0,g(f)),t.invalidated=!0;const w=(0,P.getViewportIdsWithToolToRender)(l,this.getToolName());(0,y.triggerAnnotationRenderForViewportIds)(w)},this.deleteControlPointCallback=(e,t)=>{const n=t.data.spline.type,i=this._getSplineConfig(n),o=i.controlPointDeletionDistance;if(!1===i.controlPointDeletionEnabled)return;const a=e.detail,{element:s,currentPoints:r}=a,{canvas:l}=r,{instance:d}=t.data.spline,c=d.getClosestControlPointWithinDistance(l,o);c&&this._deleteControlPointByIndex(s,t,c.index)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const o=(0,i.getEnabledElement)(t),{viewport:s}=o,{cachedStats:r}=n,{polyline:l}=n.contour,d=Object.keys(r);for(let e=0;e<d.length;e++){const t=d[e],n=this.getTargetImageData(t);if(!n)continue;const{metadata:o}=n,a=l.map((e=>s.worldToCanvas(e))),c=a[0],h=s.canvasToWorld(c),g=s.canvasToWorld([c[0]+1,c[1]]),u=s.canvasToWorld([c[0],c[1]+1]),m=C.eR.distance(h,g),v=C.eR.distance(h,u),{imageData:p}=n,{scale:f,areaUnit:w}=(0,Ue.Op)(n,(()=>{const{maxX:e,maxY:t,minX:n,minY:o}=xe.polyline.getAABB(a),r=s.canvasToWorld([n,o]),l=i.utilities.transformWorldToIndex(p,r),d=s.canvasToWorld([e,t]);return[l,i.utilities.transformWorldToIndex(p,d)]}));let E=xe.polyline.getArea(a)/f/f;E*=m*v,r[t]={Modality:o.Modality,area:E,areaUnit:w}}return this.triggerAnnotationModified(e,o,a.ChangeTypes.StatsUpdated),r},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:o}=t,{canvas:a}=n,s=(0,ht.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey,r=(0,i.getEnabledElement)(o),{renderingEngine:l}=r,d=this.createAnnotation(e);this.isDrawing=!0,this.addAnnotation(d,o);const c=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:c,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,contourHoleProcessingEnabled:s},this._activateDraw(o),e.preventDefault(),(0,y.triggerAnnotationRenderForViewportIds)(c),d}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:a}=this.editData;a&&(0,o.removeAnnotation)(t.annotationUID),super.cancelAnnotation(t);const s=(0,i.getEnabledElement)(e),{renderingEngine:r}=s;return(0,y.triggerAnnotationRenderForViewportIds)(n),this.editData=null,t.annotationUID}isContourSegmentationTool(){return!1}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:i,annotationStyle:a}=e,{viewport:s}=t,{worldToCanvas:r}=s,{element:l}=s,d=e.annotation,{annotationUID:c,data:h,highlighted:g}=d,{handles:u}=h,{points:m,activeHandleIndex:v}=u,p=this.editData?.newAnnotation,{lineWidth:f,lineDash:w,color:E,locked:I}=a,C=m.map((e=>r(e))),{drawPreviewEnabled:_}=this.configuration.spline,T=d.data.spline.type,b=this._getSplineConfig(T),y=d.data.spline.instance,A=(0,o.getChildAnnotations)(d);if(-1!==A.findIndex((e=>!e)))throw new Error(`Can't find annotation for child ${d.childAnnotationUIDs.join()}`);let D;if([d,...A].filter((e=>this._isSplineROIAnnotation(e))).forEach((e=>{const t=this._updateSplineInstance(l,e).getPolylinePoints();this.updateContourPolyline(e,{points:t,closed:h.contour.closed,targetWindingDirection:gt.W.Clockwise},s,{updateWindingDirection:h.contour.closed})})),super.renderAnnotationInstance(e),h.cachedStats[n]&&null!=h.cachedStats[n].areaUnit?d.invalidated&&this._throttledCalculateCachedStats(d,l):(h.cachedStats[n]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(d,l)),I||this.editData||null===v||(D=[C[v]]),D||p||g){const e="0";(0,S.drawHandles)(i,c,e,C,{color:E,lineWidth:f,handleRadius:"3"})}if(_&&y.numControlPoints>1&&this.editData?.lastCanvasPoint&&!y.closed){const{lastCanvasPoint:e}=this.editData,t=y.getPreviewPolylinePoints(e,10);(0,S.drawPolyline)(i,c,"previewSplineChange",t,{color:"#9EA0CA",lineDash:w,lineWidth:1})}if(b.showControlPointsConnectors){const e=[...C];y.closed&&e.push(C[0]),(0,S.drawPolyline)(i,c,"controlPointsConnectors",e,{color:"rgba(255, 255, 255, 0.5)",lineWidth:1})}return this._renderStats(d,s,i,a.textbox),this.fireChangeOnUpdate?.annotationUID===c&&(this.triggerChangeEvent(d,t,this.fireChangeOnUpdate.changeType,this.fireChangeOnUpdate.contourHoleProcessingEnabled),this.fireChangeOnUpdate=null),d.invalidated=!1,!0}createInterpolatedSplineControl(e){if(e.data.handles.points?.length)return;const{polyline:t}=e.data.contour;if(!t||!t.length)return;e.data.handles.points=[];const{points:n}=e.data.handles,i=Math.max(10,Math.floor(t.length/20));for(let e=0;e<t.length-i;e+=i)n.push(t[e]);n.push(t[t.length-1])}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints,{type:o}=this.configuration.spline,a=this._getSplineConfig(o),s=new a.Class,r=()=>({type:a.type,instance:s,resolution:a.resolution});let l;return this.configuration.interpolation?.enabled&&(l=e=>{e.data.spline||=r(),this.createInterpolatedSplineControl(e)}),i.utilities.deepMerge(t,{data:{handles:{points:[[...n]]},spline:r(),cachedStats:{}},onInterpolationComplete:l})}_deleteControlPointByIndex(e,t,n){const a=(0,i.getEnabledElement)(e),{points:s}=t.data.handles;3===s.length?(0,o.removeAnnotation)(t.annotationUID):s.splice(n,1);const{renderingEngine:r}=a,l=(0,P.getViewportIdsWithToolToRender)(e,this.getToolName());t.invalidated=!0,(0,y.triggerAnnotationRenderForViewportIds)(l)}_isSplineROIAnnotation(e){return!!e.data?.spline}_getSplineConfig(e){const{configuration:t}=this,n=t.spline.configuration;return Object.assign({type:e},wt,n[e])}_updateSplineInstance(e,t){const n=(0,i.getEnabledElement)(e),{viewport:o}=n,{worldToCanvas:a}=o,{data:s}=t,{type:r,instance:l}=t.data.spline,d=this._getSplineConfig(r),c=s.handles.points.map(a),h=void 0!==d.resolution?parseInt(d.resolution):void 0,g=void 0!==d.scale?parseFloat(d.scale):void 0;return l.setControlPoints(c),l.closed=!!s.contour.closed,l.fixedResolution||void 0===h||l.resolution===h||(l.resolution=h,t.invalidated=!0),l instanceof ut.A&&!l.fixedScale&&void 0!==g&&l.scale!==g&&(l.scale=g,t.invalidated=!0),l}}function _t(e,t){const n=e.cachedStats[t],{area:o,isEmptyArea:a,areaUnit:s}=n,r=[];if(o){const e=a?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(o)} ${s}`;r.push(e)}return r}Ct.toolName="SplineROI";const Tt=Ct;class bt extends Tt{constructor(e){super(i.utilities.deepMerge({configuration:{calculateStats:!1}},e))}isContourSegmentationTool(){return!0}}bt.toolName="SplineContourSegmentationTool";n(28220),n(37590);var St=n(98013),yt=n(78044),At=n(38776);class Dt extends ft.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextLines:Mt,calculateStats:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:a.KeyboardBindings.Shift,snapHandleNearby:2,interpolation:{enabled:!1,nearestEdge:2,showInterpolationPolyline:!1},decimate:{enabled:!1,epsilon:.1},actions:{undo:{method:"undo",bindings:[{key:"Escape"}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,r=o*o,l=t.data.contour.polyline.map((e=>s.worldToCanvas(e)));let d=l[l.length-1];for(let e=0;e<l.length;e++){const t=l[e];if(xe.lineSegment.distanceToPointSquared(d,t,n)<=r)return!0;d=t}return!1},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1};const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;this._activateModify(o),(0,k.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex((e=>e===n))}const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(d),e.preventDefault()},this._endCallback=(e,t=!1)=>{const n=e.detail,{element:s}=n,{annotation:r,viewportIdsToRender:l,newAnnotation:d,contourHoleProcessingEnabled:c}=this.editData,{data:h}=r;h.handles.activeHandleIndex=null,this._deactivateModify(s),this._deactivateDraw(s),(0,N.resetElementCursor)(s);const g=(0,i.getEnabledElement)(s);if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage||t)return(0,o.removeAnnotation)(r.annotationUID),this.clearEditData(),void(0,k.A)(l);(0,k.A)(l);const u=d?a.ChangeTypes.Completed:a.ChangeTypes.HandlesUpdated;this.triggerChangeEvent(r,g,u,c),this.clearEditData()},this.triggerChangeEvent=(e,t,n=a.ChangeTypes.StatsUpdated,i=!1)=>{n===a.ChangeTypes.Completed?(0,L.PS)(e,i):(0,L.XF)(e,t.viewport.element,n)},this._mouseDownCallback=e=>{const t=e.type===a.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:o,worldToSlice:s,sliceToWorld:r}=this.editData;if(this.editData.closed)return;const l=e.detail,{element:d}=l,{currentPoints:c}=l,{canvas:h,world:g}=c;let u=g;const m=(0,i.getEnabledElement)(d),{viewport:v,renderingEngine:p}=m,f=this.editData.currentPath.getControlPoints();let w=f.length>=2&&t;if(f.length>=2){const e={index:-1,distSquared:1/0};for(let t=0,n=f.length;t<n;t++){const n=r(f[t]),i=v.worldToCanvas(n),o=xe.point.distanceToPointSquared(h,i);o<=100&&o<e.distSquared&&(e.distSquared=o,e.index=t)}0===e.index&&(w=!0)}const{snapHandleNearby:E}=this.configuration;if(E&&!this.editData.closed){const e=new At.j,t=this.scissors.findMinNearby(s(g),1),n=this.scissors.findPathToPoint(t);e.addPoints(n),e.prependPath(this.editData.confirmedPath),u=r(t),this.editData.currentPath=e}this.editData.closed=this.editData.closed||w,this.editData.confirmedPath=this.editData.currentPath;const I=this.editData.currentPath.getLastPoint();this.editData.confirmedPath.addControlPoint(I),n.data.handles.points.push(r(I)),this.scissors.startSearch(s(u)),n.invalidated=!0,(0,k.A)(o),this.editData.closed&&(this.updateAnnotation(this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:t,currentPoints:n}=e.detail,{world:o,canvas:a}=n,{renderingEngine:s}=(0,i.getEnabledElement)(t),r=(0,P.getViewportIdsWithToolToRender)(t,this.getToolName());this.editData.lastCanvasPoint=a;const{width:l,height:d}=this.scissors,{worldToSlice:c}=this.editData,h=c(o);if(h[0]<0||h[1]<0||h[0]>=l||h[1]>=d)return;const g=this.scissors.findPathToPoint(h),u=new At.j;u.addPoints(g),u.prependPath(this.editData.confirmedPath),this.editData.currentPath=u,(0,k.A)(r),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s)console.warn("Drag annotation not implemented");else{const{currentPoints:e}=t,i=e.world;this.editHandle(i,n,o,s)}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:a}=this.editData;a&&(0,o.removeAnnotation)(t.annotationUID);const s=(0,i.getEnabledElement)(e),{renderingEngine:r}=s;return(0,k.A)(n),this.editData=null,this.scissors=null,t.annotationUID},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(a.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(a.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(a.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(a.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(a.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._mouseDownCallback)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const o=(0,i.getEnabledElement)(t),{viewport:s,renderingEngine:r}=o,{cachedStats:l}=n,{polyline:d}=n.contour,c=Object.keys(l);for(let e=0;e<c.length;e++){const t=c[e],n=this.getTargetImageData(t);if(!n)continue;const{metadata:o}=n,a=d.map((e=>s.worldToCanvas(e))),r=a[0],h=s.canvasToWorld(r),g=s.canvasToWorld([r[0]+1,r[1]]),u=s.canvasToWorld([r[0],r[1]+1]),m=C.eR.distance(h,g),v=C.eR.distance(h,u),{imageData:p}=n,{scale:f,areaUnit:w}=(0,y.getCalibratedLengthUnitsAndScale)(n,(()=>{const{maxX:e,maxY:t,minX:n,minY:o}=xe.polyline.getAABB(a),r=s.canvasToWorld([n,o]),l=i.utilities.transformWorldToIndex(p,r),d=s.canvasToWorld([e,t]);return[l,i.utilities.transformWorldToIndex(p,d)]}));let E=xe.polyline.getArea(a)/f/f;E*=m*v,l[t]={Modality:o.Modality,area:E,areaUnit:w}}return this.triggerAnnotationModified(e,o,a.ChangeTypes.StatsUpdated),l},this._renderStats=(e,t,n,i)=>{const o=e.data,a=this.getTargetId(t);if(!o.contour.closed||!i.visibility)return;const s=this.configuration.getTextLines(o,a);if(!s||0===s.length)return;const r=o.handles.points.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=(0,We.getTextBoxCoordsCanvas)(r);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const l=t.worldToCanvas(o.handles.textBox.worldPosition),d=(0,S.drawLinkedTextBox)(n,e.annotationUID??"","textBox",s,l,r,{},i),{x:c,y:h,width:g,height:u}=d;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([c,h]),topRight:t.canvasToWorld([c+g,h]),bottomLeft:t.canvasToWorld([c,h+u]),bottomRight:t.canvasToWorld([c+g,h+u])}},this.triggerAnnotationModified=(e,t,n=a.ChangeTypes.StatsUpdated)=>{const{viewportId:o,renderingEngineId:s}=t,r=a.Events.ANNOTATION_MODIFIED,l={annotation:e,viewportId:o,renderingEngineId:s,changeType:n};(0,i.triggerEvent)(i.eventTarget,r,l)},this._throttledCalculateCachedStats=(0,y.throttle)(this._calculateCachedStats,100,{trailing:!0})}setupBaseEditData(e,t,n,o,a){const s=(0,i.getEnabledElement)(t),{viewport:r}=s;this.isDrawing=!0;const l=r.getImageData(),{imageData:d}=l;let c,h,g,u,m;if(r instanceof i.VolumeViewport){if(!(r instanceof i.VolumeViewport))throw new Error("Viewport not supported");{const e=i.utilities.getCurrentVolumeViewportSlice(r),{sliceToIndexMatrix:t,indexToSliceMatrix:n}=e;c=e=>{const t=i.utilities.transformWorldToIndex(d,e),o=C.eR.transformMat4([0,0,0],t,n);return[o[0],o[1]]},h=e=>{const n=C.eR.transformMat4([0,0,0],[e[0],e[1],0],t);return i.utilities.transformIndexToWorld(d,n)},m=e.scalarData,g=e.width,u=e.height}}else g=l.dimensions[0],u=l.dimensions[1],c=e=>{const t=i.utilities.transformWorldToIndex(d,e);return[t[0],t[1]]},h=e=>i.utilities.transformIndexToWorld(d,[e[0],e[1],0]),m=l.scalarData;m=i.utilities.convertToGrayscale(m,g,u);const{voiRange:v}=r.getProperties(),p=c(e);this.scissors=yt.f.createInstanceFromRawPixelData(m,g,u,v),o&&(this.scissorsNext=yt.f.createInstanceFromRawPixelData(m,g,u,v),this.scissorsNext.startSearch(c(o))),this.scissors.startSearch(p);const f=!o,w=new At.j,E=new At.j,I=f?void 0:new At.j;w.addPoint(p),w.addControlPoint(p);const _=(0,P.getViewportIdsWithToolToRender)(t,this.getToolName()),T=r.worldToCanvas(e);this.editData={annotation:n,viewportIdsToRender:_,newAnnotation:f,hasMoved:!1,lastCanvasPoint:T,confirmedPath:w,currentPath:E,confirmedPathNext:I,closed:!1,handleIndex:this.editData?.handleIndex??n.handles?.activeHandleIndex,worldToSlice:c,sliceToWorld:h,contourHoleProcessingEnabled:a}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{world:o}=n,a=this.createAnnotation(e),s=(0,ht.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey;return this.setupBaseEditData(o,i,a,void 0,s),this.addAnnotation(a,i),this._activateDraw(i),e.preventDefault(),(0,k.A)(this.editData.viewportIdsToRender),a}clearEditData(){this.editData=null,this.scissors=null,this.scissorsNext=null,this.isDrawing=!1}editHandle(e,t,n,i){const{data:o}=n,{points:a}=o.handles,{length:s}=a,r=a[(i-1+s)%s],l=a[(i+1)%s];if(!this.editData?.confirmedPathNext){this.setupBaseEditData(r,t,n,l);const{polyline:e}=o.contour,a=new At.j,s=new At.j,{worldToSlice:d}=this.editData,c=(0,St.A)(n,i-1),h=(0,St.A)(n,i+1);if(-1===h||-1===c)throw new Error(`Can't find handle index ${-1===h&&l} ${-1===c&&r}`);0===i?s.addPoints(e.slice(h+1,c).map(d)):(a.addPoints(e.slice(0,c+1).map(d)),s.addPoints(e.slice(h,e.length).map(d))),this.editData.confirmedPath=a,this.editData.confirmedPathNext=s}const{editData:d,scissors:c}=this,{worldToSlice:h,sliceToWorld:g}=d,{activeHandleIndex:u}=o.handles;if(null==u)o.handles.activeHandleIndex=i;else if(u!==i)throw new Error(`Trying to edit a different handle than the one currently being edited ${i}!==${o.handles.activeHandleIndex}`);const m=h(e);if(m[0]<0||m[0]>=c.width||m[1]<0||m[1]>=c.height)return;a[i]=g(m);const v=c.findPathToPoint(m),p=this.scissorsNext.findPathToPoint(m),f=new At.j;f.prependPath(d.confirmedPath),0!==i&&f.addPoints(v),f.addPoints(p.reverse()),f.appendPath(d.confirmedPathNext),0===i&&f.addPoints(v),d.currentPath=f,n.invalidated=!0,d.hasMoved=!0,d.closed=!0}renderAnnotation(e,t){return this.updateAnnotation(this.editData?.currentPath),super.renderAnnotation(e,t)}isContourSegmentationTool(){return!1}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints;return i.utilities.deepMerge(t,{data:{handles:{points:[[...n]]}}})}undo(e,t,n){this.editData&&this._endCallback(n,!0)}renderAnnotationInstance(e){const{annotation:t,enabledElement:n,svgDrawingHelper:i,annotationStyle:o,targetId:a}=e,{viewport:s}=n,{element:r}=s,{worldToCanvas:l}=s,{annotationUID:d,data:c,highlighted:h}=t,{handles:g}=c,u=this.editData?.newAnnotation,{lineWidth:m,lineDash:v,color:p}=o;if(h||u&&t.annotationUID===this.editData?.annotation?.annotationUID){const e="0",t=g.points.map(l);(0,S.drawHandles)(i,d,e,t,{color:p,lineDash:v,lineWidth:m})}return super.renderAnnotationInstance(e),c.cachedStats[a]&&null!=c.cachedStats[a].areaUnit?t.invalidated&&this._throttledCalculateCachedStats(t,r):(c.cachedStats[a]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(t,r)),this._renderStats(t,s,i,o.textbox),!0}updateAnnotation(e){if(!this.editData||!e)return;const{annotation:t,sliceToWorld:n,worldToSlice:i,closed:o,newAnnotation:a}=this.editData;let{pointArray:s}=e;s.length>1&&(s=[...s,s[0]]);const r=a&&o?gt.W.Clockwise:void 0;this.updateContourPolyline(t,{points:s,closed:o,targetWindingDirection:r},{canvasToWorld:n,worldToCanvas:i})}}Dt.toolName="LivewireContour";const xt=Dt;function Mt(e,t){const n=e.cachedStats[t],{area:o,areaUnit:a}=n,s=[];if(o){const e=`Area: ${i.utilities.roundNumber(o)} ${a}`;s.push(e)}return s}class Ot extends xt{updateInterpolatedAnnotation(e,t){!this.editData&&e.invalidated&&e.data.handles.interpolationSources&&(e.data.contour.originalPolyline=e.data.contour.polyline,queueMicrotask((()=>{if(!e.data.handles.interpolationSources)return;const{points:n}=e.data.handles,{element:o}=t.viewport;this.setupBaseEditData(n[0],o,e);const{length:s}=n,{scissors:r}=this,{nearestEdge:l,repeatInterpolation:d}=this.configuration.interpolation;e.data.handles.originalPoints=n;const{worldToSlice:c,sliceToWorld:h}=this.editData,g=[];if(l){let e=c(n[n.length-1]);n.forEach(((t,o)=>{const a=c(t);e=a,g.push(a),r.startSearch(e),r.findPathToPoint(a),r.findPathToPoint(c(n[(o+3)%n.length]));const s=r.findMinNearby(a,l);i.utilities.isEqual(a,s)||(g[o]=s,e=s,n[o]=h(s))}))}const u=new At.j;for(let e=0;e<s;e++){r.startSearch(c(n[e]));const t=r.findPathToPoint(c(n[(e+1)%s]));u.addPoints(t)}this.updateAnnotation(u),this.scissors=null,this.scissorsNext=null,this.editData=null,e.data.handles.interpolationSources=null,d&&(0,L.XF)(e,t.viewport.element,a.ChangeTypes.InterpolationUpdated)})))}renderAnnotationInstance(e){const{enabledElement:t,svgDrawingHelper:n}=e,i=e.annotation,{annotationUID:o}=i,{viewport:a}=t,{worldToCanvas:s}=a,{showInterpolationPolyline:r}=this.configuration.interpolation||{};this.updateInterpolatedAnnotation?.(i,t);const{originalPolyline:l}=i.data.contour,d=super.renderAnnotationInstance(e);if(r&&l&&i.autoGenerated){const e=l.map(s);e.push(e[0]),(0,S.drawPolyline)(n,o,"interpolationContour-0",e,{color:"#70ffff",lineWidth:1,fillOpacity:0})}return d}isContourSegmentationTool(){return!0}}Ot.toolName="LivewireContourSegmentationTool";class Rt extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:Lt,changeTextCallback:Pt,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;(0,N.hideElementCursor)(a),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),{arrowFirst:m}=this.configuration,v=l.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:v,referencedImageId:u,...l.getViewReference({points:[s]})},data:{text:"",handles:{points:[[...s],[...s]],activeHandleIndex:null,arrowFirst:m,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};(0,o.addAnnotation)(p,a);const f=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),e.preventDefault(),(0,k.A)(f),p},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return j.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,N.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:l}=i;s&&!r||(l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(i.annotationUID),s?this.configuration.getTextCallback((e=>{if(!e)return(0,o.removeAnnotation)(i.annotationUID),(0,k.A)(a),this.editData=null,void(this.isDrawing=!1);i.data.text=e,(0,L.dZ)(i),(0,k.A)(a)})):(0,L.XF)(i,n),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,o.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const a=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!a)return;const s=a;this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,n,s)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const o=s[e],{annotationUID:a,data:l}=o,{handles:d,text:c}=l,{points:h,activeHandleIndex:g}=d;r.annotationUID=a;const{color:u,lineWidth:m,lineDash:v}=this.getAnnotationStyle({annotation:o,styleSpecifier:r}),p=h.map((e=>i.worldToCanvas(e)));let f;if((0,Z.isAnnotationLocked)(a)||this.editData||null===g||(f=[p[g]]),f){const e="0";(0,S.drawHandles)(t,a,e,p,{color:u,lineWidth:m})}const w="1";if(this.configuration.arrowFirst?(0,S.drawArrow)(t,a,w,p[1],p[0],{color:u,width:m,lineDash:v}):(0,S.drawArrow)(t,a,w,p[0],p[1],{color:u,width:m,lineDash:v}),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!c)continue;const E=this.getLinkedTextBoxStyle(r,o);if(!E.visibility){l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!l.handles.textBox.hasMoved){const e=p[1];l.handles.textBox.worldPosition=i.canvasToWorld(e)}const I=i.worldToCanvas(l.handles.textBox.worldPosition),C="1",_=(0,S.drawLinkedTextBox)(t,a,C,[c],I,p,{},E),{x:T,y:b,width:y,height:A}=_;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([T,b]),topRight:i.canvasToWorld([T+y,b]),bottomLeft:i.canvasToWorld([T,b+A]),bottomRight:i.canvasToWorld([T+y,b+A])}}return n}}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,N.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(d),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;(0,i.getEnabledElement)(e);const o=(0,P.getViewportIdsWithToolToRender)(e,this.getToolName());(0,k.A)(o),(0,L.XF)(t,e)}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function Lt(e){return e(prompt("Enter your annotation:"))}function Pt(e,t,n){return n(prompt("Enter your annotation:"))}Rt.toolName="ArrowAnnotate";class Nt extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:kt}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;(0,N.hideElementCursor)(a),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...l.getViewReference({points:[s]})},data:{handles:{points:[[...s],[...s]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,o.addAnnotation)(v,a);const p=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),e.preventDefault(),(0,k.A)(p),v},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d,c]=r.handles.points,h=s.worldToCanvas(l),g=s.worldToCanvas(d),u={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};if(j.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o)return!0;if(!c)return!1;const m=s.worldToCanvas(c),v={start:{x:g[0],y:g[1]},end:{x:m[0],y:m[1]}};return j.distanceToPoint([v.start.x,v.start.y],[v.end.x,v.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,N.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,k.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;if(this.angleStartedNotYetCompleted&&2===d.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const a=s[o],{annotationUID:c,data:h}=a,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:v,lineDash:p}=this.getAnnotationStyle({annotation:a,styleSpecifier:d}),f=g.map((e=>i.worldToCanvas(e)));let w;if(h.cachedStats[r]&&null!=h.cachedStats[r].angle?a.invalidated&&this._throttledCalculateCachedStats(a,l,e):(h.cachedStats[r]={angle:null},this._calculateCachedStats(a,l,e)),(0,Z.isAnnotationLocked)(a.annotationUID)||this.editData||null===u||(w=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(w){const e="0";(0,S.drawHandles)(t,c,e,f,{color:m,lineDash:p,lineWidth:v})}let E="1";if((0,S.drawLine)(t,c,E,f[0],f[1],{color:m,width:v,lineDash:p}),n=!0,3!==f.length)return n;if(E="2",(0,S.drawLine)(t,c,E,f[1],f[2],{color:m,width:v,lineDash:p}),!h.cachedStats[r]?.angle)continue;const I=this.getLinkedTextBoxStyle(d,a);if(!I.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const C=this.configuration.getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=f[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}const _=i.worldToCanvas(h.handles.textBox.worldPosition),T="1",b=(0,S.drawLinkedTextBox)(t,c,T,C,_,f,{},I),{x:y,y:A,width:D,height:x}=b;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([y,A]),topRight:i.canvasToWorld([y+D,A]),bottomLeft:i.canvasToWorld([y,A+x]),bottomRight:i.canvasToWorld([y+D,A+x])}}return n},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,N.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(d),e.preventDefault()}_calculateCachedStats(e,t,n){const o=e.data,{element:a}=n.viewport;if(3!==o.handles.points.length)return;const s=o.handles.points[0],r=o.handles.points[1],l=o.handles.points[2],{cachedStats:d}=o,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=(0,B.A)([s,r],[r,l]),{dimensions:o,imageData:a}=this.getTargetImageData(t);this.isHandleOutsideImage=[s,r,l].map((e=>i.utilities.transformWorldToIndex(a,e))).some((e=>!i.utilities.indexWithinDimensions(e,o))),d[t]={angle:isNaN(n)?"Incomplete Angle":n}}return e.invalidated=!1,(0,L.XF)(e,a),d}}function kt(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;if(isNaN(o))return[`${o}`];return[`${i.utilities.roundNumber(o)} ${String.fromCharCode(176)}`]}Nt.toolName="Angle";var Ut=n(82983);class Vt extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Wt,showArcLines:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;(0,N.hideElementCursor)(a),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...l.getViewReference({points:[s]})},data:{handles:{points:[[...s],[...s]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,o.addAnnotation)(v,a);const p=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),e.preventDefault(),(0,k.A)(p),v},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{distanceToPoint:l,distanceToPoint2:d}=this.distanceToLines({viewport:s,points:r.handles.points,canvasCoords:n,proximity:o});return l<=o||d<=o},this.toolSelectedCallback=(e,t,n,o,a=6)=>{const s=e.detail,{element:r}=s;t.highlighted=!0;const l=(0,P.getViewportIdsWithToolToRender)(r,this.getToolName()),d=(0,i.getEnabledElement)(r),{renderingEngine:c,viewport:h}=d,{isNearFirstLine:g,isNearSecondLine:u}=this.distanceToLines({viewport:h,points:t.data.handles.points,canvasCoords:o,proximity:a});this.editData={annotation:t,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:g,isNearSecondLine:u},this._activateModify(r),(0,N.hideElementCursor)(r),(0,k.A)(l),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;if(this.angleStartedNotYetCompleted&&d.handles.points.length<4)return(0,N.resetElementCursor)(n),void(this.editData.handleIndex=d.handles.points.length);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a),this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:o,currentPoints:a}=i,s=a.world,{data:r}=t;return 1===n?(r.handles.points[1]=s,void(this.editData.hasMoved=r.handles.points[1][0]!==r.handles.points[0][0]||r.handles.points[1][1]!==r.handles.points[0][0])):3===n?(r.handles.points[3]=s,this.editData.hasMoved=r.handles.points[3][0]!==r.handles.points[2][0]||r.handles.points[3][1]!==r.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,(0,N.hideElementCursor)(o),r.handles.points[2]=r.handles.points[3]=s,void(this.editData.handleIndex=r.handles.points.length-1))},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r,isNearFirstLine:l,isNearSecondLine:d}=this.editData,{data:c}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s&&(l||d)){const{deltaPoints:e}=t,n=e.world,i=c.handles.points;if(l){[i[0],i[1]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}else if(d){[i[2],i[3]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;c.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const h=(0,i.getEnabledElement)(n),{renderingEngine:g}=h;(0,k.A)(a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:a}=this.editData,{data:s}=t;s.handles.points.length<4&&(0,o.removeAnnotation)(t.annotationUID),t.highlighted=!1,s.handles.activeHandleIndex=null;const r=(0,i.getEnabledElement)(e),{renderingEngine:l}=r;return(0,k.A)(n),a&&(0,L.dZ)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(a.Events.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(a.Events.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const a=s[o],{annotationUID:c,data:h}=a,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:v,lineDash:p}=this.getAnnotationStyle({annotation:a,styleSpecifier:d}),f=g.map((e=>i.worldToCanvas(e)));let w;if(h.cachedStats[r]&&null!=h.cachedStats[r].angle?a.invalidated&&this._throttledCalculateCachedStats(a,l,e):(h.cachedStats[r]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(a,l,e)),(0,Z.isAnnotationLocked)(c)||this.editData||null===u||(w=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(w){const e="0";(0,S.drawHandles)(t,c,e,f,{color:m,lineDash:p,lineWidth:v})}const E=[f[0],f[1]],I=[f[2],f[3]];let C="line1";if((0,S.drawLine)(t,c,C,E[0],E[1],{color:m,width:v,lineDash:p}),n=!0,f.length<4)return n;C="line2",(0,S.drawLine)(t,c,C,I[0],I[1],{color:m,width:v,lineDash:p}),C="linkLine";const _=(0,Ut.f)(E[0],E[1]),T=(0,Ut.f)(I[0],I[1]);(0,S.drawLine)(t,c,C,_,T,{color:m,lineWidth:"1",lineDash:"1,4"});const{arc1Start:b,arc1End:y,arc2End:A,arc2Start:D}=h.cachedStats[r].points.canvas,{arc1Angle:x,arc2Angle:M}=h.cachedStats[r];if(this.configuration.showArcLines&&(C="arc1",(0,S.drawLine)(t,c,C,b,y,{color:m,lineWidth:"1"}),C="arc2",(0,S.drawLine)(t,c,C,D,A,{color:m,lineWidth:"1"})),!h.cachedStats[r]?.angle)continue;const O=this.getLinkedTextBoxStyle(d,a);if(!O.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const R=this.configuration.getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=(0,We.getTextBoxCoordsCanvas)(f);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const L=i.worldToCanvas(h.handles.textBox.worldPosition),P="cobbAngleText",N=(0,S.drawLinkedTextBox)(t,c,P,R,L,f,{},O),{x:k,y:U,width:V,height:W}=N;if(h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([k,U]),topRight:i.canvasToWorld([k+V,U]),bottomLeft:i.canvasToWorld([k,U+W]),bottomRight:i.canvasToWorld([k+V,U+W])},this.configuration.showArcLines){const e="arcAngle1",n=[`${x.toFixed(2)} ${String.fromCharCode(176)}`],i=(0,Ut.f)(b,y);(0,S.drawTextBox)(t,c,e,n,i,{...O,padding:3});const o="arcAngle2",a=[`${M.toFixed(2)} ${String.fromCharCode(176)}`],s=(0,Ut.f)(D,A);(0,S.drawTextBox)(t,c,o,a,s,{...O,padding:3})}}return n},this.distanceToLines=({viewport:e,points:t,canvasCoords:n,proximity:i})=>{const[o,a,s,r]=t,l=e.worldToCanvas(o),d=e.worldToCanvas(a),c=e.worldToCanvas(s),h=e.worldToCanvas(r),g={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}},m=j.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]]),v=j.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]);let p=!1,f=!1;return m<=i?p=!0:v<=i&&(f=!0),{distanceToPoint:m,distanceToPoint2:v,isNearFirstLine:p,isNearSecondLine:f}},this.getArcsStartEndPoints=({firstLine:e,secondLine:t,mid1:n,mid2:i})=>{const o=[n,i],a=(0,B.A)(e,o),s=(0,B.A)(t,o),r=a>90?1:0,l=s>90?0:1,d=(0,Ut.f)(o[0],o[1]),c=Math.sqrt((o[1][0]-o[0][0])**2+(o[1][1]-o[0][1])**2),h=.1,g=(0,Ut.f)(e[0],e[1]),u=(0,Ut.f)(t[0],t[1]),m=[e[r][0]-g[0],e[r][1]-g[1]],v=Math.sqrt(m[0]**2+m[1]**2),p=[m[0]/v,m[1]/v],f=[g[0]+p[0]*c*h,g[1]+p[1]*c*h],w=[d[0]-n[0],d[1]-n[1]],E=Math.sqrt(w[0]**2+w[1]**2),I=[w[0]/E,w[1]/E],C=[n[0]+I[0]*c*h,n[1]+I[1]*c*h],_=[t[l][0]-u[0],t[l][1]-u[1]],T=Math.sqrt(_[0]**2+_[1]**2),b=[_[0]/T,_[1]/T],S=[u[0]+b[0]*c*h,u[1]+b[1]*c*h],y=[d[0]-i[0],d[1]-i[1]],A=Math.sqrt(y[0]**2+y[1]**2),D=[y[0]/A,y[1]/A];return{arc1Start:f,arc1End:C,arc2Start:S,arc2End:[i[0]+D[0]*c*h,i[1]+D[1]*c*h],arc1Angle:a>90?180-a:a,arc2Angle:s>90?180-s:s}},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n,o="mouse"){const a=e.detail,{element:s}=a,{data:r}=t;t.highlighted=!0;let l,d=!1;n.worldPosition?d=!0:l=r.handles.points.findIndex((e=>e===n));const c=(0,P.getViewportIdsWithToolToRender)(s,this.getToolName());this.editData={annotation:t,viewportIdsToRender:c,handleIndex:l,movingTextBox:d},this._activateModify(s),(0,N.hideElementCursor)(s);const h=(0,i.getEnabledElement)(s),{renderingEngine:g}=h;(0,k.A)(c),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data;if(4!==i.handles.points.length)return;const o=[null,null],a=[null,null];let s=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=C.eR.distance(i.handles.points[e],i.handles.points[t]);n<s&&(s=n,o[1]=i.handles.points[e],o[0]=i.handles.points[(e+1)%2],a[0]=i.handles.points[t],a[1]=i.handles.points[2+(t-1)%2])}const{viewport:r}=n,{element:l}=r,d=i.handles.points.map((e=>r.worldToCanvas(e))),c=[d[0],d[1]],h=[d[2],d[3]],g=(0,Ut.f)(c[0],c[1]),u=(0,Ut.f)(h[0],h[1]),{arc1Start:m,arc1End:v,arc2End:p,arc2Start:f,arc1Angle:w,arc2Angle:E}=this.getArcsStartEndPoints({firstLine:c,secondLine:h,mid1:g,mid2:u}),{cachedStats:I}=i,_=Object.keys(I);for(let e=0;e<_.length;e++){I[_[e]]={angle:(0,B.A)(o,a),arc1Angle:w,arc2Angle:E,points:{canvas:{arc1Start:m,arc1End:v,arc2End:p,arc2Start:f},world:{arc1Start:r.canvasToWorld(m),arc1End:r.canvasToWorld(v),arc2End:r.canvasToWorld(p),arc2Start:r.canvasToWorld(f)}}}}return e.invalidated=!1,(0,L.XF)(e,l),I}}function Wt(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;return[`${i.toFixed(2)} ${String.fromCharCode(176)}`]}Vt.toolName="CobbAngle";const{transformWorldToIndex:Bt}=i.utilities;class Ht extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ft,displayBothAxesDistances:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;if(!(l instanceof i.StackViewport))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");(0,N.hideElementCursor)(a),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=l.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u},data:{handles:{points:[[...s],[...s]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,o.addAnnotation)(v,a);const p=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),e.preventDefault(),(0,k.A)(p),v},this.isPointNearTool=(e,t,n,i)=>!1,this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;if(this.startedDrawing&&1===d.handles.points.length)return void(this.editData.handleIndex=1);this.startedDrawing=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID),(0,k.A)(s),r&&(0,L.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,k.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,k.A)(n),i&&(0,L.dZ)(t),this.editData=null,this.startedDrawing=!1,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const a=s[o],{annotationUID:c,data:h}=a,{points:g}=h.handles;d.annotationUID=c;const u=this.getStyle("color",d,a),m=g.map((e=>i.worldToCanvas(e)));if(h.cachedStats[r]&&null!=h.cachedStats[r].xValues?a.invalidated&&this._throttledCalculateCachedStats(a,l,e):(h.cachedStats[r]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(a,l,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let v="0";if((0,S.drawHandle)(t,c,v,m[0],{color:u},0),n=!0,2!==m.length)return n;v="1",(0,S.drawHandle)(t,c,v,m[1],{color:u},1);if(h.cachedStats[r].isUnitless){const e=`${c}-line-1`,n="1";(0,S.drawLine)(t,c,n,m[0],m[1],{color:u,width:1,shadow:this.configuration.shadow},e)}else{const e=m[0],n=m[1],i=n[1]-e[1],o=n[0]-e[0];let a=[0,0];a=h.cachedStats[r].isHorizontal?[e[0]+o,e[1]]:[e[0],e[1]+i];let s=`${c}-line-1`,l="1";(0,S.drawLine)(t,c,l,m[0],a,{color:u,width:1,shadow:this.configuration.shadow},s),s=`${c}-line-2`,l="2",(0,S.drawLine)(t,c,l,m[1],a,{color:u,width:1,lineDash:[1,1],shadow:this.configuration.shadow},s)}const p=this.getLinkedTextBoxStyle(d,a);if(!p.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const f=this.configuration.getTextLines(h,r,this.configuration);if(!h.handles.textBox.hasMoved){const e=m[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}const w=i.worldToCanvas(h.handles.textBox.worldPosition),E="1",I=(0,S.drawLinkedTextBox)(t,c,E,f,w,m,{},p),{x:C,y:_,width:T,height:b}=I;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([C,_]),topRight:i.canvasToWorld([C+T,_]),bottomLeft:i.canvasToWorld([C,_+b]),bottomRight:i.canvasToWorld([C+T,_+b])}}return n},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(e,t,n,i){}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;const r=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());let l,d=!1;n.worldPosition?d=!0:l=s.handles.points.findIndex((e=>e===n)),this.editData={handleIndex:l,annotation:t,viewportIdsToRender:r},this._activateModify(a),(0,N.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,k.A)(r),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport;if(2!==i.handles.points.length)return;const{cachedStats:a}=i,s=Object.keys(a);for(let e=0;e<s.length;e++){const t=s[e],o=this.getTargetImageData(t);if(!o)continue;const{imageData:r}=o,l=i.handles.points[0],d=i.handles.points[1],c=Bt(r,l),h=Bt(r,d),{values:g,units:u}=(0,Ue.Xw)(o,[c]),{values:m,units:v}=(0,Ue.Xw)(o,[h]);let p,f,w,E,I=!1;if(u[0]!==v[0]||u[1]!==v[1]||"raw"===u[0]&&"raw"===v[0]){const e=(0,de.distanceToPoint)(l,d);p=[e,0],f=[e,0],w=["px"],I=!0}else{const e=n.viewport.worldToCanvas(l),t=n.viewport.worldToCanvas(d),i=t[1]-e[1],o=t[0]-e[0];E=Math.abs(o)>Math.abs(i),p=[g[0],m[0]],f=[g[1],m[1]],w=[u[0],u[1]]}a[t]={xValues:p,yValues:f,isHorizontal:E,units:w,isUnitless:I}}return e.invalidated=!1,(0,L.XF)(e,o),a}}function Ft(e,t,n){const o=e.cachedStats[t],{xValues:a,yValues:s,units:r,isUnitless:l,isHorizontal:d}=o;if(l)return[`${i.utilities.roundNumber(a[0])} px`];if(n.displayBothAxesDistances){const e=Math.abs(a[1]-a[0]),t=Math.abs(s[1]-s[0]);return[`${i.utilities.roundNumber(e)} ${r[0]}`,`${i.utilities.roundNumber(t)} ${r[1]}`]}if(d){const e=Math.abs(a[1]-a[0]);return[`${i.utilities.roundNumber(e)} ${r[0]}`]}{const e=Math.abs(s[1]-s[0]);return[`${i.utilities.roundNumber(e)} ${r[1]}`]}}Ht.toolName="UltrasoundDirectionalTool";class Gt extends D.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:$t,changeTextCallback:zt,canvasPosition:[10,10],canvasSize:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r,c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,s,h,g),m=Gt.createAnnotation({metadata:{...l.getViewReference(),referencedImageId:u}});(0,o.addAnnotation)(m,a);const v=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return e.preventDefault(),(0,k.A)(v),this.configuration.getTextCallback((e=>{if(!e)return(0,o.removeAnnotation)(m.annotationUID),(0,k.A)(v),void(this.isDrawing=!1);m.data.text=e,(0,L.dZ)(m),(0,k.A)(v)})),m},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{canvasPosition:l,canvasSize:d}=this.configuration;return!!l?.length&&(Math.abs(n[0]-l[0]+d/2)<=d/2&&Math.abs(n[1]-l[1]+d/2)<=d/2)},this.toolSelectedCallback=(e,t)=>{t.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t;this._deactivateModify(n),(0,N.resetElementCursor)(n)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,o.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const a=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!a)return;const s=a;this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,n,s)),this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,o.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const o=s[e],{annotationUID:a}=o;r.annotationUID=a;const{color:l}=this.getAnnotationStyle({annotation:o,styleSpecifier:r}),{canvasPosition:d,canvasSize:c}=this.configuration;if(d?.length){const e="1";(0,S.drawArrow)(t,a,e,d.map((e=>e+c)),d,{color:l,width:1})}if(n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n}return n}}cancel(){}handleSelectedCallback(e,t,n){}_doneChangingTextCallback(e,t,n){t.data.text=n;const o=(0,i.getEnabledElement)(e),{renderingEngine:a}=o,s=(0,P.getViewportIdsWithToolToRender)(e,this.getToolName());(0,k.A)(s),(0,L.XF)(t,e)}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function $t(e){return e(prompt("Enter your annotation:"))}function zt(e,t,n){return n(prompt("Enter your annotation:"))}Gt.toolName="KeyImage";var qt=n(17343);class jt extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>this._deleteNearbyAnnotations(e,"mouse"),this.preTouchStartCallback=e=>this._deleteNearbyAnnotations(e,"touch")}_deleteNearbyAnnotations(e,t){const{renderingEngineId:n,viewportId:i,element:a,currentPoints:s}=e.detail,r=(0,f.getToolGroupForViewport)(i,n);if(!r)return!1;const l=r._toolInstances,d=[];for(const e in l){const n=l[e];if("function"!=typeof n.isPointNearTool||"function"!=typeof n.filterInteractableAnnotationsForElement)continue;const i=(0,o.getAnnotations)(e,a);if(!i.length)continue;const r=n.filterInteractableAnnotationsForElement(a,i)||[];for(const e of r)n.isPointNearTool(a,e,s.canvas,10,t)&&d.push(e.annotationUID)}for(const e of d)(0,qt.setAnnotationSelected)(e),(0,o.removeAnnotation)(e);return e.preventDefault(),!0}}jt.toolName="Eraser";var Zt=n(10088),Kt=n(47347),Yt=n(98870);class Xt extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Zt.p,ERASE_INSIDE:Kt.M},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:o}=t,s=n.world,r=(0,i.getEnabledElement)(o),{viewport:l}=r;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=A.activeSegmentation.getActiveSegmentation(l.id);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:u}=g,m=A.segmentIndex.getActiveSegmentIndex(u),v=A.segmentLocking.getLockedSegmentIndices(u),p=A.config.color.getSegmentIndexColor(l.id,u,m),{representationData:f}=(0,Yt.getSegmentation)(u),w=f[a.SegmentationRepresentations.Labelmap],E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:p},data:{handles:{points:[[...s],[...s],[...s],[...s]],activeHandleIndex:null}}},I=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName());if(this.editData={annotation:E,segmentIndex:m,segmentationId:u,segmentsLocked:v,segmentColor:p,viewportIdsToRender:I,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},l instanceof i.BaseVolumeViewport){const{volumeId:e}=w,t=i.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const e=(0,Yt.getCurrentLabelmapImageIdForViewport)(l.id,u);this.editData={...this.editData,imageId:e}}return this._activateDraw(o),(0,N.hideElementCursor)(o),e.preventDefault(),(0,k.A)(I),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s}=this.editData,{data:r}=o,{currentPoints:l}=t,d=(0,i.getEnabledElement)(n),{worldToCanvas:c,canvasToWorld:h}=d.viewport,g=l.world,{points:u}=r.handles;let m,v,p,f,w,E,I,C;switch(u[s]=[...g],s){case 0:case 3:m=c(u[0]),f=c(u[3]),v=[f[0],m[1]],p=[m[0],f[1]],E=h(v),I=h(p),u[1]=E,u[2]=I;break;case 1:case 2:v=c(u[1]),p=c(u[2]),m=[p[0],v[1]],f=[v[0],p[1]],w=h(m),C=h(f),u[0]=w,u[3]=C}o.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(a)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=o;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,N.resetElementCursor)(n);const l=(0,i.getEnabledElement)(n),d={...this.editData,points:r.handles.points};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(l,d)},this._activateDraw=e=>{e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{annotation:o}=this.editData,a=o.metadata,s=o.annotationUID,r=o.data,{points:l}=r.handles,d=l.map((e=>i.worldToCanvas(e))),c=`rgb(${a.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,S.drawRect)(t,s,"0",d[0],d[3],{color:c}),n=!0,n}}}Xt.toolName="RectangleScissor";var Jt=n(56789),Qt=n(33852);class en extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Jt.kr,ERASE_INSIDE:Qt.r},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=n.canvas,r=(0,i.getEnabledElement)(o),{viewport:l}=r;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=A.activeSegmentation.getActiveSegmentation(l.id);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:u}=g,m=A.segmentIndex.getActiveSegmentIndex(u),v=A.segmentLocking.getLockedSegmentIndices(u),p=A.config.color.getSegmentIndexColor(l.id,u,m),{representationData:f}=(0,Yt.getSegmentation)(u),w=f.Labelmap;if(!w)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const E={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:p},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},I=[l.id];if(this.editData={annotation:E,centerCanvas:s,segmentIndex:m,segmentationId:u,segmentsLocked:v,segmentColor:p,viewportIdsToRender:I,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},l instanceof i.BaseVolumeViewport){const{volumeId:e}=w,t=i.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const e=(0,Yt.getCurrentLabelmapImageIdForViewport)(l.id,u);this.editData={...this.editData,imageId:e}}return this._activateDraw(o),(0,N.hideElementCursor)(o),e.preventDefault(),(0,k.A)(I),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h,centerCanvas:g}=this.editData,{data:u}=c,m=Math.abs(a[0]-g[0]),v=Math.abs(a[1]-g[1]),p=Math.sqrt(m*m+v*v),f=[g[0],g[1]+p],w=[g[0],g[1]-p],E=[g[0]-p,g[1]],I=[g[0]+p,g[1]];u.handles.points=[d(f),d(w),d(E),d(I)],c.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(h)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=o,{viewPlaneNormal:l,viewUp:d}=o.metadata;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),h={...this.editData,points:r.handles.points,viewPlaneNormal:l,viewUp:d,strategySpecificConfiguration:{}};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(c,h)},this._activateDraw=e=>{e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,s=a.metadata,r=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),v=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,S.drawCircle)(t,r,"0",u,m,{color:v}),n=!0,n}}}en.toolName="CircleScissor";var tn=n(17492),nn=n(1989);class on extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:tn.Jq,ERASE_INSIDE:nn._},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:o}=t,s=n.world,r=n.canvas,l=(0,i.getEnabledElement)(o),{viewport:d}=l;this.isDrawing=!0;const c=d.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=A.activeSegmentation.getActiveSegmentation(d.id);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:m}=u,v=A.segmentIndex.getActiveSegmentIndex(m),p=A.segmentLocking.getLockedSegmentIndices(m),f=A.config.color.getSegmentIndexColor(d.id,m,v);this.isDrawing=!0;const w={metadata:{viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:d.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:f},data:{invalidated:!0,handles:{points:[[...s],[...s],[...s],[...s]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},E=[d.id];this.editData={annotation:w,centerCanvas:r,segmentIndex:v,segmentationId:m,segmentsLocked:p,segmentColor:f,toolGroupId:this.toolGroupId,viewportIdsToRender:E,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null};const{representationData:I}=(0,Yt.getSegmentation)(m),C=I[a.SegmentationRepresentations.Labelmap];if(d instanceof i.BaseVolumeViewport){const{volumeId:e}=C,t=i.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else this.editData={...this.editData};return this._activateDraw(o),(0,N.hideElementCursor)(o),e.preventDefault(),(0,k.A)(E),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h,centerCanvas:g}=this.editData,{data:u}=c,m=Math.abs(a[0]-g[0]),v=Math.abs(a[1]-g[1]),p=Math.sqrt(m*m+v*v),f=[g[0],g[1]+p],w=[g[0],g[1]-p],E=[g[0]-p,g[1]],I=[g[0]+p,g[1]];u.handles.points=[d(f),d(w),d(E),d(I)],c.invalidated=!0,this.editData.hasMoved=!0,(0,k.A)(h)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:a,hasMoved:s,segmentIndex:r,segmentsLocked:l}=this.editData,{data:d}=o,{viewPlaneNormal:c,viewUp:h}=o.metadata;if(a&&!s)return;o.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,N.resetElementCursor)(n);const g=(0,i.getEnabledElement)(n),u={...this.editData,points:d.handles.points,segmentIndex:r,segmentsLocked:l,viewPlaneNormal:c,viewUp:h};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(g,u)},this._activateDraw=e=>{e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(a.Events.TOUCH_END,this._endCallback),e.addEventListener(a.Events.TOUCH_TAP,this._endCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(a.Events.TOUCH_END,this._endCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(a.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,s=a.metadata,r=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),v=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,S.drawCircle)(t,r,"0",u,m,{color:v}),n=!0,n}}}on.toolName="SphereScissor";n(40336),n(67847);const{transformWorldToIndex:an}=i.utilities;class sn extends dt{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!1,getTextLines:rn,statsCalculator:nt.BasicStatsCalculator,showTextBox:!1}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,i.getEnabledElement)(a),{viewport:l,renderingEngine:d}=r;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c;let u,m,v;if(l instanceof i.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(l);v=i.utilities.getVolumeId(e),m=i.cache.getVolume(v),u=i.utilities.getClosestImageId(m,s,h)}const p=i.utilities.getSpacingInNormalDirection(m,h),f=this._getStartCoordinate(s,p,h),w=this._getEndCoordinate(s,p,h),E=l.getFrameOfReferenceUID(),I={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:E,referencedImageId:u,volumeId:v,spacingInNormal:p,enabledElement:r},data:{label:"",startCoordinate:f,endCoordinate:w,handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...s],[...s]],activeHandleIndex:null},cachedStats:{pointsInVolume:[],projectionPoints:[],statistics:[]},labelmapUID:null}};this._computeProjectionPoints(I,m),(0,o.addAnnotation)(I,a);const C=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:I,viewportIdsToRender:C,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,N.hideElementCursor)(a),e.preventDefault(),(0,k.A)(C),I},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=a;if(r&&!l)return;a.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,o.removeAnnotation)(a.annotationUID);const h=this.getTargetId(c.viewport),g=i.cache.getVolume(h.split(/volumeId:|\?/)[1]);this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(a,g,h,c),(0,k.A)(s),r&&(0,L.dZ)(a)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:a}=e;let s=(0,o.getAnnotations)(this.getToolName(),a.element);if(!s?.length)return n;s=(0,G.filterAnnotationsWithinSamePlane)(s,a.getCamera());const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const l=s[o],{annotationUID:d,data:c}=l,{startCoordinate:h,endCoordinate:g}=c,{points:u,activeHandleIndex:m}=c.handles;r.annotationUID=d;const v=this.getStyle("lineWidth",r,l),p=this.getStyle("lineDash",r,l),f=this.getStyle("color",r,l),w=u.map((e=>a.worldToCanvas(e))),E=w[0],I=(0,re.r)(w),{centerPointRadius:C}=this.configuration,_=(0,re.H)(w),T=a.getCamera().focalPoint,b=a.getCamera().viewPlaneNormal;let y=h,A=g;Array.isArray(h)&&(y=this._getCoordinateForViewplaneNormal(y,b),c.startCoordinate=y),Array.isArray(g)&&(A=this._getCoordinateForViewplaneNormal(A,b),c.endCoordinate=A);const D=i.utilities.roundToPrecision(c.startCoordinate),x=i.utilities.roundToPrecision(c.endCoordinate),M=this._getCoordinateForViewplaneNormal(T,b),O=i.utilities.roundToPrecision(M);if(O<Math.min(D,x)||O>Math.max(D,x))continue;const R=i.utilities.roundToPrecision((c.startCoordinate+c.endCoordinate)/2);let L,P=!1;if(O===R&&(P=!0),c.handles.points[0][this._getIndexOfCoordinatesForViewplaneNormal(b)]=R,l.invalidated&&this._throttledCalculateCachedStats(l,e),!a.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,se.isAnnotationVisible)(d))continue;if((0,Z.isAnnotationLocked)(d)||this.editData||null===m||!P||(L=[w[m]]),L){const e="0";(0,S.drawHandles)(t,d,e,L,{color:f})}let N=v,k=p;P?(N=v,k=[]):k=[5,5];const U="0";if((0,S.drawCircle)(t,d,U,E,I,{color:f,lineDash:k,lineWidth:N}),C>0&&I>3*C&&(0,S.drawCircle)(t,d,`${U}-center`,E,C,{color:f,lineDash:p,lineWidth:v}),n=!0,1==this.configuration.showTextBox&&1==this.configuration.calculatePointsInsideVolume){const e=this.getLinkedTextBoxStyle(r,l);if(!e.visibility){c.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const n=this.configuration.getTextLines(c);if(!n||0===n.length)continue;let i;c.handles.textBox.hasMoved||(i=(0,We.getTextBoxCoordsCanvas)(_),c.handles.textBox.worldPosition=a.canvasToWorld(i));const o=a.worldToCanvas(c.handles.textBox.worldPosition),s="1",h=(0,S.drawLinkedTextBox)(t,d,s,n,o,w,{},e),{x:g,y:u,width:m,height:v}=h;c.handles.textBox.worldBoundingBox={topLeft:a.canvasToWorld([g,u]),topRight:a.canvasToWorld([g+m,u]),bottomLeft:a.canvasToWorld([g,u+v]),bottomRight:a.canvasToWorld([g+m,u+v])}}}return n},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:o}=e,{viewPlaneNormal:a,spacingInNormal:s}=o,{imageData:r}=t,{startCoordinate:l,endCoordinate:d}=n,{points:c}=n.handles,h=an(r,c[0]),g=an(r,c[0]),u=i.utilities.deepClone(c),m=C.eR.create();r.indexToWorldVec3(h,m);const v=C.eR.create();r.indexToWorldVec3(g,v),2==this._getIndexOfCoordinatesForViewplaneNormal(a)?(m[2]=l,v[2]=d,u[0][2]=l,u[1][2]=l):0==this._getIndexOfCoordinatesForViewplaneNormal(a)?(m[0]=l,v[0]=d,u[0][0]=l,u[1][0]=l):1==this._getIndexOfCoordinatesForViewplaneNormal(a)&&(m[1]=l,v[1]=d,u[0][1]=l,u[1][1]=l);const p=C.eR.distance(m,v),f=[];for(let e=0;e<p;e+=s)f.push(u.map((t=>{const n=C.eR.create();return C.eR.scaleAndAdd(n,t,a,e),Array.from(n)})));n.cachedStats.projectionPoints=f}_computePointsInsideVolume(e,t,n,i){const{data:o,metadata:a}=e,{viewPlaneNormal:s,viewUp:r}=a,{viewport:l}=i,d=o.cachedStats.projectionPoints,c=[[]],h=this.getTargetImageData(n),g=o.handles.points.map((e=>l.worldToCanvas(e))),[u,m]=(0,re.H)(g),v=l.canvasToWorld(u),p=l.canvasToWorld(m),{worldWidth:f,worldHeight:w}=(0,et.A)(s,r,v,p),E=(0,Ue.Op)(h,o.handles),I=(0,Ue.CQ)(h),C=Math.abs(Math.PI*(f/E.scale/2)*(w/I/E.scale/2)),_={isPreScaled:(0,je.u)(l,n),isSuvScaled:this.isSuvScaled(l,n,e.metadata.referencedImageId)},T=(0,qe.j)(a.Modality,e.metadata.referencedImageId,_);for(let e=0;e<d.length;e++){if(!t)continue;const n=d[e][0],i=d[e].map((e=>l.worldToCanvas(e))),[o,a]=(0,re.H)(i),r=l.canvasToWorld(o),h=l.canvasToWorld(a),g=r,u=h,{dimensions:m,imageData:v,voxelManager:p}=t,f=an(v,g),w=an(v,n),E=this._getIndexOfCoordinatesForViewplaneNormal(s);f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),f[E]=w[E];const I=an(v,u);if(I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]),I[E]=w[E],this._isInsideVolume(f,I,m)){const e=[[Math.min(f[0],I[0]),Math.max(f[0],I[0])],[Math.min(f[1],I[1]),Math.max(f[1],I[1])],[Math.min(f[2],I[2]),Math.max(f[2],I[2])]],t={center:n,xRadius:Math.abs(r[0]-h[0])/2,yRadius:Math.abs(r[1]-h[1])/2,zRadius:Math.abs(r[2]-h[2])/2},i=p.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,tt.pointInEllipse)(t,e),boundsIJK:e,imageData:v,returnPoints:this.configuration.storePointData});c.push(i)}}const b=this.configuration.statsCalculator.getStatistics();o.cachedStats.pointsInVolume=c,o.cachedStats.statistics={Modality:a.Modality,area:C,mean:b.mean?.value,stdDev:b.stdDev?.value,max:b.max?.value,statsArray:b.array,areaUnit:E.areaUnit,modalityUnit:T}}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:o}=t,{cachedStats:a}=n,s=this.getTargetId(o),r=i.cache.getVolume(s.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,r),this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(e,r,s,t),e.invalidated=!1,(0,L.XF)(e,o.element),a}_getStartCoordinate(e,t,n){const i=this.configuration.numSlicesToPropagate,o=Math.round(i/2),a=C.eR.create();C.eR.scaleAndAdd(a,e,n,o*-t);return this._getCoordinateForViewplaneNormal(a,n)}_getEndCoordinate(e,t,n){const i=this.configuration.numSlicesToPropagate,o=i-Math.round(i/2),a=C.eR.create();C.eR.scaleAndAdd(a,e,n,o*t);return this._getCoordinateForViewplaneNormal(a,n)}_getIndexOfCoordinatesForViewplaneNormal(e){const t=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];return t.indexOf(Math.max(...t))}_getCoordinateForViewplaneNormal(e,t){return e[this._getIndexOfCoordinatesForViewplaneNormal(t)]}}function rn(e){const t=e.cachedStats.statistics,{area:n,mean:o,max:a,stdDev:s,areaUnit:r,modalityUnit:l}=t;if(void 0===o)return;const d=[];return d.push(`Area: ${i.utilities.roundNumber(n)} ${r}`),d.push(`Mean: ${i.utilities.roundNumber(o)} ${l}`),d.push(`Max: ${i.utilities.roundNumber(a)} ${l}`),d.push(`Std Dev: ${i.utilities.roundNumber(s)} ${l}`),d}sn.toolName="CircleROIStartEndThreshold";n(48736);var ln=n(49906),dn=n(84882);const{transformWorldToIndex:cn,isEqual:hn}=i.utilities;class gn extends D.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,s=n.world,r=(0,i.getEnabledElement)(o),{viewport:l}=r,d=l.getCamera(),{viewPlaneNormal:c}=d,h=A.activeSegmentation.getActiveSegmentation(l.id);if(!h)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:g}=h,u=A.segmentIndex.getActiveSegmentIndex(g),m=A.segmentLocking.getLockedSegmentIndices(g),{representationData:v}=(0,Yt.getSegmentation)(g);let p,f,w,E;if(l instanceof i.BaseVolumeViewport){const{volumeId:e}=v[a.SegmentationRepresentations.Labelmap],t=i.cache.getVolume(e);({dimensions:p,direction:f}=t),E=t.voxelManager,w=cn(t.imageData,s)}else{const e=(0,Yt.getCurrentLabelmapImageIdForViewport)(l.id,g);if(!e)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const{imageData:t}=l.getImageData();p=t.getDimensions(),f=t.getDirection();const n=i.cache.getImage(e);E=n.voxelManager,w=cn(t,s)}const I=this.getFixedDimension(c,f);if(void 0===I)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:C,getLabelValue:_,getScalarDataPositionFromPlane:T,inPlaneSeedPoint:b,fixedDimensionValue:S}=this.generateHelpers(E,p,w,I);if(w[0]<0||w[0]>=p[0]||w[1]<0||w[1]>=p[1]||w[2]<0||w[2]>=p[2])return;const y=_(w[0],w[1],w[2]);if(m.includes(y))return;const D=(0,dn.A)(C,b),{flooded:x}=D;x.forEach((e=>{const t=T(e[0],e[1]);E.setAtIndex(t,u)}));const M=this.getFramesModified(I,S,D);return(0,ln.triggerSegmentationDataModified)(g,M),!0},this.getFramesModified=(e,t,n)=>{const{boundaries:i}=n;if(2===e)return[t];let o=1/0,a=-1/0;for(let e=0;e<i.length;e++){const t=i[e][1];t<o&&(o=t),t>a&&(a=t)}const s=[];for(let e=o;e<=a;e++)s.push(e);return s},this.generateHelpers=(e,t,n,i=2)=>{let o,a;switch(i){case 0:o=n[0],a=[n[1],n[2]];break;case 1:o=n[1],a=[n[0],n[2]];break;case 2:o=n[2],a=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${i}`)}const s=(t,n,i)=>e.getAtIJK(t,n,i),r=this.generateFloodFillGetter(t,i,o,s);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane(((t,n,i)=>e.toIndex([t,n,i])),i,o),getLabelValue:s,floodFillGetter:r,inPlaneSeedPoint:a,fixedDimensionValue:o}},this.generateFloodFillGetter=(e,t,n,i)=>{let o;switch(t){case 0:o=(t,o)=>{if(!(t>=e[1]||t<0||o>=e[2]||o<0))return i(n,t,o)};break;case 1:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[2]||o<0))return i(t,n,o)};break;case 2:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[1]||o<0))return i(t,o,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i}}getFixedDimension(e,t){const n=t.slice(0,3),i=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(hn(a,s))return 0;const r=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if(hn(a,r))return 1;const l=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return hn(a,l)?2:void 0}}gn.toolName="PaintFill";var un,mn=n(25161),vn=n(85825),pn=n(45700),fn=n(7019),wn=n(82409),En=n(49368),In=n(79484);!function(e){e[e.ANNOTATED_CUBE=1]="ANNOTATED_CUBE",e[e.AXES=2]="AXES",e[e.CUSTOM=3]="CUSTOM"}(un||(un={}));class Cn extends D.oS{static{this.CUBE=1}static{this.AXIS=2}static{this.VTPFILE=3}static{this.OVERLAY_MARKER_TYPES=un}constructor(e={},t={configuration:{orientationWidget:{enabled:!0,viewportCorner:mn.Ay.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:Cn.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[Cn.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"L",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"R",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[Cn.OVERLAY_MARKER_TYPES.AXES]:{},[Cn.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(e,t),this._resizeObservers=new Map,this.onSetToolEnabled=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolActive=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolDisabled=()=>{this.cleanUpData(),this._unsubscribeToViewportNewVolumeSet()},this._getViewportsInfo=()=>(0,f.getToolGroup)(this.toolGroupId).viewportsInfo,this.resize=e=>{const t=this.orientationMarkers[e];if(!t)return;const{orientationWidget:n}=t;n.updateViewport()},this.orientationMarkers={},this.updatingOrientationMarker={}}_unsubscribeToViewportNewVolumeSet(){const e=()=>{this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,i.getEnabledElementByIds)(e,t),{element:o}=n;o.removeEventListener(i.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));this._resizeObservers.get(e).unobserve(o)}))};i.eventTarget.removeEventListener(a.Events.TOOLGROUP_VIEWPORT_ADDED,(t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())}))}_subscribeToViewportEvents(){const e=()=>{this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,i.getEnabledElementByIds)(e,t),{element:o}=n;this.initViewports(),o.addEventListener(i.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));const a=new ResizeObserver((()=>{setTimeout((()=>{const n=(0,i.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:o}=n;this.resize(e),o.render()}),100)}));a.observe(o),this._resizeObservers.set(e,a)}))};e(),i.eventTarget.addEventListener(a.Events.TOOLGROUP_VIEWPORT_ADDED,(t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())}))}cleanUpData(){(0,i.getRenderingEngines)()[0].getViewports().forEach((e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:i}=t;i?.setEnabled(!1),i?.delete(),n?.delete();e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]}))}initViewports(){const e=(0,i.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,P.filterViewportsWithToolEnabled)(t,this.getToolName()),t.forEach((e=>{const t=e.getWidget(this.getToolName());t&&!t.isDeleted()||this.addAxisActorInViewport(e)}))}async addAxisActorInViewport(e){const t=e.id;if(!this.updatingOrientationMarker[t]){this.updatingOrientationMarker[t]=!0;const n=this.configuration.overlayMarkerType,i=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:i}=this.orientationMarkers[t];e.getRenderer().removeActor(n),i.setEnabled(!1)}let o;1===n?o=this.createAnnotationCube(i):2===n?o=pn.Ay.newInstance():3===n&&(o=await this.createCustomActor());const a=e.getRenderer(),s=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:r,viewportCorner:l,viewportSize:d,minPixelSize:c,maxPixelSize:h}=this.configuration.orientationWidget,g=mn.Ay.newInstance({actor:o,interactor:s.getInteractor(),parentRenderer:a});g.setEnabled(r),g.setViewportCorner(l),g.setViewportSize(d),g.setMinPixelSize(c),g.setMaxPixelSize(h),g.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:g,actor:o},e.addWidget(this.getToolName(),g),s.render(),e.getRenderingEngine().render(),this.updatingOrientationMarker[t]=!1}}async createCustomActor(){const e=this.configuration.overlayConfiguration[un.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=En.Ay.newInstance();i.parseAsArrayBuffer(n),i.update();const o=In.Ay.newInstance();o.shallowCopy(i.getOutputData()),o.getPointData().setActiveScalars("Color");const a=wn.Ay.newInstance();a.setInputData(o),a.setColorModeToDirectScalars();const s=fn.Ay.newInstance();return s.setMapper(a),s.rotateZ(180),s}createAnnotationCube(e){const t=vn.Ay.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=vn.Ay.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach((n=>{const i=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[i](t[n])})),e}}Cn.toolName="OrientationMarker";var _n=n(26228),Tn=(n(18682),n(70930)),bn=n(67470);class Sn extends D.oS{static{this.SelectMode={Inside:"Inside",Border:"Border"}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,mode:Sn.SelectMode.Border,searchRadius:6}}){super(e,t),this.mouseMoveCallback=e=>(this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout((()=>{this._setActiveSegment(e),this.hoverTimer=null}),this.configuration.hoverTimeout),!0),this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.hoverTimer=null}_setActiveSegment(e={}){if(v.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,o=n.world,a=(0,i.getEnabledElement)(t);if(!a)return;const{viewport:s}=a,r=(0,_n.getActiveSegmentation)(s.id);r&&this._setActiveSegmentForType(r,o,s)}_setActiveSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:i,representationData:o}=e;let a;if(this.configuration.mode===Sn.SelectMode.Inside?a=(0,bn.getSegmentIndexAtWorldPoint)(i,t,{viewport:n}):o.Labelmap?a=(0,bn.getSegmentIndexAtLabelmapBorder)(i,t,{viewport:n,searchRadius:this.configuration.searchRadius}):o.Contour?a=(0,bn.getHoveredContourSegmentationAnnotation)(i):o.Surface,!a||0===a)return;(0,Tn.setActiveSegmentIndex)(i,a);const s=n.getRenderingEngine().getViewports().map((e=>e.id));(0,ln.triggerSegmentationModified)(i),(0,k.A)(s)}}Sn.toolName="SegmentSelectTool";var yn=n(92282);class An extends D.EC{constructor(e={}){super(e,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(r,a,c,h),u={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:g,toolName:this.getToolName()},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},active:!0}};(0,p.lC)(u,o);const m=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName(),!1);return this.editData={annotation:u,viewportUIDsToRender:m,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,N.hideElementCursor)(o),e.preventDefault(),(0,k.A)(m),u},this.getHandleNearImagePoint=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles;for(let e=0;e<l.length;e++){const t=l[e],i=s.worldToCanvas(t);if(!0===C.Zc.distance(n,i)<o)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),g=[n[0],n[1]],{left:u,top:m,width:v,height:p}=h;if(yn.distanceToPoint([u,m,v,p],g)<=o)return!0},this.toolSelectedCallback=(e,t,n="mouse")=>{const i=e.detail,{element:o}=i,{data:a}=t;a.active=!0;const s=(0,P.getViewportIdsWithToolToRender)(o,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:s},this._activateModify(o),(0,N.hideElementCursor)(o),(0,k.A)(s),e.preventDefault()},this.handleSelectedCallback=(e,t,n,i="mouse")=>{const o=e.detail,{element:a}=o,{data:s}=t;s.active=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,P.getViewportIdsWithToolToRender)(a,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:d,handleIndex:r},this._activateModify(a),(0,N.hideElementCursor)(a),(0,k.A)(d),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportUIDsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:l}=o;if(s&&!r)return;l.active=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,N.resetElementCursor)(n);(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,p.O8)(o.annotationUID),(0,k.A)(a)},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportUIDsToRender:a,handleIndex:s}=this.editData,{data:r}=o;if(void 0===s){const{deltaPoints:e}=t,n=e.world,{points:i}=r.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),r.invalidated=!0}else{const{currentPoints:e}=t,o=(0,i.getEnabledElement)(n),{worldToCanvas:a,canvasToWorld:l}=o.viewport,d=e.world,{points:c}=r.handles;let h,g,u,m,v,p,f,w;switch(c[s]=[...d],s){case 0:case 3:h=a(c[0]),m=a(c[3]),g=[m[0],h[1]],u=[h[0],m[1]],p=l(g),f=l(u),c[1]=p,c[2]=f;break;case 1:case 2:g=a(c[1]),u=a(c[2]),h=[u[0],g[1]],m=[g[0],u[1]],v=l(h),w=l(m),c[0]=v,c[3]=w}r.invalidated=!0}this.editData.hasMoved=!0;(0,i.getEnabledElement)(n);(0,k.A)(a)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(a.Events.TOUCH_END,this._mouseUpCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(a.Events.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(a.Events.TOUCH_END,this._mouseUpCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._mouseDragCallback)},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(a.Events.TOUCH_END,this._mouseUpCallback),e.addEventListener(a.Events.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(a.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(a.Events.TOUCH_END,this._mouseUpCallback),e.removeEventListener(a.Events.TOUCH_DRAG,this._mouseDragCallback)},this.renderAnnotation=(e,t)=>{const n=!1,{viewport:i}=e,{element:o}=i;let a=(0,p.Rh)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;this.getTargetId(i),i.getRenderingEngine();const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const n=a[e],{annotationUID:o}=n,r=(n.metadata,n.data),{points:l,activeHandleIndex:d}=r.handles,c=l.map((e=>i.worldToCanvas(e))),h=this.getStyle("lineWidth",s,n),g=this.getStyle("lineDash",s,n),u=this.getStyle("color",s,n);if(!i.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let m;if(this.editData||null===d||(m=[c[d]]),m){const e="0";(0,S.drawHandles)(t,o,e,m,{color:u})}const v="0";(0,S.drawRedactionRect)(t,o,v,c[0],c[3],{color:"black",lineDash:g,lineWidth:h})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,o,s)=>{const{data:r}=e,{viewportUID:l,renderingEngineUID:d,sceneUID:c}=s,h=r.handles.points[0],g=r.handles.points[3],{cachedStats:u}=r,m=Object.keys(u);for(let e=0;e<m.length;e++){const i=m[e],{imageVolume:a}=this._getImageVolumeFromTargetUID(i,o),{dimensions:s,scalarData:r,vtkImageData:l,metadata:d}=a,c=C.eR.fromValues(0,0,0),v=C.eR.fromValues(0,0,0);if(l.worldToIndexVec3(h,c),c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]),l.worldToIndexVec3(g,v),v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),this._isInsideVolume(c,v,s)){this.isHandleOutsideImage=!1;const e=Math.min(c[0],v[0]),o=Math.max(c[0],v[0]),a=Math.min(c[1],v[1]),l=Math.max(c[1],v[1]),m=Math.min(c[2],v[2]),p=Math.max(c[2],v[2]),{worldWidth:f,worldHeight:w}=(0,et.A)(t,n,h,g),E=f*w;let I=0,C=0,_=0;const T=s[0],b=s[0]*s[1];for(let t=m;t<=p;t++)for(let n=a;n<=l;n++)for(let i=e;i<=o;i++){I++,C+=r[t*b+n*T+i]}C/=I;for(let t=m;t<=p;t++)for(let n=a;n<=l;n++)for(let i=e;i<=o;i++){const e=r[t*b+n*T+i]-C;_+=e*e}_/=I,_=Math.sqrt(_),u[i]={Modality:d.Modality,area:E,mean:C,stdDev:_}}else this.isHandleOutsideImage=!0,u[i]={Modality:d.Modality}}r.invalidated=!1;const v=a.Events.ANNOTATION_MODIFIED,p={annotation:e,viewportUID:l,renderingEngineUID:d,sceneUID:c};return(0,i.triggerEvent)(i.eventTarget,v,p),u},this._isInsideVolume=(e,t,n)=>i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=(0,Ve.A)(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,N.resetElementCursor)(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:i}=t;return i.active=!1,i.handles.activeHandleIndex=null,(0,k.A)(n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const i=e.indexOf(":"),o=e.substring(i+1);n=t.getViewport(o).getImageData()}else n=i.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}An.toolName="VideoRedaction"},39011:(e,t,n)=>{"use strict";n.d(t,{o:()=>c});var i=n(81985),o=n(99737),a=n(89578),s=n(39848);const{Active:r,Passive:l,Enabled:d}=o.ToolModes;const c=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))break}this._animationFrameSet=!1,this._animationFrameHandle=null,this._render()},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,i.getEnabledElement)(e);if(!t)return;if(!(0,i.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=(0,s.A)(e,[r,l,d]),{renderingEngineId:c,viewportId:h}=t,g={element:e,renderingEngineId:c,viewportId:h};(0,a.draw)(e,(a=>{let s=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,a);s=s||n}})),s&&(0,i.triggerEvent)(e,o.Events.ANNOTATION_RENDERED,{...g})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}}},67013:(e,t,n)=>{"use strict";n.d(t,{H:()=>a});var i=n(81985);class o{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,i.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,i=this.annotations[n];i&&Object.keys(i).forEach((e=>{i[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]?n[e][t]:[]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){const n=i[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(const e in n)i+=n[e].length;return i},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:i,toolName:o}=n;t=t||i;const a=this.annotations;let s=a[t];s||(a[t]={},s=a[t]);let r=s[o];r||(s[o]=[],r=s[o]),this.preprocessingFn&&(e=this.preprocessingFn(e)),r.push(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const i=t[n];for(const t in i){const n=i[t],o=n.findIndex((t=>t.annotationUID===e));-1!==o&&(n.splice(o,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations,i=[];if(!n[e])return i;if(t){const o=n[e][t];for(const e of o)this.removeAnnotation(e.annotationUID),i.push(e)}else for(const t in n[e]){const o=n[e][t];for(const e of o)this.removeAnnotation(e.annotationUID),i.push(e)}return i},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const i=n[e];if(!i)return;const o=i[t];return structuredClone(o)}if(e){const t=n[e];return structuredClone(t)}return structuredClone(n)},this.restoreAnnotations=(e,t,n)=>{const i=this.annotations;if(t&&n){let o=i[t];o||(i[t]={},o=i[t]),o[n]=e}else t?i[t]=e:this.annotations=structuredClone(e)},this.getAllAnnotations=()=>Object.values(this.annotations).map((e=>Object.values(e))).flat(2),this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){e+=i[t].length}}return e},this.removeAllAnnotations=()=>{const e=[];for(const t of this.getAllAnnotations())this.removeAnnotation(t.annotationUID),e.push(t);return e},e||(e=i.utilities.uuidv4()),this.annotations={},this.uid=e,i.eventTarget.addEventListener(i.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}setPreprocessingFn(e){this.preprocessingFn=e}}const a=new o("DEFAULT")},2076:(e,t,n)=>{"use strict";n.d(t,{checkAndSetAnnotationLocked:()=>d,isAnnotationLocked:()=>l});var i=n(81985),o=n(99737),a=n(69059);const s=new Set;function r(e,t=!0){const n=c();e&&(t?function(e,t,n){if(!t.has(e)){t.add(e),n.added.push(e);const i=(0,a.g)(e);i&&(i.isLocked=!0)}}(e,s,n):h(e,s,n)),g(n,s)}function l(e){return s.has(e)}function d(e){const t=l(e);return r(e,t),t}function c(){return Object.freeze({added:[],removed:[],locked:[]})}function h(e,t,n){if(t.delete(e)){n.removed.push(e);const t=(0,a.g)(e);t&&(t.isLocked=!1)}}function g(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_LOCK_CHANGE,e))}},17343:(e,t,n)=>{"use strict";n.d(t,{deselectAnnotation:()=>l,isAnnotationSelected:()=>d,setAnnotationSelected:()=>r});var i=n(81985),o=n(99737),a=n(69059);const s=new Set;function r(e,t=!0,n=!1){t?function(e,t=!1){const n=c();if(!t){h(s,n);const t=(0,a.g)(e);t&&(t.isSelected=!0)}if(e&&!s.has(e)){s.add(e),n.added.push(e);const t=(0,a.g)(e);t&&(t.isSelected=!0)}g(n,s)}(e,n):l(e)}function l(e){const t=c();if(e){if(s.delete(e)){t.removed.push(e);(0,a.g)(e).isSelected=!1}}else h(s,t);g(t,s)}function d(e){return s.has(e)}function c(){return Object.freeze({added:[],removed:[],selection:[]})}function h(e,t){e.forEach((n=>{if(e.delete(n)){t.removed.push(n);const e=(0,a.g)(n);e&&(e.isSelected=!1)}}))}function g(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_SELECTION_CHANGE,e))}},82056:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addAnnotation:()=>I,addChildAnnotation:()=>f,clearParentAnnotation:()=>p,getAllAnnotations:()=>v,getAnnotation:()=>a.g,getAnnotationManager:()=>h,getAnnotations:()=>m,getChildAnnotations:()=>E,getNumberOfAnnotations:()=>C,getParentAnnotation:()=>w,invalidateAnnotation:()=>S,removeAllAnnotations:()=>T,removeAnnotation:()=>_,removeAnnotations:()=>b,resetAnnotationManager:()=>u,setAnnotationManager:()=>g});var i=n(81985),o=n(67013),a=n(69059),s=n(44049),r=n(2076),l=n(82107),d=n(29601);let c=o.H;function h(){return c}function g(e){c=e}function u(){c=o.H}function m(e,t){const n=h(),i=n.getGroupKey(t);return n.getAnnotations(i,e)}function v(){return h().getAllAnnotations()}function p(e){const{annotationUID:t,parentAnnotationUID:n}=e;if(!n)return;const i=(0,a.g)(n),o=i.childAnnotationUIDs.indexOf(t);i.childAnnotationUIDs.splice(o,1),e.parentAnnotationUID=void 0}function f(e,t){const{annotationUID:n}=e,{annotationUID:i}=t;p(t),e.childAnnotationUIDs||(e.childAnnotationUIDs=[]),e.childAnnotationUIDs.includes(i)||(e.childAnnotationUIDs.push(i),t.parentAnnotationUID=n)}function w(e){return e.parentAnnotationUID?(0,a.g)(e.parentAnnotationUID):void 0}function E(e){return e.childAnnotationUIDs?.map((e=>(0,a.g)(e)))??[]}function I(e,t){e.annotationUID||(e.annotationUID=i.utilities.uuidv4());const n=h();if(t instanceof HTMLDivElement){const i=n.getGroupKey(t);n.addAnnotation(e,i),(0,s.$f)(e,t)}else n.addAnnotation(e,void 0),(0,s._3)(e);return e.annotationUID}function C(e,t){const n=h(),i=n.getGroupKey(t);return n.getNumberOfAnnotations(i,e)}function _(e){if(!e)return;const t=h(),n=t.getAnnotation(e);n&&(n.childAnnotationUIDs?.forEach((e=>_(e))),t.removeAnnotation(e),(0,s.SH)({annotation:n,annotationManagerUID:t.uid}))}function T(){const e=h(),t=e.removeAllAnnotations();for(const n of t)(0,s.SH)({annotation:n,annotationManagerUID:e.uid})}function b(e,t){const n=h(),i=n.getGroupKey(t),o=n.removeAnnotations(i,e);for(const e of o)(0,s.SH)({annotation:e,annotationManagerUID:n.uid})}function S(e){let t=e;for(;t;)t.invalidated=!0,t=t.parentAnnotationUID?(0,a.g)(t.parentAnnotationUID):void 0}c.setPreprocessingFn((e=>{e=(0,l.Q)(e);const t=(e=(0,l.d)(e)).annotationUID,n=(0,r.checkAndSetAnnotationLocked)(t);e.isLocked=n;const i=(0,d.checkAndSetAnnotationVisibility)(t);return e.isVisible=i,e}))},29601:(e,t,n)=>{"use strict";n.d(t,{checkAndSetAnnotationVisibility:()=>u,isAnnotationVisible:()=>d});var i=n(81985),o=n(99737),a=n(17343),s=n(69059);const r=new Set;function l(e,t=!0){const n=c();e&&(t?h(e,r,n):function(e,t,n){t.has(e)||(t.add(e),(0,a.isAnnotationSelected)(e)&&(0,a.deselectAnnotation)(e),n.lastHidden.push(e))}(e,r,n)),g(n)}function d(e){if((0,s.g)(e))return!r.has(e)}function c(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function h(e,t,n){if(t.delete(e)){n.lastVisible.push(e);(0,s.g)(e).isVisible=!0}}function g(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(r.forEach((t=>{e.hidden.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_VISIBILITY_CHANGE,e))}function u(e){const t=!r.has(e);return l(e,t),t}},8710:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(209, 193, 90)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(209, 193, 90)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:i,toolGroupId:o,toolName:a}=t;return this._getToolStyle(e,n,i,o,a)}_getToolStyle(e,t,n,i,o){if(t){const n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(i){const t=this.getToolGroupToolStyles(i);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[o]&&void 0!==a[o][e]?a[o][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}}},76712:(e,t,n)=>{"use strict";n.d(t,{h:()=>o});var i=n(8710);function o(e,t,n,o){const a=function(e,t,n){const i=[`${e}`];return t&&i.push(`${i[0]}${t}`),n&&i.push(`${i[i.length-1]}${n}`),i}(e,n,o);for(let e=a.length-1;e>=0;--e){const n=i.A.getStyleProperty(a[e],t);if(void 0!==n)return n}}},49310:(e,t,n)=>{"use strict";n.d(t,{getState:()=>s,style:()=>r.A});var i=n(2076),o=n(17343),a=n(99737);const s=function(e){if(e){if(e.data&&e.highlighted)return a.AnnotationStyleStates.Highlighted;if((0,o.isAnnotationSelected)(e.annotationUID))return a.AnnotationStyleStates.Selected;if((0,i.isAnnotationLocked)(e.annotationUID))return a.AnnotationStyleStates.Locked;if(e.data&&e.autoGenerated)return a.AnnotationStyleStates.AutoGenerated}return a.AnnotationStyleStates.Default};n(76712);var r=n(8710)},69059:(e,t,n)=>{"use strict";n.d(t,{g:()=>o});var i=n(67013);function o(e){return i.H.getAnnotation(e)}},44049:(e,t,n)=>{"use strict";n.d(t,{$f:()=>s,PS:()=>h,SH:()=>l,XF:()=>d,_3:()=>r,dZ:()=>c});var i=n(81985),o=n(99737),a=n(7754);function s(e,t){const n=(0,i.getEnabledElement)(t),{renderingEngine:a,viewportId:s}=n,r=o.Events.ANNOTATION_ADDED,l={annotation:e,viewportId:s,renderingEngineId:a.id};(0,i.triggerEvent)(i.eventTarget,r,l)}function r(e){const{toolName:t}=e.metadata,n=(0,a.getToolGroupsWithToolName)(t);if(!n.length)return;const s=[];n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:o}=t,{FrameOfReferenceUID:a}=(0,i.getEnabledElementByIds)(o,n);e.metadata.FrameOfReferenceUID===a&&s.push(t)}))}));const r=o.Events.ANNOTATION_ADDED,l={annotation:e};s.length?s.forEach((({renderingEngineId:e,viewportId:t})=>{l.viewportId=t,l.renderingEngineId=e,(0,i.triggerEvent)(i.eventTarget,r,l)})):(0,i.triggerEvent)(i.eventTarget,r,l)}function l(e){const t=o.Events.ANNOTATION_REMOVED;(0,i.triggerEvent)(i.eventTarget,t,e)}function d(e,t,n=o.ChangeTypes.HandlesUpdated){const a=(0,i.getEnabledElement)(t),{viewportId:s,renderingEngineId:r}=a,l=o.Events.ANNOTATION_MODIFIED,d={annotation:e,viewportId:s,renderingEngineId:r,changeType:n};(0,i.triggerEvent)(i.eventTarget,l,d)}function c(e){g({annotation:e})}function h(e,t=!1){g({annotation:e,contourHoleProcessingEnabled:t})}function g(e){const t=o.Events.ANNOTATION_COMPLETED;(0,i.triggerEvent)(i.eventTarget,t,e)}},47807:(e,t,n)=>{"use strict";n.d(t,{config:()=>i,state:()=>o});var i=n(49310),o=(n(2076),n(17343),n(82056));n(29601),n(67013),n(81985),n(94021)},24917:(e,t,n)=>{"use strict";n.d(t,{fy:()=>f,h6:()=>p});var i=n(81985),o=n(99737),a=n(18682),s=n(93210),r=n(67014),l=n(25894),d=n(684),c=n(68040),h=n(85204),g=n(37590),u=n(7754);const m={[a.A.Labelmap]:d.Ay,[a.A.Contour]:l.A,[a.A.Surface]:r.Ay},v=g.A.toolName;function p(e){w.renderSegmentationsForViewport(e)}function f(e){w.renderSegmentation(e)}const w=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._getAllViewports=()=>(0,i.getRenderingEngines)().flatMap((e=>e.getViewports())),this._renderFlaggedSegmentations=()=>{this._throwIfDestroyed();Array.from(this._needsRender).forEach((e=>{this._triggerRender(e)})),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}}renderSegmentationsForViewport(e){const t=e?[e]:this._getViewportIdsForSegmentation();this._setViewportsToBeRenderedNextFrame(t)}renderSegmentation(e){const t=this._getViewportIdsForSegmentation(e);this._setViewportsToBeRenderedNextFrame(t)}_getViewportIdsForSegmentation(e){const t=this._getAllViewports(),n=[];for(const i of t){const t=i.id;if(e){const i=(0,s.r$)(t,{segmentationId:e});i?.length>0&&n.push(t)}else{const e=(0,s.r$)(t);e?.length>0&&n.push(t)}}return n}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setViewportsToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedSegmentations),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,s.r$)(e);if(!t?.length)return;const{viewport:n}=(0,i.getEnabledElementByViewportId)(e)||{};if(!n)return;const a=[],r=t.map((e=>{e.type===o.SegmentationRepresentations.Contour&&this._addPlanarFreeHandToolIfAbsent(n);const t=m[e.type];try{const i=t.render(n,e);a.push(i)}catch(e){console.error(e)}return Promise.resolve({segmentationId:e.segmentationId,type:e.type})}));Promise.allSettled(r).then((e=>{const t=e.filter((e=>"fulfilled"===e.status)).map((e=>e.value));n.element.addEventListener(i.Enums.Events.IMAGE_RENDERED,(function e(n){const{element:a,viewportId:s}=n.detail;a.removeEventListener(i.Enums.Events.IMAGE_RENDERED,e),t.forEach((e=>{const t={viewportId:s,segmentationId:e.segmentationId,type:e.type};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_RENDERED,{...t})}))})),n.render()}))}_addPlanarFreeHandToolIfAbsent(e){v in h.wk.tools||(0,c.Gx)(g.A);const t=(0,u.getToolGroupForViewport)(e.id);t.hasTool(v)||(t.addTool(v),t.setToolPassive(v))}}},59475:(e,t,n)=>{"use strict";n.d(t,{Zm:()=>h,_6:()=>m,cC:()=>g});var i=n(81985),o=n(99737),a=n(33739),s=n(99341),r=n(49906),l=n(92686),d=n(75419);const c={colorLUT:[],segmentations:[],viewportSegRepresentations:{}};async function h({imageIds:e,options:t}){const n=e,o=t?.volumeId||i.utilities.uuidv4();return await i.volumeLoader.createAndCacheVolumeFromImages(o,n),{volumeId:o}}async function g({segmentationId:e,options:t}){const n=m.getSegmentation(e),i=n.representationData.Labelmap,{volumeId:o}=await h({imageIds:i.imageIds,options:t});n.representationData.Labelmap.volumeId=o}function u(e){const t=a.Ay.newInstance(),n=s.Ay.newInstance();return n.addPoint(0,0),e===o.SegmentationRepresentations.Labelmap?{cfun:t,ofun:n}:{}}const m=new class{constructor(e){this._stackLabelmapImageIdReferenceMap=new Map,e||=i.utilities.uuidv4(),this.state=Object.freeze(i.utilities.deepClone(c)),this.uid=e}getState(){return this.state}updateState(e){const t=i.utilities.deepClone(this.state);e(t),this.state=Object.freeze(t)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this.state=Object.freeze(i.utilities.deepClone(c))}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}updateSegmentation(e,t){this.updateState((n=>{const i=n.segmentations.find((t=>t.segmentationId===e));i?Object.assign(i,t):console.warn(`Segmentation with id ${e} not found. Update aborted.`)})),(0,r.triggerSegmentationModified)(e)}addSegmentation(e){if(this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.updateState((t=>{const n=i.utilities.deepClone(e);if(n.representationData.Labelmap&&"volumeId"in n.representationData.Labelmap&&!("imageIds"in n.representationData.Labelmap)){const e=this.getLabelmapImageIds(n.representationData);n.representationData.Labelmap.imageIds=e}t.segmentations.push(n)})),(0,d.R)(e.segmentationId)}removeSegmentation(e){this.updateState((t=>{const n=t.segmentations.filter((t=>t.segmentationId!==e));t.segmentations.splice(0,t.segmentations.length,...n)})),(0,r.triggerSegmentationRemoved)(e)}addSegmentationRepresentation(e,t,n,a){if(!(0,i.getEnabledElementByViewportId)(e))return;this.getSegmentationRepresentations(e,{type:n,segmentationId:t}).length>0?console.debug("A segmentation representation of type",n,"already exists in viewport",e,"for segmentation",t):(this.updateState((i=>{i.viewportSegRepresentations[e]||(i.viewportSegRepresentations[e]=[],l.Y.setRenderInactiveSegmentations(e,!0)),n!==o.SegmentationRepresentations.Labelmap?this.addDefaultSegmentationRepresentation(i,e,t,n,a):this.addLabelmapRepresentation(i,e,t,a)})),(0,r.triggerSegmentationRepresentationModified)(e,t,n))}addDefaultSegmentationRepresentation(e,t,n,i,o){const a=e.segmentations.find((e=>e.segmentationId===n));if(!a)return;const s={};Object.keys(a.segments).forEach((e=>{s[Number(e)]={visible:!0}})),e.viewportSegRepresentations[t].push({segmentationId:n,type:i,active:!0,visible:!0,colorLUTIndex:0,segments:s,config:{...u(i),...o}}),this._setActiveSegmentation(e,t,n)}addLabelmapRepresentation(e,t,n,a=u(o.SegmentationRepresentations.Labelmap)){if(!(0,i.getEnabledElementByViewportId)(t))return;const s=this.getSegmentation(n);if(!s)return;const{representationData:r}=s;if(!r.Labelmap)return this.addDefaultSegmentationRepresentation(e,t,n,o.SegmentationRepresentations.Labelmap,a);this.processLabelmapRepresentationAddition(t,n),this.addDefaultSegmentationRepresentation(e,t,n,o.SegmentationRepresentations.Labelmap,a)}async processLabelmapRepresentationAddition(e,t){const n=(0,i.getEnabledElementByViewportId)(e);if(!n)return;const o=this.getSegmentation(t);if(!o)return;const a=n.viewport instanceof i.BaseVolumeViewport,{representationData:s}=o,r="volumeId"in s.Labelmap;n.viewport;a||r||this.updateLabelmapSegmentationImageReferences(e,o.segmentationId)}_updateLabelmapSegmentationReferences(e,t,n,i){const o=t.getCurrentImageId();let a=!1;for(const i of n){t.isReferenceViewable({referencedImageId:i},{asOverlay:!0})&&(a=!0,this._stackLabelmapImageIdReferenceMap.get(e).set(o,i))}return i&&i(t,e,n),a?this._stackLabelmapImageIdReferenceMap.get(e).get(o):void 0}updateLabelmapSegmentationImageReferences(e,t){const n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);const{representationData:o}=n;if(!o.Labelmap)return;const a=this.getLabelmapImageIds(o),s=(0,i.getEnabledElementByViewportId)(e).viewport;return this._updateLabelmapSegmentationReferences(t,s,a,null)}_updateAllLabelmapSegmentationImageReferences(e,t){const n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);const{representationData:o}=n;if(!o.Labelmap)return;const a=this.getLabelmapImageIds(o),s=(0,i.getEnabledElementByViewportId)(e).viewport;this._updateLabelmapSegmentationReferences(t,s,a,((e,t,n)=>{e.getImageIds().forEach(((i,o)=>{for(const a of n){e.isReferenceViewable({referencedImageId:a,sliceIndex:o},{asOverlay:!0,withNavigation:!0})&&this._stackLabelmapImageIdReferenceMap.get(t).set(i,a)}}))}))}getLabelmapImageIds(e){const t=e.Labelmap;let n;if(t.imageIds)n=t.imageIds;else if(!n&&t.volumeId){const e=t.volumeId;n=i.cache.getVolume(e).imageIds}return n}getCurrentLabelmapImageIdForViewport(e,t){const n=(0,i.getEnabledElementByViewportId)(e);if(!n)return;if(!this._stackLabelmapImageIdReferenceMap.has(t))return;const o=n.viewport.getCurrentImageId();return this._stackLabelmapImageIdReferenceMap.get(t).get(o)}getStackSegmentationImageIdsForViewport(e,t){if(!this.getSegmentation(t))return[];this._updateAllLabelmapSegmentationImageReferences(e,t);const{viewport:n}=(0,i.getEnabledElementByViewportId)(e),o=n.getImageIds(),a=this._stackLabelmapImageIdReferenceMap.get(t);return o.map((e=>a.get(e)))}removeSegmentationRepresentationsInternal(e,t){const n=[];return this.updateState((i=>{if(!i.viewportSegRepresentations[e])return;const o=i.viewportSegRepresentations[e];let a=!1;if(!t||Object.values(t).every((e=>void 0===e)))n.push(...o),delete i.viewportSegRepresentations[e];else{const{segmentationId:s,type:r}=t;i.viewportSegRepresentations[e]=o.filter((e=>{const t=s&&r&&e.segmentationId===s&&e.type===r||s&&!r&&e.segmentationId===s||!s&&r&&e.type===r;return t&&(n.push(e),e.active&&(a=!0)),!t})),0===i.viewportSegRepresentations[e].length?delete i.viewportSegRepresentations[e]:a&&(i.viewportSegRepresentations[e][0].active=!0)}})),n}removeSegmentationRepresentations(e,t){const n=this.removeSegmentationRepresentationsInternal(e,t);n.forEach((t=>{(0,r.triggerSegmentationRepresentationRemoved)(e,t.segmentationId,t.type)}));const i=this.getSegmentationRepresentations(e);return i.length>0&&i[0].active&&(0,r.triggerSegmentationRepresentationModified)(e,i[0].segmentationId,i[0].type),n}removeSegmentationRepresentation(e,t,n){const i=this.removeSegmentationRepresentationsInternal(e,t);return n||i.forEach((({segmentationId:t,type:n})=>{(0,r.triggerSegmentationRepresentationRemoved)(e,t,n)})),i}_setActiveSegmentation(e,t,n){const i=e.viewportSegRepresentations[t];i&&i.forEach((e=>{e.active=e.segmentationId===n}))}setActiveSegmentation(e,t){this.updateState((n=>{const i=n.viewportSegRepresentations[e];i&&i.forEach((e=>{e.active=e.segmentationId===t}))})),(0,r.triggerSegmentationRepresentationModified)(e,t)}getActiveSegmentation(e){if(!this.state.viewportSegRepresentations[e])return;const t=this.state.viewportSegRepresentations[e].find((e=>e.active));return t?this.getSegmentation(t.segmentationId):void 0}getSegmentationRepresentations(e,t={}){const n=this.state.viewportSegRepresentations[e];return n?t.type||t.segmentationId?n.filter((e=>{const n=!t.type||e.type===t.type,i=!t.segmentationId||e.segmentationId===t.segmentationId;return n&&i})):n:[]}getSegmentationRepresentation(e,t){return this.getSegmentationRepresentations(e,t)[0]}getSegmentationRepresentationVisibility(e,t){const n=this.getSegmentationRepresentation(e,t);return n?.visible}setSegmentationRepresentationVisibility(e,t,n){this.updateState((i=>{const o=this.getSegmentationRepresentations(e,t);o&&o.forEach((e=>{e.visible=n,Object.entries(e.segments).forEach((([e,t])=>{t.visible=n}))}))})),(0,r.triggerSegmentationRepresentationModified)(e,t.segmentationId,t.type)}addColorLUT(e,t){this.updateState((n=>{n.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),n.colorLUT[t]=i.utilities.deepClone(e)}))}removeColorLUT(e){this.updateState((t=>{delete t.colorLUT[e]}))}_getStackIdForImageIds(e){return e.map((e=>e.slice(-Math.round(.15*e.length)))).join("_")}getAllViewportSegmentationRepresentations(){return Object.entries(this.state.viewportSegRepresentations).map((([e,t])=>({viewportId:e,representations:t})))}getSegmentationRepresentationsBySegmentationId(e){const t=[];return Object.entries(this.state.viewportSegRepresentations).forEach((([n,i])=>{const o=i.filter((t=>t.segmentationId===e));o.length>0&&t.push({viewportId:n,representations:o})})),t}}("DEFAULT")},92686:(e,t,n)=>{"use strict";n.d(t,{Y:()=>r});var i=n(67772),o=n(53486),a=n(99737),s=n(81985);const r=new class{constructor(){this.config={global:{},segmentations:{},viewportsStyle:{}}}setStyle(e,t){const{viewportId:n,segmentationId:i,type:o,segmentIndex:a}=e,s=this.getStyle(e);let r;if(r=n||i?this.copyActiveToInactiveIfNotProvided({...s,...t},o):{...s,...t},!o)throw new Error("Type is required to set a style");if(n){this.config.viewportsStyle[n]||(this.config.viewportsStyle[n]={renderInactiveSegmentations:!1,representations:{}});const e=this.config.viewportsStyle[n].representations;if(i){e[i]||(e[i]={}),e[i][o]||(e[i][o]={});const t=e[i][o];void 0!==a?(t.perSegment||(t.perSegment={}),t.perSegment[a]=r):t.allSegments=r}else{const t="__allSegmentations__";e[t]||(e[t]={}),e[t][o]||(e[t][o]={}),e[t][o].allSegments=r}}else if(i){this.config.segmentations[i]||(this.config.segmentations[i]={}),this.config.segmentations[i][o]||(this.config.segmentations[i][o]={});const e=this.config.segmentations[i][o];void 0!==a?(e.perSegment||(e.perSegment={}),e.perSegment[a]=r):e.allSegments=r}else this.config.global[o]=r}copyActiveToInactiveIfNotProvided(e,t){const n={...e};if(t===a.SegmentationRepresentations.Labelmap){const e=n;e.renderOutlineInactive=e.renderOutline,e.outlineWidthInactive=e.outlineWidth,e.renderFillInactive=e.renderFill,e.fillAlphaInactive=e.fillAlpha,e.outlineOpacityInactive=e.outlineOpacity}else if(t===a.SegmentationRepresentations.Contour){const e=n;e.outlineWidthInactive=e.outlineWidth,e.outlineOpacityInactive=e.outlineOpacity,e.outlineDashInactive=e.outlineDash,e.renderOutlineInactive=e.renderOutline,e.renderFillInactive=e.renderFill,e.fillAlphaInactive=e.fillAlpha}return n}getStyle(e){const{viewportId:t,segmentationId:n,type:i,segmentIndex:o}=e;let a=this.getDefaultStyle(i),s=!1;if(this.config.global[i]&&(a={...a,...this.config.global[i]}),this.config.segmentations[n]?.[i]&&(a={...a,...this.config.segmentations[n][i].allSegments},void 0!==o&&this.config.segmentations[n][i].perSegment?.[o]&&(a={...a,...this.config.segmentations[n][i].perSegment[o]})),t&&this.config.viewportsStyle[t]){s=this.config.viewportsStyle[t].renderInactiveSegmentations;const e="__allSegmentations__";this.config.viewportsStyle[t].representations[e]?.[i]&&(a={...a,...this.config.viewportsStyle[t].representations[e][i].allSegments}),n&&this.config.viewportsStyle[t].representations[n]?.[i]&&(a={...a,...this.config.viewportsStyle[t].representations[n][i].allSegments},void 0!==o&&this.config.viewportsStyle[t].representations[n][i].perSegment?.[o]&&(a={...a,...this.config.viewportsStyle[t].representations[n][i].perSegment[o]}))}return a}getRenderInactiveSegmentations(e){return this.config.viewportsStyle[e]?.renderInactiveSegmentations}setRenderInactiveSegmentations(e,t){this.config.viewportsStyle[e]||(this.config.viewportsStyle[e]={renderInactiveSegmentations:!1,representations:{}}),this.config.viewportsStyle[e].renderInactiveSegmentations=t}getDefaultStyle(e){switch(e){case a.SegmentationRepresentations.Labelmap:return(0,o.A)();case a.SegmentationRepresentations.Contour:return(0,i.A)();case a.SegmentationRepresentations.Surface:return{};default:throw new Error(`Unknown representation type: ${e}`)}}clearSegmentationStyle(e){this.config.segmentations[e]&&delete this.config.segmentations[e]}clearAllSegmentationStyles(){this.config.segmentations={}}clearViewportStyle(e){this.config.viewportsStyle[e]&&delete this.config.viewportsStyle[e]}clearAllViewportStyles(){for(const e in this.config.viewportsStyle){const t=this.config.viewportsStyle[e].renderInactiveSegmentations;this.config.viewportsStyle[e]={renderInactiveSegmentations:t,representations:{}}}}resetToGlobalStyle(){this.clearAllSegmentationStyles(),this.clearAllViewportStyles()}hasCustomStyle(e){const{type:t}=e,n=this.getStyle(e),i=this.getDefaultStyle(t);return!s.utilities.deepEqual(n,i)}}},26228:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getActiveSegmentation:()=>a,setActiveSegmentation:()=>s});var i=n(67165),o=n(59475);function a(e){return(0,i.T)(e)}function s(e,t,n=!1){!function(e,t){o._6.setActiveSegmentation(e,t)}(e,t)}},4714:(e,t,n)=>{"use strict";n.d(t,{u:()=>r});var i=n(81985),o=n(59475),a=n(70906),s=n(93952);function r(e,t){const n=o._6,r=t??(0,a.u)();let l=[...e];if(i.utilities.isEqual(l[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),l=[[0,0,0,0],...l]),l=l.map((e=>3===e.length?[e[0],e[1],e[2],255]:e)),l.length<255){const e=s.A.slice(l.length);l=[...l,...e]}return n.addColorLUT(l,r),r}},38816:(e,t,n)=>{"use strict";n.d(t,{gR:()=>g});var i=n(99737),o=n(93952),a=n(58640),s=n(49906),r=n(4714),l=n(70906),d=n(59475),c=n(50409);function h(e){const{colorLUTOrIndex:t}=e||{},n="number"==typeof t,i=n?(0,c.B)(t):o.A,a=n?t:(0,l.u)();return n||(0,r.u)(i,a),a}function g(e,t){t.map((t=>function(e,t){const{segmentationId:n,config:o}=t,r={colorLUTIndex:h(o)};d._6.addSegmentationRepresentation(e,n,t.type,r),t.type===i.SegmentationRepresentations.Contour&&(0,a.t)([e]),(0,s.triggerSegmentationModified)(n)}(e,t)))}},30935:(e,t,n)=>{"use strict";n(59475),n(49906),n(99737),n(81985)},93733:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addColorLUT:()=>r,getSegmentIndexColor:()=>d,setColorLUT:()=>l,setSegmentIndexColor:()=>c});var i=n(4714),o=n(50409),a=n(93210),s=n(49906);function r(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");return(0,i.u)(e,t)}function l(e,t,n){if(!(0,o.B)(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);const i=(0,a.r$)(e,{segmentationId:t});if(!i)throw new Error(`viewport specific state for viewport ${e} does not exist`);i.forEach((e=>{e.colorLUTIndex=n})),(0,s.triggerSegmentationRepresentationModified)(e,t)}function d(e,t,n){const i=(0,a.r$)(e,{segmentationId:t});if(!i||0===i.length)return null;const s=i[0],{colorLUTIndex:r}=s,l=(0,o.B)(r);let d=l[n];if(!d){if("number"!=typeof n)throw new Error(`Can't create colour for LUT index ${n}`);d=l[n]=[0,0,0,0]}return d}function c(e,t,n,i){const o=d(e,t,n);for(let e=0;e<i.length;e++)o[e]=i[e];(0,s.triggerSegmentationRepresentationModified)(e,t)}},98798:(e,t,n)=>{"use strict";n.d(t,{Q:()=>s});var i=n(81985),o=n(99737),a=n(64063);function s(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,a.HM)(e),(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_DATA_MODIFIED,n)}},60740:(e,t,n)=>{"use strict";n.d(t,{Q:()=>o});var i=n(33283);function o(e){const t=(0,i.T)(e);if(t){const e=Object.keys(t.segments).find((e=>t.segments[e].active));return e?Number(e):void 0}}},67165:(e,t,n)=>{"use strict";n.d(t,{T:()=>o});var i=n(59475);function o(e){return i._6.getActiveSegmentation(e)}},50409:(e,t,n)=>{"use strict";n.d(t,{B:()=>o});var i=n(59475);function o(e){return i._6.getColorLUT(e)}},97577:(e,t,n)=>{"use strict";n.d(t,{v:()=>o});var i=n(59475);function o(e,t){return i._6.getCurrentLabelmapImageIdForViewport(e,t)}},70906:(e,t,n)=>{"use strict";n.d(t,{u:()=>o});var i=n(59475);function o(){return i._6.getNextColorLUTIndex()}},93210:(e,t,n)=>{"use strict";n.d(t,{Ut:()=>a,r$:()=>o});var i=n(59475);function o(e,t={}){return i._6.getSegmentationRepresentations(e,t)}function a(e,t){const n=i._6;if(!t.segmentationId||!t.type)throw new Error("getSegmentationRepresentation: No segmentationId or type provided, you need to provide at least one of them");const o=n.getSegmentationRepresentations(e,t);return o?.[0]}},33658:(e,t,n)=>{"use strict";n.d(t,{I:()=>o});var i=n(59475);function o(e,t){return i._6.getSegmentationRepresentationVisibility(e,t)}},70758:(e,t,n)=>{"use strict";n.d(t,{K:()=>o});var i=n(59475);function o(){return i._6.getState().segmentations}},58859:(e,t,n)=>{"use strict";n.d(t,{P:()=>o});var i=n(59475);function o(e){const t=i._6.getState().viewportSegRepresentations;return Object.entries(t).filter((([,t])=>t.some((t=>t.segmentationId===e)))).map((([e])=>e))}},42568:(e,t,n)=>{"use strict";n(33283),n(59475)},6994:(e,t,n)=>{"use strict";n.d(t,{a:()=>o});var i=n(59475);async function o(e){return(0,i.Zm)(e)}},1300:(e,t,n)=>{"use strict";n.d(t,{activeSegmentation:()=>a,addSegmentationRepresentations:()=>o.gR,config:()=>i,segmentIndex:()=>l,segmentLocking:()=>s});var i={};n.r(i),n.d(i,{color:()=>r});n(53662);var o=n(38816);n(30935),n(59475),n(49906);var a=n(26228),s=n(26795),r=(n(98870),n(93733));n(93210);n(33658),n(24917);n(70758),n(42568),n(92686);var l=n(70930),d=n(6273),c=n(6994);n(58062),n(79462),n(13654),n(69073),n(81985),n(33283);var h=n(21);n(60740),n(58859);n(63427);d.p,c.a,h.f},13654:(e,t,n)=>{"use strict";n.d(t,{D:()=>s});var i=n(99737),o=n(56005),a=n(75499);function s(e,t={}){return(0,o.d)(e,i.SegmentationRepresentations.Contour,(()=>(0,a.c)(e,t)),(()=>{}))}},79462:(e,t,n)=>{"use strict";n.d(t,{z:()=>l});var i=n(99737),o=n(56005),a=n(89661),s=n(59475),r=n(49906);async function l(e,t={}){return(0,o.d)(e,i.SegmentationRepresentations.Labelmap,(()=>(0,a.Y)(e,t)),(()=>null),(()=>{s._6.processLabelmapRepresentationAddition(t.viewport.id,e),setTimeout((()=>{(0,r.triggerSegmentationDataModified)(e)}),0)}))}},58062:(e,t,n)=>{"use strict";n.d(t,{o:()=>u});var i=n(99737),o=n(56005),a=n(42867),s=n(81985),r=n(25758),l=n(58859),d=n(33283),c=n(49906),h=n(93210),g=n(85884);function u(e,t={}){return(0,o.d)(e,i.SegmentationRepresentations.Surface,(()=>(0,a.HN)(e,t)),(()=>async function(e){const t=await(0,a.HE)(e);if(!t)return;const n=(0,d.T)(e),o=(0,r.O)(e);if(!o.length)return n.representationData.Surface.geometryIds.forEach((e=>{const t=s.cache.getGeometry(e).data;t.points=[],t.polys=[]})),void(0,c.triggerSegmentationModified)(e);const u=t.map((({data:t,segmentIndex:a})=>{const r=`segmentation_${e}_surface_${a}`,d=s.cache.getGeometry(r);if(!d)return(0,l.P)(e).map((o=>[(0,h.Ut)(o,{segmentationId:e,type:i.SegmentationRepresentations.Surface})].map((i=>(n.representationData.Surface.geometryIds.set(a,r),(0,g.Y)(e,[{segmentIndex:a,data:t}],{segmentationId:i.segmentationId}))))));if(o.includes(a)){const e=d.data;e.points=t.points,e.polys=t.polys}else{const e=d.data;e.points=[],e.polys=[]}}));await Promise.all(u),(0,c.triggerSegmentationModified)(e)}(e)))}},85884:(e,t,n)=>{"use strict";n.d(t,{Y:()=>s});var i=n(81985),o=n(93733),a=n(33283);async function s(e,t,n={}){const s=(0,a.T)(e),r=new Map,l=Object.keys(t).map((async e=>{const a=t[e],l=a.segmentIndex,d=(0,o.getSegmentIndexColor)(n.viewport.id,s.segmentationId,l).slice(0,3);if(!d)throw new Error("No color found for segment index, unable to create surface");const c={id:`segmentation_${s.segmentationId}_surface_${l}`,color:d,frameOfReferenceUID:"test-frameOfReferenceUID",points:a.data.points,polys:a.data.polys,segmentIndex:l},h=c.id;return r.set(l,h),i.geometryLoader.createAndCacheGeometry(h,{type:i.Enums.GeometryType.SURFACE,geometryData:c})}));return await Promise.all(l),{geometryIds:r}}},42867:(e,t,n)=>{"use strict";n.d(t,{HN:()=>m,HE:()=>v});var i=n(25758),o=n(33283),a=n(81985),s=n(82056),r=n(99737);const l=(0,a.getWebWorkerManager)(),d=(e,t,n)=>{(0,a.triggerEvent)(e,a.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:r.WorkerTypes.POLYSEG_CONTOUR_TO_SURFACE,id:n})};var c=n(85884),h=n(6994);const g=(0,a.getWebWorkerManager)(),u=(e,t,n)=>{(0,a.triggerEvent)(e,a.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:r.WorkerTypes.POLYSEG_LABELMAP_TO_SURFACE,id:n})};async function m(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,i.O)(e);let r;const h=(0,o.T)(e),g=h.representationData;try{g.Contour?r=await async function(e,t={}){const n=(0,o.T)(e),r=n.representationData.Contour,c=t.segmentIndices||(0,i.O)(e),h=c.map((async e=>{const t=await async function(e,t){const{annotationUIDsMap:n}=e,i=[],o=[],r=n.get(t);for(const e of r){const t=(0,s.getAnnotation)(e),{polyline:n}=t.data.contour;o.push(n.length),n.forEach((e=>i.push(...e)))}d(a.eventTarget,0,t);const c=await l.executeTask("polySeg","convertContourToSurface",{polylines:i,numPointsArray:o},{callbacks:[e=>{d(a.eventTarget,e,t)}]});return d(a.eventTarget,100,t),c}(r,e);return{segmentIndex:e,data:t}}));return await Promise.all(h)}(e,{segmentIndices:n,...t}):g.Labelmap&&(r=await v(h.segmentationId,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!r)throw new Error("Not enough data to convert to surface, currently only support converting volume labelmap to surface if available");return await(0,c.Y)(e,r,t)}async function v(e,t={}){const n=(0,o.T)(e);if(!n?.representationData?.Labelmap)return void console.warn("Only support surface update from labelmaps");const s=n.representationData.Labelmap,r=t.segmentIndices||(0,i.O)(e),l=r.map((e=>{const t=async function(e,t){let n;if(e.volumeId)n=e.volumeId;else{const{imageIds:t}=e;({volumeId:n}=await(0,h.a)({imageIds:t}))}const i=a.cache.getVolume(n),o=i.voxelManager.getCompleteScalarDataArray(),{dimensions:s,spacing:r,origin:l,direction:d}=i;u(a.eventTarget,0,t);const c=await g.executeTask("polySeg","convertLabelmapToSurface",{scalarData:o,dimensions:s,spacing:r,origin:l,direction:d,segmentIndex:t},{callbacks:[e=>{u(a.eventTarget,e,t)}]});return u(a.eventTarget,100,t),c}(s,e);return t})),d=await Promise.allSettled(l),c=d.filter((e=>"rejected"===e.status));if(c.length>0)throw console.error(c),new Error("Failed to convert labelmap to surface");return d.map(((e,t)=>{if("fulfilled"===e.status)return{segmentIndex:r[t],data:e.value}})).filter(Boolean)}},69073:(e,t,n)=>{"use strict";n.d(t,{n:()=>r});var i=n(99737),o=n(33283),a=n(6934);const s=new Map([[i.SegmentationRepresentations.Labelmap,new Set([i.SegmentationRepresentations.Surface,i.SegmentationRepresentations.Contour])],[i.SegmentationRepresentations.Contour,new Set([i.SegmentationRepresentations.Labelmap,i.SegmentationRepresentations.Surface])],[i.SegmentationRepresentations.Surface,new Set([i.SegmentationRepresentations.Labelmap])]]);function r(e,t){const{representationData:n}=(0,o.T)(e),r=function(e){const t=[];return Object.keys(e).forEach((n=>{const o=e[n];let s;if(n===i.SegmentationRepresentations.Labelmap)s=a.t;if(s)try{s(o),t.push(n)}catch(e){console.warn(`Validation failed for labelmap of type ${n}`)}else t.push(n)})),t}(n);return r.some((e=>async function(e,t){return s.get(e)?.has(t)||!1}(e,t)))}},56005:(e,t,n)=>{"use strict";n.d(t,{d:()=>c});var i=n(81985),o=n(99737),a=n(44188),s=n(49906),r=n(52905),l=n(31199);const d=new Map;async function c(e,t,n,r,c){(0,l.b)();const g=await n();(0,a.A)({segmentationId:e,type:t,data:g}),c?.(),d.has(e)||d.set(e,[]);const u=d.get(e);return u.includes(t)||u.push(t),function(e){const t=t=>{h(t,e)};e._debouncedUpdateFunction=t,i.eventTarget.removeEventListener(o.Events.SEGMENTATION_DATA_MODIFIED,e._debouncedUpdateFunction),i.eventTarget.addEventListener(o.Events.SEGMENTATION_DATA_MODIFIED,e._debouncedUpdateFunction)}(r),(0,s.triggerSegmentationModified)(e),g}const h=(0,r.A)(((e,t)=>{const n=e.detail.segmentationId,i=d.get(n);i&&i.length&&(t(n),i.length&&(0,s.triggerSegmentationModified)(n))}),300)},63427:(e,t,n)=>{"use strict";n(59475),n(49906),n(53662)},53662:(e,t,n)=>{"use strict";n(18682),n(684),n(25894),n(93210),n(81985),n(59475),n(67014)},70930:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getActiveSegmentIndex:()=>l.Q,setActiveSegmentIndex:()=>c});var i=n(7754),o=n(35706),a=n(33283),s=n(58859),r=n(49906),l=n(60740),d=n(93210);function c(e,t){const n=(0,a.T)(e);"string"==typeof t&&(console.warn("segmentIndex is a string, converting to number"),t=Number(t)),Object.values(n.segments).forEach((e=>{e.active=!1})),n.segments[t]||(n.segments[t]={segmentIndex:t,label:"",locked:!1,cachedStats:{},active:!1}),!0!==n.segments[t].active&&(n.segments[t].active=!0,(0,r.triggerSegmentationModified)(e));const l=(0,s.P)(e);l.forEach((n=>{(0,d.r$)(n,{segmentationId:e}).forEach((e=>{e.segments[t]||(e.segments[t]={visible:!0})}))})),l.forEach((e=>{const t=(0,i.getToolGroupForViewport)(e);(0,o.E)(t.id)}))}},26795:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getLockedSegmentIndices:()=>r,isSegmentIndexLocked:()=>a,setSegmentIndexLocked:()=>s});var i=n(33283),o=n(49906);function a(e,t){const n=(0,i.T)(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segments:o}=n;return o[t].locked}function s(e,t,n=!0){const a=(0,i.T)(e);if(!a)throw new Error(`No segmentation state found for ${e}`);const{segments:s}=a;s[t].locked=n,(0,o.triggerSegmentationModified)(e)}function r(e){const t=(0,i.T)(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segments:n}=t;return Object.keys(n).filter((e=>n[e].locked)).map((e=>parseInt(e)))}},98870:(e,t,n)=>{"use strict";n.d(t,{getCurrentLabelmapImageIdForViewport:()=>a.v,getSegmentation:()=>i.T,getStackSegmentationImageIdsForViewport:()=>s});var i=n(33283),o=(n(70758),n(30935),n(63427),n(53662),n(4714),n(50409),n(70906),n(59475));n(42568),n(58859);var a=n(97577);n(78231);function s(e,t){return o._6.getStackSegmentationImageIdsForViewport(e,t)}n(93210)},49906:(e,t,n)=>{"use strict";n.d(t,{triggerSegmentationDataModified:()=>i.Q,triggerSegmentationModified:()=>o.G,triggerSegmentationRemoved:()=>a.B,triggerSegmentationRepresentationModified:()=>s.r,triggerSegmentationRepresentationRemoved:()=>r.O});var i=n(98798),o=n(9726),a=n(1485),s=n(44951),r=n(65290)},78231:(e,t,n)=>{"use strict";n.d(t,{t:()=>o});var i=n(59475);function o(e,t){return i._6.updateLabelmapSegmentationImageReferences(e,t)}},65136:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(81985),o=n(85204);const a=function(e,t){t||(t=(0,i.getRenderingEngines)().find((t=>t.getViewports().find((t=>t.id===e))))?.id);const n=o.wk.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}}},7754:(e,t,n)=>{"use strict";n.d(t,{getToolGroup:()=>a,getToolGroupForViewport:()=>c.A,getToolGroupsWithToolName:()=>g});var i=n(85204),o=n(99737);n(93008),n(81985),n(79475),n(7001);const a=function(e){return i.wk.toolGroups.find((t=>t.id===e))},{Active:s,Passive:r,Enabled:l,Disabled:d}=o.ToolModes;o.MouseBindings.Primary;var c=n(65136);const h=[o.ToolModes.Active,o.ToolModes.Passive,o.ToolModes.Enabled];const g=function(e){return i.wk.toolGroups.filter((({toolOptions:t})=>{const n=Object.keys(t);for(let i=0;i<n.length;i++)if(e===n[i]&&t[e]&&h.includes(t[e].mode))return!0;return!1}))}},68040:(e,t,n)=>{"use strict";n.d(t,{Gx:()=>o});var i=n(85204);function o(e){const t=e.toolName;i.wk.tools[t];if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);i.wk.tools[t]={toolClass:e}}},85204:(e,t,n)=>{"use strict";n.d(t,{wk:()=>o});var i=n(48145);i.A;let o={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:i.A,enabledElements:[],handleRadius:6}},48145:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});let i={};const o=i},25072:(e,t,n)=>{"use strict";n.d(t,{A:()=>T});var i=n(3823),o=n(81985),a=n(4096),s=n(85817),r=n(27730),l=n(82056),d=n(2076),c=n(29601),h=n(44049),g=n(89578),u=n(85204),m=n(99737),v=n(8056),p=n(93258),f=n(66990),w=n(7001),E=n(58640);const{transformWorldToIndex:I}=o.utilities;class C extends s.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:_}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles;let d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[1]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=p.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]);return g<=i||(d=s.worldToCanvas(l[2]),c=s.worldToCanvas(l[3]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=p.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]),g<=i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,E.A)(a),(0,w.hideElementCursor)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,s=t.data;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,v.getViewportIdsWithToolToRender)(a,this.getToolName());(0,w.hideElementCursor)(a),this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,E.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:d}=this.editData,{data:c}=a;if(r&&!d)return;c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const{renderingEngine:g}=(0,o.getEnabledElement)(n);if(void 0!==this.editData.handleIndex){const{points:e}=c.handles,t=i.eR.distance(e[0],e[1]);if(i.eR.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],o=[...e[1]],a=i.Zc.create();i.Zc.set(a,t[1][0]-t[0][0],t[1][1]-t[1][0]);const s=i.Zc.create();i.Zc.set(s,-a[1],a[0]);const r=i.Zc.create();let l;i.Zc.set(r,o[0]-n[0],o[1]-n[0]),l=i.Zc.dot(r,s)>0?[n,o]:[o,n],c.handles.points=[t[0],t[1],l[0],l[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(a.annotationUID),(0,E.A)(s),r&&(0,h.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:a}=t,s=(0,o.getEnabledElement)(a),{renderingEngine:r,viewport:l}=s,{worldToCanvas:d}=l,{annotation:c,viewportIdsToRender:h,handleIndex:g}=this.editData,{data:u}=c,m=n.world;u.handles.points[g]=[...m];const v=u.handles.points.map(d),p={start:{x:v[0][0],y:v[0][1]},end:{x:v[1][0],y:v[1][1]}},f=(v[2][0],v[2][1],v[3][0],v[3][1],i.Zc.distance(v[0],v[1])/3),w=p.start.x-p.end.x,I=p.start.y-p.end.y,C=Math.sqrt(w*w+I*I),_=w/C,T=I/C,b=(p.start.x+p.end.x)/2,S=(p.start.y+p.end.y)/2,y=b+f*T,A=S-f*_,D=b-f*T,x=S+f*_;u.handles.points[2]=l.canvasToWorld([y,A]),u.handles.points[3]=l.canvasToWorld([D,x]),c.invalidated=!0,(0,E.A)(h),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{renderingEngine:a}=i,{annotation:s,viewportIdsToRender:r,handleIndex:l,movingTextBox:d}=this.editData,{data:c}=s;if(d){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===l){const{deltaPoints:e}=t,n=e.world;c.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),s.invalidated=!0}else this._dragModifyHandle(e),s.invalidated=!0;(0,E.A)(r)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=(0,o.getEnabledElement)(a),{viewport:r}=s,{annotation:l,handleIndex:d}=this.editData,{data:c}=l,h=n.world,g=[r.worldToCanvas(c.handles.points[0]),r.worldToCanvas(c.handles.points[1]),r.worldToCanvas(c.handles.points[2]),r.worldToCanvas(c.handles.points[3])],u={start:{x:g[0][0],y:g[0][1]},end:{x:g[1][0],y:g[1][1]}},m={start:{x:g[2][0],y:g[2][1]},end:{x:g[3][0],y:g[3][1]}},v=[...h],f=r.worldToCanvas(v);if(0===d||1===d){const e=g[0===d?1:0],t=i.Zc.set(i.Zc.create(),f[0]-e[0],f[1]-e[1]),n=i.Zc.set(i.Zc.create(),g[d][0]-e[0],g[d][1]-e[1]);i.Zc.normalize(t,t),i.Zc.normalize(n,n);const o={start:{x:e[0],y:e[1]},end:{x:f[0],y:f[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(o,m))return;const a=e,s=this._getSignedAngle(n,t);let l=g[2][0],h=g[2][1],u=g[3][0],p=g[3][1];l-=a[0],h-=a[1],u-=a[0],p-=a[1];const w=l*Math.cos(s)-h*Math.sin(s),E=l*Math.sin(s)+h*Math.cos(s),I=u*Math.cos(s)-p*Math.sin(s),C=u*Math.sin(s)+p*Math.cos(s);l=w+a[0],h=E+a[1],u=I+a[0],p=C+a[1];const _=r.canvasToWorld([l,h]),T=r.canvasToWorld([u,p]);c.handles.points[d]=v,c.handles.points[2]=_,c.handles.points[3]=T}else{const e=2===d?3:2,t={longLineSegment:{start:u.start,end:u.end},shortLineSegment:{start:m.start,end:m.end}},n=i.Zc.subtract(i.Zc.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),o=i.Zc.normalize(i.Zc.create(),n),a=i.Zc.subtract(i.Zc.create(),[f[0],f[1]],[g[d][0],g[d][1]]),s=i.Zc.length(a),l=this._getSignedAngle(o,a),h=Math.cos(l)*s,w=i.Zc.scaleAndAdd(i.Zc.create(),[g[e][0],g[e][1]],o,h);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:f[0],y:f[1]},end:{x:w[0],y:w[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!p.intersectLine([f[0],f[1]],[w[0],w[1]],[u.start.x,u.start.y],[u.end.x,u.end.y]))return;c.handles.points[e]=r.canvasToWorld(w),c.handles.points[d]=v}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,E.A)(n),i&&(0,h.dZ)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:i}=e,{element:o}=i;let a=(0,l.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const l=a[o],{annotationUID:u,data:m}=l,{points:v,activeHandleIndex:p}=m.handles,w=v.map((e=>i.worldToCanvas(e)));h.annotationUID=u;const{color:E,lineWidth:I,lineDash:C,shadow:_}=this.getAnnotationStyle({annotation:l,styleSpecifier:h});if(m.cachedStats[s]&&null!=m.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(m.cachedStats[s]={length:null,width:null,unit:null},this._calculateCachedStats(l,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!(0,c.isAnnotationVisible)(u))continue;if((0,d.isAnnotationLocked)(u)||this.editData||null===p||(T=[w[p]]),T){const e="0";(0,g.drawHandles)(t,u,e,T,{color:E})}const b=`${u}-line-1`,S=`${u}-line-2`,y="0";(0,g.drawLine)(t,u,y,w[0],w[1],{color:E,lineDash:C,lineWidth:I,shadow:_},b);const A="1";(0,g.drawLine)(t,u,A,w[2],w[3],{color:E,lineDash:C,lineWidth:I,shadow:_},S),n=!0;const D=this.getLinkedTextBoxStyle(h,l);if(!D.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(m,s);if(!x||0===x.length)continue;let M;m.handles.textBox.hasMoved||(M=(0,f.getTextBoxCoordsCanvas)(w),m.handles.textBox.worldPosition=i.canvasToWorld(M));const O=i.worldToCanvas(m.handles.textBox.worldPosition),R="1",L=(0,g.drawLinkedTextBox)(t,u,R,x,O,w,{},D),{x:P,y:N,width:k,height:U}=L;m.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,N]),topRight:i.canvasToWorld([P+k,N]),bottomLeft:i.canvasToWorld([P,N+U]),bottomRight:i.canvasToWorld([P+k,N+U])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=i.Zc.create();i.Zc.set(n,t.end.x-t.start.x,t.end.y-t.start.y),i.Zc.normalize(n,n);const o={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!p.intersectLine([o.start.x,o.start.y],[o.end.x,o.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:i}=e,{element:o}=n.viewport,s=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],d=i.handles.points[3],{cachedStats:c}=i,g=Object.keys(c);for(let e=0;e<g.length;e++){const t=g[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:i,dimensions:o}=n,h=I(i,s),u=I(i,r),m=I(i,l),v=I(i,d),p=[h,u],f=[m,v],{scale:w,unit:E}=(0,a.Op)(n,p),{scale:C,unit:_}=(0,a.Op)(n,f),T=this._calculateLength(s,r)/w,b=this._calculateLength(l,d)/C,S=T>b?T:b,y=T>b?b:T,A=T>b?E:_,D=T>b?_:E;this._isInsideVolume(h,u,m,v,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[t]={length:S,width:y,unit:A,widthUnit:D}}return e.invalidated=!1,(0,h.XF)(e,o),c},this._isInsideVolume=(e,t,n,i,a)=>o.utilities.indexWithinDimensions(e,a)&&o.utilities.indexWithinDimensions(t,a)&&o.utilities.indexWithinDimensions(n,a)&&o.utilities.indexWithinDimensions(i,a),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:r,renderingEngine:d}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,a,h,g),m=r.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...r.getViewReference({points:[a]})},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,l.addAnnotation)(p,i);const f=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,E.A)(f),p}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}}function _(e,t){const{cachedStats:n,label:i}=e,{length:a,width:s,unit:r}=n[t],l=[];return i&&l.push(i),void 0===a||l.push(`L: ${o.utilities.roundNumber(a)} ${r||r}`,`W: ${o.utilities.roundNumber(s)} ${r}`),l}C.toolName="Bidirectional";const T=C},37590:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(81985),o=n(49906),a=n(28220);class s extends a.A{constructor(e){super(i.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e))}isContourSegmentationTool(){return!0}renderAnnotationInstance(e){const t=e.annotation,{invalidated:n}=t,i=super.renderAnnotationInstance(e);if(n){const{segmentationId:e}=t.data.segmentation;(0,o.triggerSegmentationDataModified)(e)}return i}}s.toolName="PlanarFreehandContourSegmentationTool";const r=s},28220:(e,t,n)=>{"use strict";n.d(t,{A:()=>R});var i=n(81985),o=n(3823),a=n(4096),s=n(95527),r=n(13165),l=n(27730),d=n(8056),c=n(58640),h=n(55927),g=n(92400),u=n(57999),m=n(69855),v=n(70734),p=n(58161),f=n(44049),w=n(89578),E=n(66990),I=n(92984),C=n(18990),_=n(79362),T=n(93843),b=n(36320),S=n(99737),y=n(40634);const{pointCanProjectOnLine:A}=s.polyline,{EPSILON:D}=i.CONSTANTS,x=1-D;class M extends b.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:S.KeyboardBindings.Shift,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,makeClockWise:!0,subPixelResolution:4,smoothing:{smoothOnAdd:!1,smoothOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},interpolation:{enabled:!1,onInterpolationComplete:null},decimate:{enabled:!1,epsilon:.1},displayOnePointAsCrosshairs:!1,calculateStats:!0,getTextLines:O,statsCalculator:_.BasicStatsCalculator}}){super(e,t),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,i=this.createAnnotation(e);this.addAnnotation(i,n);const o=(0,d.getViewportIdsWithToolToRender)(n,this.getToolName());return this.activateDraw(e,i,o),e.preventDefault(),(0,c.A)(o),i},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,a=(0,d.getViewportIdsWithToolToRender)(o,this.getToolName());this.activateOpenContourEndEdit(e,t,a,n)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n,o=(0,d.getViewportIdsWithToolToRender)(i,this.getToolName());t.data.contour.closed?this.activateClosedContourEdit(e,t,o):this.activateOpenContourEdit(e,t,o),e.preventDefault()},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{polyline:r}=t.data.contour;let l=s.worldToCanvas(r[0]);for(let e=1;e<r.length;e++){const t=l,i=s.worldToCanvas(r[e]);if(A(n,t,i,o))return!0;l=i}if(!t.data.contour.closed)return!1;const d=s.worldToCanvas(r[0]),c=s.worldToCanvas(r[r.length-1]);return A(n,d,c,o)},this.cancel=e=>{const t=this.isDrawing,n=this.isEditingOpen,i=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):i&&this.cancelClosedContourEdit(e)},this._calculateCachedStats=(e,t,n,o)=>{const{data:r}=e,{cachedStats:l}=r,{polyline:d,closed:c}=r.contour,h=Object.keys(l);for(let n=0;n<h.length;n++){const o=h[n],g=this.getTargetImageData(o);if(!g)continue;const{imageData:u,metadata:m}=g,v=d.map((e=>t.worldToCanvas(e))),p={isPreScaled:(0,C.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},f=(0,y.j)(m.Modality,e.metadata.referencedImageId,p),w=(0,a.Op)(g,(()=>{const e=r.contour.polyline,n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);const{maxX:a,maxY:l,minX:d,minY:c}=s.polyline.getAABB(o),h=t.canvasToWorld([d,c]),g=i.utilities.transformWorldToIndex(u,h),m=t.canvasToWorld([a,l]);return[g,i.utilities.transformWorldToIndex(u,m)]}));c?this.updateClosedCachedStats({targetId:o,viewport:t,canvasCoordinates:v,points:d,imageData:u,metadata:m,cachedStats:l,modalityUnit:f,calibratedScale:w}):this.updateOpenCachedStats({metadata:m,canvasCoordinates:v,targetId:o,cachedStats:l,modalityUnit:f,calibratedScale:w})}return(0,f.XF)(e,o.viewport.element,S.ChangeTypes.StatsUpdated),e.invalidated=!1,l},this._renderStats=(e,t,n,i)=>{const{data:o}=e,a=this.getTargetId(t),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},r=this.getLinkedTextBoxStyle(s,e);if(!r.visibility)return;const l=this.configuration.getTextLines(o,a);if(!l||0===l.length)return;const d=o.contour.polyline.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=(0,E.getTextBoxCoordsCanvas)(d);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const c=t.worldToCanvas(o.handles.textBox.worldPosition),h=(0,w.drawLinkedTextBox)(i,e.annotationUID??"","1",l,c,d,{},r),{x:g,y:u,width:m,height:v}=h;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([g,u]),topRight:t.canvasToWorld([g+m,u]),bottomLeft:t.canvasToWorld([g,u+v]),bottomRight:t.canvasToWorld([g+m,u+v])}},(0,h.A)(this),(0,g.A)(this),(0,u.A)(this),(0,m.A)(this),(0,v.A)(this),(0,p.A)(this),this._throttledCalculateCachedStats=(0,l.A)(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,i.getEnabledElement)(e),{viewport:o}=n;let a;if(o instanceof i.VolumeViewport){const e=o.getCamera(),{spacingInNormalDirection:n}=i.utilities.getTargetVolumeAndSpacingInNormalDir(o,e);a=this.filterAnnotationsWithinSlice(t,e,n)}else a=(0,r.filterAnnotationsForDisplay)(o,t);return a}filterAnnotationsWithinSlice(e,t,n){const{viewPlaneNormal:i}=t,a=e.filter((e=>{const t=e.metadata.viewPlaneNormal,n=Math.abs(o.eR.dot(i,t))>x;return t&&n}));if(!a.length)return[];const s=n/2,{focalPoint:r}=t,l=[];for(const e of a){const t=e.data.contour.polyline[0];if(!e.isVisible)continue;const n=o.eR.create();o.eR.sub(n,r,t);const a=o.eR.dot(n,i);Math.abs(a)<s&&l.push(e)}return l}isContourSegmentationTool(){return!1}createAnnotation(e){const t=e.detail.currentPoints.world,n=super.createAnnotation(e);return i.utilities.deepMerge(n,{data:{contour:{polyline:[[...t]]},label:"",cachedStats:{}},onInterpolationComplete:e=>{e.data.handles.points.length=0}})}getAnnotationStyle(e){return super.getAnnotationStyle(e)}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:i}=e,o=e.annotation;let a=!1;const{viewport:s,renderingEngine:r}=t,l=this.isDrawing,d=this.isEditingOpen,c=this.isEditingClosed;if(l||d||c){const e=this.commonData.annotation.annotationUID;if(o.annotationUID===e)if(l)this.renderContourBeingDrawn(t,i,o);else if(c)this.renderClosedContourBeingEdited(t,i,o);else{if(!d)throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);this.renderOpenContourBeingEdited(t,i,o)}else this.configuration.displayOnePointAsCrosshairs&&1===o.data.contour.polyline.length?this.renderPointContourWithMarker(t,i,o):this.renderContour(t,i,o);a=!0}else this.configuration.displayOnePointAsCrosshairs&&1===o.data.contour.polyline.length?this.renderPointContourWithMarker(t,i,o):this.renderContour(t,i,o);if(this.configuration.calculateStats)return this._calculateStatsIfActive(o,n,s,r,t),this._renderStats(o,s,t,i),a}_calculateStatsIfActive(e,t,n,i,o){const a=this.commonData?.annotation.annotationUID;if((e.annotationUID!==a||this.commonData?.movingTextBox)&&!this.commonData?.movingTextBox){const{data:a}=e;a.cachedStats[t]&&null!=a.cachedStats[t].areaUnit?e.invalidated&&this._throttledCalculateCachedStats(e,n,i,o):(a.cachedStats[t]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(e,n,i,o))}}updateClosedCachedStats({viewport:e,points:t,imageData:n,metadata:a,cachedStats:r,targetId:l,modalityUnit:d,canvasCoordinates:c,calibratedScale:h}){const{scale:g,areaUnit:u,units:m}=h,{voxelManager:v}=e.getImageData(),p=c[0],f=e.canvasToWorld(p),w=e.canvasToWorld([p[0]+1,p[1]]),E=e.canvasToWorld([p[0],p[1]+1]),C=o.eR.distance(f,w),_=o.eR.distance(f,E),b=i.utilities.transformWorldToIndex(n,t[0]);b[0]=Math.floor(b[0]),b[1]=Math.floor(b[1]),b[2]=Math.floor(b[2]);let S=b[0],y=b[0],A=b[1],D=b[1],x=b[2],M=b[2];for(let e=1;e<t.length;e++){const o=i.utilities.transformWorldToIndex(n,t[e]);o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o[2]=Math.floor(o[2]),S=Math.min(S,o[0]),y=Math.max(y,o[0]),A=Math.min(A,o[1]),D=Math.max(D,o[1]),x=Math.min(x,o[2]),M=Math.max(M,o[2])}const O=i.utilities.transformWorldToIndex(n,t[1]);O[0]=Math.floor(O[0]),O[1]=Math.floor(O[1]),O[2]=Math.floor(O[2]);let R=s.polyline.getArea(c)/g/g;R*=C*_;const L=.01*(y-S),P=.01*(D-A),N=.01*(M-x);S=Math.floor(S-L),y=Math.ceil(y+L),A=Math.floor(A-P),D=Math.ceil(D+P),x=Math.floor(x-N),M=Math.ceil(M+N);const k=[[S,y],[A,D],[x,M]],U=n.indexToWorld([y,D,M]),V=e.worldToCanvas(U);let W=0,B=[],H=0;const F=v.forEach(this.configuration.statsCalculator.statsCallback,{imageData:n,isInObject:(t,n)=>{let i=!0;const o=e.worldToCanvas(t);return o[1]!=W&&(H=0,W=o[1],B=(0,I.getLineSegmentIntersectionsCoordinates)(c,o,[V[0],o[1]]),B.sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),B.length&&o[0]>B[0][0]&&(B.shift(),H++),H%2==0&&(i=!1),i},boundsIJK:k,returnPoints:this.configuration.storePointData}),G=this.configuration.statsCalculator.getStatistics();r[l]={Modality:a.Modality,area:R,perimeter:(0,T.A)(c,closed)/g,mean:G.mean?.value,max:G.max?.value,stdDev:G.stdDev?.value,statsArray:G.array,pointsInShape:F,areaUnit:u,modalityUnit:d,unit:m}}updateOpenCachedStats({targetId:e,metadata:t,canvasCoordinates:n,cachedStats:i,modalityUnit:o,calibratedScale:a}){const{scale:s,units:r}=a;i[e]={Modality:t.Modality,length:(0,T.A)(n,!1)/s,modalityUnit:o,getPixelValueUnitunit:r}}}function O(e,t){const n=e.cachedStats[t],{area:o,mean:a,stdDev:s,length:r,perimeter:l,max:d,isEmptyArea:c,unit:h,areaUnit:g,modalityUnit:u}=n||{},m=[];if(o){const e=c?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(o)} ${g}`;m.push(e)}return a&&m.push(`Mean: ${i.utilities.roundNumber(a)} ${u}`),Number.isFinite(d)&&m.push(`Max: ${i.utilities.roundNumber(d)} ${u}`),s&&m.push(`Std Dev: ${i.utilities.roundNumber(s)} ${u}`),l&&m.push(`Perimeter: ${i.utilities.roundNumber(l)} ${h}`),r&&m.push(`${i.utilities.roundNumber(r)} ${h}`),m}M.toolName="PlanarFreehandROI";const R=M},4010:(e,t,n)=>{"use strict";n.d(t,{A:()=>y});var i=n(85817),o=n(81985),a=n(4096),s=n(27730),r=n(6802),l=n(2076),d=n(29601),c=n(44049),h=n(89578),g=n(85204),u=n(99737),m=n(8056),v=n(92282),p=n(66990),f=n(35489),w=n(7001),E=n(58640),I=n(40634),C=n(18990),_=n(79362);const{transformWorldToIndex:T}=o.utilities;class b extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,getTextLines:S,statsCalculator:_.BasicStatsCalculator}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=s;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,a,h,g),v=l.getFrameOfReferenceUID(),p={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:v,referencedImageId:u,...l.getViewReference({points:[a]})},data:{label:"",handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};(0,r.lC)(p,i);const f=(0,m.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,E.A)(f),p},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),g=[n[0],n[1]],{left:u,top:m,width:p,height:f}=h;return v.distanceToPoint([u,m,p,f],g)<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,m.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,w.hideElementCursor)(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,E.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,m.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,w.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,E.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:l}=this.editData,{data:d}=i;if(s&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const{renderingEngine:h}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.O8)(i.annotationUID),(0,E.A)(a),s&&(0,c.dZ)(i)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world,{points:o}=l.handles;o.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,a=(0,o.getEnabledElement)(n),{worldToCanvas:r,canvasToWorld:d}=a.viewport,c=e.world,{points:h}=l.handles;let g,u,m,v,p,f,w,E;switch(h[s]=[...c],s){case 0:case 3:g=r(h[0]),v=r(h[3]),u=[v[0],g[1]],m=[g[0],v[1]],f=d(u),w=d(m),h[1]=f,h[2]=w;break;case 1:case 2:u=r(h[1]),m=r(h[2]),g=[m[0],u[1]],v=[u[0],m[1]],p=d(g),E=d(v),h[0]=p,h[3]=E}i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,E.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,E.A)(n),i&&(0,c.dZ)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(u.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(u.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,r.Rh)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const c=this.getTargetId(i),g=i.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const r=s[a],{annotationUID:m,data:v}=r,{points:f,activeHandleIndex:w}=v.handles,E=f.map((e=>i.worldToCanvas(e)));u.annotationUID=m;const{color:I,lineWidth:C,lineDash:_}=this.getAnnotationStyle({annotation:r,styleSpecifier:u}),{viewPlaneNormal:T,viewUp:b}=i.getCamera();if(v.cachedStats[c]&&null!=v.cachedStats[c].areaUnit){if(r.invalidated&&(this._throttledCalculateCachedStats(r,T,b,g,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in v.cachedStats)if(t.startsWith("imageId")){g.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete v.cachedStats[t]}}}else v.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(r,T,b,g,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let S;if(!(0,d.isAnnotationVisible)(m))continue;if((0,l.isAnnotationLocked)(m)||this.editData||null===w||(S=[E[w]]),S){const e="0";(0,h.drawHandles)(t,m,e,S,{color:I})}const y=`${m}-rect`,A="0";(0,h.drawRectByCoordinates)(t,m,A,E,{color:I,lineDash:_,lineWidth:C},y),n=!0;const D=this.getLinkedTextBoxStyle(u,r);if(!D.visibility){v.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(v,c);if(!x||0===x.length)continue;if(!v.handles.textBox.hasMoved){const e=(0,p.getTextBoxCoordsCanvas)(E);v.handles.textBox.worldPosition=i.canvasToWorld(e)}const M=i.worldToCanvas(v.handles.textBox.worldPosition),O="1",R=(0,h.drawLinkedTextBox)(t,m,O,x,M,E,{},D),{x:L,y:P,width:N,height:k}=R;v.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([L,P]),topRight:i.canvasToWorld([L+N,P]),bottomLeft:i.canvasToWorld([L,P+k]),bottomRight:i.canvasToWorld([L+N,P+k])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{const{data:s}=e,{viewport:r}=o,{element:l}=r,d=s.handles.points[0],h=s.handles.points[3],{cachedStats:g}=s,u=Object.keys(g);for(let i=0;i<u.length;i++){const o=u[i],s=this.getTargetImageData(o);if(!s)continue;const{dimensions:l,imageData:c,metadata:m,voxelManager:v}=s,p=T(c,d);p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]);const w=T(c,h);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(p,w,l)){this.isHandleOutsideImage=!1;const i=[[Math.min(p[0],w[0]),Math.max(p[0],w[0])],[Math.min(p[1],w[1]),Math.max(p[1],w[1])],[Math.min(p[2],w[2]),Math.max(p[2],w[2])]],{worldWidth:l,worldHeight:u}=(0,f.A)(t,n,d,h),E=[p,w],{scale:_,areaUnit:T}=(0,a.Op)(s,E),b=Math.abs(l*u)/(_*_),S={isPreScaled:(0,C.u)(r,o),isSuvScaled:this.isSuvScaled(r,o,e.metadata.referencedImageId)},y=(0,I.j)(m.Modality,e.metadata.referencedImageId,S),A=v.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:i,imageData:c,returnPoints:this.configuration.storePointData}),D=this.configuration.statsCalculator.getStatistics();g[o]={Modality:m.Modality,area:b,mean:D.mean?.value,stdDev:D.stdDev?.value,max:D.max?.value,statsArray:D.array,pointsInShape:A,areaUnit:T,modalityUnit:y}}else this.isHandleOutsideImage=!0,g[o]={Modality:m.Modality}}return e.invalidated=!1,(0,c.XF)(e,l),g},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}}function S(e,t){const n=e.cachedStats[t],{area:i,mean:a,max:s,stdDev:r,areaUnit:l,modalityUnit:d}=n;if(void 0===a)return;const c=[];return c.push(`Area: ${o.utilities.roundNumber(i)} ${l}`),c.push(`Mean: ${o.utilities.roundNumber(a)} ${d}`),c.push(`Max: ${o.utilities.roundNumber(s)} ${d}`),c.push(`Std Dev: ${o.utilities.roundNumber(r)} ${d}`),c}b.toolName="RectangleROI";const y=b},6030:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var i=n(81985),o=n(37234),a=n(82056),s=n(56069),r=n(94418),l=n(76712),d=n(49310);class c extends o.A{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,imageId:n}=e.detail,o=i.utilities.imageIdToURI(n),r=(0,a.getAnnotationManager)();r.getFramesOfReference().forEach((e=>{const n=r.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach((e=>{if(!e.metadata?.referencedImageId)return;i.utilities.imageIdToURI(e.metadata.referencedImageId)===o&&(e.invalidated=!0,e.data.cachedStats={})})),(0,s.A)(t))}))}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,i.getEnabledElement)(e),{viewport:o}=n;return(0,r.A)(o,t)}getReferencedImageId(e,t,n,o){const a=this.getTargetId(e);let s=a.split(/^[a-zA-Z]+:/)[1];if(e instanceof i.BaseVolumeViewport){const e=i.utilities.getVolumeId(a),o=i.cache.getVolume(e);s=i.utilities.getClosestImageId(o,t,n)}return s}getStyle(e,t,n){return(0,l.h)(e,t,(0,d.getState)(n),this.mode)}}c.toolName="AnnotationDisplayTool";const h=c},37234:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(81985),o=n(49892);class a{constructor(e,t){const n=i.utilities.deepMerge(t,e),{configuration:a={},supportedInteractionTypes:s,toolGroupId:r}=n;a.strategies||(a.strategies={},a.defaultStrategy=void 0,a.activeStrategy=void 0,a.strategyOptions={}),this.toolGroupId=r,this.supportedInteractionTypes=s||[],this.configuration=Object.assign({},a),this.mode=o.A.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:i}=this.configuration;return n[i]?.call(this,e,t)}applyActiveStrategyCallback(e,t,n){const{strategies:i,activeStrategy:o}=this.configuration;if(!i[o])throw new Error(`applyActiveStrategyCallback: active strategy ${o} not found, check tool configuration or spellings`);return i[o][n]?.call(this,e,t)}setConfiguration(e){this.configuration=i.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetImageData(e){if(e.startsWith("imageId:")){const t=e.split("imageId:")[1],n=i.utilities.imageIdToURI(t);let o=i.utilities.getViewportsWithImageURI(n);if(!o||!o.length)return;if(o=o.filter((e=>e.getCurrentImageId()===t)),!o||!o.length)return;return o[0].getImageData()}if(e.startsWith("volumeId:")){const t=i.utilities.getVolumeId(e),n=i.utilities.getViewportsWithVolumeId(t);if(!n||!n.length)return;return n[0].getImageData()}if(e.startsWith("videoId:")){const t=i.utilities.imageIdToURI(e),n=i.utilities.getViewportsWithImageURI(t);if(!n||!n.length)return;return n[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){const t=e.getViewReferenceId?.();if(t)return t;throw new Error("getTargetId: viewport must have a getViewReferenceId method")}}a.toolName="BaseTool";const s=a},85817:(e,t,n)=>{"use strict";n.d(t,{EC:()=>o.A,oS:()=>i.A});var i=n(37234),o=n(91350);n(6030)},25894:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var i=n(81985),o=n(18682),a=n(22384),s=n(33283),r=n(69073),l=n(13654),d=n(87420);let c=!1;new Map;const h={render:async function(e,t){const{segmentationId:n}=t,i=(0,s.T)(n);if(!i)return;let d=i.representationData[o.A.Contour];d||!(0,r.n)(n,o.A.Contour)||c||(c=!0,d=await(0,l.D)(n,{viewport:e}),c=!1),d&&d.geometryIds?.length&&(0,a.d)(e,d.geometryIds,d.annotationUIDsMap,t)},removeRepresentation:function(e,t,n=!1){const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{viewport:a}=o;n&&((0,d.A)(e,t),a.render())}}},684:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>T});var i=n(81985),o=n(36014),a=n(88234),s=n(26228),r=n(50409),l=n(97577),d=n(33283),c=n(69073),h=n(79462),g=n(92686),u=n(18682),m=n(47098),v=n(60740),p=n(59452);const f=255,w=new Map;let E=!1;function I(e,t,n){const i={...e,...n||{}};return{fillAlpha:t?i.fillAlpha:i.fillAlphaInactive,outlineWidth:t?i.outlineWidth:i.outlineWidthInactive,renderFill:t?i.renderFill:i.renderFillInactive,renderOutline:t?i.renderOutline:i.renderOutlineInactive,outlineOpacity:t?i.outlineOpacity:i.outlineOpacityInactive,activeSegmentOutlineWidthDelta:i.activeSegmentOutlineWidthDelta}}function C(e,t,n,{fillAlpha:i,renderFill:o,renderOutline:a,segmentColor:s,outlineWidth:r,segmentsHidden:l,cfun:d,ofun:c}){const h=`${e}-${t}-${n}`,g=w.get(h);if(!g)return w.set(h,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l),cfunMTime:d.getMTime(),ofunMTime:c.getMTime()}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:u,renderFill:m,renderOutline:v,outlineWidth:p,segmentColor:f,segmentsHidden:E,cfunMTime:I,ofunMTime:C}=g,_=f[0]!==s[0]||f[1]!==s[1]||f[2]!==s[2],T=f[3]!==s[3]||u!==i||m!==o||v!==a||p!==r||E!==l;return(T||_)&&w.set(h,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l),cfunMTime:d.getMTime(),ofunMTime:c.getMTime()}),{forceOpacityUpdate:T,forceColorUpdate:_}}async function _(e,t,n){await(0,o.A)(e.element,t,n)}const T={render:async function(e,t){const{segmentationId:n}=t,o=(0,d.T)(n);if(!o)return void console.warn("No segmentation found for segmentationId: ",n);let a=o.representationData[u.A.Labelmap],w=(0,p.wV)(e.id,n);if(!a&&(0,c.n)(n,u.A.Labelmap)&&!E){if(E=!0,a=await(0,h.z)(n,{viewport:e}),!a)throw new Error(`No labelmap data found for segmentationId ${n}.`);E=!1}if(a){if(e instanceof i.VolumeViewport)w||await _(e,a,n),w=(0,p.wV)(e.id,n);else{if(!(0,l.v)(e.id,n))return;w||await _(e,a,n),w=(0,p.wV)(e.id,n)}w&&function(e,t,n){const{segmentationId:i}=n,{cfun:o,ofun:a}=n.config,{colorLUTIndex:l}=n,d=(0,s.getActiveSegmentation)(e),c=d?.segmentationId===i,h=g.Y.getStyle({viewportId:e,type:u.A.Labelmap,segmentationId:i}),p=g.Y.getRenderInactiveSegmentations(e),w=(0,r.B)(l),E=Math.min(256,w.length),{outlineWidth:_,renderOutline:T,outlineOpacity:b,activeSegmentOutlineWidthDelta:S}=I(h,c),y=(0,m.s)(e,{segmentationId:i,type:u.A.Labelmap});for(let t=0;t<E;t++){const n=t,s=w[n],r=g.Y.getStyle({viewportId:e,type:u.A.Labelmap,segmentationId:i,segmentIndex:n}),{fillAlpha:l,outlineWidth:d,renderFill:m,renderOutline:v}=I(h,c,r),{forceOpacityUpdate:p,forceColorUpdate:E}=C(e,i,n,{fillAlpha:l,renderFill:m,renderOutline:v,segmentColor:s,outlineWidth:d,segmentsHidden:y,cfun:o,ofun:a});if(E&&o.addRGBPoint(n,s[0]/f,s[1]/f,s[2]/f),p)if(m){const e=y.has(n)?0:s[3]/255*l;a.removePoint(n),a.addPointLong(n,e,.5,1)}else a.addPointLong(n,.01,.5,1)}const A=t.actor;if(A.getProperty().setRGBTransferFunction(0,o),a.setClamping(!1),A.getProperty().setScalarOpacity(0,a),A.getProperty().setInterpolationTypeToNearest(),T){A.getProperty().setUseLabelOutline(T),A.getProperty().setLabelOutlineOpacity(b);const e=(0,v.Q)(n.segmentationId),t=new Array(E-1);for(let n=1;n<E;n++){y.has(n)?t[n-1]=0:t[n-1]=n===e?_+S:_}A.getProperty().setLabelOutlineThickness(t)}else A.getProperty().setLabelOutlineThickness(new Array(E-1).fill(0));const D=c||p;A.setVisibility(D)}(e.id,w,t)}},removeRepresentation:function(e,t,n=!1){const o=(0,i.getEnabledElementByViewportId)(e);if(w.forEach(((e,n)=>{n.includes(t)&&w.delete(n)})),!o)return;const{viewport:s}=o;(0,a.A)(s.element,t),n&&s.render()}}},67014:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>g});var i=n(81985),o=n(18682),a=n(20552),s=n(18796),r=n(33283),l=n(50409),d=n(69073),c=n(58062);const{ViewportType:h}=i.Enums;const g={render:async function(e,t){const{segmentationId:n}=t,a=(0,r.T)(n);if(!a)return;let h=a.representationData[o.A.Surface];if(!h&&(0,d.n)(n,o.A.Surface)&&(h=await(0,c.o)(n,{viewport:e}),!h))throw new Error(`No Surface data found for segmentationId ${n}.`);const{geometryIds:g}=h;g?.size||console.warn(`No Surfaces found for segmentationId ${n}. Skipping render.`);const{colorLUTIndex:u}=t,m=(0,l.B)(u),v=[];g.forEach((t=>{const o=i.cache.getGeometry(t);if(!o?.data)return void console.warn(`No Surfaces found for geometryId ${t}. Skipping render.`);const a=o.data.segmentIndex,r=o.data,l=m[a];r.color=l.slice(0,3),v.push(r),(0,s.A)(e.element,r,n)})),e.render()},removeRepresentation:function(e,t,n=!1){const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{viewport:s}=o;(0,a.A)(s.element,t),n&&s.render()}}},48736:(e,t,n)=>{"use strict";n.d(t,{A:()=>I});var i=n(81985),o=n(3823),a=n(85817),s=n(17492),r=n(1989),l=n(56789),d=n(33852),c=n(99737),h=n(89578),g=n(7001),u=n(58640),m=n(98870),v=n(26795),p=n(60740),f=n(93733),w=n(67165);class E extends a.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:l.kr,ERASE_INSIDE_CIRCLE:d.r,FILL_INSIDE_SPHERE:s.Jq,ERASE_INSIDE_SPHERE:r._,THRESHOLD_INSIDE_CIRCLE:l.q,THRESHOLD_INSIDE_SPHERE:s.rd},strategySpecificConfiguration:{THRESHOLD:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",thresholdVolumeId:null,brushSize:25,preview:{enabled:!1,previewColors:{},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[c.StrategyCallbacks.AcceptPreview]:{method:c.StrategyCallbacks.AcceptPreview,bindings:[{key:"Enter"}]},[c.StrategyCallbacks.RejectPreview]:{method:c.StrategyCallbacks.RejectPreview,bindings:[{key:"Escape"}]}}}}){super(e,t),this._previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1},this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n);this._editData=this.createEditData(n),this._activateDraw(n),(0,g.hideElementCursor)(n),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();const a=this._hoverData||this.createHoverData(n);(0,u.A)(a.viewportIdsToRender);const s=this.getOperationData(n);return this.applyActiveStrategyCallback(o,s,c.StrategyCallbacks.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===c.ToolModes.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:i}=this.configuration.preview,{currentPoints:a,element:s}=e.detail,{canvas:r}=a,{preview:l,startPoint:d,timer:c,timerStart:h,isDrag:g}=this._previewData,u=o.Zc.distance(r,d),m=Date.now()-h;if((u>n||m>t&&u>i)&&(c&&(window.clearTimeout(c),this._previewData.timer=null),l&&!g&&this.rejectPreview(s)),!this._previewData.timer){const e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:r,element:s})}}},this.previewCallback=()=>{this._previewData.timer=null,this._previewData.preview||(this._previewData.preview=this.applyActiveStrategyCallback((0,i.getEnabledElement)(this._previewData.element),this.getOperationData(this._previewData.element),c.StrategyCallbacks.Preview))},this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:a}=t,s=(0,i.getEnabledElement)(n);this.updateCursor(e);const{viewportIdsToRender:r}=this._hoverData;(0,u.A)(r);const l=o.Zc.distance(a.canvas,this._previewData.startPoint),{dragTimeMs:d,dragMoveDistance:c}=this.configuration.preview;!this._previewData.isDrag&&this._previewData.preview&&Date.now()-this._previewData.timerStart<d&&l<c||(this._previewData.preview=this.applyActiveStrategy(s,this.getOperationData(n)),this._previewData.element=n,this._previewData.timerStart=Date.now()+d,this._previewData.isDrag=!0,this._previewData.startPoint=a.canvas)},this._endCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),a=this.getOperationData(n);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(o,a),this._deactivateDraw(n),(0,g.resetElementCursor)(n),this.updateCursor(e),this._editData=null,this.applyActiveStrategyCallback(o,a,c.StrategyCallbacks.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(n)},this._activateDraw=e=>{e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}createEditData(e){const t=(0,i.getEnabledElement)(e),{viewport:n}=t,o=(0,w.T)(n.id);if(!o){const e=new CustomEvent(i.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"No active segmentation detected, create a segmentation representation before using the brush tool"},cancelable:!0});return i.eventTarget.dispatchEvent(e),null}const{segmentationId:a}=o,s=(0,v.getLockedSegmentIndices)(a),{representationData:r}=(0,m.getSegmentation)(a);if(n instanceof i.BaseVolumeViewport){const{volumeId:e}=r[c.SegmentationRepresentations.Labelmap],t=n.getActors();if(n instanceof i.StackViewport){const e=new CustomEvent(i.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"Cannot perform brush operation on the selected viewport"},cancelable:!0});return i.eventTarget.dispatchEvent(e),null}const o=t.map((e=>i.cache.getVolume(e.referencedId))),a=i.cache.getVolume(e),l=o.find((e=>i.utilities.isEqual(e.dimensions,a.dimensions)))?.volumeId||o[0]?.volumeId;return{volumeId:e,referencedVolumeId:this.configuration.thresholdVolumeId??l,segmentsLocked:s}}{const e=(0,m.getCurrentLabelmapImageIdForViewport)(n.id,a);if(!e)return;if(this.configuration.activeStrategy.includes("SPHERE")){const t=n.getImageIds();if(!i.utilities.isValidVolume(t))throw new Error("Volume is not reconstructable for sphere manipulation");const o=`${a}_${n.id}`,r=i.cache.getVolume(o);if(r)return{imageId:e,segmentsLocked:s,override:{voxelManager:r.voxelManager,imageData:r.imageData}};{const t=(0,m.getStackSegmentationImageIdsForViewport)(n.id,a);if(!t||1===t.length)return{imageId:e,segmentsLocked:s};const r=i.volumeLoader.createAndCacheVolumeFromImagesSync(o,t);return{imageId:e,segmentsLocked:s,override:{voxelManager:r.voxelManager,imageData:r.imageData}}}}return{imageId:e,segmentsLocked:s}}}createHoverData(e,t){const n=(0,i.getEnabledElement)(e),{viewport:o}=n,a=o.getCamera(),{viewPlaneNormal:s,viewUp:r}=a,l=[o.id],{segmentIndex:d,segmentationId:c,segmentColor:h}=this.getActiveSegmentationData(o)||{};return{brushCursor:{metadata:{viewPlaneNormal:[...s],viewUp:[...r],FrameOfReferenceUID:o.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:h},data:{}},centerCanvas:t,segmentIndex:d,viewport:o,segmentationId:c,segmentColor:h,viewportIdsToRender:l}}getActiveSegmentationData(e){const t=e.id,n=(0,w.T)(t);if(!n)return;const{segmentationId:i}=n,o=(0,p.Q)(i);if(!o)return;return{segmentIndex:o,segmentationId:i,segmentColor:(0,f.getSegmentIndexColor)(t,i,o)}}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas;this._hoverData=this.createHoverData(n,o),this._calculateCursor(n,o),this._hoverData&&(0,u.A)(this._hoverData.viewportIdsToRender)}getOperationData(e){const t=this._editData||this.createEditData(e),{segmentIndex:n,segmentationId:i,brushCursor:o}=this._hoverData||this.createHoverData(e),{data:a,metadata:s={}}=o||{},{viewPlaneNormal:r,viewUp:l}=s;return{...t,points:a?.handles?.points,segmentIndex:n,previewColors:this.configuration.preview.enabled?this.configuration.preview.previewColors:null,viewPlaneNormal:r,toolGroupId:this.toolGroupId,segmentationId:i,viewUp:l,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration,preview:this._previewData?.preview}}_calculateCursor(e,t){const n=(0,i.getEnabledElement)(e),{viewport:a}=n,{canvasToWorld:s}=a,r=a.getCamera(),{brushSize:l}=this.configuration,d=o.eR.fromValues(r.viewUp[0],r.viewUp[1],r.viewUp[2]),c=o.eR.fromValues(r.viewPlaneNormal[0],r.viewPlaneNormal[1],r.viewPlaneNormal[2]),h=o.eR.create();o.eR.cross(h,d,c);const g=s([t[0],t[1]]),u=o.eR.create(),m=o.eR.create(),v=o.eR.create(),p=o.eR.create();for(let e=0;e<=2;e++)u[e]=g[e]-d[e]*l,m[e]=g[e]+d[e]*l,v[e]=g[e]-h[e]*l,p[e]=g[e]+h[e]*l;if(!this._hoverData)return;const{brushCursor:f}=this._hoverData,{data:w}=f;void 0===w.handles&&(w.handles={}),w.handles.points=[u,m,v,p];const E=this.configuration.activeStrategy,I=this.configuration.strategies[E];"function"==typeof I.computeInnerCircleRadius&&I.computeInnerCircleRadius({configuration:this.configuration,viewport:a}),w.invalidated=!1}rejectPreview(e=this._previewData.element){if(!e||!this._previewData.preview)return;const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),c.StrategyCallbacks.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(e=this._previewData.element){if(!e)return;const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),c.StrategyCallbacks.AcceptPreview),this._previewData.isDrag=!1,this._previewData.preview=null}invalidateBrushCursor(){if(void 0===this._hoverData)return;const{data:e}=this._hoverData.brushCursor,{viewport:t}=this._hoverData;e.invalidated=!0;const{segmentColor:n}=this.getActiveSegmentationData(t)||{};this._hoverData.brushCursor.metadata.segmentColor=n}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const i=this._hoverData.brushCursor;if(!0===i.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const o=i.metadata;if(!o)return;const a=o.brushCursorUID,s=i.data,{points:r}=s.handles,l=r.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],g=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],u=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),m=`rgb(${o.segmentColor?.slice(0,3)||[0,0,0]})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");(0,h.drawCircle)(t,a,"0",g,u,{color:m});const v=this.configuration.activeStrategy,{dynamicRadiusInCanvas:p}=this.configuration.strategySpecificConfiguration[v]||{dynamicRadiusInCanvas:0};if(p){const e="1";(0,h.drawCircle)(t,a,e,g,p,{color:m})}}}E.toolName="Brush";const I=E},67847:(e,t,n)=>{"use strict";n.d(t,{A:()=>S});var i=n(81985),o=n(4096),a=n(3823),s=n(6802),r=n(2076),l=n(89578),d=n(8056),c=n(27730),h=n(66990),g=n(35489),u=n(29601),m=n(7001),v=n(58640),p=n(44049),f=n(4010),w=n(18990),E=n(79362),I=n(13165),C=n(40634);const{transformWorldToIndex:_}=i.utilities;class T extends f.A{constructor(e={},t={configuration:{storePointData:!1,numSlicesToPropagate:10,computePointsInsideVolume:!1,getTextLines:b,statsCalculator:E.BasicStatsCalculator,showTextBox:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,r=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:c}=r;this.isDrawing=!0;const h=l.getCamera(),{viewPlaneNormal:g,viewUp:u}=h;let p,f,w;if(l instanceof i.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(l);w=i.utilities.getVolumeId(e),f=i.cache.getVolume(w),p=i.utilities.getClosestImageId(f,a,g)}const E=i.utilities.getSpacingInNormalDirection(f,g),I=this._getStartCoordinate(a,g),C=this._getEndCoordinate(a,E,g),_=l.getFrameOfReferenceUID(),T={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...g],enabledElement:r,viewUp:[...u],FrameOfReferenceUID:_,referencedImageId:p,toolName:this.getToolName(),volumeId:w,spacingInNormal:E},data:{label:"",startCoordinate:I,endCoordinate:C,cachedStats:{pointsInVolume:[],projectionPoints:[],projectionPointsImageIds:[p],statistics:[]},handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(T,f),(0,s.lC)(T,o);const b=(0,d.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:T,viewportIdsToRender:b,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,m.hideElementCursor)(o),e.preventDefault(),(0,v.A)(b),T},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=o;if(r&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,m.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.O8)(o.annotationUID);const h=this.getTargetId(c.viewport),g=i.cache.getVolume(h.split(/volumeId:|\?/)[1]);this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(o,h,g,c),(0,v.A)(a),r&&(0,p.dZ)(o)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e;let a=(0,s.Rh)(this.getToolName(),o.element);if(!a?.length)return n;a=(0,I.filterAnnotationsWithinSamePlane)(a,o.getCamera());const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<a.length;s++){const c=a[s],{annotationUID:g,data:m}=c,{startCoordinate:v,endCoordinate:p}=m,{points:f,activeHandleIndex:w}=m.handles,E=f.map((e=>o.worldToCanvas(e)));d.annotationUID=g;const I=this.getStyle("lineWidth",d,c),C=this.getStyle("lineDash",d,c),_=this.getStyle("color",d,c),T=o.getCamera().focalPoint,b=o.getCamera().viewPlaneNormal;let S=v,y=p;Array.isArray(v)&&(S=this._getCoordinateForViewplaneNormal(S,b),m.startCoordinate=S,m.handles.points[0][this._getIndexOfCoordinatesForViewplaneNormal(b)]=S,m.startCoordinate=S,m.handles.points[0][this._getIndexOfCoordinatesForViewplaneNormal(b)]=S),Array.isArray(p)&&(y=this._getCoordinateForViewplaneNormal(y,b),m.endCoordinate=y,m.endCoordinate=y);const A=i.utilities.roundToPrecision(S),D=i.utilities.roundToPrecision(y),x=this._getCoordinateForViewplaneNormal(T,b),M=i.utilities.roundToPrecision(x);if(M<Math.min(A,D)||M>Math.max(A,D))continue;c.invalidated&&this._throttledCalculateCachedStats(c,e);let O,R=!1;if(M!==A&&M!==D||(R=!0),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,u.isAnnotationVisible)(g))continue;if((0,r.isAnnotationLocked)(g)||this.editData||null===w||!R||(O=[E[w]]),O){const e="0";(0,l.drawHandles)(t,g,e,O,{color:_})}let L=C;R||(L=2);const P="0";if((0,l.drawRect)(t,g,P,E[0],E[3],{color:_,lineDash:L,lineWidth:I}),n=!0,this.configuration.showTextBox&&this.configuration.calculatePointsInsideVolume){const e=this.getLinkedTextBoxStyle(d,c);if(!e.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const n=this.configuration.getTextLines(m);if(!n||0===n.length)continue;if(!m.handles.textBox.hasMoved){const e=(0,h.getTextBoxCoordsCanvas)(E);m.handles.textBox.worldPosition=o.canvasToWorld(e)}const i=o.worldToCanvas(m.handles.textBox.worldPosition),a="1",s=(0,l.drawLinkedTextBox)(t,g,a,n,i,E,{},e),{x:r,y:u,width:v,height:p}=s;m.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([r,u]),topRight:o.canvasToWorld([r+v,u]),bottomLeft:o.canvasToWorld([r,u+p]),bottomRight:o.canvasToWorld([r+v,u+p])}}}return n},this._throttledCalculateCachedStats=(0,c.A)(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:o,spacingInNormal:s}=i,{imageData:r}=t,{startCoordinate:l,endCoordinate:d}=n,{points:c}=n.handles,h=_(r,c[0]),g=_(r,c[0]),u=a.eR.create();r.indexToWorldVec3(h,u);const m=a.eR.create();r.indexToWorldVec3(g,m),2==this._getIndexOfCoordinatesForViewplaneNormal(o)?(u[2]=l,m[2]=d):0==this._getIndexOfCoordinatesForViewplaneNormal(o)?(u[0]=l,m[0]=d):1==this._getIndexOfCoordinatesForViewplaneNormal(o)&&(u[1]=l,m[1]=d);const v=a.eR.distance(u,m),p=[];for(let e=0;e<v;e+=s)p.push(c.map((t=>{const n=a.eR.create();return a.eR.scaleAndAdd(n,t,o,e),Array.from(n)})));n.cachedStats.projectionPoints=p}_computePointsInsideVolume(e,t,n,i){const{data:a,metadata:s}=e,{viewPlaneNormal:r,viewUp:l}=s,{viewport:d}=i,c=a.cachedStats.projectionPoints,h=[[]],u=this.getTargetImageData(t),m=a.handles.points[0],v=a.handles.points[3],{worldWidth:p,worldHeight:f}=(0,g.A)(r,l,m,v),E=(0,o.Op)(u,a.habdles),I=Math.abs(p*f)/(E.scale*E.scale),T={isPreScaled:(0,w.u)(d,t),isSuvScaled:this.isSuvScaled(d,t,e.metadata.referencedImageId)},b=(0,C.j)(s.Modality,e.metadata.referencedImageId,T);for(let e=0;e<c.length;e++){if(!n)continue;const t=c[e][0],{dimensions:i,imageData:o,voxelManager:a}=n,s=_(o,m),l=_(o,t),d=this._getIndexOfCoordinatesForViewplaneNormal(r);s[0]=Math.floor(s[0]),s[1]=Math.floor(s[1]),s[2]=Math.floor(s[2]),s[d]=l[d];const g=_(o,v);if(g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]),g[d]=l[d],this._isInsideVolume(s,g,i)){this.isHandleOutsideImage=!1;const e=[[Math.min(s[0],g[0]),Math.max(s[0],g[0])],[Math.min(s[1],g[1]),Math.max(s[1],g[1])],[Math.min(s[2],g[2]),Math.max(s[2],g[2])]],t=a.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:e,imageData:o,returnPoints:this.configuration.storePointData});h.push(t)}}const S=this.configuration.statsCalculator.getStatistics();a.cachedStats.pointsInVolume=h,a.cachedStats.statistics={Modality:s.Modality,area:I,mean:S.mean?.value,stdDev:S.stdDev?.value,max:S.max?.value,statsArray:S.array,areaUnit:E.areaUnit,modalityUnit:b}}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:o}=t,{cachedStats:a}=n,s=this.getTargetId(o),r=i.cache.getVolume(s.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,r),this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(e,s,r,t),this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(e,s,r,t),e.invalidated=!1,(0,p.XF)(e,o.element),a}_getStartCoordinate(e,t){const n=e;return this._getCoordinateForViewplaneNormal(n,t)}_getEndCoordinate(e,t,n){const i=this.configuration.numSlicesToPropagate,o=a.eR.create();a.eR.scaleAndAdd(o,e,n,i*t);return this._getCoordinateForViewplaneNormal(o,n)}_getIndexOfCoordinatesForViewplaneNormal(e){const t=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];return t.indexOf(Math.max(...t))}_getCoordinateForViewplaneNormal(e,t){return e[this._getIndexOfCoordinatesForViewplaneNormal(t)]}}function b(e){const t=e.cachedStats.statistics,{area:n,mean:o,max:a,stdDev:s,areaUnit:r,modalityUnit:l}=t;if(void 0===o)return;const d=[];return d.push(`Area: ${i.utilities.roundNumber(n)} ${r}`),d.push(`Mean: ${i.utilities.roundNumber(o)} ${l}`),d.push(`Max: ${i.utilities.roundNumber(a)} ${l}`),d.push(`Std Dev: ${i.utilities.roundNumber(s)} ${l}`),d}T.toolName="RectangleROIStartEndThreshold";const S=T},40336:(e,t,n)=>{"use strict";n.d(t,{A:()=>m});var i=n(81985),o=n(6802),a=n(2076),s=n(89578),r=n(8056),l=n(7001),d=n(58640),c=n(29601),h=n(44049),g=n(4010);class u extends g.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,c=(0,i.getEnabledElement)(a),{viewport:h,renderingEngine:g}=c;this.isDrawing=!0;const u=h.getCamera(),{viewPlaneNormal:m,viewUp:v}=u,p=this.getTargetId(h);let f,w;if(h instanceof i.StackViewport)f=p.split("imageId:")[1];else{w=i.utilities.getVolumeId(p);const e=i.cache.getVolume(w);f=i.utilities.getClosestImageId(e,s,m)}const E=h.getFrameOfReferenceUID(),I={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...m],enabledElement:c,viewUp:[...v],FrameOfReferenceUID:E,referencedImageId:f,toolName:this.getToolName(),volumeId:w},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...s],[...s],[...s],[...s]],activeHandleIndex:null},segmentationId:null}};(0,o.lC)(I,a);const C=(0,r.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:I,viewportIdsToRender:C,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,l.hideElementCursor)(a),e.preventDefault(),(0,d.A)(C),I},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:r}=i;let l=(0,o.Rh)(this.getToolName(),r);if(!l?.length)return n;if(l=this.filterInteractableAnnotationsForElement(r,l),!l?.length)return n;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){const o=l[e],{annotationUID:g,data:u}=o,{points:m,activeHandleIndex:v}=u.handles,p=m.map((e=>i.worldToCanvas(e)));d.annotationUID=g;const f=this.getStyle("lineWidth",d,o),w=this.getStyle("lineDash",d,o),E=this.getStyle("color",d,o);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let I;if((0,h.XF)(o,r),!(0,c.isAnnotationVisible)(g))continue;if((0,a.isAnnotationLocked)(g)||this.editData||null===v||(I=[p[v]]),I){const e="0";(0,s.drawHandles)(t,g,e,I,{color:E})}const C="0";(0,s.drawRect)(t,g,C,p[0],p[3],{color:E,lineDash:w,lineWidth:f}),n=!0}return n}}}u.toolName="RectangleROIThreshold";const m=u},93126:(e,t,n)=>{"use strict";var i;n.d(t,{W:()=>i}),function(e){e[e.CounterClockwise=-1]="CounterClockwise",e[e.Unknown=0]="Unknown",e[e.Clockwise=1]="Clockwise"}(i||(i={}))},13369:()=>{},64843:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addContourSegmentationAnnotation:()=>a.V,areSameSegment:()=>i.A,isContourSegmentationAnnotation:()=>o.A,removeContourSegmentationAnnotation:()=>s.M});var i=n(62854),o=n(78130),a=n(85263),s=n(37354)},15295:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(81985);const{isEqual:o}=i.utilities;function a(e){const{metadata:t}=e;return(0,i.getEnabledElements)().filter((e=>{if(e.FrameOfReferenceUID===t.FrameOfReferenceUID){const n=e.viewport,{viewPlaneNormal:i,viewUp:a}=n.getCamera();return o(i,t.viewPlaneNormal)&&(!t.viewUp||o(a,t.viewUp))}})).map((e=>e.viewport))}},23566:(e,t,n)=>{"use strict";n.r(t),n.d(t,{annotationFrameRange:()=>p.A,annotationHydration:()=>w.i,boundingBox:()=>D,calibrateImageSpacing:()=>d.A,cine:()=>A,contourSegmentation:()=>U,contours:()=>E,debounce:()=>s.A,drawing:()=>C,dynamicVolume:()=>P,getAnnotationNearPoint:()=>a.S,getAnnotationNearPointOnEnabledElement:()=>a.s,getCalibratedAspect:()=>c.CQ,getCalibratedLengthUnitsAndScale:()=>c.Op,getCalibratedProbeUnitsAndValue:()=>c.Xw,getClosestImageIdForStackViewport:()=>w.x,getSphereBoundsInfo:()=>m.R,getViewportForAnnotation:()=>f.A,isObject:()=>l.A,math:()=>_,orientation:()=>i,planar:()=>T,planarFreehandROITool:()=>x,pointInSurroundingSphereCallback:()=>V.i,pointToString:()=>v.l,polyDataUtils:()=>N,rectangleROITool:()=>M,roundNumber:()=>W,segmentation:()=>I,stackContextPrefetch:()=>O.N,stackPrefetch:()=>O.S,throttle:()=>r.A,touch:()=>L,triggerAnnotationRender:()=>u.A,triggerAnnotationRenderForToolGroupIds:()=>g.A,triggerAnnotationRenderForViewportIds:()=>h.A,triggerEvent:()=>o.triggerEvent,viewport:()=>R,viewportFilters:()=>b,voi:()=>k});var i={};n.r(i),n.d(i,{getOrientationStringLPS:()=>S.A,invertOrientationStringLPS:()=>y.A});var o=n(81985),a=n(41293),s=n(52905),r=n(27730),l=n(45217),d=n(58271),c=n(4096),h=n(58640),g=n(94779),u=n(56069),m=n(4296),v=n(38726),p=n(73961),f=n(62514),w=n(64485),E=n(54010),I=n(67470),C=n(66990),_=n(95527),T=n(13165),b=n(8056),S=n(7193),y=n(2786),A=n(43488),D=n(72282),x=n(66129),M=n(74866),O=n(4850),R=n(19027),L=n(76260),P=n(74609),N=n(32994),k=n(93575),U=n(64843),V=n(10261);const W=o.utilities.roundNumber},95527:(e,t,n)=>{"use strict";n.r(t),n.d(t,{BasicStatsCalculator:()=>o,aabb:()=>i,ellipse:()=>a,lineSegment:()=>s,point:()=>r,polyline:()=>l,rectangle:()=>d,vec2:()=>c});var i=n(88638),o=n(79362),a=n(87009),s=n(93258),r=n(29614),l=n(92984),d=n(92282),c=n(23324)},90554:(e,t,n)=>{"use strict";function i(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const o=function(e,t){const[n,i]=e,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))}(t,e);o<i&&(i=o,n=[...e])})),n}n.d(t,{A:()=>i})},25758:(e,t,n)=>{"use strict";n.d(t,{O:()=>r});var i=n(81985),o=n(99737),a=n(64063),s=n(33283);function r(e){const t=(0,a.R1)(e);if(t)return t;const n=(0,s.T)(e);if(!n)throw new Error(`No segmentation found for segmentationId ${e}`);let r;if(n.representationData.Labelmap)r=function(e,t){const n=e.representationData[o.SegmentationRepresentations.Labelmap],a=new Set;n.imageIds?function(e,t){t.forEach((t=>{i.cache.getImage(t).voxelManager.getScalarData().forEach((t=>{0!==t&&e.add(t)}))}))}(a,n.imageIds):function(e,t){const n=i.cache.getVolume(t);n.voxelManager.forEach((({value:t})=>{0!==t&&e.add(t)}))}(a,t);return Array.from(a).map(Number).sort(((e,t)=>e-t))}(n,e);else if(n.representationData.Contour)r=function(e){const{annotationUIDsMap:t,geometryIds:n}=e.representationData.Contour||{};if(!n)throw new Error(`No geometryIds found for segmentationId ${e.segmentationId}`);const o=new Set([...t.keys()]);return n.forEach((e=>{const t=i.cache.getGeometry(e);o.add(t.data.segmentIndex)})),Array.from(o).sort(((e,t)=>e-t))}(n);else{if(!n.representationData.Surface)throw new Error(`Unsupported segmentation type: ${n.representationData}`);r=function(e){const t=e.representationData.Surface?.geometryIds??[];return Array.from(t.keys()).map(Number).sort(((e,t)=>e-t))}(n)}return(0,a.Dm)(e,r),r}},35706:(e,t,n)=>{"use strict";n.d(t,{E:()=>s});var i=n(7754),o=n(58640),a=n(14957);function s(e){const t=(0,i.getToolGroup)(e);if(void 0===t)return;(0,a.n)(e).forEach((e=>{e.invalidateBrushCursor()}));const n=t.getViewportsInfo();if(!Object.keys(n).map((e=>n[e])).length)return;const s=t.getViewportIds();(0,o.A)(s)}},64063:(e,t,n)=>{"use strict";n.d(t,{Dm:()=>h,HM:()=>d,Q5:()=>s,R1:()=>c,zf:()=>r});var i=n(81985),o=n(87063);const a=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function s(e,t,n,a){const s=n[0]/2,r=n[1]/2,l=n[2]/2,d=new Array(8);d[0]=i.utilities.transformWorldToIndex(e,[a[0]-s,a[1]-r,a[2]-l]);const c=[[1,-1,-1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,1,1],[1,1,1]];for(let t=0;t<7;t++){const[n,o,h]=c[t];d[t+1]=i.utilities.transformWorldToIndex(e,[a[0]+n*s,a[1]+o*r,a[2]+h*l])}return(0,o.g)(d,t)}function r(e,t){const{spacing:n}=e,i=e.voxelManager.getScalarDataLength(),o=[];let s=0;for(let e=0;e<t.length;e++){const{imageData:r,spacing:l,dimensions:d,voxelManager:c}=t[e].volume,h=t[e].volume.voxelManager.getScalarDataLength();h===i&&a(l,n)&&(s=e);const g=t[e].lower,u=t[e].upper;o.push({imageData:r,lower:g,upper:u,spacing:l,dimensions:d,volumeSize:h,voxelManager:c})}return{volumeInfoList:o,baseVolumeIdx:s}}const l=new Map,d=e=>{const t=l.get(e);t&&(t.isDirty=!0)},c=e=>{const t=l.get(e);return t&&!t.isDirty?t.indices:null},h=(e,t)=>{l.set(e,{indices:t,isDirty:!1})}},58640:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,t:()=>a});var i=n(81985),o=n(56069);function a(e){e.length&&e.forEach((e=>{const t=(0,i.getEnabledElementByViewportId)(e);if(!t)return void console.warn(`Viewport not available for ${e}`);const{viewport:n}=t;if(!n)return void console.warn(`Viewport not available for ${e}`);const a=n.element;(0,o.A)(a)}))}const s=a},28802:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Colorbar:()=>o.P,Enums:()=>i,ViewportColorbar:()=>a.b});var i=n(51807),o=n(24605),a=n(91008)},35056:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>c});var i=n(28906),o=n(42008),a=n(28914);function s(e){let t=0;return e.filter(((e,n)=>n===t&&(t+=e+1,!0)))}function r(e){let t=0;for(let n=0;n<e.length;)n+=e[n]+1,t++;return t}const l={extractCellSizes:s,getNumberOfCells:r};function d(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};o.Ay.extend(e,t,function(e){return{empty:!0,numberOfComponents:1,dataType:a.JA.UNSIGNED_INT,...e}}(n)),function(e,t){t.classHierarchy.push("vtkCellArray");const n={...e};e.getNumberOfCells=n=>void 0===t.numberOfCells||n?(t.cellSizes?t.numberOfCells=t.cellSizes.length:t.numberOfCells=r(e.getData()),t.numberOfCells):t.numberOfCells,e.getCellSizes=n=>void 0===t.cellSizes||n?(t.cellSizes=s(e.getData()),t.cellSizes):t.cellSizes,e.resize=i=>{const o=e.getNumberOfTuples();n.resize(i);const a=e.getNumberOfTuples();a<o&&(0===a?(t.numberOfCells=0,t.cellSizes=[]):(t.numberOfCells=void 0,t.cellSizes=void 0))},e.setData=e=>{n.setData(e,1),t.numberOfCells=void 0,t.cellSizes=void 0},e.getCell=e=>{let n=e;const i=t.values[n++];return t.values.subarray(n,n+i)},e.insertNextCell=n=>{const i=e.getNumberOfCells();return e.insertNextTuples([n.length,...n]),++t.numberOfCells,null!=t.cellSizes&&t.cellSizes.push(n.length),i}}(e,t)}var c={newInstance:i.m.newInstance(d,"vtkCellArray"),extend:d,...l}},28914:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>a,JA:()=>o,uP:()=>i});const i={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},o={VOID:"",CHAR:"Int8Array",SIGNED_CHAR:"Int8Array",UNSIGNED_CHAR:"Uint8Array",UNSIGNED_CHAR_CLAMPED:"Uint8ClampedArray",SHORT:"Int16Array",UNSIGNED_SHORT:"Uint16Array",INT:"Int32Array",UNSIGNED_INT:"Uint32Array",FLOAT:"Float32Array",DOUBLE:"Float64Array"};var a={DefaultDataType:o.FLOAT,DataTypeByteSize:i,VtkDataTypes:o}},62612:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>o,kP:()=>i});const i={DEFAULT:0,SINGLE:1,DOUBLE:2};var o={AttributeCopyOperations:{COPYTUPLE:0,INTERPOLATE:1,PASSDATA:2,ALLCOPY:3},AttributeLimitTypes:{MAX:0,EXACT:1,NOLIMIT:2},AttributeTypes:{SCALARS:0,VECTORS:1,NORMALS:2,TCOORDS:3,TENSORS:4,GLOBALIDS:5,PEDIGREEIDS:6,EDGEFLAG:7,NUM_ATTRIBUTES:8},CellGhostTypes:{DUPLICATECELL:1,HIGHCONNECTIVITYCELL:2,LOWCONNECTIVITYCELL:4,REFINEDCELL:8,EXTERIORCELL:16,HIDDENCELL:32},DesiredOutputPrecision:i,PointGhostTypes:{DUPLICATEPOINT:1,HIDDENPOINT:2},ghostArrayName:"vtkGhostType"}},58498:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>u});var i=n(28906),o=n(16632),a=n(21734),s=n(69147),r=n(24964),l=n(85278),d=n(3823);const{vtkErrorMacro:c}=i.m;const h={direction:null,indexToWorld:null,worldToIndex:null,spacing:[1,1,1],origin:[0,0,0],extent:[0,-1,0,-1,0,-1],dataDescription:l.e.EMPTY};function g(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,h,n),s.Ay.extend(e,t,n),t.direction?Array.isArray(t.direction)&&(t.direction=new Float64Array(t.direction.slice(0,9))):t.direction=d.w0.identity(new Float64Array(9)),t.indexToWorld=new Float64Array(16),t.worldToIndex=new Float64Array(16),i.m.get(e,t,["indexToWorld","worldToIndex"]),i.m.setGetArray(e,t,["origin","spacing"],3),i.m.setGetArray(e,t,["direction"],9),i.m.getArray(e,t,["extent"],6),function(e,t){t.classHierarchy.push("vtkImageData"),e.setExtent=function(){if(t.deleted)return c("instance deleted - cannot call any method"),!1;for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];const a=1===i.length?i[0]:i;if(6!==a.length)return!1;const s=t.extent.some(((e,t)=>e!==a[t]));return s&&(t.extent=a.slice(),t.dataDescription=r.A.getDataDescriptionFromExtent(t.extent),e.modified()),s},e.setDimensions=function(){let n,i,o;if(t.deleted)c("instance deleted - cannot call any method");else{if(1===arguments.length){const e=arguments.length<=0?void 0:arguments[0];n=e[0],i=e[1],o=e[2]}else{if(3!==arguments.length)return void c("Bad dimension specification");n=arguments.length<=0?void 0:arguments[0],i=arguments.length<=1?void 0:arguments[1],o=arguments.length<=2?void 0:arguments[2]}e.setExtent(0,n-1,0,i-1,0,o-1)}},e.getDimensions=()=>[t.extent[1]-t.extent[0]+1,t.extent[3]-t.extent[2]+1,t.extent[5]-t.extent[4]+1],e.getNumberOfCells=()=>{const t=e.getDimensions();let n=1;for(let e=0;e<3;e++){if(0===t[e])return 0;t[e]>1&&(n*=t[e]-1)}return n},e.getNumberOfPoints=()=>{const t=e.getDimensions();return t[0]*t[1]*t[2]},e.getPoint=n=>{const i=e.getDimensions();if(0===i[0]||0===i[1]||0===i[2])return c("Requesting a point from an empty image."),null;const o=new Float64Array(3);switch(t.dataDescription){case l.e.EMPTY:return null;case l.e.SINGLE_POINT:break;case l.e.X_LINE:o[0]=n;break;case l.e.Y_LINE:o[1]=n;break;case l.e.Z_LINE:o[2]=n;break;case l.e.XY_PLANE:o[0]=n%i[0],o[1]=n/i[0];break;case l.e.YZ_PLANE:o[1]=n%i[1],o[2]=n/i[1];break;case l.e.XZ_PLANE:o[0]=n%i[0],o[2]=n/i[0];break;case l.e.XYZ_GRID:o[0]=n%i[0],o[1]=n/i[0]%i[1],o[2]=n/(i[0]*i[1]);break;default:c("Invalid dataDescription")}const a=[0,0,0];return e.indexToWorld(o,a),a},e.getBounds=()=>e.extentToBounds(e.getSpatialExtent()),e.extentToBounds=e=>a.Ay.transformBounds(e,t.indexToWorld),e.getSpatialExtent=()=>a.Ay.inflate([...t.extent],.5),e.computeTransforms=()=>{d.pB.fromTranslation(t.indexToWorld,t.origin),t.indexToWorld[0]=t.direction[0],t.indexToWorld[1]=t.direction[1],t.indexToWorld[2]=t.direction[2],t.indexToWorld[4]=t.direction[3],t.indexToWorld[5]=t.direction[4],t.indexToWorld[6]=t.direction[5],t.indexToWorld[8]=t.direction[6],t.indexToWorld[9]=t.direction[7],t.indexToWorld[10]=t.direction[8],d.pB.scale(t.indexToWorld,t.indexToWorld,t.spacing),d.pB.invert(t.worldToIndex,t.indexToWorld)},e.indexToWorld=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return d.eR.transformMat4(n,e,t.indexToWorld),n},e.indexToWorldVec3=e.indexToWorld,e.worldToIndex=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return d.eR.transformMat4(n,e,t.worldToIndex),n},e.worldToIndexVec3=e.worldToIndex,e.indexToWorldBounds=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return a.Ay.transformBounds(e,t.indexToWorld,n)},e.worldToIndexBounds=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return a.Ay.transformBounds(e,t.worldToIndex,n)},e.onModified(e.computeTransforms),e.computeTransforms(),e.getCenter=()=>a.Ay.getCenter(e.getBounds()),e.computeHistogram=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=[0,0,0,0,0,0];e.worldToIndexBounds(t,i);const s=[0,0,0],r=[0,0,0];a.Ay.computeCornerPoints(i,s,r),(0,o.b)(s,s),(0,o.b)(r,r);const l=e.getDimensions();(0,o.c)(s,[0,0,0],[l[0]-1,l[1]-1,l[2]-1],s),(0,o.c)(r,[0,0,0],[l[0]-1,l[1]-1,l[2]-1],r);const d=l[0],c=l[0]*l[1],h=e.getPointData().getScalars().getData();let g=-1/0,u=1/0,m=0,v=0,p=0;for(let e=s[2];e<=r[2];e++)for(let t=s[1];t<=r[1];t++){let o=s[0]+t*d+e*c;for(let a=s[0];a<=r[0];a++){if(!n||n([a,t,e],i)){const e=h[o];e>g&&(g=e),e<u&&(u=e),m+=e*e,v+=e,p+=1}++o}}const f=p>0?v/p:0,w=p?Math.abs(m/p-f*f):0;return{minimum:u,maximum:g,average:f,variance:w,sigma:Math.sqrt(w),count:p}},e.computeIncrements=function(e){const t=[];let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;for(let i=0;i<3;++i)t[i]=n,n*=e[2*i+1]-e[2*i]+1;return t},e.computeOffsetIndex=t=>{let[n,i,o]=t;const a=e.getExtent(),s=e.getPointData().getScalars().getNumberOfComponents(),r=e.computeIncrements(a,s);return Math.floor((Math.round(n)-a[0])*r[0]+(Math.round(i)-a[2])*r[1]+(Math.round(o)-a[4])*r[2])},e.getOffsetIndexFromWorld=t=>{const n=e.getExtent(),i=e.worldToIndex(t);for(let e=0;e<3;++e)if(i[e]<n[2*e]||i[e]>n[2*e+1])return c(`GetScalarPointer: Pixel ${i} is not in memory. Current extent = ${n}`),NaN;return e.computeOffsetIndex(i)},e.getScalarValueFromWorld=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=e.getPointData().getScalars().getNumberOfComponents();if(n<0||n>=i)return c(`GetScalarPointer: Scalar Component ${n} is not within bounds. Current Scalar numberOfComponents: ${i}`),NaN;const o=e.getOffsetIndexFromWorld(t);return Number.isNaN(o)?o:e.getPointData().getScalars().getComponent(o,n)}}(e,t)}var u={newInstance:i.m.newInstance(g,"vtkImageData"),extend:g}},93008:(e,t,n)=>{var i="__lodash_hash_undefined__",o=1/0,a="[object Function]",s="[object GeneratorFunction]",r="[object Symbol]",l=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,d=/^\w*$/,c=/^\./,h=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,g=/\\(\\)?/g,u=/^\[object .+?Constructor\]$/,m="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,v="object"==typeof self&&self&&self.Object===Object&&self,p=m||v||Function("return this")();var f,w=Array.prototype,E=Function.prototype,I=Object.prototype,C=p["__core-js_shared__"],_=(f=/[^.]+$/.exec(C&&C.keys&&C.keys.IE_PROTO||""))?"Symbol(src)_1."+f:"",T=E.toString,b=I.hasOwnProperty,S=I.toString,y=RegExp("^"+T.call(b).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),A=p.Symbol,D=w.splice,x=B(p,"Map"),M=B(Object,"create"),O=A?A.prototype:void 0,R=O?O.toString:void 0;function L(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function N(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function k(e,t){for(var n,i,o=e.length;o--;)if((n=e[o][0])===(i=t)||n!=n&&i!=i)return o;return-1}function U(e,t){var n;t=function(e,t){if($(e))return!1;var n=typeof e;if("number"==n||"symbol"==n||"boolean"==n||null==e||q(e))return!0;return d.test(e)||!l.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:$(n=t)?n:H(n);for(var i=0,o=t.length;null!=e&&i<o;)e=e[F(t[i++])];return i&&i==o?e:void 0}function V(e){if(!z(e)||(t=e,_&&_ in t))return!1;var t,n=function(e){var t=z(e)?S.call(e):"";return t==a||t==s}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?y:u;return n.test(function(e){if(null!=e){try{return T.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function W(e,t){var n,i,o=e.__data__;return("string"==(i=typeof(n=t))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function B(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return V(n)?n:void 0}L.prototype.clear=function(){this.__data__=M?M(null):{}},L.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},L.prototype.get=function(e){var t=this.__data__;if(M){var n=t[e];return n===i?void 0:n}return b.call(t,e)?t[e]:void 0},L.prototype.has=function(e){var t=this.__data__;return M?void 0!==t[e]:b.call(t,e)},L.prototype.set=function(e,t){return this.__data__[e]=M&&void 0===t?i:t,this},P.prototype.clear=function(){this.__data__=[]},P.prototype.delete=function(e){var t=this.__data__,n=k(t,e);return!(n<0)&&(n==t.length-1?t.pop():D.call(t,n,1),!0)},P.prototype.get=function(e){var t=this.__data__,n=k(t,e);return n<0?void 0:t[n][1]},P.prototype.has=function(e){return k(this.__data__,e)>-1},P.prototype.set=function(e,t){var n=this.__data__,i=k(n,e);return i<0?n.push([e,t]):n[i][1]=t,this},N.prototype.clear=function(){this.__data__={hash:new L,map:new(x||P),string:new L}},N.prototype.delete=function(e){return W(this,e).delete(e)},N.prototype.get=function(e){return W(this,e).get(e)},N.prototype.has=function(e){return W(this,e).has(e)},N.prototype.set=function(e,t){return W(this,e).set(e,t),this};var H=G((function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(q(e))return R?R.call(e):"";var t=e+"";return"0"==t&&1/e==-o?"-0":t}(t);var n=[];return c.test(e)&&n.push(""),e.replace(h,(function(e,t,i,o){n.push(i?o.replace(g,"$1"):t||e)})),n}));function F(e){if("string"==typeof e||q(e))return e;var t=e+"";return"0"==t&&1/e==-o?"-0":t}function G(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var i=arguments,o=t?t.apply(this,i):i[0],a=n.cache;if(a.has(o))return a.get(o);var s=e.apply(this,i);return n.cache=a.set(o,s),s};return n.cache=new(G.Cache||N),n}G.Cache=N;var $=Array.isArray;function z(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function q(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&S.call(e)==r}e.exports=function(e,t,n){var i=null==e?void 0:U(e,t);return void 0===i?n:i}},99178:(e,t,n)=>{"use strict";n.d(t,{A2:()=>a,BX:()=>I,LV:()=>g,p:()=>c});const i=Symbol("Comlink.proxy"),o=Symbol("Comlink.endpoint"),a=Symbol("Comlink.releaseProxy"),s=Symbol("Comlink.finalizer"),r=Symbol("Comlink.thrown"),l=e=>"object"==typeof e&&null!==e||"function"==typeof e,d=new Map([["proxy",{canHandle:e=>l(e)&&e[i],serialize(e){const{port1:t,port2:n}=new MessageChannel;return c(e,t),[n,[n]]},deserialize:e=>(e.start(),g(e))}],["throw",{canHandle:e=>l(e)&&r in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function c(e,t=globalThis,n=["*"]){t.addEventListener("message",(function i(o){if(!o||!o.data)return;if(!function(e,t){for(const n of e){if(t===n||"*"===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}return!1}(n,o.origin))return void console.warn(`Invalid origin '${o.origin}' for comlink proxy`);const{id:a,type:l,path:d}=Object.assign({path:[]},o.data),g=(o.data.argumentList||[]).map(_);let u;try{const t=d.slice(0,-1).reduce(((e,t)=>e[t]),e),n=d.reduce(((e,t)=>e[t]),e);switch(l){case"GET":u=n;break;case"SET":t[d.slice(-1)[0]]=_(o.data.value),u=!0;break;case"APPLY":u=n.apply(t,g);break;case"CONSTRUCT":u=I(new n(...g));break;case"ENDPOINT":{const{port1:t,port2:n}=new MessageChannel;c(e,n),u=function(e,t){return E.set(e,t),e}(t,[t])}break;case"RELEASE":u=void 0;break;default:return}}catch(e){u={value:e,[r]:0}}Promise.resolve(u).catch((e=>({value:e,[r]:0}))).then((n=>{const[o,r]=C(n);t.postMessage(Object.assign(Object.assign({},o),{id:a}),r),"RELEASE"===l&&(t.removeEventListener("message",i),h(t),s in e&&"function"==typeof e[s]&&e[s]())})).catch((e=>{const[n,i]=C({value:new TypeError("Unserializable return value"),[r]:0});t.postMessage(Object.assign(Object.assign({},n),{id:a}),i)}))})),t.start&&t.start()}function h(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function g(e,t){return f(e,[],t)}function u(e){if(e)throw new Error("Proxy has been released and is not useable")}function m(e){return T(e,{type:"RELEASE"}).then((()=>{h(e)}))}const v=new WeakMap,p="FinalizationRegistry"in globalThis&&new FinalizationRegistry((e=>{const t=(v.get(e)||0)-1;v.set(e,t),0===t&&m(e)}));function f(e,t=[],n=function(){}){let i=!1;const s=new Proxy(n,{get(n,o){if(u(i),o===a)return()=>{!function(e){p&&p.unregister(e)}(s),m(e),i=!0};if("then"===o){if(0===t.length)return{then:()=>s};const n=T(e,{type:"GET",path:t.map((e=>e.toString()))}).then(_);return n.then.bind(n)}return f(e,[...t,o])},set(n,o,a){u(i);const[s,r]=C(a);return T(e,{type:"SET",path:[...t,o].map((e=>e.toString())),value:s},r).then(_)},apply(n,a,s){u(i);const r=t[t.length-1];if(r===o)return T(e,{type:"ENDPOINT"}).then(_);if("bind"===r)return f(e,t.slice(0,-1));const[l,d]=w(s);return T(e,{type:"APPLY",path:t.map((e=>e.toString())),argumentList:l},d).then(_)},construct(n,o){u(i);const[a,s]=w(o);return T(e,{type:"CONSTRUCT",path:t.map((e=>e.toString())),argumentList:a},s).then(_)}});return function(e,t){const n=(v.get(t)||0)+1;v.set(t,n),p&&p.register(e,t,e)}(s,e),s}function w(e){const t=e.map(C);return[t.map((e=>e[0])),(n=t.map((e=>e[1])),Array.prototype.concat.apply([],n))];var n}const E=new WeakMap;function I(e){return Object.assign(e,{[i]:!0})}function C(e){for(const[t,n]of d)if(n.canHandle(e)){const[i,o]=n.serialize(e);return[{type:"HANDLER",name:t,value:i},o]}return[{type:"RAW",value:e},E.get(e)||[]]}function _(e){switch(e.type){case"HANDLER":return d.get(e.name).deserialize(e.value);case"RAW":return e.value}}function T(e,t,n){return new Promise((i=>{const o=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===o&&(e.removeEventListener("message",t),i(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),n)}))}},75210:(e,t,n)=>{"use strict";n.d(t,{h1:()=>i.Ay,yl:()=>o.A,lq:()=>s.lq,sG:()=>s.sG,Zc:()=>s.Ay,yU:()=>l});var i=n(81068),o=(n(18642),n(38153)),a=(n(19743),n(5739),n(67800),n(11472),n(33760),n(47803),n(80130),n(52827),n(13723),n(22543),n(97315),n(48210),n(95211),n(67049),n(36426),n(64196),n(61515),n(26892),n(37412),n(57623)),s=(n(97982),n(3581),n(51963),n(35457),n(83254),n(49115),n(43523),n(14029),n(36820),n(84201),n(55973),n(40049),n(82061),n(65591),n(96945),n(66871),n(47598));function r(e){return e.length}n(77097);function l(){return function(e){if(!(o=e.length))return[];for(var t=-1,n=(0,a.A)(e,r),i=new Array(n);++t<n;)for(var o,s=-1,l=i[t]=new Array(o);++s<o;)l[s]=e[s][t];return i}(arguments)}n(25475),n(39034),n(95388),n(69010),n(91804),n(23526),n(60786),n(18949),n(77050),n(29351),n(59128),n(47051),n(78603),n(59043)},57623:(e,t,n)=>{"use strict";function i(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let i=-1;for(let o of e)null!=(o=t(o,++i,e))&&(n>o||void 0===n&&o>=o)&&(n=o)}return n}n.d(t,{A:()=>i})},65481:(e,t,n)=>{"use strict";n.d(t,{GW:()=>i.A,Qm:()=>o.A,Dj:()=>a.A,sH:()=>s.A,yd:()=>r});var i=n(1283),o=(n(82043),n(43724)),a=(n(96184),n(2728),n(61847),n(73524),n(20825)),s=(n(32204),n(34107),n(66822));n(33637),n(62911),n(85351),n(83441),n(26093),n(86617),n(69277),n(34121),n(84444);function r(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e(i/(t-1));return n}}}]);
//# sourceMappingURL=5717.bundle.b8aa8ab6825291a6bba0.js.map