{"version":3,"file":"8228.bundle.cf66576507e12939d599.js","mappings":"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","sources":["webpack:///../../../extensions/dicom-microscopy/src/components/ViewportOverlay/listComponentGenerator.tsx","webpack:///../../../extensions/dicom-microscopy/src/components/ViewportOverlay/index.tsx","webpack:///../../../extensions/dicom-microscopy/src/DicomMicroscopyViewport.tsx","webpack:///../../../extensions/dicom-microscopy/src/utils/dicomWebClient.ts"],"sourcesContent":["const listComponentGenerator = props => {\n  const { list, itemGenerator } = props;\n  if (!list) {\n    return;\n  }\n  return list.map(item => {\n    if (!item) {\n      return;\n    }\n    const generator = item.generator || itemGenerator;\n    if (!generator) {\n      throw new Error(`No generator for ${item}`);\n    }\n    return generator({ ...props, item });\n  });\n};\n\nexport default listComponentGenerator;\n","import React from 'react';\nimport classnames from 'classnames';\n\nimport listComponentGenerator from './listComponentGenerator';\nimport './ViewportOverlay.css';\nimport { formatDICOMDate, formatDICOMTime, formatNumberPrecision, formatPN } from './utils';\n\ninterface OverlayItem {\n  id: string;\n  title: string;\n  value?: (props: any) => string;\n  condition?: (props: any) => boolean;\n  contents?: (props: any) => { className: string; value: any };\n  generator?: (props: any) => any;\n}\n\n/**\n *\n * @param {*} config is a configuration object that defines four lists of elements,\n * one topLeft, topRight, bottomLeft, bottomRight contents.\n * @param {*} extensionManager is used to load the image data.\n * @returns\n */\nexport const generateFromConfig = ({\n  topLeft = [],\n  topRight = [],\n  bottomLeft = [],\n  bottomRight = [],\n  itemGenerator = () => {},\n}: {\n  topLeft?: OverlayItem[];\n  topRight?: OverlayItem[];\n  bottomLeft?: OverlayItem[];\n  bottomRight?: OverlayItem[];\n  itemGenerator?: (props: any) => any;\n}) => {\n  return (props: any) => {\n    const topLeftClass = 'top-viewport left-viewport text-primary-light';\n    const topRightClass = 'top-viewport right-viewport-scrollbar text-primary-light';\n    const bottomRightClass = 'bottom-viewport right-viewport-scrollbar text-primary-light';\n    const bottomLeftClass = 'bottom-viewport left-viewport text-primary-light';\n    const overlay = 'absolute pointer-events-none microscopy-viewport-overlay';\n\n    return (\n      <>\n        {topLeft && topLeft.length > 0 && (\n          <div data-cy={'viewport-overlay-top-left'} className={classnames(overlay, topLeftClass)}>\n            {listComponentGenerator({ ...props, list: topLeft, itemGenerator })}\n          </div>\n        )}\n        {topRight && topRight.length > 0 && (\n          <div\n            data-cy={'viewport-overlay-top-right'}\n            className={classnames(overlay, topRightClass)}\n          >\n            {listComponentGenerator({\n              ...props,\n              list: topRight,\n              itemGenerator,\n            })}\n          </div>\n        )}\n        {bottomRight && bottomRight.length > 0 && (\n          <div\n            data-cy={'viewport-overlay-bottom-right'}\n            className={classnames(overlay, bottomRightClass)}\n          >\n            {listComponentGenerator({\n              ...props,\n              list: bottomRight,\n              itemGenerator,\n            })}\n          </div>\n        )}\n        {bottomLeft && bottomLeft.length > 0 && (\n          <div\n            data-cy={'viewport-overlay-bottom-left'}\n            className={classnames(overlay, bottomLeftClass)}\n          >\n            {listComponentGenerator({\n              ...props,\n              list: bottomLeft,\n              itemGenerator,\n            })}\n          </div>\n        )}\n      </>\n    );\n  };\n};\n\nconst itemGenerator = (props: any) => {\n  const { item } = props;\n  const { title, value: valueFunc, condition, contents } = item;\n  props.image = { ...props.image, ...props.metadata };\n  props.formatDate = formatDICOMDate;\n  props.formatTime = formatDICOMTime;\n  props.formatPN = formatPN;\n  props.formatNumberPrecision = formatNumberPrecision;\n  if (condition && !condition(props)) {\n    return null;\n  }\n  if (!contents && !valueFunc) {\n    return null;\n  }\n  const value = valueFunc && valueFunc(props);\n  const contentsValue = (contents && contents(props)) || [\n    { className: 'mr-1', value: title },\n    { classname: 'mr-1 font-light', value },\n  ];\n\n  return (\n    <div key={item.id} className=\"flex flex-row\">\n      {contentsValue.map((content, idx) => (\n        <span key={idx} className={content.className}>\n          {content.value}\n        </span>\n      ))}\n    </div>\n  );\n};\n\nexport default generateFromConfig({});\n","import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { LoadingIndicatorProgress } from '@ohif/ui';\nimport { cleanDenaturalizedDataset } from '@ohif/extension-default';\n\nimport './DicomMicroscopyViewport.css';\nimport ViewportOverlay from './components/ViewportOverlay';\nimport getDicomWebClient from './utils/dicomWebClient';\nimport dcmjs from 'dcmjs';\nimport MicroscopyService from './services/MicroscopyService';\n\nclass DicomMicroscopyViewport extends Component {\n  state = {\n    error: null as any,\n    isLoaded: false,\n  };\n\n  microscopyService: MicroscopyService;\n  viewer: any = null; // dicom-microscopy-viewer instance\n  managedViewer: any = null; // managed wrapper of microscopy-dicom extension\n\n  container = React.createRef();\n  overlayElement = React.createRef();\n\n  constructor(props: any) {\n    super(props);\n\n    const { microscopyService } = this.props.servicesManager.services;\n    this.microscopyService = microscopyService;\n  }\n\n  static propTypes = {\n    viewportData: PropTypes.object,\n    activeViewportId: PropTypes.string,\n    setViewportActive: PropTypes.func,\n\n    // props from OHIF Viewport Grid\n    displaySets: PropTypes.array,\n    viewportId: PropTypes.string,\n    viewportLabel: PropTypes.string,\n    dataSource: PropTypes.object,\n    viewportOptions: PropTypes.object,\n    displaySetOptions: PropTypes.array,\n\n    // other props from wrapping component\n    servicesManager: PropTypes.object,\n    extensionManager: PropTypes.object,\n    commandsManager: PropTypes.object,\n    resizeRef: PropTypes.oneOfType([PropTypes.func, PropTypes.shape({ current: PropTypes.any })]),\n  };\n\n\n  /**\n   * Get the nearest ROI from the mouse click point\n   *\n   * @param event\n   * @param autoselect\n   * @returns\n   */\n  getNearbyROI(event: Event, autoselect = true) {\n    const symbols = Object.getOwnPropertySymbols(this.viewer);\n    const _drawingSource = symbols.find(p => p.description === 'drawingSource');\n    const _pyramid = symbols.find(p => p.description === 'pyramid');\n    const _map = symbols.find(p => p.description === 'map');\n    const _affine = symbols.find(p => p.description === 'affine');\n\n    const feature = this.viewer[_drawingSource].getClosestFeatureToCoordinate(\n      this.viewer[_map].getEventCoordinate(event)\n    );\n\n    if (!feature) {\n      return null;\n    }\n\n    const roiAnnotation = this.viewer._getROIFromFeature(\n      feature,\n      this.viewer[_pyramid].metadata,\n      this.viewer[_affine]\n    );\n    if (roiAnnotation && autoselect) {\n      this.microscopyService.selectAnnotation(roiAnnotation);\n    }\n    return roiAnnotation;\n  }\n\n  // install the microscopy renderer into the web page.\n  // you should only do this once.\n  async installOpenLayersRenderer(container, displaySet) {\n    const loadViewer = async metadata => {\n      const dicomMicroscopyModule = await this.microscopyService.importDicomMicroscopyViewer();\n      const { viewer: DicomMicroscopyViewer, metadata: metadataUtils } = dicomMicroscopyModule;\n\n      const microscopyViewer = DicomMicroscopyViewer.VolumeImageViewer;\n\n      const client = getDicomWebClient({\n        extensionManager: this.props.extensionManager,\n        servicesManager: this.props.servicesManager,\n      });\n\n      // Parse, format, and filter metadata\n      const volumeImages: any[] = [];\n\n      /**\n       * This block of code is the original way of loading DICOM into dicom-microscopy-viewer\n       * as in their documentation.\n       * But we have the metadata already loaded by our loaders.\n       * As the metadata for microscopy DIOM files tends to be big and we don't\n       * want to double load it, below we have the mechanism to reconstruct the\n       * DICOM JSON structure (denaturalized) from naturalized metadata.\n       * (NOTE: Our loaders cache only naturalized metadata, not the denaturalized.)\n       */\n      // {\n      //   const retrieveOptions = {\n      //     studyInstanceUID: metadata[0].StudyInstanceUID,\n      //     seriesInstanceUID: metadata[0].SeriesInstanceUID,\n      //   };\n      //   metadata = await client.retrieveSeriesMetadata(retrieveOptions);\n      //   // Parse, format, and filter metadata\n      //   metadata.forEach(m => {\n      //     if (\n      //       volumeImages.length > 0 &&\n      //       m['00200052'].Value[0] != volumeImages[0].FrameOfReferenceUID\n      //     ) {\n      //       console.warn(\n      //         'Expected FrameOfReferenceUID of difference instances within a series to be the same, found multiple different values',\n      //         m['00200052'].Value[0]\n      //       );\n      //       m['00200052'].Value[0] = volumeImages[0].FrameOfReferenceUID;\n      //     }\n      //     NOTE: depending on different data source, image.ImageType sometimes\n      //     is a string, not a string array.\n      //     m['00080008'] = transformImageTypeUnnaturalized(m['00080008']);\n\n      //     const image = new metadataUtils.VLWholeSlideMicroscopyImage({\n      //       metadata: m,\n      //     });\n      //     const imageFlavor = image.ImageType[2];\n      //     if (imageFlavor === 'VOLUME' || imageFlavor === 'THUMBNAIL') {\n      //       volumeImages.push(image);\n      //     }\n      //   });\n      // }\n\n      metadata.forEach(m => {\n        // NOTE: depending on different data source, image.ImageType sometimes\n        //    is a string, not a string array.\n        m.ImageType = typeof m.ImageType === 'string' ? m.ImageType.split('\\\\') : m.ImageType;\n\n        const inst = cleanDenaturalizedDataset(\n          dcmjs.data.DicomMetaDictionary.denaturalizeDataset(m),\n          {\n            StudyInstanceUID: m.StudyInstanceUID,\n            SeriesInstanceUID: m.SeriesInstanceUID,\n            dataSourceConfig: this.props.dataSource.getConfig(),\n          }\n        );\n        if (!inst['00480105']) {\n          // Optical Path Sequence, no OpticalPathIdentifier?\n          // NOTE: this is actually a not-well formatted DICOM VL Whole Slide Microscopy Image.\n          inst['00480105'] = {\n            vr: 'SQ',\n            Value: [\n              {\n                '00480106': {\n                  vr: 'SH',\n                  Value: ['1'],\n                },\n              },\n            ],\n          };\n        }\n        const image = new metadataUtils.VLWholeSlideMicroscopyImage({\n          metadata: inst,\n        });\n\n        const imageFlavor = image.ImageType[2];\n        if (imageFlavor === 'VOLUME' || imageFlavor === 'THUMBNAIL') {\n          volumeImages.push(image);\n        }\n      });\n\n      // format metadata for microscopy-viewer\n      const options = {\n        client,\n        metadata: volumeImages,\n        retrieveRendered: false,\n        controls: ['overview', 'position'],\n      };\n\n      this.viewer = new microscopyViewer(options);\n\n      if (this.overlayElement && this.overlayElement.current && this.viewer.addViewportOverlay) {\n        this.viewer.addViewportOverlay({\n          element: this.overlayElement.current,\n          coordinates: [0, 0], // TODO: dicom-microscopy-viewer documentation says this can be false to be automatically, but it is not.\n          navigate: true,\n          className: 'OpenLayersOverlay',\n        });\n      }\n\n      this.viewer.render({ container });\n\n      const { StudyInstanceUID, SeriesInstanceUID } = displaySet;\n\n      this.managedViewer = this.microscopyService.addViewer(\n        this.viewer,\n        this.props.viewportId,\n        container,\n        StudyInstanceUID,\n        SeriesInstanceUID\n      );\n\n      this.managedViewer.addContextMenuCallback((event: Event) => {\n        // TODO: refactor this after Bill's changes on ContextMenu feature get merged\n        // const roiAnnotationNearBy = this.getNearbyROI(event);\n      });\n    };\n\n    this.microscopyService.clearAnnotations();\n\n    let smDisplaySet = displaySet;\n    if (displaySet.Modality === 'SR') {\n      // for SR displaySet, let's load the actual image displaySet\n      smDisplaySet = displaySet.getSourceDisplaySet();\n    }\n    console.log('Loading viewer metadata', smDisplaySet);\n\n    await loadViewer(smDisplaySet.others);\n\n    if (displaySet.Modality === 'SR') {\n      displaySet.load(smDisplaySet);\n    }\n  }\n\n  componentDidMount() {\n    const { displaySets, viewportOptions } = this.props;\n    // Todo-rename: this is always getting the 0\n    const displaySet = displaySets[0];\n    this.installOpenLayersRenderer(this.container.current, displaySet).then(() => {\n      this.setState({ isLoaded: true });\n    });\n  }\n\n  componentDidUpdate(prevProps: Readonly<{}>, prevState: Readonly<{}>, snapshot?: any): void {\n    if (this.managedViewer && prevProps.displaySets !== this.props.displaySets) {\n      const { displaySets } = this.props;\n      const displaySet = displaySets[0];\n\n      this.microscopyService.clearAnnotations();\n\n      // loading SR\n      if (displaySet.Modality === 'SR') {\n        const referencedDisplaySet = displaySet.getSourceDisplaySet();\n        displaySet.load(referencedDisplaySet);\n      }\n    }\n  }\n\n  componentWillUnmount() {\n    this.microscopyService.removeViewer(this.viewer);\n  }\n\n  setViewportActiveHandler = () => {\n    const { setViewportActive, viewportId, activeViewportId } = this.props;\n\n    if (viewportId !== activeViewportId) {\n      setViewportActive(viewportId);\n    }\n  };\n\n  render() {\n    const style = { width: '100%', height: '100%' };\n    const displaySet = this.props.displaySets[0];\n    const firstInstance = displaySet.firstInstance || displaySet.instance;\n\n    return (\n      <div\n        className={'DicomMicroscopyViewer'}\n        style={style}\n        onClick={this.setViewportActiveHandler}\n      >\n        <div style={{ ...style, display: 'none' }}>\n          <div style={{ ...style }} ref={this.overlayElement}>\n            <div style={{ position: 'relative', height: '100%', width: '100%' }}>\n              {displaySet && firstInstance.imageId && (\n                <ViewportOverlay\n                  displaySet={displaySet}\n                  instance={displaySet.instance}\n                  metadata={displaySet.metadata}\n                />\n              )}\n            </div>\n          </div>\n        </div>\n        {this.state.error ? (\n          <h2>{JSON.stringify(this.state.error)}</h2>\n        ) : (\n          <div\n            style={style}\n            ref={(ref: any) => {\n              this.container.current = ref;\n              this.props.resizeRef.current = ref;\n            }}\n          />\n        )}\n        {this.state.isLoaded ? null : (\n          <LoadingIndicatorProgress className={'h-full w-full bg-black'} />\n        )}\n      </div>\n    );\n  }\n}\n\nexport default DicomMicroscopyViewport;\n","import { errorHandler, DicomMetadataStore } from '@ohif/core';\nimport { StaticWadoClient } from '@ohif/extension-default';\n\n/**\n * create a DICOMwebClient object to be used by Dicom Microscopy Viewer\n *\n * Referenced the code from `/extensions/default/src/DicomWebDataSource/index.js`\n *\n * @param param0\n * @returns\n */\nexport default function getDicomWebClient({ extensionManager, servicesManager }: withAppTypes) {\n  const dataSourceConfig = window.config.dataSources.find(\n    ds => ds.sourceName === extensionManager.activeDataSource\n  );\n  const { userAuthenticationService } = servicesManager.services;\n\n  const { wadoRoot, staticWado, singlepart } = dataSourceConfig.configuration;\n\n  const wadoConfig = {\n    url: wadoRoot || '/dicomlocal',\n    staticWado,\n    singlepart,\n    headers: userAuthenticationService.getAuthorizationHeader(),\n    errorInterceptor: errorHandler.getHTTPErrorHandler(),\n  };\n\n  const client = new StaticWadoClient(wadoConfig);\n  client.wadoURL = wadoConfig.url;\n\n  if (extensionManager.activeDataSource === 'dicomlocal') {\n    /**\n     * For local data source, override the retrieveInstanceFrames() method of the\n     * dicomweb-client to retrieve image data from memory cached metadata.\n     * Other methods of the client doesn't matter, as we are feeding the DMV\n     * with the series metadata already.\n     *\n     * @param {Object} options\n     * @param {String} options.studyInstanceUID - Study Instance UID\n     * @param {String} options.seriesInstanceUID - Series Instance UID\n     * @param {String} options.sopInstanceUID - SOP Instance UID\n     * @param {String} options.frameNumbers - One-based indices of Frame Items\n     * @param {Object} [options.queryParams] - HTTP query parameters\n     * @returns {ArrayBuffer[]} Rendered Frame Items as byte arrays\n     */\n    //\n    client.retrieveInstanceFrames = async options => {\n      if (!('studyInstanceUID' in options)) {\n        throw new Error('Study Instance UID is required for retrieval of instance frames');\n      }\n      if (!('seriesInstanceUID' in options)) {\n        throw new Error('Series Instance UID is required for retrieval of instance frames');\n      }\n      if (!('sopInstanceUID' in options)) {\n        throw new Error('SOP Instance UID is required for retrieval of instance frames');\n      }\n      if (!('frameNumbers' in options)) {\n        throw new Error('frame numbers are required for retrieval of instance frames');\n      }\n      console.log(\n        `retrieve frames ${options.frameNumbers.toString()} of instance ${options.sopInstanceUID}`\n      );\n\n      const instance = DicomMetadataStore.getInstance(\n        options.studyInstanceUID,\n        options.seriesInstanceUID,\n        options.sopInstanceUID\n      );\n\n      const frameNumbers = Array.isArray(options.frameNumbers)\n        ? options.frameNumbers\n        : options.frameNumbers.split(',');\n\n      return frameNumbers.map(fr =>\n        Array.isArray(instance.PixelData) ? instance.PixelData[+fr - 1] : instance.PixelData\n      );\n    };\n  }\n\n  return client;\n}\n"],"names":["props","list","itemGenerator","map","item","generator","Error","generateFromConfig","topLeft","topRight","bottomLeft","bottomRight","overlay","React","length","className","classnames","listComponentGenerator","DicomMicroscopyViewport","Component","constructor","super","state","error","isLoaded","microscopyService","viewer","managedViewer","container","overlayElement","setViewportActiveHandler","setViewportActive","viewportId","activeViewportId","this","servicesManager","services","getNearbyROI","event","autoselect","symbols","Object","getOwnPropertySymbols","_drawingSource","find","p","description","_pyramid","_map","_affine","feature","getClosestFeatureToCoordinate","getEventCoordinate","roiAnnotation","_getROIFromFeature","metadata","selectAnnotation","installOpenLayersRenderer","displaySet","clearAnnotations","smDisplaySet","Modality","getSourceDisplaySet","console","log","async","dicomMicroscopyModule","importDicomMicroscopyViewer","DicomMicroscopyViewer","metadataUtils","microscopyViewer","VolumeImageViewer","client","extensionManager","dataSourceConfig","window","config","dataSources","ds","sourceName","activeDataSource","userAuthenticationService","wadoRoot","staticWado","singlepart","configuration","wadoConfig","url","headers","getAuthorizationHeader","errorInterceptor","errorHandler","getHTTPErrorHandler","StaticWadoClient","wadoURL","retrieveInstanceFrames","options","frameNumbers","toString","sopInstanceUID","instance","DicomMetadataStore","getInstance","studyInstanceUID","seriesInstanceUID","Array","isArray","split","fr","PixelData","getDicomWebClient","volumeImages","forEach","m","ImageType","inst","cleanDenaturalizedDataset","dcmjs","DicomMetaDictionary","denaturalizeDataset","StudyInstanceUID","SeriesInstanceUID","dataSource","getConfig","vr","Value","image","VLWholeSlideMicroscopyImage","imageFlavor","push","retrieveRendered","controls","current","addViewportOverlay","element","coordinates","navigate","render","addViewer","addContextMenuCallback","loadViewer","others","load","componentDidMount","displaySets","viewportOptions","then","setState","componentDidUpdate","prevProps","prevState","snapshot","referencedDisplaySet","componentWillUnmount","removeViewer","style","width","height","firstInstance","onClick","display","ref","position","imageId","ViewportOverlay","JSON","stringify","resizeRef","LoadingIndicatorProgress","propTypes","viewportData","PropTypes","viewportLabel","displaySetOptions","commandsManager"],"sourceRoot":""}